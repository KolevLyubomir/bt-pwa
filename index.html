<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>БТ App 3 — v2.34</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <meta name="theme-color" content="#0b1215"/>
  <link rel="manifest" href="manifest.webmanifest?v=1.39"/>
  <link rel="icon" href="assets/icons/icon-192.png?v=1.39"/>

  <style>
    :root{
      --bg:#0b1215; --card:#111a1f; --text:#e6f2ef; --muted:#9fb4ad;
      --accent:#10b981; --border:#1e2b30; --has:#c7f5df; --danger:#ef4444;
      --chart-label:15px; --chart-values:15px;
      --line-green:#87f3c5; --line-orange:#f59e0b; --line-neutral:#2dd4bf;
      --ctl-h:42px; --lbl-h:16px; --maxw:980px; --pill-w:168px;

      /* ProLact таблица */
      --wk-green-d:#9fdcc7;
      --sel-orange:#f59e0b;
      --pl-font:11.5px;  /* ~ -20% */
      --pl-pad:2px;
      --pl-minw:42px;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,"Noto Sans",sans-serif
    }

    /* ===== Горна лента ===== */
    .topbar-wrap{ position:sticky; top:0; z-index:10; background:#0b1215; border-bottom:1px solid var(--border) }
    .topbar{ max-width:var(--maxw); margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:center; gap:10px }
    .topbar .brand{ display:flex; align-items:center; gap:10px; font-weight:800 }
    .topbar .brand img{ width:24px; height:24px }
    .topbar .title{ font-size:18px; font-weight:800 }
    .topbar .badge{ font-size:12px; font-weight:800; color:#06241b; background:linear-gradient(90deg,#22c55e,#14b8a6); padding:2px 8px; border-radius:10px }

    /* ===== Табове ===== */
    .tabs-wrap{ background:#0b1215; border-bottom:1px solid var(--border) }
    .tabs{ max-width:var(--maxw); margin:0 auto; padding:10px 16px; display:flex; gap:8px }
    .tab-btn{
      -webkit-tap-highlight-color: transparent;
      appearance:none; border:1px solid var(--border); background:#0d171b; color:#e6f2ef;
      padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:800; font-size:16px; transition:.15s ease
    }
    .tab-btn[aria-selected="true"]{ color:#06241b; border-color:transparent; background:linear-gradient(90deg,#22c55e,#14b8a6) }

    /* ===== Основно съдържание ===== */
    main{ max-width:var(--maxw); margin:20px auto; padding:0 16px 40px; display:grid; gap:16px; align-content:start }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px }

    /* ===== „Данни“ ===== */
    .inputs-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .spacer{ flex:1 1 auto }
    .field{ display:flex; flex-direction:column; justify-content:flex-end }
    .lbl{ height:var(--lbl-h); line-height:var(--lbl-h); font-size:12px; color:var(--muted); margin:0 0 6px 0 }
    .ctl{ display:flex; align-items:center }

    input,select,button{
      background:#0d171b; border:1px solid #254046; color:var(--text);
      border-radius:10px; padding:8px 10px; font-size:14px; height:var(--ctl-h)
    }
    input[type="number"]{ appearance:textfield; -webkit-appearance:none; -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }

    button{ cursor:pointer } button.primary{ background:var(--accent); border-color:var(--accent); color:#06241b; font-weight:700 }

    .field.date{ width:120px }
    .field.weight input{ font-weight:700; font-size:18px; width:9ch }
    .field.weight input[type="number"]{ appearance:auto; -webkit-appearance:auto; -moz-appearance:auto }
    .field.weight input[type="number"]::-webkit-inner-spin-button,
    .field.weight input[type="number"]::-webkit-outer-spin-button{ -webkit-appearance:auto; margin:0 }

    .bt-only{ display:flex; align-items:center; justify-content:center; width:var(--ctl-h); height:var(--ctl-h);
      border:1px solid #334a4f; background:#0d171b; border-radius:10px }
    .bt-only input{ width:16px; height:16px; margin:0 }

    table{ width:100%; border-collapse:collapse }
    colgroup col.date{ width:70px } colgroup col.w{ width:70px } colgroup col.act{ width:auto }
    th,td{ padding:3px 4px; border-bottom:1px solid #20343a; font-size:13px; line-height:1.15; white-space:nowrap; text-align:left; vertical-align:middle }
    th{ color:var(--muted); font-weight:600 }
    th.actions,td.actions{ padding-left:72px }

    .wCell{ text-align:right }
    .wSmall{ font-size:.6em; opacity:.95; margin-left:1px }

    .icon{ display:inline-flex; align-items:center; justify-content:center; border:1px solid #2a3e41; background:#0d171b; border-radius:8px; padding:4px 6px; color:#fff; height:var(--ctl-h) }
    .icon svg{ width:16px; height:16px; stroke:currentColor; stroke-linecap:round; stroke-linejoin:round }
    .icon.danger{ border-color:#3a2222; background:#161112; color:#ffd5d5 }

    .recbar{ display:flex; align-items:center; gap:8px; margin:8px 0; flex-wrap:wrap }
    .pager{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-top:8px }
    .pager .info{ color:var(--muted); font-size:12px; margin-right:8px }
    .pager button{ background:#0d171b; border:1px solid #2a3e41; color:#fff; padding:4px 8px; border-radius:8px; font-size:13px }
    .pager button.active{ background:var(--accent); color:#06241b; border-color:var(--accent) }

    canvas{ width:100%; height:360px; display:block; margin-top:8px; background:#0b1215; border:1px solid #1a2a2f; border-radius:8px }

    .date-wrap{ position:relative } #dateText[readonly]{ cursor:pointer }
    .cal{ position:absolute; z-index:10; top:calc(var(--ctl-h) + 6px); left:0; background:#0e1518; border:1px solid #20343a; border-radius:12px;
      box-shadow:0 8px 30px rgba(0,0,0,.35); padding:10px; width:auto; display:none }
    .cal.show{ display:block }
    .cal .cal-grid{ display:grid; grid-template-columns:repeat(7,36px); gap:6px; justify-content:center }
    .cal .day{ width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid transparent }
    .cal .day.today{ outline:1px dashed #5b8f98 }
    .cal .day.sel{ background:#84e9c2; color:#041915; font-weight:700 }

    /* Панели */
    .tabpanel{ display:none }
    .tabpanel[aria-hidden="false"]{ display:block }

    /* ====== ПРОГРАМА (общи) ====== */
    .prog-row{ display:flex; align-items:flex-start; gap:12px; flex-wrap:wrap; margin:8px 0 0 }
    .prog-head{ display:flex; align-items:center; gap:12px; margin-bottom:6px }
    .prod-img{ width:76px; height:76px; object-fit:contain; border-radius:12px; background:#0d171b; border:1px solid #254046 }
    .prog-pill{
      display:flex; flex-direction:column; gap:6px;
      padding:8px 10px; background:#0d171b; border:1px solid #254046; border-radius:10px;
      width:var(--pill-w); min-width:var(--pill-w); max-width:var(--pill-w);
    }
    .prog-cap{ font-weight:700 }

    /* ===== ProLact Slim+ таблица ===== */
    .pl-wrap{ overflow-x:hidden }
    .pl-table{ width:100%; border-collapse:separate; border-spacing:3px; table-layout:fixed }
    .pl-table th, .pl-table td{
      border:1px solid #20343a; border-radius:10px; text-align:center;
      padding:var(--pl-pad); font-size:var(--pl-font); line-height:1.05; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      min-width:var(--pl-minw);
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .pl-day{ cursor:pointer; user-select:none; font-weight:800 }
    .pl-day.weekend{ color:var(--wk-green-d) }
    .pl-day.today{ outline:1px dashed rgba(200,200,200,.55); outline-offset:-4px }
    .pl-day.active{ border-color:var(--sel-orange) }

    .pl-time-cell{ cursor:pointer; user-select:none; font-weight:600; background:#0f1518 }
    .pl-time-cell.sel{ box-shadow:0 0 0 2px var(--sel-orange) inset }
    .pl-time-cell.green{ background:#103d2a; border-color:#1e6147 }
    .pl-time-cell.yellow{ background:#3a3616; border-color:#6b5314 }
    .pl-time-cell.red{ background:#3d1010; border-color:#6b1414 }
    .pl-ico{ display:inline-flex; margin-left:3px; vertical-align:middle }

    /* ===== Модал часовник (drag) ===== */
    .clk{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100 }
    .clk.show{ display:flex; align-items:center; justify-content:center }
    .clk-card{ background:#0e1519; border:1px solid #20343a; border-radius:16px;
      padding:12px; width:340px; max-width:94vw; box-shadow:0 10px 40px rgba(0,0,0,.5); outline:none }
    .clk-card:focus{ box-shadow:0 0 0 2px rgba(255,255,255,.08) inset }

    .clk-face{ position:relative; width:290px; height:290px; margin:0 auto; border-radius:50%; border:1px solid #294047; background:#0b1317; touch-action:none }
    .clk-ring{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); border-radius:50% }
    .clk-ring.hours{ width:200px; height:200px }  /* вътрешен: 12 отметки, цикли 1–12 / 13–24 */
    .clk-ring.mins{ width:260px; height:260px }   /* външен: 60 отметки */

    .clk-tick{ position:absolute; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; color:#d6ece6;
      border:1px solid transparent; background:#0f1a1d; user-select:none }
    .clk-tick.strong{ font-weight:800 }
    .clk-tick.sel{ background:#22c55e; color:#06241b }

    /* минутна чертичка */
    .m-tick{ width:2px; height:7px; background:#cde7df; border-radius:1px }

    /* стрелки */
    .clk-hand{ position:absolute; left:50%; top:50%; transform-origin:50% 100%; pointer-events:none }
    .clk-hand.hour{ width:6px; height:78px; background:#e7faf4; border-radius:3px; transform:translate(-50%,-100%) rotate(0deg); box-shadow:0 0 0 1px #0b1215 inset }
    .clk-hand.min{ width:3px; height:106px; background:#cde7df; border-radius:2px; transform:translate(-50%,-100%) rotate(0deg); box-shadow:0 0 0 1px #0b1215 inset }

    .clk-center-dot{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:10px; height:10px; background:#fff; border-radius:50%; box-shadow:0 0 0 2px #0b1317 }

    /* център – правоъгълник с текущия избор + drag */
    .clk-read{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:#10191c; border:1px solid #294047; border-radius:8px; padding:5px 8px;
      font-weight:800; min-width:86px; text-align:center; cursor:ns-resize; user-select:none }

    /* бутони */
    .clk-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap }
    .traffic-btn{
      display:flex; align-items:center; gap:6px;
      border-radius:999px; padding:6px 10px; border:2px solid #0b1215; font-weight:800;
      color:#06241b; min-width:64px; justify-content:center;
    }
    #btnGreen{ background:#22c55e }
    #btnYellow{ background:#f59e0b }
    #btnRed{ background:#ef4444; color:#0b1215 }
    #btnRed svg{ width:16px; height:16px; stroke:#0b1215; stroke-width:2 }
    @media (max-width: 380px){
      :root{ --pill-w:156px; --pl-font:11px; --pl-pad:2px; --pl-minw:40px }
      .prod-img{ width:64px; height:64px; border-radius:10px }
      .clk-card{ width:312px }
      .clk-face{ width:272px; height:272px }
      .clk-ring.hours{ width:188px; height:188px }
      .clk-ring.mins{ width:248px; height:248px }
      .clk-hand.hour{ height:72px } .clk-hand.min{ height:98px }
    }
  </style>
</head>
<body>

  <!-- Горна лента -->
  <div class="topbar-wrap">
    <div class="topbar">
      <div class="brand">
        <img src="assets/icons/icon-192.png?v=1.39" alt="BT"/>
        <span class="title">BT&nbsp;Безопасно Тегло —</span>
        <span class="badge">v2.34</span>
      </div>
    </div>
  </div>

  <!-- Табове -->
  <div class="tabs-wrap" role="navigation" aria-label="Навигация">
    <div class="tabs" role="tablist">
      <button id="tab-data" class="tab-btn" role="tab" aria-controls="panel-data" aria-selected="true">Данни</button>
      <button id="tab-program" class="tab-btn" role="tab" aria-controls="panel-program" aria-selected="false">Програма</button>
    </div>
  </div>

  <!-- ПАНЕЛ: ДАННИ -->
  <div id="panel-data" class="tabpanel" role="tabpanel" aria-labelledby="tab-data" aria-hidden="false">
    <main>
      <section class="card">
        <h2 style="margin:0 0 10px">Запис</h2>
        <div class="inputs-row">
          <div class="inputs-row" style="gap:10px">
            <div class="field date">
              <div class="lbl">Дата</div>
              <div class="ctl date-wrap">
                <input id="dateText" type="text" readonly placeholder="ДД.ММ.ГГ"/>
                <div id="cal" class="cal" role="dialog" aria-label="Календар"></div>
              </div>
            </div>
            <div class="field weight">
              <div class="lbl">Тегло (kg)</div>
              <div class="ctl"><input id="weight" type="number" step="0.1" min="0.1" placeholder="107.7"/></div>
            </div>
            <div class="field" style="min-width:var(--ctl-h)">
              <div class="lbl"></div>
              <label class="bt-only" title="Маркиран като БТ"><input id="btFlag" type="checkbox" checked/></label>
            </div>
            <div class="field" style="min-width:100px">
              <div class="lbl"></div>
              <button id="addBtn" class="primary" type="button" style="height:var(--ctl-h); min-width:100px">Добави</button>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="inputs-row" style="gap:8px">
            <div class="field"><div class="lbl"></div>
              <button id="exportBtn" class="icon" title="Експорт" aria-label="Експорт" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 16V4M12 4l-4 4M12 4l4 4"></path><path d="M4 20h16"></path></svg>
              </button>
            </div>
            <div class="field"><div class="lbl"></div>
              <input id="importFile" type="file" accept="application/json" style="display:none"/>
              <button id="importBtn" class="icon" title="Импорт" aria-label="Импорт" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v12M12 20l-4-4M12 20l4-4"></path><path d="M4 4h16"></path></svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 style="margin:0 0 10px">Графика</h2>
        <div class="inputs-row">
          <select id="aggSel" title="Агрегация">
            <option value="daily" selected>Дневни</option>
            <option value="weekly">Седмични</option>
            <option value="monthly">Месечни</option>
          </select>
        </div>
        <canvas id="chart"></canvas>
      </section>

      <section class="card">
        <h2 style="margin:0">Записи</h2>
        <div class="recbar">
          <label for="pageSize" style="font-size:12px;color:var(--muted)">На страница:</label>
          <select id="pageSize">
            <option value="7">7 (1 сед.)</option>
            <option value="14">14 (2 сед.)</option>
            <option value="28" selected>28 (~1 мес.)</option>
            <option value="84">84 (~3 мес.)</option>
            <option value="112">112 (~4 мес.)</option>
            <option value="168">168 (~6 мес.)</option>
            <option value="336">336 (~12 мес.)</option>
            <option value="all">Всички</option>
          </select>
        </div>
        <div class="pager" id="pagerTop"></div>
        <table id="tbl">
          <colgroup><col class="date"><col class="w"><col class="act"></colgroup>
          <thead id="theadTop"><tr><th class="date">Дата</th><th class="w">Тегло (kg)</th><th class="actions">Действия</th></tr></thead>
          <tbody></tbody>
          <tfoot id="tfootBottom"><tr><th class="date">Дата</th><th class="w">Тегло (kg)</th><th class="actions">Действия</th></tr></tfoot>
        </table>
        <div class="pager" id="pagerBottom"></div>
      </section>
    </main>
  </div>

  <!-- ПАНЕЛ: ПРОГРАМА -->
  <div id="panel-program" class="tabpanel" role="tabpanel" aria-labelledby="tab-program" aria-hidden="true">
    <main>
      <section class="card" id="pkg-core">
        <h2 style="margin:0 0 10px">Основен пакет</h2>

        <!-- ProLact Slim+ — таблица Пн–Нд × 2 часа -->
        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/prolact.webp" alt="ProLact Slim+"/>
            <span class="prog-cap">ProLact Slim+ — два приема</span>
          </div>

          <div class="pl-wrap">
            <table class="pl-table" id="pl-table">
              <thead>
                <tr>
                  <th class="pl-day" data-dow="1">Пн</th>
                  <th class="pl-day" data-dow="2">Вт</th>
                  <th class="pl-day" data-dow="3">Ср</th>
                  <th class="pl-day" data-dow="4">Чт</th>
                  <th class="pl-day" data-dow="5">Пт</th>
                  <th class="pl-day weekend" data-dow="6">Сб</th>
                  <th class="pl-day weekend" data-dow="0">Нд</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="pl-time-cell" data-row="0" data-dow="1">08:00</td>
                  <td class="pl-time-cell" data-row="0" data-dow="2">08:00</td>
                  <td class="pl-time-cell" data-row="0" data-dow="3">08:00</td>
                  <td class="pl-time-cell" data-row="0" data-dow="4">08:00</td>
                  <td class="pl-time-cell" data-row="0" data-dow="5">08:00</td>
                  <td class="pl-time-cell" data-row="0" data-dow="6">08:00</td>
                  <td class="pl-time-cell" data-row="0" data-dow="0">08:00</td>
                </tr>
                <tr>
                  <td class="pl-time-cell" data-row="1" data-dow="1">19:00</td>
                  <td class="pl-time-cell" data-row="1" data-dow="2">19:00</td>
                  <td class="pl-time-cell" data-row="1" data-dow="3">19:00</td>
                  <td class="pl-time-cell" data-row="1" data-dow="4">19:00</td>
                  <td class="pl-time-cell" data-row="1" data-dow="5">19:00</td>
                  <td class="pl-time-cell" data-row="1" data-dow="6">19:00</td>
                  <td class="pl-time-cell" data-row="1" data-dow="0">19:00</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <hr class="prog-sep"/>

        <!-- OMNi-Biotic HETOX light (както преди) -->
        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/omni-hetox-light.png" alt="OMNi-Biotic HETOX light"/>
            <span class="prog-cap">OMNi-Biotic HETOX light</span>
          </div>
          <div class="prog-row" role="group" aria-label="HETOX — 1 от 3">
            <span class="prog-pill">
              <label><input type="checkbox" id="he-m"> Сутрин</label>
              <div id="he-tp-m" class="time-wrap" style="display:none">
                <div class="time-row"><select id="he-hh-m"></select><span class="colon">:</span><select id="he-mm-m"></select></div>
              </div>
            </span>
            <span class="prog-pill">
              <label><input type="checkbox" id="he-n" checked> Обед</label>
              <div id="he-tp-n" class="time-wrap" style="display:block">
                <div class="time-row"><select id="he-hh-n"></select><span class="colon">:</span><select id="he-mm-n"></select></div>
              </div>
            </span>
            <span class="prog-pill">
              <label><input type="checkbox" id="he-e"> Вечер</label>
              <div id="he-tp-e" class="time-wrap" style="display:none">
                <div class="time-row"><select id="he-hh-e"></select><span class="colon">:</span><select id="he-mm-e"></select></div>
              </div>
            </span>
          </div>
        </div>

        <hr class="prog-sep"/>

        <!-- Fortex Хитозан Плюс (както преди) -->
        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/chitosan-plus.webp" alt="Fortex Хитозан Плюс"/>
            <span class="prog-cap">Fortex Хитозан Плюс</span>
          </div>
          <div class="prog-row" role="group" aria-label="Хитозан Плюс">
            <span class="prog-pill">
              <label><input type="checkbox" id="ch-m" checked disabled> Сутрин</label>
              <div id="ch-tp-m" class="time-wrap">
                <div class="time-row"><select id="ch-hh-m"></select><span class="colon">:</span><select id="ch-mm-m"></select></div>
              </div>
            </span>
            <span class="prog-pill">
              <label><input type="checkbox" id="ch-n" checked disabled> Обед</label>
              <div id="ch-tp-n" class="time-wrap">
                <div class="time-row"><select id="ch-hh-n"></select><span class="colon">:</span><select id="ch-mm-n"></select></div>
              </div>
            </span>
            <span class="prog-pill">
              <label><input type="checkbox" id="ch-e" checked disabled> Вечер</label>
              <div id="ch-tp-e" class="time-wrap">
                <div class="time-row"><select id="ch-hh-e"></select><span class="colon">:</span><select id="ch-mm-e"></select></div>
              </div>
            </span>
          </div>
        </div>
      </section>

      <section class="card" id="pkg-extra">
        <h2 style="margin:0 0 10px">Допълнителен пакет</h2>
        <ul style="margin:8px 0 0; padding-left:1rem; line-height:1.5">
          <li><strong>Берберин 500–600 mg</strong> — марка по избор</li>
          <li><strong>Глюкоманан</strong> (<em>NOW Foods</em>)</li>
          <li><strong>EGCg</strong> — екстракт от зелен чай (<em>NOW Foods</em>)</li>
        </ul>
      </section>

      <section class="card" id="pkg-personal">
        <h2 style="margin:0 0 10px">Личен режим</h2>
        <p style="margin:0 0 8px; color:#9fb4ad">Тук включваш други добавки/витамини/медикаменти извън основната програма.</p>
        <ul style="margin:8px 0 0; padding-left:1rem; line-height:1.5">
          <li><em>Пример:</em> Магнезий бисглицинат</li>
          <li><em>Пример:</em> Витамин D3 + K2</li>
          <li><em>Пример:</em> Омега-3</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- МОДАЛ ЧАСОВНИК -->
  <div class="clk" id="clk" aria-hidden="true">
    <div class="clk-card" id="clkCard" role="dialog" aria-label="Избор на време" tabindex="0">
      <div class="clk-face" id="clkFace">
        <div class="clk-ring mins" id="ringM"></div>
        <div class="clk-ring hours" id="ringH"></div>
        <div class="clk-hand hour" id="handH"></div>
        <div class="clk-hand min" id="handM"></div>
        <div class="clk-center-dot"></div>
        <div class="clk-read" id="clkRead" title="Плъзни нагоре/надолу">08:00</div>
      </div>
      <div class="clk-actions">
        <button id="btnGreen" class="traffic-btn" aria-label="Запиши (зелено)">ОК</button>
        <button id="btnYellow" class="traffic-btn" aria-label="Запиши (жълто)">Взех го</button>
        <button id="btnRed" class="traffic-btn" aria-label="Запиши (червено)">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M9 9l6 6M15 9l-6 6" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M3 9v6h4l5 4V5L7 9H3z" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    "use strict";
    function two(n){ return String(n).padStart(2,"0"); }
    function todayISO(){ var d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    var TODAY = todayISO();

    /* ===== Табове ===== */
    (function(){
      const tabs = [
        {btn: document.getElementById('tab-data'), panel: document.getElementById('panel-data')},
        {btn: document.getElementById('tab-program'), panel: document.getElementById('panel-program')}
      ];
      function select(i){
        tabs.forEach((t,idx)=>{
          const sel = idx===i;
          t.btn.setAttribute('aria-selected', String(sel));
          t.panel.setAttribute('aria-hidden', String(!sel));
        });
        try{ localStorage.setItem('bt_active_tab_v234', String(i)); }catch(_){}
      }
      tabs.forEach((t,idx)=> t.btn.addEventListener('click', ()=>select(idx)));
      try{
        const saved = parseInt(localStorage.getItem('bt_active_tab_v234'),10);
        if(Number.isInteger(saved) && saved>=0 && saved<tabs.length) select(saved); else select(0);
      }catch(_){ select(0); }
    })();

    /* ===== (Данни) логика – без промяна спрямо 2.33 ===== */
    (function(){
      function isoToBG_YY(iso){ if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return ""; var y=iso.slice(0,4), m=iso.slice(5,7), d=iso.slice(8,10); return d+"."+m+"."+y.slice(2); }
      function bgToISO_any(bg){
        var m2=bg.match(/^(\d{2})\.(\d{2})\.(\d{2})$/); if(m2) return "20"+m2[3]+"-"+m2[2]+"-"+m2[1];
        var m4=bg.match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(m4) return m4[3]+"-"+m4[2]+"-"+m4[1];
        return "";
      }
      var KEY="bt-progress";
      function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_) { return []; } }
      function save(a){ localStorage.setItem(KEY, JSON.stringify(a)); }
      function sortDesc(a){ return a.slice().sort((x,y)=>y.date.localeCompare(x.date)); }
      function sortAsc(a){ return a.slice().sort((x,y)=>x.date.localeCompare(y.date)); }

      var dateText=document.getElementById("dateText"), calEl=document.getElementById("cal"),
          weight=document.getElementById("weight"), addBtn=document.getElementById("addBtn"),
          tb=document.querySelector("#tbl tbody"), pagerTop=document.getElementById("pagerTop"),
          pagerBottom=document.getElementById("pagerBottom"), aggSel=document.getElementById("aggSel"),
          chart=document.getElementById("chart"), pageSizeSel=document.getElementById("pageSize"),
          exportBtn=document.getElementById("exportBtn"), importBtn=document.getElementById("importBtn"),
          importFile=document.getElementById("importFile"), btFlag=document.getElementById("btFlag");

      var currentISO=localStorage.getItem("bt-last-date")||TODAY;
      if(!/^\d{4}-\d{2}-\d{2}$/.test(currentISO)) currentISO=TODAY;
      dateText.value=isoToBG_YY(currentISO);
      function prefillFor(iso){
        var data=load(); var rec=data.find(r=>r.date===iso);
        if(rec){ weight.value=(typeof rec.weight==="number")?rec.weight:""; btFlag.checked = (rec.bt!==false); return; }
        var prev=sortDesc(data).find(r=>r.date<iso);
        weight.value=prev?prev.weight:""; btFlag.checked=true;
      }
      prefillFor(currentISO);

      var calYear=+currentISO.slice(0,4), calMonth=+currentISO.slice(5,7);
      function ymd(y,m,d){ return String(y).padStart(4,"0")+"-"+String(m).padStart(2,"0")+"-"+String(d).padStart(2,"0"); }
      function hasDataSet(){ var s=new Set(); load().forEach(r=>s.add(r.date)); return s; }
      function renderCalendar(){
        var set=hasDataSet(), y=calYear, m=calMonth;
        var first=new Date(Date.UTC(y,m-1,1));
        var startDow=(first.getUTCDay()+6)%7;
        var daysInMonth=new Date(Date.UTC(y,m,0)).getUTCDate();
        var title=new Date(Date.UTC(y,m-1,1)).toLocaleDateString("bg-BG",{year:"numeric",month:"long"});
        var html='<div class="cal-head"><button id="calPrev" type="button">←</button><div class="cal-title">'+title+'</div><button id="calNext" type="button">→</button></div>';
        html+='<div class="cal-grid">';
        ["Пн","Вт","Ср","Чт","Пт","Сб","Нд"].forEach(x=>html+='<div class="dow">'+x+'</div>');
        for(var i=0;i<startDow;i++) html+='<div class="day disabled"></div>';
        for(var d=1; d<=daysInMonth; d++){
          var iso=ymd(y,m,d), future=(iso>TODAY);
          var cls=["day"]; if(iso===currentISO) cls.push("sel"); if(iso===TODAY) cls.push("today");
          if(set.has(iso)) cls.push("has"); if(future) cls.push("disabled");
          html+='<button type="button" class="'+cls.join(" ")+'" data-iso="'+iso+'">'+d+'</button>';
        }
        html+='</div>';
        calEl.innerHTML=html;
      }
      function showCalendar(){ renderCalendar(); calEl.classList.add("show"); }
      function hideCalendar(){ calEl.classList.remove("show"); }
      dateText.addEventListener("click",(e)=>{ e.stopPropagation(); calYear=+currentISO.slice(0,4); calMonth=+currentISO.slice(5,7); showCalendar(); });
      calEl.addEventListener("click",(e)=>{
        e.stopPropagation(); var t=e.target;
        if(t && t.id==="calPrev"){ calMonth--; if(calMonth===0){calMonth=12; calYear--; } renderCalendar(); return; }
        if(t && t.id==="calNext"){ calMonth++; if(calMonth===13){calMonth=1; calYear++; } renderCalendar(); return; }
        var btn=t.closest && t.closest(".day[data-iso]");
        if(btn){ var iso=btn.getAttribute("data-iso"); if(iso<=TODAY){ currentISO=iso; localStorage.setItem("bt-last-date",iso); dateText.value=isoToBG_YY(iso); prefillFor(iso); hideCalendar(); } }
      });
      document.addEventListener("click",(e)=>{ if(!calEl.contains(e.target) && e.target!==dateText) hideCalendar(); });

      addBtn.addEventListener("click", ()=>{
        var iso=currentISO;
        if(iso>TODAY){ alert("Датата е в бъдещето."); return; }
        var w=Number(weight.value); if(!(w>0)){ alert("Въведи тегло > 0."); return; }

        var data=load(), prev=sortDesc(data).find(r=>r.date<iso), next=sortAsc(data).find(r=>r.date>iso);
        var ok=true, msgs=[];
        if(prev){ var minP=prev.weight*0.95, maxP=prev.weight*1.05; if(w<minP||w>maxP){ ok=false; msgs.push("спрямо "+isoToBG_YY(prev.date)+": "+minP.toFixed(1)+"–"+maxP.toFixed(1)+" kg"); } }
        if(next){ var minN=next.weight*0.95, maxN=next.weight*1.05; if(w<minN||w>maxN){ ok=false; msgs.push("спрямо "+isoToBG_YY(next.date)+": "+minN.toFixed(1)+"–"+maxN.toFixed(1)+" kg"); } }
        if(!ok){ alert("Извън допустимите граници:\n"+msgs.join("\n")); return; }

        var idx=data.findIndex(r=>r.date===iso);
        var rec={date: iso, weight: w, bt: !!btFlag.checked};
        if(idx>=0) data[idx]=rec; else data.push(rec);
        save(data);
        renderTable(); renderChart();
      });

      var PAGE_SIZES=[7,14,28,84,112,168,336,"all"];
      function getPS(){ var v=localStorage.getItem("bt-page-size"); if(v==="all") return "all"; var n=Number(v); return (PAGE_SIZES.indexOf(n)>=0)?n:28; }
      function setPS(v){ localStorage.setItem("bt-page-size",v); }
      var pageSize=getPS(), currentPage=1;
      (function(){ var v=(pageSize==="all")?"all":String(pageSize); var opt=document.querySelector('#pageSize option[value="'+v+'"]'); if(opt) pageSizeSel.value=v; })();
      pageSizeSel.addEventListener("change", ()=>{ var v=pageSizeSel.value; pageSize=(v==="all")?"all":Number(v); setPS(v); currentPage=1; renderTable(); renderChart(); });

      var __currentSlice=[];

      function buildPager(container,total,eff){
        container.innerHTML="";
        var start=(currentPage-1)*eff, from=total?start+1:0, to=Math.min(start+eff,total);
        var info=document.createElement("span"); info.className="info"; info.textContent=from+"-"+to+" от "+total; container.appendChild(info);

        var pagesTotal=Math.max(1,Math.ceil(total/eff)), frag=document.createDocumentFragment();
        function pageBtn(n,active){ var b=document.createElement("button"); b.textContent=String(n); if(active) b.className="active";
          b.addEventListener("click",()=>{currentPage=n; renderTable(); renderChart();}); return b; }
        if(pagesTotal>1 && currentPage>1){ var prev=document.createElement("button"); prev.textContent="←";
          prev.addEventListener("click",()=>{currentPage=Math.max(1,currentPage-1); renderTable(); renderChart();}); frag.appendChild(prev); }
        if(pagesTotal<=5){ for(var p=1;p<=pagesTotal;p++) frag.appendChild(pageBtn(p,p===currentPage)); }
        else{ var sp=currentPage-2; if(sp<1) sp=1; if(sp+4>pagesTotal) sp=pagesTotal-4; for(var pp=sp; pp<=sp+4; pp++) frag.appendChild(pageBtn(pp,pp===currentPage)); }
        if(pagesTotal>1 && currentPage<pagesTotal){ var next=document.createElement("button"); next.textContent="→";
          next.addEventListener("click",()=>{currentPage=Math.min(pagesTotal,currentPage+1); renderTable(); renderChart();}); frag.appendChild(next); }
        container.appendChild(frag);
      }

      function renderTable(){
        var all=sortDesc(load()), total=all.length, eff=(pageSize==="all")?(total||1):pageSize;
        var pages=Math.max(1,Math.ceil(total/eff)); if(currentPage>pages) currentPage=pages;
        var start=(currentPage-1)*eff, slice=all.slice(start,start+eff); __currentSlice=slice.slice();

        buildPager(pagerTop,total,eff);
        tb.innerHTML="";
        slice.forEach((r)=>{
          var tr=document.createElement("tr");
          var s=Number(r.weight).toFixed(1).split(".");
          tr.innerHTML =
            '<td class="date">'+isoToBG_YY(r.date)+'</td>'+
            '<td class="w wCell"><span class="wInt">'+s[0]+'</span><span class="wSmall">.'+s[1]+'</span></td>'+
            '<td class="actions">'+
              '<button class="icon" title="Редакция" data-edit="'+r.date+'" aria-label="Редакция" type="button">'+
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21l3-1 11-11-2-2L4 18z"></path><path d="M14 5l5 5"></path></svg>'+
              '</button>'+
              '<button class="icon danger" title="Изтрий" data-del="'+r.date+'" aria-label="Изтрий" type="button">'+
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8л1-14"></path></svg>'+
              '</button>'+
            '</td>';
          tb.appendChild(tr);
        });
        Array.from(tb.querySelectorAll('button[data-edit]')).forEach((b)=>{
          b.addEventListener("click",()=>{
            var iso=b.getAttribute("data-edit"); var rec=load().find(x=>x.date===iso);
            if(rec){
              currentISO=iso; localStorage.setItem("bt-last-date",iso);
              dateText.value=isoToBG_YY(iso); prefillFor(iso);
              window.scrollTo({top:0,behavior:"smooth"});
            }
          });
        });
        Array.from(tb.querySelectorAll('button[data-del]')).forEach((b)=>{
          b.addEventListener("click",()=>{
            var iso=b.getAttribute("data-del"); if(!confirm("Да изтрия записа за "+isoToBG_YY(iso)+"?")) return;
            var data=load().filter(x=>x.date!==iso); save(data); renderTable(); renderChart();
          });
        });
        buildPager(pagerBottom,total,eff);
      }

      function weekKey(iso){
        var d=new Date(iso); d.setUTCHours(0,0,0,0); d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
        var yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
        var week=Math.ceil((((d-yearStart)/86400000)+1)/7);
        return d.getUTCFullYear()+"-W"+String(week).padStart(2,"0");
      }
      function monthKey(iso){ var d=new Date(iso); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); }
      function labelWeek(k){ var s=k.split("-W"); return "С"+s[1]+"."+String(s[0]).slice(2); }
      function labelMonth(k){ var s=k.split("-"); return s[1]+"."+String(s[0]).slice(2); }

      aggSel.addEventListener("change", ()=>renderChart());

      function cssPx(name, fallback){
        var v=getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        var n=parseFloat(v); return Number.isFinite(n)?n:fallback;
      }

      function getChartRawData(){
        var mode=aggSel.value;
        if(mode==="daily"){ var src=(__currentSlice && __currentSlice.length)?__currentSlice.slice():sortDesc(load()); return sortAsc(src); }
        return sortAsc(load());
      }

      function renderChart(){
        var ctx=chart.getContext("2d"), rect=chart.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
        chart.width=Math.round(rect.width*dpr); chart.height=Math.round(360*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
        var w=rect.width, h=360; ctx.clearRect(0,0,w,h);

        var raw=getChartRawData(); if(!raw.length){
          ctx.fillStyle="#9fb4ad"; ctx.font="700 "+cssPx('--chart-values', 15)+"px system-ui"; ctx.fillText("Няма данни",10,26); return;
        }

        var mode=aggSel.value, pts=[];
        if(mode==="daily"){ pts=raw.map(r=>({x:r.date,y:r.weight,label:isoToBG_YY(r.date), bt:(r.bt!==false)})); }
        else if(mode==="weekly"){
          var wm=new Map();
          raw.forEach(r=>{ var k=weekKey(r.date); (wm.get(k)||wm.set(k,[]).get(k)).push(r); });
          wm.forEach((arr,k)=>{ var s=0; for(var i=0;i<arr.length;i++) s+=arr[i].weight; var btCount=arr.filter(z=>z.bt!==false).length;
            pts.push({x:k,y:s/arr.length,label:labelWeek(k), bt:(btCount>=arr.length-бtCount)}); });
        } else {
          var mm=new Map();
          raw.forEach(r=>{ var k=monthKey(r.date); (mm.get(k)||mm.set(k,[]).get(k)).push(r); });
          mm.forEach((arr,k)=>{ var s=0; for(var i=0;i<arr.length;i++) s+=arr[i].weight; var btCount=arr.filter(z=>z.bt!==false).length;
            pts.push({x:k,y:s/arr.length,label:labelMonth(k), bt:(btCount>=arr.length-бtCount)}); });
        }

        pts.sort((a,b)=>a.x.localeCompare(b.x));
        var vals=pts.map(p=>p.y).filter(n=>typeof n==="number");
        ctx.font="700 "+cssPx('--chart-values', 15)+"px system-ui";
        if(vals.length<2){ ctx.fillStyle="#9fb4ad"; ctx.fillText("Добави поне 2 точки",10,26); return; }

        var min=Math.min(...vals), max=Math.max(...vals);
        var padL=48, padR=18, padT=16, padB=96, n=pts.length;
        function X(i){ return padL+(w-padL-padR)*(n<=1?0:i/(n-1)); }
        function Y(v){ return h-padB-((v-min)/((max-min)||1))*(h-padT-padB); }

        ctx.strokeStyle="#20343a"; ctx.lineWidth=1.1;
        ctx.beginPath(); ctx.moveTo(padL,h-пadB); ctx.lineTo(w-padR,h-пadB); ctx.moveTo(padL,padT); ctx.lineTo(padL,h-пadB); ctx.stroke();

        for(var i=1;i<n;i++){
          var p0=pts[i-1], p1=pts[i];
          var bothBT = (p0.bt && p1.bt), bothNon = (!p0.bt && !p1.bt);
          ctx.strokeStyle = bothBT ? getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b'
                          : bothNon ? getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5'
                          : getComputedStyle(document.documentElement).getPropertyValue('--line-neutral').trim()||'#2dd4bf';
          ctx.lineWidth=2.0; ctx.beginPath(); ctx.moveTo(X(i-1), Y(p0.y)); ctx.lineTo(X(i), Y(p1.y)); ctx.stroke();
        }

        ctx.fillStyle="#d9ebe5"; ctx.textBaseline="middle";
        ctx.fillText(String(max.toFixed(1)),10,Y(max)); ctx.fillText(String(min.toFixed(1)),10,Y(min));
      }

      exportBtn.addEventListener("click", ()=>{
        var data = load();
        var blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
        var url = URL.createObjectURL(blob); var a = document.createElement("a");
        a.href=url; a.download="bt-progress-export.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
      importBtn.addEventListener("click", ()=>importFile.click());
      importFile.addEventListener("change", ()=>{
        var f=importFile.files[0]; if(!f) return;
        var fr=new FileReader();
        fr.onload = () => {
          try{
            var arr = JSON.parse(fr.result||"[]"); if(!Array.isArray(arr)) throw new Error("Невалиден формат");
            arr = arr.filter(r => r && typeof r.date==="string" && typeof r.weight==="number")
                     .map(r => ({ date:r.date, weight:r.weight, bt:(r.bt!==false) }));
            localStorage.setItem("bt-progress", JSON.stringify(arr)); renderTable(); renderChart();
            alert("Импортът е успешен. Записите са презаредени.");
          }catch(e){ alert("Грешка при импорт: "+e.message); }
          importFile.value="";
        }; fr.readAsText(f);
      });

      function migrateDatesAndBT(){
        var arr=(function(){ try{ return JSON.parse(localStorage.getItem("bt-progress")||"[]"); }catch(_){ return []; } })(), changed=false;
        function fix(bg){ var m2=bg.match(/^(\d{2})\.(\d{2})\.(\d{2})$/); if(m2) return "20"+m2[3]+"-"+m2[2]+"-"+m2[1]; var m4=bg.match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(m4) return m4[3]+"-"+m4[2]+"-"+м4[1]; return ""; }
        for(var i=0;i<arr.length;i++){ var r=arr[i]; if(typeof r.date==="string" && !/^\d{4}-\d{2}-\d{2}$/.test(r.date)){ var iso=fix(r.date); if(iso){ r.date=iso; changed=true; } }
          if(typeof r.bt==="undefined"){ r.bt=true; changed=true; } }
        if(changed) localStorage.setItem("bt-progress", JSON.stringify(arr));
      }
      function initialRender(){ migrateDatesAndBT(); prefillFor(currentISO); renderTable(); renderChart(); window.addEventListener("resize", ()=>renderChart(), {passive:true}); }
      initialRender();
    })();

    /* ===== helper-и за OMNi/Хитозан ===== */
    function buildHourRange(sel, fromH, toH){
      sel.innerHTML=""; for(let h=fromH; h<=toH; h++){ const o=document.createElement("option"); o.value=two(h); o.textContent=o.value; if(h===8||h===12||h===19) o.className="strong"; sel.appendChild(o); }
    }
    function buildMinutes5(sel){
      sel.innerHTML=""; for(let m=0; m<60; m+=5){ const o=document.createElement("option"); o.value=two(m); o.textContent=o.value; if(m%15===0) o.className="strong"; sel.appendChild(o); }
    }
    function setSel(sel,val){ const opt=[...sel.options].find(o=>o.value===val); if(opt){ sel.value=val; return true;} return false; }

    /* ===== OMNi-Biotic — 1 от 3 ===== */
    (function(){
      const DEF={m:"08:00", n:"12:00", e:"19:00"};
      const KEY_SEL='bt_he_sel_v234'; const KEY_TIM='bt_he_tim_v234';
      const m=document.getElementById('he-m'), n=document.getElementById('he-n'), e=document.getElementById('he-e');
      const boxM=document.getElementById('he-tp-m'), boxN=document.getElementById('he-tp-n'), boxE=document.getElementById('he-tp-e');
      const hhM=document.getElementById('he-hh-m'), mmM=document.getElementById('he-mm-m');
      const hhN=document.getElementById('he-hh-n'), mmN=document.getElementById('he-mm-n');
      const hhE=document.getElementById('he-hh-e'), mmE=document.getElementById('he-mm-e');

      function ensureTim(){ try{ const r=JSON.parse(localStorage.getItem(KEY_TIM)||''); if(r&&r.m&&r.n&&r.e) return r; }catch(_){}
        localStorage.setItem(KEY_TIM, JSON.stringify({...DEF})); return {...DEF}; }
      function loadTim(){ try{ return JSON.parse(localStorage.getItem(KEY_TIM))||ensureTim(); }catch(_){ return ensureTim(); } }
      function saveTim(t){ localStorage.setItem(KEY_TIM, JSON.stringify(t)); }

      function loadSel(){ return localStorage.getItem(KEY_SEL)||"n"; }
      function saveSel(v){ localStorage.setItem(KEY_SEL, v); }

      buildHourRange(hhM,0,9);  buildMinutes5(mmM);
      buildHourRange(hhN,10,17); buildMinutes5(mmN);
      buildHourRange(hhE,18,23); buildMinutes5(mmE);

      function setOnly(which){
        m.checked=(which==="m"); n.checked=(which==="n"); e.checked=(which==="e");
        boxM.style.display=(which==="м")?"block":"none"; boxN.style.display=(which==="n")?"block":"none"; boxE.style.display=(which==="e")?"block":"none";
        saveSel(which);
      }
      function setFromStr(hhSel, mmSel, str){ const [H,M]=(str||"").split(":"); if(!setSel(hhSel,H)) hhSel.value=hhSel.options[0].value; if(!setSel(mmSel,M)) mmSel.value="00"; }
      function getStr(hhSel, mmSel){ return (hhSel.value||"00")+":"+(ммSel.value||"00"); }

      const which0=loadSel(); setOnly(which0); const t0=ensureTim();
      setFromStr(hhM,mmM,t0.m); setFromStr(hhN,mmN,t0.n); setFromStr(hhE,mmE,t0.e);

      [m,n,e].forEach(el=>el.addEventListener('change',()=>{ const which = el===m ? "m" : el===n ? "n" : "e"; setOnly(which); saveTim(loadTim()); }));
      [hhM,mmM,hhN,mmN,hhE,mmE].forEach(sel=> sel.addEventListener('change', ()=>{
        const which = localStorage.getItem(KEY_SEL)||"n"; const t=loadTim();
        if(which==="m") t.m = getStr(hhM,mmM); else if(which==="n") t.n = getStr(hhN,mmN); else t.e = getStr(hhE,mmE);
        saveTim(t);
      }));
    })();

    /* ===== Хитозан Плюс — 3 активни ===== */
    (function(){
      const DEF={m:"08:00", n:"12:00", e:"19:00"}; const KEY='bt_ch_tim_v234';
      const hhM=document.getElementById('ch-hh-m'), mmM=document.getElementById('ch-mm-m');
      const hhN=document.getElementById('ch-hh-n'), mmN=document.getElementById('ch-mm-n');
      const hhE=document.getElementById('ch-hh-e'), mmE=document.getElementById('ch-mm-e');
      buildHourRange(hhM,0,9);  buildMinutes5(mmM); buildHourRange(hhN,10,17); buildMinutes5(mmN); buildHourRange(hhE,18,23); buildMinutes5(mmE);
      function ensure(){ try{ const r=JSON.parse(localStorage.getItem(KEY)||''); if(r&&r.m&&r.n&&r.e) return r; }catch(_){}
        const def={...DEF}; localStorage.setItem(KEY, JSON.stringify(def)); return def; }
      function load(){ try{ return JSON.parse(localStorage.getItem(KEY))||ensure(); }catch(_){ return ensure(); } }
      function save(t){ localStorage.setItem(KEY, JSON.stringify(t)); }
      function setFromStr(hhSel, mmSel, str){ const [H,M]=(str||"").split(":"); if(!setSel(hhSel,H)) hhSel.value=hhSel.options[0].value; if(!setSel(mmSel,M)) mmSel.value="00"; }
      function getStr(hhSel, mmSel){ return (hhSel.value||"00")+":"+(mmSel.value||"00"); }
      const t0=ensure(); setFromStr(hhM,mmM,t0.m); setFromStr(hhN,mmN,t0.n); setFromStr(hhE,mmE,t0.e);
      function write(){ save({ m:getStr(hhM,mmM), n:getStr(hhN,mmN), e:getStr(hhE,mmE) }); }
      [hhM,mmM,hhN,mmN,hhE,mmE].forEach(sel=> sel.addEventListener('change', write)); write();
    })();

    /* ===== ProLact Slim+ — таблица + модал часовник ===== */
    (function(){
      const TABLE = document.getElementById('pl-table'); if(!TABLE) return;
      const KEY='bt_pl_grid_v234';
      const DEF_T1 = ["08:00","08:00","08:00","08:00","08:00","08:00","08:00"];
      const DEF_T2 = ["19:00","19:00","19:00","19:00","19:00","19:00","19:00"];

      function getTodayDow(){ return (new Date()).getDay(); }
      function load(){
        try{
          const r=JSON.parse(localStorage.getItem(KEY)||"");
          if(r && r.times && r.times.length===2 && r.flag && r.flag.length===2) return r;
        }catch(_){}
        const init = { times:[ [...DEF_T1], [...DEF_T2] ], flag:[ [0,0,0,0,0,0,0],[0,0,0,0,0,0,0] ], todayDow:getTodayDow(), activeDow:getTodayDow() };
        localStorage.setItem(KEY, JSON.stringify(init)); return init;
      }
      function save(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
      let state = load();

      function refreshDays(){
        const ths = TABLE.querySelectorAll('thead .pl-day');
        ths.forEach(th=>{
          const dow = Number(th.getAttribute('data-dow'));
          th.classList.toggle('today', dow===state.todayDow);
          th.classList.toggle('active', dow===state.activeDow);
        });
      }
      function iconCheck(){ return '<span class="pl-ico" title="Взето"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="#eafff3" stroke-width="3"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg></span>'; }
      function iconMute(){ return '<span class="pl-ico" title="Без звук"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="#ffcccc" stroke-width="2"><path d="M9 9l6 6M15 9l-6 6" stroke-linecap="round" stroke-linejoin="round"></path><path d="M3 9v6h4l5 4V5L7 9H3z" stroke-linecap="round" stroke-linejoin="round"></path></svg></span>'; }

      function renderTimes(){
        const seq=[1,2,3,4,5,6,0];
        for(let row=0; row<2; row++){
          for(let i=0;i<7;i++){
            const dow = seq[i], idx=(dow===0?6:dow-1);
            const cell = TABLE.querySelector('.pl-time-cell[data-row="'+row+'"][data-dow="'+dow+'"]');
            if(!cell) continue;
            cell.className='pl-time-cell'; // reset
            const timeStr = state.times[row][idx];
            const f = state.flag[row][idx]|0;
            if(f===0) cell.classList.add('green'); else if(f===1) cell.classList.add('yellow'); else cell.classList.add('red');
            cell.innerHTML = timeStr + (f===1 ? iconCheck() : f===2 ? iconMute() : '');
          }
        }
      }
      refreshDays(); renderTimes();

      TABLE.querySelectorAll('thead .pl-day').forEach(th=>{
        th.addEventListener('click', ()=>{ state.activeDow = Number(th.getAttribute('data-dow')); refreshDays(); save(state); });
      });

      // ===== Модал =====
      const Modal = document.getElementById('clk');
      const Card  = document.getElementById('clkCard');
      const face  = document.getElementById('clkFace');
      const ringH = document.getElementById('ringH');
      const ringM = document.getElementById('ringM');
      const handH = document.getElementById('handH');
      const handM = document.getElementById('handM');
      const read  = document.getElementById('clkRead');
      const btnGreen  = document.getElementById('btnGreen');
      const btnYellow = document.getElementById('btnYellow');
      const btnRed    = document.getElementById('btnRed');

      let selRow=0, selDow=1, activeCell=null;
      let H=8, M=0;
      let hourCycle=0;  // 0 => 1..12 ; 1 => 13..24
      let focusHM='H';

      // Позиции на етикетите по 12-секторния циферблат (k=0 е горе)
      const POS_12H = [12,1,2,3,4,5,6,7,8,9,10,11];
      const POS_24H = [24,13,14,15,16,17,18,19,20,21,22,23];

      function hToCycle(H){ return (H===0 || (H>=13 && H<=23)) ? 1 : 0; }
      function labelAt(k){ const arr=(hourCycle===0)?POS_12H:POS_24H; const raw=arr[k]; return (raw===24?0:raw); }
      function shownLabel(raw){ return (raw===24?24:raw); } // визуално показваме 24, не 0

      function hourIndexFor(H){
        if(hourCycle===0){
          const h12 = (H%12)||12; // 12 вместо 0
          return POS_12H.indexOf(h12);
        }else{
          const raw = (H===0)?24:H;
          return POS_24H.indexOf(raw);
        }
      }

      function updateRead(){ read.textContent = two(H)+":"+two(M); }
      function setHands(){
        const k = hourIndexFor(H); // 0..11
        const degH = (k + M/60)*30; // 12 сектора × 30°
        const degM = M*6;
        handH.style.transform = 'translate(-50%,-100%) rotate('+degH+'deg)';
        handM.style.transform = 'translate(-50%,-100%) rotate('+degM+'deg)';
      }

      function clear(node){ while(node.firstChild) node.removeChild(node.firstChild); }

      function buildHours(){
        clear(ringH);
        const arr=(hourCycle===0)?POS_12H:POS_24H;
        for(let k=0;k<12;k++){
          const raw=arr[k];
          const el=document.createElement('div'); el.className='clk-tick strong'; el.textContent = shownLabel(raw);
          const ang = (Math.PI*2)*(k/12) - Math.PI/2; // k=0 горе
          const R=84; const x=Math.cos(ang)*R, y=Math.sin(ang)*R;
          el.style.left='calc(50% + '+(x-12)+'px)'; el.style.top='calc(50% + '+(y-12)+'px)';
          const h24 = (raw===24?0:raw);
          if(h24===H) el.classList.add('sel');
          el.addEventListener('click', ()=>{ H=h24; updateRead(); setHands(); buildHours(); });
          ringH.appendChild(el);
        }
      }
      function buildMins(){
        clear(ringM);
        for(let m=0; m<60; m++){
          const el=document.createElement('div'); el.className='clk-tick'+((m%5===0)?' strong':'' );
          if(m%5===0){ el.textContent = m; } else { el.innerHTML='<div class="m-tick"></div>'; }
          const ang = (Math.PI*2) * (m/60) - Math.PI/2;
          const R=124; const x=Math.cos(ang)*R, y=Math.sin(ang)*R;
          el.style.left='calc(50% + '+(x-12)+'px)'; el.style.top='calc(50% + '+(y-12)+'px)';
          if(m===M) el.classList.add('sel');
          el.addEventListener('click', ()=>{ M=m; updateRead(); setHands(); buildMins(); });
          ringM.appendChild(el);
        }
      }

      function showClk(row,dow,initial, cell){
        if(activeCell) activeCell.classList.remove('sel');
        activeCell = cell; if(activeCell) activeCell.classList.add('sel');

        selRow=row; selDow=dow;
        state.activeDow = dow; save(state);

        const idx = (dow===0?6:dow-1);
        const [h,m] = (initial||state.times[row][idx]).split(':').map(x=>parseInt(x,10));
        H=isFinite(h)?h:8; M=isFinite(m)?m:0; focusHM='H';

        hourCycle = hToCycle(H);
        updateRead(); setHands(); buildHours(); buildMins();

        Modal.classList.add('show'); Modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; Card.focus();
      }
      function hideClk(){
        Modal.classList.remove('show'); Modal.setAttribute('aria-hidden','true'); document.body.style.overflow='';
        if(activeCell){ activeCell.classList.remove('sel'); activeCell=null; }
      }
      Modal.addEventListener('click',(e)=>{ if(e.target===Modal) hideClk(); });

      // Геометрия
      function ptAngle(cx,cy, x,y){ const dx=x-cx, dy=y-cy; let ang=Math.atan2(dy,dx); ang+=Math.PI/2; if(ang<0) ang+=Math.PI*2; return ang; }

      // Drag въртене
      let dragging=null; // 'H' | 'M'
      let prevAngle=null; let prevM=null;

      function handleMove(e){
        if(!dragging) return;
        const rect=face.getBoundingClientRect();
        const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
        const p=(e.touches?e.touches[0]:e);
        const ang=ptAngle(cx,cy,p.clientX,p.clientY);

        if(dragging==='H'){
          // смяна на цикъл при преминаване през горната граница (грубо)
          if(prevAngle!==null){
            const delta = ang - prevAngle;
            if(delta>Math.PI) { hourCycle = (hourCycle-1+2)%2; }
            else if(delta<-Math.PI) { hourCycle = (hourCycle+1)%2; }
          }
          prevAngle=ang;
          // позиция 0..11 (0 = горе)
          let k = Math.round((ang/(Math.PI*2))*12) % 12; if(k<0) k+=12;
          H = labelAt(k);
          updateRead(); setHands(); buildHours();
        }else{
          let v = Math.round((ang/(Math.PI*2))*60) % 60; if(v<0) v+=60;
          if(prevM!==null){
            const diff = v - prevM;
            if(diff>40){ // 59 -> 0 (въртене напред)
              H=(H+1)%24; const prevC=hourCycle; hourCycle=hToCycle(H); if(hourCycle!==prevC) buildHours();
            } else if(diff<-40){ // 0 -> 59 (въртене назад)
              H=(H-1+24)%24; const prevC=hourCycle; hourCycle=hToCycle(H); if(hourCycle!==prevC) buildHours();
            }
          }
          prevM=v; M=v; updateRead(); setHands(); buildMins();
        }
      }
      function startDrag(which, e){ dragging=which; prevAngle=null; prevM=null; handleMove(e); }
      function endDrag(){ dragging=null; }
      ringH.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startDrag('H',e); });
      ringM.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startDrag('M',e); });
      window.addEventListener('pointermove', handleMove, {passive:false});
      window.addEventListener('pointerup', endDrag);
      ringH.addEventListener('touchstart', (e)=>{ startDrag('H',e); }, {passive:false});
      ringM.addEventListener('touchstart', (e)=>{ startDrag('M',e); }, {passive:false});
      window.addEventListener('touchmove', handleMove, {passive:false});
      window.addEventListener('touchend', endDrag);

      // Център drag ↑/↓
      let centerDragging=false, startY=0;
      document.getElementById('clkRead').addEventListener('pointerdown', (e)=>{ centerDragging=true; startY=e.clientY||0; e.preventDefault(); });
      window.addEventListener('pointermove', (e)=>{
        if(!centerDragging) return;
        const dy = (e.clientY||0) - startY;
        if(Math.abs(dy)>=12){
          const step = (dy>0)?-1:1; startY = e.clientY||0;
          if(focusHM==='H'){
            H=(H+step+24)%24;
            const prevC=hourCycle; hourCycle=hToCycle(H); buildHours();
          }else{
            let oldM=M; M=(M+step+60)%60;
            if(oldM===59 && M===0){ H=(H+1)%24; const prevC=hourCycle; hourCycle=hToCycle(H); buildHours(); }
            if(oldM===0 && M===59){ H=(H-1+24)%24; const prevC=hourCycle; hourCycle=hToCycle(H); buildHours(); }
            buildMins();
          }
          updateRead(); setHands();
        }
      }, {passive:false});
      window.addEventListener('pointerup', ()=>{ centerDragging=false; });

      // Клавиатура
      document.getElementById('clkCard').addEventListener('keydown', (ev)=>{
        if(ev.key==='Escape'){ hideClk(); return; }
        if(ev.key==='ArrowUp' || ev.key==='ArrowDown'){
          ev.preventDefault();
          const dir = ev.key==='ArrowUp'?1:-1;
          const oldM=M;
          if(focusHM==='H'){
            H=(H+dir+24)%24; hourCycle=hToCycle(H); buildHours();
          }else{
            M=(M+dir+60)%60;
            if(oldM===59 && M===0){ H=(H+1)%24; hourCycle=hToCycle(H); buildHours(); }
            if(oldM===0 && M===59){ H=(H-1+24)%24; hourCycle=hToCycle(H); buildHours(); }
            buildMins();
          }
          updateRead(); setHands();
        }
      });

      // Отваряне при клик на клетка
      TABLE.querySelectorAll('.pl-time-cell').forEach(td=>{
        td.addEventListener('click', ()=>{
          const row = Number(td.getAttribute('data-row'));
          const dow = Number(td.getAttribute('data-dow'));
          showClk(row, dow, td.textContent.replace(/[^\d:]/g,'').trim(), td);
        });
      });

      function commitTime(flag){ // 0 green, 1 yellow, 2 red
        const idx = (selDow===0?6:selDow-1);
        state.times[selRow][idx] = two(H)+":"+two(M);
        state.flag[selRow][idx] = flag|0;
        save(state); renderTimes(); hideClk();
      }
      btnGreen.addEventListener('click', ()=>commitTime(0));
      btnYellow.addEventListener('click', ()=>commitTime(1));
      btnRed.addEventListener('click',   ()=>commitTime(2));

      // Инициална маркировка на „днес“
      (function markDays(){
        state.todayDow = (new Date()).getDay();
        if(typeof state.activeDow!=="number") state.activeDow = state.todayDow;
        save(state); refreshDays();
      })();
    })();
  </script>
</body>
</html>
