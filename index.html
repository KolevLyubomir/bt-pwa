<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Безопасно Тегло — Тракер (PWA)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#10b981">
  <link rel="icon" href="assets/icons/icon-192.png">
  <style>
    :root{--bg:#0b1215;--card:#111a1f;--text:#e6f2ef;--muted:#9fb4ad;--accent:#10b981;--danger:#ef4444;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:linear-gradient(180deg,#071013,#0b1215);color:var(--text)}
    header{position:sticky;top:0;background:#071013aa;backdrop-filter:blur(6px);border-bottom:1px solid #1e2b30;padding:12px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.3px}
    main{max-width:980px;margin:20px auto;padding:0 16px 48px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1e2b30;border-radius:16px;padding:16px;box-shadow:0 10px 30px #00000040}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,textarea,select,button{border-radius:12px;border:1px solid #254046;background:#0d171b;color:var(--text);padding:10px 12px;font-size:14px}
    button{background:var(--accent);border:none;color:#06241b;font-weight:700;cursor:pointer}
    button.ghost{background:#0d171b;color:var(--text);border:1px solid #2a3e41}
    button.danger{background:var(--danger);color:white}
    table{width:100%;border-collapse:collapse;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid #20343a;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .muted{color:var(--muted)} .right{text-align:right}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0a1e18;border:1px solid #20473e;color:#87f3c5;font-size:12px}
    .warn{background:#2a1616;border:1px solid #532b2b;color:#ffb4b4;padding:6px 10px;border-radius:10px}
    canvas{max-width:100%;height:340px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0d171b;border:1px solid #284647;border-radius:999px;padding:4px 10px;font-size:12px;margin:2px 6px 0 0}
    .chip input{accent-color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <img src="assets/icons/icon-192.png" width="28" height="28" alt="BT">
    <h1>Безопасно Тегло — Тракер</h1>
    <span class="pill" id="pwa-pill">PWA</span>
    <span id="file-warning" class="warn" style="display:none">За инсталация/офлайн отвори през http:// (локален сървър), не file://.</span>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 8px">Нов запис</h2>
      <div class="row">
        <div style="flex:1;min-width:160px">
          <label for="date">Дата</label>
          <input id="date" type="date">
        </div>
        <div style="flex:1;min-width:140px">
          <label for="weight">Тегло (kg)</label>
          <input id="weight" type="number" step="0.1" placeholder="напр. 86.4">
        </div>
        <div style="flex:1;min-width:140px">
          <label for="waist">Талия (cm)</label>
          <input id="waist" type="number" step="0.5" placeholder="по желание">
        </div>
      </div>
      <div style="margin-top:12px">
        <label for="notes">Бележки</label>
        <textarea id="notes" rows="2" placeholder="Как се чувстваш, тренировка, сън, хранене..."></textarea>
      </div>
      <div style="margin-top:12px">
        <span class="muted">Добавки (днес):</span>
        <div id="supplements" class="row" style="margin-top:6px"></div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="add">Добави запис</button>
        <button class="ghost" id="export">Експорт (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="ghost" id="importBtn">Импорт</button>
        <button class="danger" id="wipe">Изтрий всички</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Графика — Прогрес</h2>
      <div class="row">
        <div>
          <label for="span">Период</label>
          <select id="span">
            <option value="30">30 дни</option>
            <option value="90">90 дни</option>
            <option value="365">1 година</option>
            <option value="all">Всички</option>
          </select>
        </div>
        <div>
          <label for="metric">Метрика</label>
          <select id="metric">
            <option value="weight">Тегло</option>
            <option value="waist">Талия</option>
          </select>
        </div>
      </div>
      <canvas id="chart"></canvas>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">Инсталация като приложение</h3>
      <ol style="margin:6px 0 0 18px">
        <li>Пусни локален сървър (виж по-долу) и отвори адреса в Chrome.</li>
        <li>Меню ⋮ → <b>Install app</b> или <b>Add to Home screen</b>.</li>
      </ol>
      <p class="muted" style="margin:6px 0 0">При <code>file://</code> инсталацията е ограничена — нужно е <code>http://</code>.</p>
    </section>
  </main>

  <script>
    if (location.protocol === 'file:') {
      document.getElementById('file-warning').style.display='inline-block';
      document.getElementById('pwa-pill').textContent='PWA (ограничено)';
    }
  </script>
  <script src="chart.local.js"></script>
  <script>
    const SUPP_LIST = ["ProLact Slim+","Omni-Biotic Hetox Slim","Глюкоманан","Chitosan Plus","Берберин","EGCG","Entresto","Jardiance","Магнезий","Витамин D3","Омега-3"];
    const $ = sel => document.querySelector(sel);
    const dateInput = $("#date"), weightInput = $("#weight"), waistInput = $("#waist"), notesInput = $("#notes");
    const spanSelect = $("#span"), metricSelect = $("#metric");
    function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    dateInput.value = todayISO();
    const suppWrap = document.getElementById("supplements");
    SUPP_LIST.forEach(s => { const chip = document.createElement("label"); chip.className="chip"; chip.innerHTML = `<input type="checkbox" value="${s}"> ${s}`; suppWrap.appendChild(chip); });
    function getSupp(){ return [...suppWrap.querySelectorAll("input[type=checkbox]:checked")].map(i=>i.value); }
    function load(){ try{ return JSON.parse(localStorage.getItem("bt-progress")||"[]"); }catch{ return []; } }
    function save(d){ localStorage.setItem("bt-progress", JSON.stringify(d)); }
    function buildTableOnce(){
      if(document.getElementById("table")) return;
      const sec = document.createElement("section"); sec.className="card"; sec.innerHTML = '<h2 style="margin:0 0 8px">Записи</h2><table id="table"><thead><tr><th>Дата</th><th>Тегло</th><th>Талия</th><th>Добавки</th><th>Бележки</th><th class="right">Действия</th></tr></thead><tbody></tbody></table>';
      document.querySelector("main").appendChild(sec);
    }
    function renderTable(){
      buildTableOnce();
      const tbody = document.querySelector("#table tbody");
      tbody.innerHTML="";
      const data=load().sort((a,b)=>a.date.localeCompare(b.date));
      data.forEach((rec, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${rec.date}</td><td>${rec.weight??""}</td><td>${rec.waist??""}</td>
        <td class="muted">${(rec.supplements||[]).join(", ")}</td><td>${rec.notes||""}</td>
        <td class="right"><button class="ghost" data-edit="${idx}">Редакция</button>
        <button class="danger" data-del="${idx}">Изтрий</button></td>`;
        tbody.appendChild(tr);
      });
    }
    function renderChart(){
      const all = load().sort((a,b)=>a.date.localeCompare(b.date));
      const span = spanSelect.value;
      const cutoff = new Date(); if(span!=="all"){ cutoff.setDate(cutoff.getDate()-parseInt(span,10)); }
      const filtered = (span==="all"? all : all.filter(r=> new Date(r.date)>=cutoff ));
      const metric = metricSelect.value;
      const labels = filtered.map(r=>r.date);
      const values = filtered.map(r=> (metric==='weight'? Number(r.weight): Number(r.waist)) || null);
      const ctx = document.getElementById("chart").getContext("2d");
      const mini = new MiniChart(ctx); mini.labels=labels; mini.data=values; mini.render();
    }
    document.getElementById("add").addEventListener("click", ()=>{
      const rec = { date: dateInput.value||todayISO(), weight: weightInput.value?Number(weightInput.value):null, waist: waistInput.value?Number(waistInput.value):null, notes: notesInput.value.trim(), supplements: getSupp() };
      const data = load(); const i = data.findIndex(r=>r.date===rec.date); if(i>=0) data[i]=rec; else data.push(rec);
      save(data); renderTable(); renderChart();
      weightInput.value=""; waistInput.value=""; notesInput.value=""; document.querySelectorAll("#supplements input[type=checkbox]").forEach(cb=>cb.checked=false);
    });
    document.addEventListener("click",(e)=>{
      const t=e.target; if(!t.closest("#table")) return; const data=load();
      if(t.matches("button[data-del]")){ const i=Number(t.getAttribute("data-del")); data.splice(i,1); save(data); renderTable(); renderChart(); }
      else if(t.matches("button[data-edit]")){ const i=Number(t.getAttribute("data-edit")); const r=data[i];
        dateInput.value=r.date; weightInput.value=r.weight??""; waistInput.value=r.waist??""; notesInput.value=r.notes??"";
        document.querySelectorAll("#supplements input[type=checkbox]").forEach(cb=>cb.checked = r.supplements?.includes(cb.value));
        window.scrollTo({top:0, behavior:"smooth"});
      }
    });
    document.getElementById("export").addEventListener("click",()=>{
      const blob = new Blob([JSON.stringify(load(),null,2)], {type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bt-progress-export.json"; a.click(); URL.revokeObjectURL(a.href);
    });
    document.getElementById("importBtn").addEventListener("click",()=>document.getElementById("importFile").click());
    document.getElementById("importFile").addEventListener("change",(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(Array.isArray(data)){ save(data); renderTable(); renderChart(); } }catch{} }; r.readAsText(f); });
    if("serviceWorker" in navigator && location.protocol!=='file:'){ window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js")); }
    renderTable(); renderChart();
  </script>
</body>
</html>
