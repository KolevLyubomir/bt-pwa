<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>БТ App 3 — v2.35</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <meta name="theme-color" content="#0b1215"/>
  <link rel="manifest" href="manifest.webmanifest?v=1.39"/>
  <link rel="icon" href="assets/icons/icon-192.png?v=1.39"/>

  <style>
    :root{
      --bg:#0b1215; --card:#111a1f; --text:#e6f2ef; --muted:#9fb4ad;
      --accent:#10b981; --border:#1e2b30; --has:#c7f5df; --danger:#ef4444;
      --chart-label:15px; --chart-values:15px;
      --line-green:#87f3c5; --line-orange:#f59e0b; --line-neutral:#2dd4bf;
      --ctl-h:42px; --lbl-h:16px; --maxw:980px;
      --pill-w:168px;
      --wk-font:13px;
      --wk-pad:6px;
      --wk-head-pad:6px;
      --wk-weekend:#cfe7da;
      --wk-head-border:#6f8e94;
      --wk-head-dotted:#8ca3a8;
      --modal-backdrop:rgba(0,0,0,.55);
      --modal-card:#0e1619;
      --orange:#f59e0b;
      --green:#22c55e;
      --yellow:#fbbf24;
      --red:#ef4444;
      --muted2:#b6c8c2;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,"Noto Sans",sans-serif
    }

    .topbar-wrap{ position:sticky; top:0; z-index:10; background:#0b1215; border-bottom:1px solid var(--border); }
    .topbar{
      max-width:var(--maxw); margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .topbar .brand{ display:flex; align-items:center; gap:10px; font-weight:800 }
    .topbar .brand img{ width:24px; height:24px }
    .topbar .title{ font-size:18px; font-weight:800 }
    .topbar .badge{
      font-size:12px; font-weight:800; color:#06241b;
      background:linear-gradient(90deg,#22c55e,#14b8a6); padding:2px 8px; border-radius:10px;
    }

    .tabs-wrap{ background:#0b1215; border-bottom:1px solid var(--border); }
    .tabs{ max-width:var(--maxw); margin:0 auto; padding:10px 16px; display:flex; gap:8px; }
    .tab-btn{
      -webkit-tap-highlight-color: transparent;
      appearance:none; border:1px solid var(--border); background:#0d171b; color:#e6f2ef;
      padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:800; font-size:16px; transition:.15s ease;
    }
    .tab-btn[aria-selected="true"]{
      color:#06241b; border-color:transparent; background:linear-gradient(90deg,#22c55e,#14b8a6);
    }

    main{ max-width:var(--maxw); margin:20px auto; padding:0 16px 40px; display:grid; gap:16px; align-content:start }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px }

    .inputs-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .spacer{ flex:1 1 auto }
    .field{ display:flex; flex-direction:column; justify-content:flex-end }
    .lbl{ height:var(--lbl-h); line-height:var(--lbl-h); font-size:12px; color:var(--muted); margin:0 0 6px 0 }
    .ctl{ display:flex; align-items:center }

    input,select,button{
      background:#0d171b; border:1px solid #254046; color:var(--text);
      border-radius:10px; padding:8px 10px; font-size:14px; height:var(--ctl-h)
    }
    input[type="number"]{ appearance:textfield; -webkit-appearance:none; -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }

    button{ cursor:pointer } button.primary{ background:var(--accent); border-color:var(--accent); color:#06241b; font-weight:700 }

    .field.date{ width:120px }
    .field.weight input{ font-weight:700; font-size:18px; width:9ch }
    .field.weight input:focus{ outline:2px solid #2b6e66 }

    .bt-only{ display:flex; align-items:center; justify-content:center; width:var(--ctl-h); height:var(--ctl-h);
      border:1px solid #334a4f; background:#0d171b; border-radius:10px }
    .bt-only input{ width:16px; height:16px; margin:0 }

    table{ width:100%; border-collapse:collapse }
    colgroup col.date{ width:70px } colgroup col.w{ width:70px } colgroup col.act{ width:auto }
    th,td{ padding:3px 4px; border-bottom:1px solid #20343a; font-size:13px; line-height:1.15; white-space:nowrap; text-align:left; vertical-align:middle }
    th{ color:var(--muted); font-weight:600 }
    th.actions,td.actions{ padding-left:72px }

    .wCell{ text-align:right }
    .wSmall{ font-size:.6em; opacity:.95; margin-left:1px }

    .actions{ display:inline-flex; gap:6px; align-items:center; }
    .icon{ display:inline-flex; align-items:center; justify-content:center; border:1px solid #2a3e41; background:#0d171b; border-radius:8px; padding:4px 6px; color:#fff; height:var(--ctl-h) }
    .icon svg{ width:16px; height:16px; stroke:currentColor; stroke-linecap:round; stroke-linejoin:round }
    .icon.danger{ border-color:#3a2222; background:#161112; color:#ffd5d5 }

    .recbar{ display:flex; align-items:center; gap:8px; margin:8px 0; flex-wrap:wrap }
    .pager{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-top:8px }
    .pager .info{ color:var(--muted); font-size:12px; margin-right:8px }
    .pager button{ background:#0d171b; border:1px solid #2a3e41; color:#fff; padding:4px 8px; border-radius:8px; font-size:13px }
    .pager button.active{ background:var(--accent); color:#06241b; border-color:var(--accent) }

    canvas.bt-chart{ width:100%; height:360px; display:block; margin-top:8px; background:#0b1215; border:1px solid #1a2a2f; border-radius:8px }

    .date-wrap{ position:relative } #dateText[readonly]{ cursor:pointer }
    .cal{ position:absolute; z-index:10; top:calc(var(--ctl-h) + 6px); left:0; background:#0e1518; border:1px solid #20343a; border-radius:12px;
      box-shadow:0 8px 30px rgba(0,0,0,.35); padding:10px; width:auto; display:none }
    .cal.show{ display:block }
    .cal .cal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:8px }
    .cal .cal-title{ font-weight:700; text-transform:capitalize }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,36px); gap:6px; justify-content:center }
    .cal .dow{ color:var(--muted); font-size:11px; text-align:center; line-height:36px; height:36px }
    .cal .day{ width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid transparent }
    .cal .day:hover{ border-color:#27454a }
    .cal .day.disabled{ opacity:.35; pointer-events:none }
    .cal .day.has{ background:var(--has); color:#092218 }
    .cal .day.today{ outline:1px dashed #5b8f98 }
    .cal .day.sel{ background:#84e9c2; color:#041915; font-weight:700 }

    .tabpanel{ display:none }
    .tabpanel[aria-hidden="false"]{ display:block }

    .prog-row{ display:flex; align-items:flex-start; gap:12px; flex-wrap:wrap; margin:8px 0 0 }
    .prog-head{ display:flex; align-items:center; gap:12px; margin-bottom:6px }
    .prod-img{ width:76px; height:76px; object-fit:contain; border-radius:12px; background:#0d171b; border:1px solid #254046 }
    .prog-cap{ font-weight:700 }
    .prog-sep{ border:0; border-top:1px solid var(--border); margin:14px 0 }

    .wk-table-wrap{ overflow:auto; }
    .wk{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .wk th, .wk td{
      font-size:var(--wk-font); font-weight:600; white-space:nowrap; text-align:center;
      padding:var(--wk-pad);
      border-bottom:1px solid #20343a;
    }
    .wk th{
      color:var(--muted2);
      border-top:1px solid #20343a; background:#0d171b;
      position:relative;
      padding:var(--wk-head-pad);
    }
    .wk th .h{
      display:inline-block; padding:2px 6px; border-radius:8px; border:1px solid transparent;
    }
    .wk th .h.weekend{ color:var(--wk-weekend); }
    .wk th .h.today{ border:1px dashed var(--wk-head-dotted); }
    .wk th .h.active{ background:rgba(245,158,11,.18); outline:1px solid var(--orange); color:#fff; }
    .wk .tcell{
      display:flex; align-items:center; justify-content:center; gap:6px;
      padding:6px 2px; cursor:pointer; user-select:none; font-weight:600;
    }
    .wk .tcell.editing{ outline:1px solid var(--orange); border-radius:8px; }
    @media (max-width: 420px){
      :root{ --wk-font:12px; --wk-pad:4px; --wk-head-pad:4px; }
    }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:30; background:var(--modal-backdrop); }
    .modal.show{ display:flex; }
    .modal-card{
      width:min(94vw, 360px); background:var(--modal-card); border:1px solid #1e2b30; border-radius:14px; padding:12px 12px 8px;
      box-shadow:0 12px 50px rgba(0,0,0,.45);
    }
    .clock-top{ display:flex; align-items:center; justify-content:center; margin-bottom:6px; }
    .clock-val{
      display:inline-flex; gap:6px; align-items:center; justify-content:center;
      font-weight:800; font-size:22px; background:#0b1417; border:1px solid #20343a; border-radius:10px; padding:6px 10px; min-width:112px;
    }
    .clock-val span{ display:inline-block; min-width:2ch; text-align:center; }
    .clock-canvas-wrap{ display:flex; align-items:center; justify-content:center; }
    .clock-actions{ display:flex; align-items:center; justify-content:center; gap:10px; margin-top:8px; }
    .btn-round{
      width:38px; height:38px; border-radius:999px; border:1px solid #20343a; background:#0d171b; display:inline-flex; align-items:center; justify-content:center;
    }
    .btn-round.green{ background:var(--green); border-color:var(--green); color:#032514; }
    .btn-round.yellow{ background:var(--yellow); border-color:var(--yellow); color:#3a2b03; }
    .btn-round.red{ background:var(--red); border-color:var(--red); color:#260808; }
    .btn-round svg{ width:18px; height:18px; stroke:currentColor; stroke-width:2; fill:none; }

    .prolact-pills{ display:none !important; }
  </style>
</head>
<body>

  <div class="topbar-wrap">
    <div class="topbar">
      <div class="brand">
        <img src="assets/icons/icon-192.png?v=1.39" alt="BT"/>
        <span class="title">BT&nbsp;Безопасно Тегло —</span>
        <span class="badge">v2.35</span>
      </div>
    </div>
  </div>

  <div class="tabs-wrap" role="navigation" aria-label="Навигация">
    <div class="tabs" role="tablist">
      <button id="tab-data" class="tab-btn" role="tab" aria-controls="panel-data" aria-selected="true">Данни</button>
      <button id="tab-program" class="tab-btn" role="tab" aria-controls="panel-program" aria-selected="false">Програма</button>
    </div>
  </div>

  <!-- ДАННИ -->
  <div id="panel-data" class="tabpanel" role="tabpanel" aria-labelledby="tab-data" aria-hidden="false">
    <main>
      <section class="card">
        <h2 style="margin:0 0 10px">Запис</h2>

        <div class="inputs-row">
          <div class="inputs-row" style="gap:10px">
            <div class="field date">
              <div class="lbl">Дата</div>
              <div class="ctl date-wrap">
                <input id="dateText" type="text" readonly placeholder="ДД.ММ.ГГ"/>
                <div id="cal" class="cal" role="dialog" aria-label="Календар"></div>
              </div>
            </div>

            <div class="field weight">
              <div class="lbl">Тегло (kg)</div>
              <div class="ctl">
                <input id="weight" type="number" step="0.1" min="0.1" placeholder="107.7"/>
              </div>
            </div>

            <div class="field" style="min-width:var(--ctl-h)">
              <div class="lbl"></div>
              <label class="bt-only" title="Маркиран като БТ"><input id="btFlag" type="checkbox" checked/></label>
            </div>

            <div class="field" style="min-width:100px">
              <div class="lbl"></div>
              <button id="addBtn" class="primary" type="button" style="height:var(--ctl-h); min-width:100px">Добави</button>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="inputs-row" style="gap:8px">
            <div class="field">
              <div class="lbl"></div>
              <button id="exportBtn" class="icon" title="Експорт" aria-label="Експорт" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 16V4M12 4l-4 4M12 4l4 4"></path><path d="M4 20h16"></path>
                </svg>
              </button>
            </div>
            <div class="field">
              <div class="lbl"></div>
              <input id="importFile" type="file" accept="application/json" style="display:none"/>
              <button id="importBtn" class="icon" title="Импорт" aria-label="Импорт" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 8v12M12 20l-4-4M12 20l4-4"></path><path d="M4 4h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 style="margin:0 0 10px">Графика</h2>
        <div class="inputs-row">
          <select id="aggSel" title="Агрегация">
            <option value="daily" selected>Дневни</option>
            <option value="weekly">Седмични</option>
            <option value="monthly">Месечни</option>
          </select>
        </div>
        <canvas id="chart" class="bt-chart"></canvas>
      </section>

      <section class="card">
        <h2 style="margin:0">Записи</h2>

        <div class="recbar">
          <label for="pageSize" style="font-size:12px;color:var(--muted)">На страница:</label>
          <select id="pageSize">
            <option value="7">7 (1 сед.)</option>
            <option value="14">14 (2 сед.)</option>
            <option value="28" selected>28 (~1 мес.)</option>
            <option value="84">84 (~3 мес.)</option>
            <option value="112">112 (~4 мес.)</option>
            <option value="168">168 (~6 мес.)</option>
            <option value="336">336 (~12 мес.)</option>
            <option value="all">Всички</option>
          </select>
        </div>

        <div class="pager" id="pagerTop"></div>
        <table id="tbl">
          <colgroup><col class="date"><col class="w"><col class="act"></colgroup>
          <thead id="theadTop">
            <tr>
              <th class="date">Дата</th>
              <th class="w">Тегло (kg)</th>
              <th class="actions">Действия</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="tfootBottom">
            <tr>
              <th class="date">Дата</th>
              <th class="w">Тегло (kg)</th>
              <th class="actions">Действия</th>
            </tr>
          </tfoot>
        </table>
        <div class="pager" id="pagerBottom"></div>
      </section>
    </main>
  </div>

  <!-- ПРОГРАМА -->
  <div id="panel-program" class="tabpanel" role="tabpanel" aria-labelledby="tab-program" aria-hidden="true">
    <main>
      <section class="card" id="pkg-core">
        <h2 style="margin:0 0 10px">Основен пакет</h2>

        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/prolact.webp" alt="ProLact Slim+"/>
            <span class="prog-cap">ProLact Slim+</span>
          </div>

          <div class="wk-table-wrap">
            <table class="wk" id="pl-wk">
              <thead><tr id="pl-wk-head"></tr></thead>
              <tbody>
                <tr id="pl-wk-row1" class="tight"></tr>
                <tr id="pl-wk-row2" class="tight"></tr>
              </tbody>
            </table>
          </div>

          <div class="prolact-pills">
            <!-- скрито старо мини-UI -->
          </div>
        </div>

        <hr class="prog-sep"/>

        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/omni-hetox-light.png" alt="OMNi-Biotic HETOX light"/>
            <span class="prog-cap">OMNi-Biotic HETOX light</span>
          </div>
          <div class="prog-row" role="group" aria-label="HETOX — 1 от 3">
            <span class="prog-pill">
              <label><input type="checkbox" id="he-m"> Сутрин</label>
              <div id="he-tp-m" class="time-wrap" style="display:none">
                <div class="time-row">
                  <select id="he-hh-m"></select><span class="colon">:</span><select id="he-mm-m"></select>
                </div>
              </div>
            </span>
            <span class="prog-pill">
              <label><input type="checkbox" id="he-n" checked> Обед</label>
              <div id="he-tp-n" class="time-wrap" style="display:block">
                <div class="time-row">
                  <select id="he-hh-n"></select><span class="colon">:</span><select id="he-mm-n"></select>
                </div>
              </div>
            </span>
            <span class="prog-pill">
              <label><input type="checkbox" id="he-e"> Вечер</label>
              <div id="he-tp-e" class="time-wrap" style="display:none">
                <div class="time-row">
                  <select id="he-hh-e"></select><span class="colon">:</span><select id="he-mm-e"></select>
                </div>
              </div>
            </span>
          </div>
        </div>

        <hr class="prog-sep"/>

        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/chitosan-plus.webp" alt="Fortex Хитозан Плюс"/>
            <span class="prog-cap">Fortex Хитозан Плюс</span>
          </div>
          <div class="prog-row" role="group" aria-label="Хитозан Плюс">
            <span class="prog-pill">
              <label><input type="checkbox" id="ch-m" checked disabled> Сутрин</label>
              <div id="ch-tp-m" class="time-wrap">
                <div class="time-row">
                  <select id="ch-hh-m"></select><span class="colon">:</span><select id="ch-mm-m"></select>
                </div>
              </div>
            </span>
            <span class="prog-pill">
              <label><input type="checkbox" id="ch-n" checked disabled> Обед</label>
              <div id="ch-tp-n" class="time-wrap">
                <div class="time-row">
                  <select id="ch-hh-n"></select><span class="colon">:</span><select id="ch-mm-n"></select>
                </div>
              </div>
            </span>
            <span class="prog-pill">
              <label><input type="checkbox" id="ch-e" checked disabled> Вечер</label>
              <div id="ch-tp-e" class="time-wrap">
                <div class="time-row">
                  <select id="ch-hh-e"></select><span class="colon">:</span><select id="ch-mm-e"></select>
                </div>
              </div>
            </span>
          </div>
        </div>
      </section>

      <section class="card" id="pkg-extra">
        <h2 style="margin:0 0 10px">Допълнителен пакет</h2>
        <ul style="margin:8px 0 0; padding-left:1rem; line-height:1.5">
          <li><strong>Берберин 500–600 mg</strong> — марка по избор</li>
          <li><strong>Глюкоманан</strong> (<em>NOW Foods</em>)</li>
          <li><strong>EGCg</strong> — екстракт от зелен чай (<em>NOW Foods</em>)</li>
        </ul>
      </section>

      <section class="card" id="pkg-personal">
        <h2 style="margin:0 0 10px">Личен режим</h2>
        <p style="margin:0 0 8px; color:#9fb4ad">
          Тук включваш други добавки/витамини/медикаменти извън основната програма.
        </p>
        <ul style="margin:8px 0 0; padding-left:1rem; line-height:1.5">
          <li><em>Пример:</em> Магнезий бисглицинат</li>
          <li><em>Пример:</em> Витамин D3 + K2</li>
          <li><em>Пример:</em> Омега-3</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- МОДАЛ ЧАСОВНИК -->
  <div id="timeModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-label="Избор на време">
      <div class="clock-top">
        <div class="clock-val" id="clockVal">
          <span id="cvHH">08</span><span>:</span><span id="cvMM">00</span>
        </div>
      </div>
      <div class="clock-canvas-wrap">
        <canvas id="clock" width="300" height="300" style="width:300px;height:300px"></canvas>
      </div>
      <div class="clock-actions">
        <button class="btn-round green" id="clkOk" title="OK">
          <svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>
        </button>
        <button class="btn-round yellow" id="clkTake" title="Взето">
          <svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>
        </button>
        <button class="btn-round red" id="clkMute" title="Без звук">
          <svg viewBox="0 0 24 24"><path d="M9 9v6h4l5 4V5l-5 4H9zM3 3l18 18"/></svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    "use strict";
    window.__BT_VER = '2.35';

    /* ===== табове ===== */
    (function(){
      const tabs = [
        {btn: document.getElementById('tab-data'), panel: document.getElementById('panel-data')},
        {btn: document.getElementById('tab-program'), panel: document.getElementById('panel-program')}
      ];
      function select(i){
        tabs.forEach((t,idx)=>{
          const sel = idx===i;
          t.btn.setAttribute('aria-selected', String(sel));
          t.panel.setAttribute('aria-hidden', String(!sel));
        });
        try{ localStorage.setItem('bt_active_tab_v218', String(i)); }catch(_){}
      }
      tabs.forEach((t,idx)=> t.btn.addEventListener('click', ()=>select(idx)));
      try{
        const saved = parseInt(localStorage.getItem('bt_active_tab_v218'),10);
        if(Number.isInteger(saved) && saved>=0 && saved<tabs.length) select(saved); else select(0);
      }catch(_){ select(0); }
    })();

    /* ===== помощни за дати/записи/графика (както в 2.34) ===== */
    function todayISO(){ var d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    var TODAY = todayISO();
    function isoToBG_YY(iso){ if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return ""; var y=iso.slice(0,4), m=iso.slice(5,7), d=iso.slice(8,10); return d+"."+m+"."+y.slice(2); }
    function bgToISO_any(bg){
      var m2=bg.match(/^(\d{2})\.(\d{2})\.(\d{2})$/); if(m2) return "20"+m2[3]+"-"+m2[2]+"-"+m2[1];
      var m4=bg.match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(m4) return m4[3]+"-"+m4[2]+"-"+m4[1];
      return "";
    }

    var KEY="bt-progress";
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_) { return []; } }
    function save(a){ localStorage.setItem(KEY, JSON.stringify(a)); }
    function sortDesc(a){ return a.slice().sort((x,y)=>y.date.localeCompare(x.date)); }
    function sortAsc(a){ return a.slice().sort((x,y)=>x.date.localeCompare(y.date)); }

    var dateText=document.getElementById("dateText"), calEl=document.getElementById("cal"),
        weight=document.getElementById("weight"), addBtn=document.getElementById("addBtn"),
        tb=document.querySelector("#tbl tbody"), pagerTop=document.getElementById("pagerTop"),
        pagerBottom=document.getElementById("pagerBottom"), aggSel=document.getElementById("aggSel"),
        chart=document.getElementById("chart"), pageSizeSel=document.getElementById("pageSize"),
        exportBtn=document.getElementById("exportBtn"), importBtn=document.getElementById("importBtn"),
        importFile=document.getElementById("importFile"), btFlag=document.getElementById("btFlag");

    var currentISO=localStorage.getItem("bt-last-date")||TODAY;
    if(!/^\d{4}-\d{2}-\d{2}$/.test(currentISO)) currentISO=TODAY;
    dateText.value=isoToBG_YY(currentISO);
    function prefillFor(iso){
      var data=load(); var rec=data.find(r=>r.date===iso);
      if(rec){
        weight.value=(typeof rec.weight==="number")?rec.weight:"";
        btFlag.checked = (rec.bt!==false);
        return;
      }
      var prev=sortDesc(data).find(r=>r.date<iso);
      weight.value=prev?prev.weight:"";
      btFlag.checked=true;
    }
    prefillFor(currentISO);

    var calYear=+currentISO.slice(0,4), calMonth=+currentISO.slice(5,7);
    function ymd(y,m,d){ return String(y).padStart(4,"0")+"-"+String(m).padStart(2,"0")+"-"+String(d).padStart(2,"0"); }
    function hasDataSet(){ var s=new Set(); load().forEach(r=>s.add(r.date)); return s; }
    function renderCalendar(){
      var set=hasDataSet(), y=calYear, m=calMonth;
      var first=new Date(Date.UTC(y,m-1,1));
      var startDow=(first.getUTCDay()+6)%7;
      var daysInMonth=new Date(Date.UTC(y,m,0)).getUTCDate();
      var title=new Date(Date.UTC(y,m-1,1)).toLocaleDateString("bg-BG",{year:"numeric",month:"long"});
      var html='<div class="cal-head"><button id="calPrev" type="button">←</button><div class="cal-title">'+title+'</div><button id="calNext" type="button">→</button></div>';
      html+='<div class="cal-grid">';
      ["Пн","Вт","Ср","Чт","Пт","Сб","Нд"].forEach(x=>html+='<div class="dow">'+x+'</div>');
      for(var i=0;i<startDow;i++) html+='<div class="day disabled"></div>';
      for(var d=1; d<=daysInMonth; d++){
        var iso=ymd(y,m,d), future=(iso>TODAY);
        var cls=["day"]; if(iso===currentISO) cls.push("sel"); if(iso===TODAY) cls.push("today");
        if(set.has(iso)) cls.push("has"); if(future) cls.push("disabled");
        html+='<button type="button" class="'+cls.join(" ")+'" data-iso="'+iso+'">'+d+'</button>';
      }
      html+='</div>';
      calEl.innerHTML=html;
    }
    function showCalendar(){ renderCalendar(); calEl.classList.add("show"); }
    function hideCalendar(){ calEl.classList.remove("show"); }
    dateText.addEventListener("click",(e)=>{ e.stopPropagation(); calYear=+currentISO.slice(0,4); calMonth=+currentISO.slice(5,7); showCalendar(); });
    calEl.addEventListener("click",(e)=>{
      e.stopPropagation(); var t=e.target;
      if(t && t.id==="calPrev"){ calMonth--; if(calMonth===0){calMonth=12; calYear--; } renderCalendar(); return; }
      if(t && t.id==="calNext"){ calMonth++; if(calMonth===13){calMonth=1; calYear++; } renderCalendar(); return; }
      var btn=t.closest && t.closest(".day[data-iso]");
      if(btn){ var iso=btn.getAttribute("data-iso"); if(iso<=TODAY){ currentISO=iso; localStorage.setItem("bt-last-date",iso); dateText.value=isoToBG_YY(iso); prefillFor(iso); hideCalendar(); } }
    });
    document.addEventListener("click",(e)=>{ if(!calEl.contains(e.target) && e.target!==dateText) hideCalendar(); });

    addBtn.addEventListener("click", ()=>{
      var iso=currentISO;
      if(iso>TODAY){ alert("Датата е в бъдещето."); return; }
      var w=Number(weight.value); if(!(w>0)){ alert("Въведи тегло > 0."); return; }

      var data=load(), prev=sortDesc(data).find(r=>r.date<iso), next=sortAsc(data).find(r=>r.date>iso);
      var ok=true, msgs=[];
      if(prev){ var minP=prev.weight*0.95, maxP=prev.weight*1.05; if(w<minP||w>maxP){ ok=false; msgs.push("спрямо "+isoToBG_YY(prev.date)+": "+minP.toFixed(1)+"–"+maxP.toFixed(1)+" kg"); } }
      if(next){ var minN=next.weight*0.95, maxN=next.weight*1.05; if(w<minN||w>maxN){ ok=false; msgs.push("спрямо "+isoToBG_YY(next.date)+": "+minN.toFixed(1)+"–"+maxN.toFixed(1)+" kg"); } }
      if(!ok){ alert("Извън допустимите граници:\n"+msgs.join("\n")); return; }

      var idx=data.findIndex(r=>r.date===iso);
      var rec={date: iso, weight: w, bt: !!btFlag.checked};
      if(idx>=0) data[idx]=rec; else data.push(rec);
      save(data);
      renderTable(); renderChart();
    });

    var pageSizeSel=document.getElementById("pageSize");
    var PAGE_SIZES=[7,14,28,84,112,168,336,"all"];
    function getPS(){ var v=localStorage.getItem("bt-page-size"); if(v==="all") return "all"; var n=Number(v); return (PAGE_SIZES.indexOf(n)>=0)?n:28; }
    function setPS(v){ localStorage.setItem("bt-page-size",v); }
    var pageSize=getPS(), currentPage=1;
    (function(){ var v=(pageSize==="all")?"all":String(pageSize); var opt=document.querySelector('#pageSize option[value="'+v+'"]'); if(opt) pageSizeSel.value=v; })();
    pageSizeSel.addEventListener("change", ()=>{ var v=pageSizeSel.value; pageSize=(v==="all")?"all":Number(v); setPS(v); currentPage=1; renderTable(); renderChart(); });

    var __currentSlice=[];

    function buildPager(container,total,eff){
      container.innerHTML="";
      var start=(currentPage-1)*eff, from=total?start+1:0, to=Math.min(start+eff,total);
      var info=document.createElement("span"); info.className="info"; info.textContent=from+"-"+to+" от "+total; container.appendChild(info);

      var pagesTotal=Math.max(1,Math.ceil(total/eff)), frag=document.createDocumentFragment();
      function pageBtn(n,active){ var b=document.createElement("button"); b.textContent=String(n); if(active) b.className="active";
        b.addEventListener("click",()=>{currentPage=n; renderTable(); renderChart();}); return b; }
      if(pagesTotal>1 && currentPage>1){ var prev=document.createElement("button"); prev.textContent="←";
        prev.addEventListener("click",()=>{currentPage=Math.max(1,currentPage-1); renderTable(); renderChart();}); frag.appendChild(prev); }
      if(pagesTotal<=5){ for(var p=1;p<=pagesTotal;p++) frag.appendChild(pageBtn(p,p===currentPage)); }
      else{ var sp=currentPage-2; if(sp<1) sp=1; if(sp+4>pagesTotal) sp=pagesTotal-4; for(var pp=sp; pp<=sp+4; pp++) frag.appendChild(pageBtn(pp,pp===currentPage)); }
      if(pagesTotal>1 && currentPage<pagesTotal){ var next=document.createElement("button"); next.textContent="→";
        next.addEventListener("click",()=>{currentPage=Math.min(pagesTotal,currentPage+1); renderTable(); renderChart();}); frag.appendChild(next); }
      container.appendChild(frag);
    }

    function renderTable(){
      var all=sortDesc(load()), total=all.length, eff=(pageSize==="all")?(total||1):pageSize;
      var pages=Math.max(1,Math.ceil(total/eff)); if(currentPage>pages) currentPage=pages;
      var start=(currentPage-1)*eff, slice=all.slice(start,start+eff); __currentSlice=slice.slice();

      buildPager(pagerTop,total,eff);
      tb.innerHTML="";
      slice.forEach((r)=>{
        var tr=document.createElement("tr");
        var s=Number(r.weight).toFixed(1).split(".");
        tr.innerHTML =
          '<td class="date">'+isoToBG_YY(r.date)+'</td>'+
          '<td class="w wCell"><span class="wInt">'+s[0]+'</span><span class="wSmall">.'+s[1]+'</span></td>'+
          '<td class="actions">'+
            '<div class="actions">'+
              '<button class="icon" title="Редакция" data-edit="'+r.date+'" aria-label="Редакция" type="button">'+
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21l3-1 11-11-2-2L4 18z"></path><path d="M14 5l5 5"></path></svg>'+
              '</button>'+
              '<button class="icon danger" title="Изтрий" data-del="'+r.date+'" aria-label="Изтрий" type="button">'+
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"></path></svg>'+
              '</button>'+
            '</div>'+
          '</td>';
        tb.appendChild(tr);
      });
      Array.from(tb.querySelectorAll('button[data-edit]')).forEach((b)=>{
        b.addEventListener("click",()=>{
          var iso=b.getAttribute("data-edit"); var rec=load().find(x=>x.date===iso);
          if(rec){
            currentISO=iso; localStorage.setItem("bt-last-date",iso);
            dateText.value=isoToBG_YY(iso); prefillFor(iso);
            window.scrollTo({top:0,behavior:"smooth"});
          }
        });
      });
      Array.from(tb.querySelectorAll('button[data-del]')).forEach((b)=>{
        b.addEventListener("click",()=>{
          var iso=b.getAttribute("data-del"); if(!confirm("Да изтрия записа за "+isoToBG_YY(iso)+"?")) return;
          var data=load().filter(x=>x.date!==iso); save(data); renderTable(); renderChart();
        });
      });
      buildPager(pagerBottom,total,eff);
    }

    function weekKey(iso){
      var d=new Date(iso); d.setUTCHours(0,0,0,0); d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
      var yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
      var week=Math.ceil((((d-yearStart)/86400000)+1)/7);
      return d.getUTCFullYear()+"-W"+String(week).padStart(2,"0");
    }
    function monthKey(iso){ var d=new Date(iso); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); }
    function labelWeek(k){ var s=k.split("-W"); return "С"+s[1]+"."+String(s[0]).slice(2); }
    function labelMonth(k){ var s=k.split("-"); return s[1]+"."+String(s[0]).slice(2); }

    aggSel.addEventListener("change", ()=>renderChart());

    function cssPx(name, fallback){
      var v=getComputedStyle(document.documentElement).getPropertyValue(name).trim();
      var n=parseFloat(v); return Number.isFinite(n)?n:fallback;
    }

    function getChartRawData(){
      var mode=aggSel.value;
      if(mode==="daily"){ var src=(__currentSlice && __currentSlice.length)?__currentSlice.slice():sortDesc(load()); return sortAsc(src); }
      return sortAsc(load());
    }

    function renderChart(){
      var ctx=chart.getContext("2d"), rect=chart.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
      chart.width=Math.round(rect.width*dpr); chart.height=Math.round(360*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
      var w=rect.width, h=360; ctx.clearRect(0,0,w,h);

      var raw=getChartRawData(); if(!raw.length){
        ctx.fillStyle="#9fb4ad"; ctx.font="700 "+cssPx('--chart-values', 15)+"px system-ui"; ctx.fillText("Няма данни",10,26); return;
      }

      var mode=aggSel.value, pts=[];
      if(mode==="daily"){
        pts=raw.map(r=>({x:r.date,y:r.weight,label:isoToBG_YY(r.date), bt:(r.bt!==false)}));
      } else if(mode==="weekly"){
        var wm=new Map();
        raw.forEach(r=>{ var k=weekKey(r.date); (wm.get(k)||wm.set(k,[]).get(k)).push(r); });
        wm.forEach((arr,k)=>{
          var s=0; for(var i=0;i<arr.length;i++) s+=arr[i].weight;
          var btCount=arr.filter(z=>z.bt!==false).length;
          pts.push({x:k,y:s/arr.length,label:labelWeek(k), bt:(btCount>=arr.length-btCount)});
        });
      } else {
        var mm=new Map();
        raw.forEach(r=>{ var k=monthKey(r.date); (mm.get(k)||mm.set(k,[]).get(k)).push(r); });
        mm.forEach((arr,k)=>{
          var s=0; for(var i=0;i<arr.length;i++) s+=arr[i].weight;
          var btCount=arr.filter(z=>z.bt!==false).length;
          pts.push({x:k,y:s/arr.length,label:labelMonth(k), bt:(btCount>=arr.length-btCount)});
        });
      }

      pts.sort((a,b)=>a.x.localeCompare(b.x));
      var vals=pts.map(p=>p.y).filter(n=>typeof n==="number");
      ctx.font="700 "+cssPx('--chart-values', 15)+"px system-ui";
      if(vals.length<2){ ctx.fillStyle="#9fb4ad"; ctx.fillText("Добави поне 2 точки",10,26); return; }

      var min=Math.min(...vals), max=Math.max(...vals);
      var padL=48, padR=18, padT=16, padB=96, n=pts.length;
      function X(i){ return padL+(w-padL-padR)*(n<=1?0:i/(n-1)); }
      function Y(v){ return h-padB-((v-min)/((max-min)||1))*(h-padT-padB); }

      ctx.strokeStyle="#20343a"; ctx.lineWidth=1.1;
      ctx.beginPath(); ctx.moveTo(padL,h-padB); ctx.lineTo(w-padR,h-padB); ctx.moveTo(padL,padT); ctx.lineTo(padL,h-padB); ctx.stroke();

      for(var i=1;i<n;i++){
        var p0=pts[i-1], p1=pts[i];
        var bothBT = (p0.bt && p1.bt);
        var bothNon = (!p0.bt && !p1.bt);
        ctx.strokeStyle = bothBT ? (getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b')
                        : bothNon ? (getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5')
                        : (getComputedStyle(document.documentElement).getPropertyValue('--line-neutral').trim()||'#2dd4bf');
        ctx.lineWidth=2.0;
        ctx.beginPath(); ctx.moveTo(X(i-1), Y(p0.y)); ctx.lineTo(X(i),   Y(p1.y)); ctx.stroke();
      }

      ctx.fillStyle="#d9ebe5"; ctx.textBaseline="middle";
      ctx.fillText(String(max.toFixed(1)),10,Y(max)); ctx.fillText(String(min.toFixed(1)),10,Y(min));

      var maxLabels=Math.min(16,n), step=Math.max(1,Math.floor(n/maxLabels));
      var green=getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5';
      var orange=getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b';
      ctx.font="700 "+cssPx('--chart-label', 15)+"px system-ui";
      for(var j=0;j<n;j++){
        var pe=pts[j], x0=X(j), yVal=Y(pe.y);
        ctx.beginPath(); ctx.fillStyle = pe.bt ? orange : green; ctx.arc(x0, yVal, 3, 0, Math.PI*2); ctx.fill();

        ctx.save(); ctx.font = "600 11px system-ui"; ctx.fillStyle = "#9fb4ad"; ctx.textBaseline = "bottom"; ctx.textAlign = "left";
        const txt = pe.y.toFixed(1); const tw = ctx.measureText(txt).width; let xText = x0 + 5;
        if (xText + tw > w - padR - 2) xText = (w - padR - 2) - tw;
        if (xText < padL + 2) xText = padL + 2; ctx.fillText(txt, xText, yVal - 4); ctx.restore();

        if(j%step===0){ ctx.save(); ctx.translate(x0,h-padB+64); ctx.rotate(-Math.PI/2); ctx.fillStyle="#e7faf4"; ctx.fillText(pe.label,0,0); ctx.restore(); }
      }
    }

    exportBtn.addEventListener("click", ()=>{
      var data = load();
      var blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href=url; a.download="bt-progress-export.json";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    importBtn.addEventListener("click", ()=>importFile.click());
    importFile.addEventListener("change", ()=>{
      var f=importFile.files[0]; if(!f) return;
      var fr=new FileReader();
      fr.onload = () => {
        try{
          var arr = JSON.parse(fr.result||"[]");
          if(!Array.isArray(arr)) throw new Error("Невалиден формат");
          arr = arr.filter(r => r && typeof r.date==="string" && typeof r.weight==="number")
                   .map(r => ({ date:r.date, weight:r.weight, bt:(r.bt!==false) }));
          save(arr); renderTable(); renderChart();
          alert("Импортът е успешен. Записите са презаредени.");
        }catch(e){ alert("Грешка при импорт: "+e.message); }
        importFile.value="";
      };
      fr.readAsText(f);
    });

    function migrateDatesAndBT(){
      var arr=load(), changed=false;
      for(var i=0;i<arr.length;i++){
        var r=arr[i];
        if(typeof r.date==="string" && !/^\d{4}-\d{2}-\d{2}$/.test(r.date)){
          var iso=bgToISO_any(r.date); if(iso){ r.date=iso; changed=true; }
        }
        if(typeof r.bt==="undefined"){ r.bt=true; changed=true; }
      }
      if(changed) save(arr);
    }

    function initialRender(){
      migrateDatesAndBT();
      prefillFor(currentISO);
      renderTable(); renderChart();
      window.addEventListener("resize", ()=>renderChart(), {passive:true});
    }
    initialRender();

    /* ===== помощни за селекти (за другите продукти) ===== */
    function two(n){ return String(n).padStart(2,"0"); }
    function buildHourRange(sel, fromH, toH){
      if(!sel) return;
      sel.innerHTML="";
      for(let h=fromH; h<=toH; h++){
        const o=document.createElement("option");
        o.value=two(h); o.textContent=o.value;
        sel.appendChild(o);
      }
    }
    function buildMinutes5(sel){
      if(!sel) return;
      sel.innerHTML="";
      for(let m=0; m<60; m+=5){
        const o=document.createElement("option");
        o.value=two(m); o.textContent=o.value;
        sel.appendChild(o);
      }
    }
    function setSel(sel,val){ if(!sel) return false; const opt=[...sel.options].find(o=>o.value===val); if(opt){ sel.value=val; return true;} return false; }

    /* ===== ProLact седмична таблица ===== */
    (function(){
      const HEAD = ["Пн","Вт","Ср","Чт","Пт","Сб","Нд"];
      const DEF = { t1:"08:00", t2:"19:00", f1:"", f2:"" };
      const STORE = "bt_pl_wk_v234";
      const elHead = document.getElementById('pl-wk-head');
      const row1 = document.getElementById('pl-wk-row1');
      const row2 = document.getElementById('pl-wk-row2');
      let state = loadState();
      let activeDay = getTodayIdx();
      let editing = null;

      function loadState(){
        try{
          const s = JSON.parse(localStorage.getItem(STORE)||"");
          if(Array.isArray(s) && s.length===7) return s.map(v=>({t1:v.t1||"08:00",t2:v.t2||"19:00",f1:v.f1||"",f2:v.f2||""}));
        }catch(_){}
        return Array.from({length:7},()=>({...DEF}));
      }
      function saveState(){ localStorage.setItem(STORE, JSON.stringify(state)); }

      function getTodayIdx(){
        const js = (new Date()).getDay();
        return (js+6)%7;
      }

      function renderHead(){
        elHead.innerHTML = "";
        HEAD.forEach((h,i)=>{
          const th = document.createElement('th');
          const span = document.createElement('span');
          span.className="h";
          span.textContent = h;
          if(i===5 || i===6) span.classList.add('weekend');
          if(i===getTodayIdx()) span.classList.add('today');
          if(i===activeDay) span.classList.add('active');
          span.addEventListener('click',()=>{ activeDay=i; renderHead(); });
          th.appendChild(span);
          elHead.appendChild(th);
        });
      }

      function icSpan(type){
        if(type==="take") return '<svg class="ic" viewBox="0 0 20 20" width="14" height="14"><path d="M16 5L8.5 12.5 4 8" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        if(type==="mute") return '<svg class="ic" viewBox="0 0 20 20" width="14" height="14"><path d="M8 7v6h3l4 3V4l-4 3H8zM3 3l14 14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>';
        return '';
      }

      function cell(day,row){
        const r = state[day];
        const time = row===1 ? r.t1 : r.t2;
        const flag = row===1 ? r.f1 : r.f2;
        const td = document.createElement('td');
        const div = document.createElement('div');
        div.className="tcell" + (editing && editing.day===day && editing.row===row ? " editing":"");
        div.innerHTML = `<span class="t">${time}</span>${icSpan(flag)}`;
        div.addEventListener('click', ()=>{
          editing = {day,row};
          renderBody();
          openClock(time, (newTime, saveFlag)=>{
            const rec = state[day];
            if(row===1){ rec.t1=newTime; rec.f1 = saveFlag==="take"?"take":(saveFlag==="mute"?"mute":""); }
            else { rec.t2=newTime; rec.f2 = saveFlag==="take"?"take":(saveFlag==="mute"?"mute":""); }
            saveState();
            editing = null;
            renderBody();
          });
        });
        td.appendChild(div);
        return td;
      }

      function renderBody(){
        row1.innerHTML=""; row2.innerHTML="";
        for(let i=0;i<7;i++) row1.appendChild(cell(i,1));
        for(let i=0;i<7;i++) row2.appendChild(cell(i,2));
      }

      renderHead(); renderBody();
    })();

    /* ===== Модал часовник (canvas) — с fallback на roundRect ===== */
    function openClock(current, onCommit){
      const modal = document.getElementById('timeModal');
      const cvHH = document.getElementById('cvHH');
      const cvMM = document.getElementById('cvMM');
      const clk = document.getElementById('clock');
      const ctx = clk.getContext('2d');
      const ok = document.getElementById('clkOk');
      const take = document.getElementById('clkTake');
      const mute = document.getElementById('clkMute');

      // рендер на заоблен правоъгълник без roundRect
      function roundRectPath(ctx,x,y,w,h,r){
        const rr = Math.max(0, Math.min(r, Math.min(w,h)/2));
        ctx.beginPath();
        ctx.moveTo(x+rr, y);
        ctx.lineTo(x+w-rr, y);
        ctx.arcTo(x+w, y, x+w, y+rr, rr);
        ctx.lineTo(x+w, y+h-rr);
        ctx.arcTo(x+w, y+h, x+w-rr, y+h, rr);
        ctx.lineTo(x+rr, y+h);
        ctx.arcTo(x, y+h, x, y+h-rr, rr);
        ctx.lineTo(x, y+rr);
        ctx.arcTo(x, y, x+rr, y, rr);
        ctx.closePath();
      }

      let HH = 8, MM = 0;
      if(typeof current==="string" && /^\d{2}:\d{2}$/.test(current)){ HH=+current.slice(0,2); MM=+current.slice(3,5); }

      function setVal(h,m){
        HH=(Math.max(0,Math.min(24, h|0)));
        if(HH===24&&m>0){ HH=23; m=59; }
        MM=(Math.max(0,Math.min(59, m|0)));
        cvHH.textContent=String(HH).padStart(2,"0");
        cvMM.textContent=String(MM).padStart(2,"0");
        try{ draw(); }catch(e){ /* не блокирай UI */ }
      }

      const W=clk.width, H=clk.height, CX=W/2, CY=H/2;
      const R = 132;
      const R_H_IN = 62;
      const R_H_OUT= 92;
      const R_MIN   = 118;
      const HIT_H   = 22;
      const HIT_M   = 16;

      let dragMode = "";
      function angToXY(r,ang){ return [CX + r*Math.sin(ang), CY - r*Math.cos(ang)]; }
      function xyToAng(x,y){ return Math.atan2(x-CX, CY-y); } // 0 горе

      function drawRingHours(){
        ctx.save();
        ctx.strokeStyle="#20343a"; ctx.lineWidth=1;
        ctx.beginPath(); ctx.arc(CX,CY,R_H_IN,0,Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.arc(CX,CY,R_H_OUT,0,Math.PI*2); ctx.stroke();
        ctx.fillStyle="#cfe5df"; ctx.font="700 12px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
        for(let h=1;h<=12;h++){
          const ang = (Math.PI*2)*(h%12)/12;
          let [x,y] = angToXY(R_H_IN, ang);
          ctx.fillText(String(h), x, y);
        }
        for(let n=13;n<=24;n++){
          const ang = (Math.PI*2)*(n%12)/12;
          let [x,y] = angToXY(R_H_OUT, ang);
          ctx.fillText(String(n), x, y);
        }
        ctx.restore();
      }

      function drawRingMinutes(){
        ctx.save();
        ctx.strokeStyle="#20343a"; ctx.lineWidth=1;
        ctx.beginPath(); ctx.arc(CX,CY,R_MIN,0,Math.PI*2); ctx.stroke();
        for(let m=0;m<60;m++){
          const ang=(Math.PI*2)*m/60;
          const r1 = R_MIN-8, r2 = (m%5===0)? R_MIN : R_MIN-3;
          const [x1,y1]=angToXY(r1,ang), [x2,y2]=angToXY(r2,ang);
          ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.strokeStyle = (m%5===0)?"#38545b":"#2a4146"; ctx.stroke();
          if(m%5===0){
            const [tx,ty]=angToXY(R_MIN-18,ang);
            ctx.fillStyle="#9fb4ad"; ctx.font="700 11px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
            ctx.fillText(String(m).padStart(2,"0"), tx, ty);
          }
        }
        ctx.restore();
      }

      function drawHands(){
        ctx.save();
        ctx.beginPath(); ctx.arc(CX,CY,R,0,Math.PI*2); ctx.strokeStyle="#20343a"; ctx.lineWidth=1; ctx.stroke();

        const aM=(Math.PI*2)*(MM/60);
        const [mx,my]=angToXY(R_MIN-12,aM);
        ctx.beginPath(); ctx.moveTo(CX,CY); ctx.lineTo(mx,my);
        ctx.lineWidth=2; ctx.strokeStyle="#a7f3d0"; ctx.stroke();

        const isOut = (HH>=13);
        const base = HH%12===0?12:HH%12;
        const aH=(Math.PI*2)*(base/12) + (Math.PI*2)*(MM/60)/12;
        const rH = isOut ? (R_H_OUT-8) : (R_H_IN-8);
        const [hx,hy]=angToXY(rH,aH);
        ctx.beginPath(); ctx.moveTo(CX,CY); ctx.lineTo(hx,hy);
        ctx.lineWidth=4; ctx.strokeStyle="#f59e0b"; ctx.stroke();

        // правоъгълник HH:MM (fallback без roundRect)
        ctx.fillStyle="#0b1417"; ctx.strokeStyle="#20343a"; ctx.lineWidth=1;
        const rectW=114, rectH=34, rx=8;
        roundRectPath(ctx, CX-rectW/2, CY-rectH/2, rectW, rectH, rx);
        ctx.fill(); ctx.stroke();
        ctx.fillStyle="#e7faf4"; ctx.font="800 18px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(String(HH).padStart(2,"0")+":"+String(MM).padStart(2,"0"), CX, CY);
        ctx.restore();
      }

      function draw(){
        ctx.clearRect(0,0,clk.width,clk.height);
        drawRingHours();
        drawRingMinutes();
        drawHands();
      }

      function pickWhere(x,y){
        const dx=x-CX, dy=y-CY; const d=Math.hypot(dx,dy);
        if(d>R_H_IN-22 && d<R_H_IN+22) return "h-in";
        if(d>R_H_OUT-22 && d<R_H_OUT+22) return "h-out";
        if(d>R_MIN-16 && d<R_MIN+16) return "m";
        if(Math.abs(dx)<=60 && Math.abs(dy)<=18) return "center";
        return "";
      }

      function setHourFromAng(ring, ang){
        let idx = Math.round((ang/(Math.PI*2))*12) % 12;
        if(idx<=0) idx += 12;
        if(ring==="in"){ setVal(idx===12?12:idx, MM); }
        else { const val = idx===12 ? 24 : (12+idx); setVal(val, MM); }
      }
      function setMinuteFromAng(ang){
        let m = Math.round((ang/(Math.PI*2))*60) % 60;
        if(m<0) m+=60;
        setVal(HH, m);
      }

      // показваме първо модала, после рисуваме (за да не блокира при грешка)
      function show(){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
      function hide(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

      show();        // <-- важно
      setVal(HH,MM); // рисуване след show()

      const valBox=document.getElementById('clockVal');
      valBox.tabIndex = 0;

      let mouseDown=false, modePicked="";
      clk.addEventListener('pointerdown', (e)=>{
        const rect=clk.getBoundingClientRect();
        const x=(e.clientX-rect.left)* (clk.width/rect.width);
        const y=(e.clientY-rect.top )* (clk.height/rect.height);
        const hit = pickWhere(x,y);
        if(hit==="h-in"||hit==="h-out"){ dragMode="h"; modePicked=hit; mouseDown=true; const ang=xyToAng(x,y); setHourFromAng(hit==="h-in"?"in":"out", ang); }
        else if(hit==="m"){ dragMode="m"; mouseDown=true; const ang=xyToAng(x,y); setMinuteFromAng(ang); }
      });
      clk.addEventListener('pointermove', (e)=>{
        if(!mouseDown) return;
        const rect=clk.getBoundingClientRect();
        const x=(e.clientX-rect.left)* (clk.width/rect.width);
        const y=(e.clientY-rect.top )* (clk.height/rect.height);
        const ang=xyToAng(x,y);
        if(dragMode==="h"){ setHourFromAng(modePicked==="h-in"?"in":"out", ang); }
        else if(dragMode==="m"){ setMinuteFromAng(ang); }
      });
      window.addEventListener('pointerup', ()=>{ mouseDown=false; dragMode=""; });

      valBox.addEventListener('keydown',(e)=>{
        if(e.key==="ArrowUp"){ setVal(HH+1>24?24:HH+1, MM); e.preventDefault(); }
        else if(e.key==="ArrowDown"){ setVal(HH-1<0?0:HH-1, MM); e.preventDefault(); }
        else if(e.key==="ArrowRight"){ setVal(HH, (MM+1)%60); e.preventDefault(); }
        else if(e.key==="ArrowLeft"){ setVal(HH, (MM+59)%60); e.preventDefault(); }
      });
      valBox.addEventListener('wheel',(e)=>{ e.preventDefault(); const d=Math.sign(e.deltaY); setVal(HH,(MM + (d>0?59:1))%60); }, {passive:false});

      modal.addEventListener('click', (e)=>{ if(e.target===modal) hide(); });

      ok.onclick = ()=>{ hide(); onCommit(`${String(HH).padStart(2,"0")}:${String(MM).padStart(2,"0")}`, "ok"); };
      take.onclick = ()=>{ hide(); onCommit(`${String(HH).padStart(2,"0")}:${String(MM).padStart(2,"0")}`, "take"); };
      mute.onclick = ()=>{ hide(); onCommit(`${String(HH).padStart(2,"0")}:${String(MM).padStart(2,"0")}`, "mute"); };
    }

    /* ===== Omni/Chitosan (непипната логика) ===== */
    (function(){
      const DEF={m:"08:00", n:"12:00", e:"19:00"};
      const KEY_SEL='bt_he_sel_v218';
      const KEY_TIM='bt_he_tim_v218';

      const m=document.getElementById('he-m'), n=document.getElementById('he-n'), e=document.getElementById('he-e');
      const boxM=document.getElementById('he-tp-m'), boxN=document.getElementById('he-tp-n'), boxE=document.getElementById('he-tp-e');
      const hhM=document.getElementById('he-hh-m'), mmM=document.getElementById('he-mm-m');
      const hhN=document.getElementById('he-hh-n'), mmN=document.getElementById('he-mm-n');
      const hhE=document.getElementById('he-hh-e'), mmE=document.getElementById('he-mm-e');

      function ensureTim(){
        try{
          const r=JSON.parse(localStorage.getItem(KEY_TIM)||'');
          if(r && r.m && r.n && r.e) return r;
        }catch(_){}
        localStorage.setItem(KEY_TIM, JSON.stringify({...DEF}));
        return {...DEF};
      }
      function loadTim(){ try{ return JSON.parse(localStorage.getItem(KEY_TIM))||ensureTim(); }catch(_){ return ensureTim(); } }
      function saveTim(t){ localStorage.setItem(KEY_TIM, JSON.stringify(t)); }

      function loadSel(){ return localStorage.getItem(KEY_SEL)||"n"; }
      function saveSel(v){ localStorage.setItem(KEY_SEL, v); }

      buildHourRange(hhM,0,9);  buildMinutes5(mmM);
      buildHourRange(hhN,10,17); buildMinutes5(mmN);
      buildHourRange(hhE,18,23); buildMinutes5(mmE);

      function setOnly(which){
        if(!m||!n||!e) return;
        m.checked = (which==="m"); n.checked = (which==="n"); e.checked = (which==="e");
        if(boxM) boxM.style.display = (which==="m")?"block":"none";
        if(boxN) boxN.style.display = (which==="n")?"block":"none";
        if(boxE) boxE.style.display = (which==="e")?"block":"none";
        saveSel(which);
      }
      function setFromStr(hhSel, mmSel, str){ if(!hhSel||!mmSel) return; const [H,M]=(str||"").split(":"); if(!setSel(hhSel,H)) hhSel.value=hhSel.options[0].value; if(!setSel(mmSel,M)) mmSel.value="00"; }
      function getStr(hhSel, mmSel){ return (hhSel.value||"00")+":"+(mmSel.value||"00"); }

      const which0=loadSel(); setOnly(which0);
      const t0=ensureTim();
      setFromStr(hhM,mmM,t0.m); setFromStr(hhN,mmN,t0.n); setFromStr(hhE,mmE,t0.e);

      [m,n,e].forEach(el=>el && el.addEventListener('change',()=>{
        const which = el===m ? "m" : el===n ? "n" : "e";
        setOnly(which);
        const t=loadTim(); saveTim(t);
      }));
      [hhM,mmM,hhN,mmN,hhE,mmE].forEach(sel=> sel && sel.addEventListener('change', ()=>{
        const which = localStorage.getItem(KEY_SEL)||"n";
        const t=loadTim();
        if(which==="m") t.m = getStr(hhM,mmM);
        else if(which==="n") t.n = getStr(hhN,mmN);
        else t.e = getStr(hhE,mmE);
        saveTim(t);
      }));
    })();

    (function(){
      const DEF={m:"08:00", n:"12:00", e:"19:00"};
      const KEY='bt_ch_tim_v218';

      const hhM=document.getElementById('ch-hh-m'), mmM=document.getElementById('ch-mm-m');
      const hhN=document.getElementById('ch-hh-n'), mmN=document.getElementById('ch-mm-n');
      const hhE=document.getElementById('ch-hh-e'), mmE=document.getElementById('ch-mm-e');

      if(!hhM||!hhN||!hhE) return;

      buildHourRange(hhM,0,9);  buildMinutes5(mmM);
      buildHourRange(hhN,10,17); buildMinutes5(mmN);
      buildHourRange(hhE,18,23); buildMinutes5(mmE);

      function ensure(){ try{ const r=JSON.parse(localStorage.getItem(KEY)||''); if(r&&r.m&&r.n&&r.e) return r; }catch(_){}
        const def={...DEF}; localStorage.setItem(KEY, JSON.stringify(def)); return def; }
      function load(){ try{ return JSON.parse(localStorage.getItem(KEY))||ensure(); }catch(_){ return ensure(); } }
      function save(t){ localStorage.setItem(KEY, JSON.stringify(t)); }
      function setFromStr(hhSel, mmSel, str){ const [H,M]=(str||"").split(":"); if(!setSel(hhSel,H)) hhSel.value=hhSel.options[0].value; if(!setSel(mmSel,M)) mmSel.value="00"; }
      function getStr(hhSel, mmSel){ return (hhSel.value||"00")+":"+(mmSel.value||"00"); }

      const t0=ensure();
      setFromStr(hhM,mmM,t0.m); setFromStr(hhN,mmN,t0.n); setFromStr(hhE,mmE,t0.e);
      function write(){ save({ m:getStr(hhM,mmM), n:getStr(hhN,mmN), e:getStr(hhE,mmE) }); }
      [hhM,mmM,hhN,mmN,hhE,mmE].forEach(sel=> sel && sel.addEventListener('change', write));
      write();
    })();
  </script>
</body>
</html>
