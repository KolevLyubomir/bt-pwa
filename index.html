<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BT — Тегло v11</title>
  <link rel="manifest" href="manifest.webmanifest?v=11">
  <meta name="theme_color" content="#10b981">
  <link rel="icon" href="assets/icons/icon-192.png?v=11">
  <style>
    :root{--bg:#0b1215;--card:#111a1f;--text:#e6f2ef;--muted:#9fb4ad;--accent:#10b981;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
         background:linear-gradient(180deg,#071013,#0b1215);color:var(--text)}
    header{position:sticky;top:0;background:#071013aa;backdrop-filter:blur(6px);border-bottom:1px solid #1e2b30;
           padding:12px 16px;display:flex;gap:12px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}
    .badge{display:inline-block;background:#f59e0b;color:#06241b;font-weight:700;border-radius:10px;padding:2px 8px;margin-left:8px}
    main{max-width:900px;margin:20px auto;padding:0 16px 40px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1e2b30;border-radius:16px;padding:16px;box-shadow:0 10px 30px #00000040}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{border-radius:12px;border:1px solid #254046;background:#0d171b;color:var(--text);
                        padding:10px 12px;font-size:14px}
    button{background:var(--accent);border:none;color:#06241b;font-weight:700;cursor:pointer}
    button.ghost{background:#0d171b;color:#e6f2ef;border:1px solid #2a3e41}
    button.danger{background:#ef4444;color:white}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #20343a;text-align:left;font-size:14px}
    th{color:#9fb4ad;font-weight:600}
    .right{text-align:right}
    canvas{max-width:100%;height:320px}
    .pagination{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:10px}
    .pagination button{background:#0d171b;border:1px solid #2a3e41;color:#e6f2ef;padding:6px 10px;border-radius:10px;cursor:pointer}
    .pagination button.active{background:#10b981;color:#06241b;border-color:#10b981}
    .pagination .muted{color:#9fb4ad;margin-right:auto}
    .page-size select{background:#0d171b;border:1px solid #2a3e41;color:#e6f2ef;border-radius:10px;padding:6px 8px}
    .error{color:#ef4444;font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <img src="assets/icons/icon-192.png?v=11" width="28" height="28" alt="BT">
    <h1>Безопасно Тегло — Тракер <span class="badge">v11</span></h1>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 8px">Нов запис</h2>
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label for="date">Дата</label>
          <input id="date" type="date">
          <div style="margin-top:8px">
            <button id="openCal" class="ghost">Календар</button>
          </div>
          <div id="dateErr" class="error" style="display:none"></div>
        </div>
        <div style="flex:1;min-width:140px">
          <label for="weight">Тегло (kg)</label>
          <input id="weight" type="number" step="0.1" min="0.1">
          <div id="weightErr" class="error" style="display:none"></div>
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="add">Добави</button>
        <button class="ghost" id="export">Експорт (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="ghost" id="importBtn">Импорт</button>
        <button class="danger" id="wipe">Изтрий всички</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Графика</h2>
      <div class="row">
        <div>
          <label for="span">Период</label>
          <select id="span">
            <option value="30">30 дни</option>
            <option value="90">90 дни</option>
            <option value="365">1 година</option>
            <option value="all">Всички</option>
          </select>
        </div>
      </div>
      <canvas id="chart"></canvas>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Записи</h2>
      <table id="table">
        <thead><tr><th>Дата</th><th>Тегло (kg)</th><th class="right">Действия</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="pagination" id="pager"></div>
    </section>
  </main>

  <script>
    /* Мини графика */
    class MiniChart{
      constructor(ctx){ this.ctx=ctx; this.data=[]; }
      render(){
        const c=this.ctx.canvas, w=c.width=c.clientWidth, h=c.height=320;
        const ctx=this.ctx; ctx.clearRect(0,0,w,h);
        const vals=this.data.filter(v=>typeof v==='number');
        ctx.fillStyle="#9fb4ad"; ctx.font="14px system-ui";
        if(vals.length<2){ ctx.fillText("Добави поне 2 записа за графика", 10, 24); return; }
        const min=Math.min(...vals), max=Math.max(...vals), pad=24;
        ctx.strokeStyle="#87f3c5"; ctx.lineWidth=2; ctx.beginPath();
        this.data.forEach((v,i)=>{
          const x=pad + (w-2*pad)*(i/(this.data.length-1));
          const y=h-pad - ((v-min)/((max-min)||1))*(h-2*pad);
          i?ctx.lineTo(x,y):ctx.moveTo(x,y);
        });
        ctx.stroke();
      }
    }

    const $ = s=>document.querySelector(s);
    const dateInput=$("#date"), weightInput=$("#weight");
    const dateErr=$("#dateErr"), weightErr=$("#weightErr");
    const tbody = document.querySelector("#table tbody");
    const pager = $("#pager");
    const spanSelect=$("#span");

    // ---- Настройки на странициране (запомняне)
    const PAGE_SIZES = [10,20,50,100,"all"];
    function getSavedPageSize(){
      const v = localStorage.getItem("bt-page-size");
      if(v==="all") return "all";
      const n = Number(v);
      return PAGE_SIZES.includes(n) ? n : 20;
    }
    function savePageSize(v){ localStorage.setItem("bt-page-size", v); }
    let pageSize = getSavedPageSize();
    let currentPage = 1;

    // ---- Дата и валидация
    function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    const TODAY = todayISO();

    function getSavedDate(){ return localStorage.getItem("bt-last-date") || TODAY; }
    function saveLastDate(dStr){ localStorage.setItem("bt-last-date", dStr); }
    function clampToToday(dStr){ return dStr > TODAY ? TODAY : dStr; }

    // инициализация на датата: последната запомнена (или днес)
    dateInput.value = clampToToday(getSavedDate());
    dateInput.max = TODAY;

    function load(){ try{return JSON.parse(localStorage.getItem("bt-progress")||"[]");}catch{return [];} }
    function save(d){ localStorage.setItem("bt-progress", JSON.stringify(d)); }
    function sortDescByDate(arr){ return [...arr].sort((a,b)=> b.date.localeCompare(a.date)); }
    function sortAscByDate(arr){ return [...arr].sort((a,b)=> a.date.localeCompare(b.date)); }

    // ---- Таблица + странициране
    function renderTable(){
      const allDesc = sortDescByDate(load());
      const total = allDesc.length;
      const effectivePageSize = pageSize==="all" ? total||1 : pageSize;
      const pages = Math.max(1, Math.ceil(total / effectivePageSize));
      if(currentPage > pages) currentPage = pages;

      const start = (currentPage - 1) * effectivePageSize;
      const slice = allDesc.slice(start, start + effectivePageSize);

      tbody.innerHTML="";
      slice.forEach((r, idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td><td>${r.weight??""}</td>
        <td class="right"><button class="ghost" data-edit="${start+idx}">Редакция</button>
        <button class="danger" data-del="${start+idx}">Изтрий</button></td>`;
        tbody.appendChild(tr);
      });

      // --- pager
      pager.innerHTML="";
      const infoWrap = document.createElement("div");
      infoWrap.style.display="flex";
      infoWrap.style.alignItems="center";
      infoWrap.style.gap="8px";
      infoWrap.style.marginRight="auto";

      const info = document.createElement("span");
      info.className="muted";
      const from = total ? start+1 : 0;
      const to = Math.min(start + effectivePageSize, total);
      info.textContent = `${from}-${to} от ${total}`;
      infoWrap.appendChild(info);

      // селектор за размер (без етикет)
      const sizeWrap = document.createElement("div");
      sizeWrap.className="page-size";
      const sizeSel = document.createElement("select");
      sizeSel.id = "pageSize";
      [10,20,50,100,"all"].forEach(opt=>{
        const o = document.createElement("option");
        o.value = String(opt);
        o.textContent = (opt==="all" ? "Всички" : opt);
        if(opt===pageSize) o.selected = true;
        sizeSel.appendChild(o);
      });
      sizeWrap.appendChild(sizeSel);
      infoWrap.appendChild(sizeWrap);
      pager.appendChild(infoWrap);

      const pagesToShow = 7;
      const pagesCount = Math.max(1, Math.ceil(total / (pageSize==="all"? (total||1) : pageSize)));
      if(pagesCount > 1){
        if(currentPage > 1){
          const prev = document.createElement("button");
          prev.textContent = "←";
          prev.onclick = ()=>{ currentPage=Math.max(1,currentPage-1); renderTable(); };
          pager.appendChild(prev);
        }
        let first = Math.max(1, currentPage - Math.floor(pagesToShow/2));
        let last = Math.min(pages, first + pagesToShow - 1);
        first = Math.max(1, last - pagesToShow + 1);
        for(let p=first; p<=last; p++){
          const btn = document.createElement("button");
          btn.textContent = p;
          if(p===currentPage) btn.className="active";
          btn.onclick = ()=>{ currentPage=p; renderTable(); };
          pager.appendChild(btn);
        }
        if(currentPage < pages){
          const next = document.createElement("button");
          next.textContent = "→";
          next.onclick = ()=>{ currentPage=Math.min(pages,currentPage+1); renderTable(); };
          pager.appendChild(next);
        }
      }

      sizeSel.addEventListener("change", ()=>{
        const v = sizeSel.value === "all" ? "all" : Number(sizeSel.value);
        pageSize = v;
        savePageSize(v);
        currentPage = 1;
        renderTable();
      });
    }

    function renderChart(){
      const allAsc = sortAscByDate(load());
      let filtered = allAsc;
      const span=document.getElementById("span").value;
      if(span!=="all"){
        const days=parseInt(span,10);
        const cut=new Date(); cut.setDate(cut.getDate()-days);
        filtered = allAsc.filter(r=> new Date(r.date)>=cut );
      }
      const vals = filtered.map(r=> Number(r.weight) || null);
      const ctx=document.getElementById("chart").getContext("2d");
      const mini=new MiniChart(ctx); mini.data=vals; mini.render();
    }

    function clearForm(){
      weightInput.value="";
      dateErr.style.display="none";
      dateErr.textContent="";
      weightErr.style.display="none";
      weightErr.textContent="";
    }

    // ---- Добавяне / редакция / триене
    document.getElementById("add").addEventListener("click",()=>{
      const TODAY_NOW = todayISO();
      let dStr = dateInput.value || TODAY_NOW;
      if(dStr > TODAY_NOW){
        dateErr.textContent = "Датата е в бъдещето. Моля, избери днешна или минала дата.";
        dateErr.style.display = "block";
        return;
      }
      const wRaw = weightInput.value.trim();
      const wVal = wRaw === "" ? NaN : Number(wRaw);
      if(!(wVal > 0)){
        weightErr.textContent = "Моля, въведи тегло > 0.";
        weightErr.style.display = "block";
        return;
      }

      const rec={ date: dStr, weight: wVal };
      const data=load();
      const idx=data.findIndex(r=>r.date===rec.date);
      if(idx>=0) data[idx]=rec; else data.push(rec);
      save(data);
      saveLastDate(dStr);                 // 💾 запомняме последната дата
      renderTable(); renderChart(); clearForm();
    });

    document.addEventListener("click",(e)=>{
      const t=e.target; if(!t.closest("#table")) return;
      const allDesc = sortDescByDate(load());
      if(t.matches("button[data-del]")){
        const iDesc = +t.getAttribute("data-del");
        const rec = allDesc[iDesc];
        let data = load();
        const i = data.findIndex(r=> r.date===rec.date);
        if(i>=0){ data.splice(i,1); save(data); renderTable(); renderChart(); }
      } else if(t.matches("button[data-edit]")){
        const iDesc = +t.getAttribute("data-edit");
        const rec = allDesc[iDesc];
        dateInput.value = clampToToday(rec.date);
        dateInput.max = TODAY;
        weightInput.value = rec.weight ?? "";
        window.scrollTo({top:0, behavior:"smooth"});
      }
    });

    // ---- Календар бутон
    document.getElementById("openCal").addEventListener("click", ()=>{
      if(typeof dateInput.showPicker === "function"){
        dateInput.showPicker();
      }else{
        dateInput.focus();
      }
    });

    // запомняме последната дата при ръчна промяна
    dateInput.addEventListener("change", ()=>{
      const v = clampToToday(dateInput.value || TODAY);
      dateInput.value = v;
      saveLastDate(v);
      dateErr.style.display="none";
    });

    renderTable(); renderChart();
  </script>
</body>
</html>
