<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BT ‚Äî –¢–µ–≥–ª–æ v19</title>
  <link rel="manifest" href="manifest.webmanifest?v=19">
  <meta name="theme_color" content="#10b981">
  <link rel="icon" href="assets/icons/icon-192.png?v=19">
  <style>
    :root{--bg:#0b1215;--card:#111a1f;--text:#e6f2ef;--muted:#9fb4ad;--accent:#10b981;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
         background:linear-gradient(180deg,#071013,#0b1215);color:var(--text)}
    header{position:sticky;top:0;background:#071013aa;backdrop-filter:blur(6px);border-bottom:1px solid #1e2b30;
           padding:12px 16px;display:flex;gap:12px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}
    .badge{display:inline-block;background:#f59e0b;color:#06241b;font-weight:700;border-radius:10px;padding:2px 8px;margin-left:8px}
    main{max-width:900px;margin:20px auto;padding:0 16px 40px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1e2b30;border-radius:16px;padding:16px;box-shadow:0 10px 30px #00000040}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{border-radius:12px;border:1px solid #254046;background:#0d171b;color:var(--text);
                        padding:10px 12px;font-size:14px}
    input[readonly]{cursor:pointer}
    button{background:var(--accent);border:none;color:#06241b;font-weight:700;cursor:pointer}
    button.ghost{background:#0d171b;color:#e6f2ef;border:1px solid #2a3e41}
    button.danger{background:#ef4444;color:white}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #20343a;text-align:left;font-size:14px}
    th{color:#9fb4ad;font-weight:600}
    .right{text-align:right}
    canvas{max-width:100%;height:360px}
    .pagination{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:10px}
    .pagination button{background:#0d171b;border:1px solid #2a3e41;color:#e6f2ef;padding:6px 10px;border-radius:10px;cursor:pointer}
    .pagination button.active{background:#10b981;color:#06241b;border-color:#10b981}
    .pagination .muted{color:#9fb4ad;margin-right:auto}
    .page-size select{background:#0d171b;border:1px solid #2a3e41;color:#e6f2ef;border-radius:10px;padding:6px 8px}
    .error{color:#ef4444;font-size:13px;margin-top:6px}

    /* –ò–∫–æ–Ω–∫–∏ –±—É—Ç–æ–Ω–∏ */
    .icon-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid #2a3e41;background:#0d171b;color:#e6f2ef}
    .icon-btn svg{width:18px;height:18px;display:block}
    .icon-only{padding:6px 8px}
    .icon-only svg{width:16px;height:16px}
    .icon-btn.danger{border-color:#3a2222;background:#161112;color:#ffd5d5}

    /* –ö–∞–ª–µ–Ω–¥–∞—Ä */
    .cal-wrap{position:relative}
    .calendar{position:absolute; top:100%; left:0; z-index:20; background:#0d171b; border:1px solid #2a3e41;
              border-radius:12px; padding:10px; margin-top:6px; box-shadow:0 10px 30px #00000055; width:270px; display:none}
    .calendar.open{display:block}
    .cal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .cal-head button{background:#0f1a1f; border:1px solid #2a3e41; color:#e6f2ef; padding:4px 8px; border-radius:8px; cursor:pointer}
    .cal-title{font-weight:700; color:#e6f2ef}
    .cal-grid{display:grid; grid-template-columns:repeat(7, 1fr); gap:4px}
    .cal-dow, .cal-day{ text-align:center; padding:6px 0; border-radius:8px; }
    .cal-dow{ color:#9fb4ad; font-size:12px }
    .cal-day{ background:#0f1a1f; border:1px solid #20343a; cursor:pointer }
    .cal-day.dis{ opacity:.35; cursor:not-allowed }
    .cal-day.sel{ border-color:#10b981; outline:2px solid #10b98166 }
    .cal-day.hasdata{ background:#f0fff7; color:#063; border-color:#c6f7df } /* –±—è–ª–æ-–∑–µ–ª–µ–Ω–æ */
    .cal-foot{ display:flex; justify-content:flex-end; margin-top:8px }
    .cal-foot button{ background:#10b981; color:#06241b; border:none; border-radius:8px; padding:6px 10px; font-weight:700 }
  </style>
</head>
<body>
  <header>
    <img src="assets/icons/icon-192.png?v=19" width="28" height="28" alt="BT">
    <h1>–ë–µ–∑–æ–ø–∞—Å–Ω–æ –¢–µ–≥–ª–æ ‚Äî –¢—Ä–∞–∫–µ—Ä <span class="badge">v19</span></h1>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 8px">–ù–æ–≤ –∑–∞–ø–∏—Å</h2>
      <div class="row">
        <div style="flex:1;min-width:220px" class="cal-wrap">
          <label for="dateText">–î–∞—Ç–∞</label>
          <input id="dateText" type="text" inputmode="none" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì" autocomplete="off" readonly>
          <div id="dateErr" class="error" style="display:none"></div>

          <div class="calendar" id="calendar">
            <div class="cal-head">
              <button id="calPrev">‚Äπ</button>
              <div class="cal-title" id="calTitle">–°–µ–ø—Ç–µ–º–≤—Ä–∏ 2025</div>
              <button id="calNext">‚Ä∫</button>
            </div>
            <div class="cal-grid" id="calGrid"></div>
            <div class="cal-foot">
              <button id="calToday">–î–Ω–µ—Å</button>
            </div>
          </div>
        </div>

        <div style="flex:1;min-width:140px">
          <label for="weight">–¢–µ–≥–ª–æ (kg)</label>
          <input id="weight" type="number" step="0.1" min="0.1">
          <div id="weightErr" class="error" style="display:none"></div>
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="add">–î–æ–±–∞–≤–∏</button>

        <button class="icon-btn" id="export" title="–ï–∫—Å–ø–æ—Ä—Ç (JSON)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v12m0 0l-4-4m4 4l4-4"/><path d="M5 21h14"/></svg>
          –ï–∫—Å–ø–æ—Ä—Ç
        </button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="icon-btn" id="importBtn" title="–ò–º–ø–æ—Ä—Ç –æ—Ç JSON">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21V9m0 0l4 4m-4-4L8 13"/><path d="M5 3h14"/></svg>
          –ò–º–ø–æ—Ä—Ç
        </button>

        <!-- –¢—Ä–∏ –∫–æ—à—á–µ—Ç–∞, –ø–ª—ä—Ç–Ω–æ –µ–¥–Ω–æ –¥–æ –¥—Ä—É–≥–æ (–µ–¥–Ω–æ SVG) -->
        <button class="icon-btn danger" id="wipe" title="–ò–∑—Ç—Ä–∏–π –≤—Å–∏—á–∫–∏">
          <svg viewBox="0 0 72 24" fill="none" stroke="currentColor" stroke-width="2" style="width:40px;height:18px">
            <g transform="translate(0,0)"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"/></g>
            <g transform="translate(24,0)"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"/></g>
            <g transform="translate(48,0)"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"/></g>
          </svg>
        </button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">–ì—Ä–∞—Ñ–∏–∫–∞</h2>
      <div class="row">
        <div>
          <label for="span">–ê–≥—Ä–µ–≥–∞—Ü–∏—è</label>
          <select id="span">
            <option value="daily" selected>–î–Ω–∏ (–≤—Å–∏—á–∫–∏)</option>
            <option value="weekly">–°–µ–¥–º–∏—Ü–∏ (—Å—Ä–µ–¥–Ω–æ)</option>
            <option value="monthly">–ú–µ—Å–µ—Ü–∏ (—Å—Ä–µ–¥–Ω–æ)</option>
          </select>
        </div>
      </div>
      <canvas id="chart"></canvas>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">–ó–∞–ø–∏—Å–∏</h2>
      <table id="table">
        <thead><tr><th>–î–∞—Ç–∞</th><th>–¢–µ–≥–ª–æ (kg)</th><th class="right">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="pagination" id="pager"></div>
    </section>
  </main>

  <script>
    /* === –î–∞—Ç–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏ === */
    function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    const TODAY = todayISO();
    const MONTHS_BG = ["–Ø–Ω—É–∞—Ä–∏","–§–µ–≤—Ä—É–∞—Ä–∏","–ú–∞—Ä—Ç","–ê–ø—Ä–∏–ª","–ú–∞–π","–Æ–Ω–∏","–Æ–ª–∏","–ê–≤–≥—É—Å—Ç","–°–µ–ø—Ç–µ–º–≤—Ä–∏","–û–∫—Ç–æ–º–≤—Ä–∏","–ù–æ–µ–º–≤—Ä–∏","–î–µ–∫–µ–º–≤—Ä–∏"];
    const isoToBG = iso => /^\d{4}-\d{2}-\d{2}$/.test(iso) ? iso.split("-").reverse().join(".") : "";
    const isoToBGYY = iso => { // DD.MM.YY
      if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return "";
      const [y,m,d] = iso.split("-");
      return `${d}.${m}.${y.slice(2)}`;
    };
    function bgToISO(bg){ const m=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(bg); return m?`${m[3]}-${m[2]}-${m[1]}`:""; }
    const clampToTodayISO = iso => iso && iso > TODAY ? TODAY : iso;

    /* === –°—ä—Å—Ç–æ—è–Ω–∏–µ === */
    function load(){ try{return JSON.parse(localStorage.getItem("bt-progress")||"[]");}catch{return [];} }
    function save(d){ localStorage.setItem("bt-progress", JSON.stringify(d)); }
    function sortDescByDate(arr){ return [...arr].sort((a,b)=> b.date.localeCompare(a.date)); }
    function sortAscByDate(arr){ return [...arr].sort((a,b)=> a.date.localeCompare(b.date)); }
    const getSavedDateISO = ()=> localStorage.getItem("bt-last-date") || TODAY;
    const saveLastDateISO = iso => localStorage.setItem("bt-last-date", iso);

    function findRecord(iso){ return load().find(r=>r.date===iso); }
    function lastWeightBefore(iso){
      const data = sortDescByDate(load());
      for(const r of data){ if(r.date < iso && typeof r.weight==="number") return r.weight; }
      return "";
    }

    /* === –ú–∏–Ω–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —Å –ø—Ä–µ–∫—ä—Å–≤–∞–Ω–∏—è + –≤–µ—Ä—Ç–∏–∫–∞–ª–Ω–∏ –µ—Ç–∏–∫–µ—Ç–∏ === */
    class MiniChart{
      constructor(ctx){ this.ctx=ctx; this.series=[]; this.labels=[]; }
      render(){
        const c=this.ctx.canvas, w=c.width=c.clientWidth, h=c.height=360;
        const ctx=this.ctx; ctx.clearRect(0,0,w,h);

        const vals=this.series.filter(v=>typeof v==='number');
        ctx.fillStyle="#9fb4ad"; ctx.font="13px system-ui";
        if(vals.length<2){ ctx.fillText("–î–æ–±–∞–≤–∏ –ø–æ–Ω–µ 2 –∑–∞–ø–∏—Å–∞ –∑–∞ –≥—Ä–∞—Ñ–∏–∫–∞", 10, 24); return; }

        const padLeft=32, padRight=12, padTop=18, padBottom=64;
        const min=Math.min(...vals), max=Math.max(...vals);
        const n=this.series.length;
        const xAt=i=> padLeft + (w-padLeft-padRight)*(n<=1?0:(i/(n-1)));
        const yAt=v=> h-padBottom - ((v-min)/((max-min)||1))*(h-padTop-padBottom);

        // –æ—Å–∏
        ctx.strokeStyle="#20343a"; ctx.lineWidth=1; ctx.beginPath();
        ctx.moveTo(padLeft, h-padBottom); ctx.lineTo(w-padRight, h-padBottom);
        ctx.moveTo(padLeft, padTop); ctx.lineTo(padLeft, h-padBottom);
        ctx.stroke();

        // –ª–∏–Ω–∏—è
        ctx.strokeStyle="#87f3c5"; ctx.lineWidth=2; ctx.beginPath();
        let penDown=false;
        for(let i=0;i<n;i++){
          const v=this.series[i];
          if(typeof v==='number'){
            const x=xAt(i), y=yAt(v);
            if(!penDown){ ctx.moveTo(x,y); penDown=true; }
            else ctx.lineTo(x,y);
          }else{
            penDown=false;
          }
        }
        ctx.stroke();

        // Y –µ—Ç–∏–∫–µ—Ç–∏ (min/max)
        ctx.fillStyle="#9fb4ad";
        ctx.fillText(String(max), 4, yAt(max)+4);
        ctx.fillText(String(min), 4, yAt(min)+4);

        // X –µ—Ç–∏–∫–µ—Ç–∏ ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª–Ω–∏
        const maxLabels=10;
        const step = Math.max(1, Math.floor(n / maxLabels));
        for(let i=0;i<n;i+=step){
          const txt=this.labels[i]; if(!txt) continue;
          const x=xAt(i), y=h-10;
          ctx.save();
          ctx.translate(x, y);
          ctx.rotate(-Math.PI/2);
          ctx.textAlign="right";
          ctx.fillText(txt, 0, 0);
          ctx.restore();

          // –º–∞—Ä–∫–µ—Ä
          ctx.beginPath(); ctx.arc(x, h-padBottom, 2, 0, Math.PI*2); ctx.fill();
        }
      }
    }

    /* === –ï–ª–µ–º–µ–Ω—Ç–∏ === */
    const dateText = document.getElementById("dateText");
    const dateErr  = document.getElementById("dateErr");
    const weight   = document.getElementById("weight");
    const weightErr= document.getElementById("weightErr");
    const tbody    = document.querySelector("#table tbody");
    const pager    = document.getElementById("pager");
    const spanSel  = document.getElementById("span");

    // –ü–µ–π–¥–∂–∏–Ω–≥
    const PAGE_SIZES = [10,20,50,100,"all"];
    const getSavedPageSize=()=>{ const v=localStorage.getItem("bt-page-size"); if(v==="all")return"all"; const n=Number(v); return PAGE_SIZES.includes(n)?n:20; };
    const savePageSize=v=>localStorage.setItem("bt-page-size", v);
    let pageSize = getSavedPageSize();
    let currentPage = 1;

    /* === –î–∞—Ç–∞/–∫–∞–ª–µ–Ω–¥–∞—Ä === */
    let currentISO = clampToTodayISO(getSavedDateISO());
    dateText.value = isoToBG(currentISO);

    const cal      = document.getElementById("calendar");
    const calGrid  = document.getElementById("calGrid");
    const calTitle = document.getElementById("calTitle");
    const calPrev  = document.getElementById("calPrev");
    const calNext  = document.getElementById("calNext");
    const calToday = document.getElementById("calToday");

    let view = (function(){ const [y,m]=currentISO.split("-").map(Number); return {year:y, month:m-1}; })();

    function getDataDateSet(){
      const set = new Set();
      for(const r of load()){ if(/^\d{4}-\d{2}-\d{2}$/.test(r.date)) set.add(r.date); }
      return set;
    }

    function prefillWeightForDate(iso){
      const rec = findRecord(iso);
      if(rec && typeof rec.weight==="number") { weight.value = rec.weight; return; }
      const prev = lastWeightBefore(iso);
      weight.value = prev!=="" ? prev : "";
    }

    function buildCalendar(){
      calTitle.textContent = `${MONTHS_BG[view.month]} ${view.year}`;
      calGrid.innerHTML = "";
      const dow = ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–ù–¥"];
      dow.forEach(d=>{ const el=document.createElement("div"); el.className="cal-dow"; el.textContent=d; calGrid.appendChild(el); });

      const first = new Date(view.year, view.month, 1);
      const last  = new Date(view.year, view.month+1, 0);
      let startIdx = (first.getDay()+6)%7;
      const daysInMonth = last.getDate();
      const todayISO = TODAY;
      const withData = getDataDateSet();

      for(let i=0;i<startIdx;i++){ const el=document.createElement("div"); el.className="cal-day dis"; el.textContent=" "; calGrid.appendChild(el); }

      for(let d=1; d<=daysInMonth; d++){
        const el=document.createElement("div"); el.className="cal-day"; el.textContent=d;
        const iso = `${view.year}-${String(view.month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        if(iso===currentISO) el.classList.add("sel");
        if(iso > todayISO) el.classList.add("dis");
        if(withData.has(iso)) el.classList.add("hasdata");
        el.addEventListener("click", ()=>{
          if(el.classList.contains("dis")) return;
          currentISO = iso;
          dateText.value = isoToBG(currentISO);
          saveLastDateISO(currentISO);
          prefillWeightForDate(currentISO);  // üî∏ –∞–≤—Ç–æ-–ø–æ–ø—ä–ª–≤–∞–Ω–µ
          closeCalendar();
          dateErr.style.display="none";
        });
        calGrid.appendChild(el);
      }
    }

    function openCalendar(){ cal.classList.add("open"); buildCalendar(); }
    function closeCalendar(){ cal.classList.remove("open"); }
    dateText.addEventListener("focus", openCalendar);
    dateText.addEventListener("click", openCalendar);
    document.addEventListener("click", (e)=>{ if(cal.contains(e.target)||e.target===dateText) return; closeCalendar(); });
    calPrev.addEventListener("click", ()=>{ if(view.month===0){view.month=11;view.year--;} else view.month--; buildCalendar(); });
    calNext.addEventListener("click", ()=>{ if(view.month===11){view.month=0;view.year++;} else view.month++; buildCalendar(); });
    calToday.addEventListener("click", ()=>{
      const t = TODAY.split("-"); view.year=+t[0]; view.month=+t[1]-1;
      currentISO = TODAY; dateText.value = isoToBG(currentISO); saveLastDateISO(currentISO);
      prefillWeightForDate(currentISO); // üî∏
      buildCalendar(); closeCalendar();
    });

    /* === –¢–∞–±–ª–∏—Ü–∞ + —Å—Ç—Ä–∞–Ω–∏—Ü–∏—Ä–∞–Ω–µ === */
    function renderTable(){
      const allDesc = sortDescByDate(load());
      const total = allDesc.length;
      const effectivePageSize = pageSize==="all" ? total||1 : pageSize;
      const pages = Math.max(1, Math.ceil(total / effectivePageSize));
      if(currentPage > pages) currentPage = pages;

      const start = (currentPage - 1) * effectivePageSize;
      const slice = allDesc.slice(start, start + effectivePageSize);

      tbody.innerHTML="";
      slice.forEach((r, idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${isoToBG(r.date)}</td><td>${r.weight??""}</td>
        <td class="right">
          <button class="icon-btn icon-only" title="–†–µ–¥–∞–∫—Ü–∏—è" data-edit="${start+idx}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21l3-1 11-11-2-2L4 18l-1 3z"/><path d="M14 5l5 5"/></svg>
          </button>
          <button class="icon-btn icon-only danger" title="–ò–∑—Ç—Ä–∏–π" data-del="${start+idx}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"/></svg>
          </button>
        </td>`;
        tbody.appendChild(tr);
      });

      // pager
      pager.innerHTML="";
      const infoWrap = document.createElement("div");
      infoWrap.style.display="flex"; infoWrap.style.alignItems="center"; infoWrap.style.gap="8px"; infoWrap.style.marginRight="auto";
      const info = document.createElement("span"); info.className="muted";
      const from = total ? start+1 : 0; const to = Math.min(start + effectivePageSize, total);
      info.textContent = `${from}-${to} –æ—Ç ${total}`; infoWrap.appendChild(info);

      const sizeWrap = document.createElement("div"); sizeWrap.className="page-size";
      const sizeSel = document.createElement("select"); sizeSel.id="pageSize";
      [10,20,50,100,"all"].forEach(opt=>{ const o=document.createElement("option"); o.value=String(opt); o.textContent=(opt==="all"?"–í—Å–∏—á–∫–∏":opt); if(opt===pageSize) o.selected=true; sizeSel.appendChild(o); });
      sizeWrap.appendChild(sizeSel); infoWrap.appendChild(sizeWrap); pager.appendChild(infoWrap);

      if(pages > 1){
        if(currentPage > 1){ const prev=document.createElement("button"); prev.textContent="‚Üê"; prev.onclick=()=>{currentPage=Math.max(1,currentPage-1); renderTable();}; pager.appendChild(prev); }
        const pagesToShow=7; let first=Math.max(1,currentPage-Math.floor(pagesToShow/2)); let last=Math.min(pages,first+pagesToShow-1); first=Math.max(1,last-pagesToShow+1);
        for(let p=first;p<=last;p++){ const btn=document.createElement("button"); btn.textContent=p; if(p===currentPage) btn.className="active"; btn.onclick=()=>{currentPage=p; renderTable();}; pager.appendChild(btn); }
        if(currentPage < pages){ const next=document.createElement("button"); next.textContent="‚Üí"; next.onclick=()=>{currentPage=Math.min(pages,currentPage+1); renderTable();}; pager.appendChild(next); }
      }

      sizeSel.addEventListener("change", ()=>{ const v=sizeSel.value==="all"?"all":Number(sizeSel.value); pageSize=v; savePageSize(v); currentPage=1; renderTable(); });
    }

    /* === –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ –∑–∞ –≥—Ä–∞—Ñ–∏–∫–∞ + –≤–µ—Ä—Ç–∏–∫–∞–ª–Ω–∏ –µ—Ç–∏–∫–µ—Ç–∏ === */
    function isoWeekYear(d){
      const tmp=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      tmp.setUTCDate(tmp.getUTCDate()+4-(tmp.getUTCDay()||7));
      return tmp.getUTCFullYear();
    }
    function isoWeekNumber(d){
      const tmp=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNr = (tmp.getUTCDay()||7);
      tmp.setUTCDate(tmp.getUTCDate()+4-dayNr);
      const yearStart=new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
      return Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
    }

    function aggregate(mode){
      const data = sortAscByDate(load()); // [{date, weight}]
      if(mode==="daily"){
        const values = data.map(r=> typeof r.weight==="number" ? r.weight : null);
        const labels = data.map(r=> isoToBGYY(r.date)); // DD.MM.YY
        return {values, labels};
      }
      if(mode==="weekly"){
        const map=new Map(); // key = YYYY-Www
        for(const r of data){
          const d=new Date(r.date+"T00:00:00");
          const key=`${isoWeekYear(d)}-W${String(isoWeekNumber(d)).padStart(2,"0")}`;
          const arr = map.get(key) || [];
          if(typeof r.weight==="number") arr.push(r.weight);
          map.set(key, arr);
        }
        const values=[]; const labels=[];
        for(const [key, arr] of map.entries()){
          const [yy, wwRaw] = key.split("-W");
          values.push(arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length) : null);
          labels.push(`–°${wwRaw}.${String(yy).slice(2)}`); // –°38.25
        }
        return {values, labels};
      }
      if(mode==="monthly"){
        const map=new Map(); // key = YYYY-MM
        for(const r of data){
          const key=r.date.slice(0,7);
          const arr = map.get(key) || [];
          if(typeof r.weight==="number") arr.push(r.weight);
          map.set(key, arr);
        }
        const values=[]; const labels=[];
        for(const [key, arr] of map.entries()){
          values.push(arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length) : null);
          const [y,m] = key.split("-");
          labels.push(`${m}.${String(y).slice(2)}`); // 09.25
        }
        return {values, labels};
      }
      return {values:[], labels:[]};
    }

    function renderChart(){
      const mode = spanSel.value;
      const {values, labels} = aggregate(mode);
      const ctx=document.getElementById("chart").getContext("2d");
      const mini=new MiniChart(ctx);
      mini.series = values;
      mini.labels = labels;
      mini.render();
    }

    spanSel.addEventListener("change", renderChart);

    function clearForm(){
      // –Ω–µ —á–∏—Å—Ç–∏–º —Ç–µ–≥–ª–æ—Ç–æ ‚Äî –ª–æ–≥–∏–∫–∞—Ç–∞ –≤–µ—á–µ –≥–æ –ø–æ–ø—ä–ª–≤–∞ —Å–ø—Ä—è–º–æ –¥–∞—Ç–∞—Ç–∞
      dateErr.style.display="none"; dateErr.textContent="";
      weightErr.style.display="none"; weightErr.textContent="";
    }

    /* === –î–æ–±–∞–≤—è–Ω–µ / —Ä–µ–¥–∞–∫—Ü–∏—è / —Ç—Ä–∏–µ–Ω–µ === */
    document.getElementById("add").addEventListener("click",()=>{
      let iso = bgToISO(dateText.value.trim());
      if(!iso) iso = TODAY;
      if(iso > TODAY){ dateErr.textContent="–î–∞—Ç–∞—Ç–∞ –µ –≤ –±—ä–¥–µ—â–µ—Ç–æ. –ú–æ–ª—è, –∏–∑–±–µ—Ä–∏ –¥–Ω–µ—à–Ω–∞ –∏–ª–∏ –º–∏–Ω–∞–ª–∞ –¥–∞—Ç–∞."; dateErr.style.display="block"; return; }
      const wRaw = weight.value.trim(); const wVal = wRaw==="" ? NaN : Number(wRaw);
      if(!(wVal > 0)){ weightErr.textContent="–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ —Ç–µ–≥–ª–æ > 0."; weightErr.style.display="block"; return; }

      const data=load(); const idx=data.findIndex(r=>r.date===iso);
      const rec={ date: iso, weight: wVal };
      if(idx>=0) data[idx]=rec; else data.push(rec);
      save(data);
      saveLastDateISO(iso);
      currentISO = iso;
      dateText.value = isoToBG(currentISO);
      renderTable(); renderChart();
      // –æ—Å—Ç–∞–≤—è–º–µ weight —Å—Ç–æ–π–Ω–æ—Å—Ç—Ç–∞ (–∑–∞ –±—ä—Ä–∑–∏ –ø–æ—Ä–µ–¥–Ω–∏ –¥–Ω–∏ –º–æ–∂–µ –¥–∞ —Å–º–µ–Ω–∏—à —Å–∞–º–æ –¥–∞—Ç–∞—Ç–∞)
    });

    document.addEventListener("click",(e)=>{
      const t=e.target; if(!t.closest("#table")) return;
      const allDesc = sortDescByDate(load());
      if(t.matches("button[data-del]")){
        const iDesc = +t.getAttribute("data-del"); const rec = allDesc[iDesc];
        let data = load(); const i = data.findIndex(r=> r.date===rec.date);
        if(i>=0){ data.splice(i,1); save(data); renderTable(); renderChart(); }
      } else if(t.matches("button[data-edit]")){
        const iDesc = +t.getAttribute("data-edit"); const rec = allDesc[iDesc];
        currentISO = clampToTodayISO(rec.date);
        dateText.value = isoToBG(currentISO);
        weight.value = rec.weight ?? "";
        window.scrollTo({top:0, behavior:"smooth"});
      }
    });

    /* === –ï–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç / –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ === */
    document.getElementById("export").addEventListener("click", ()=>{
      const data = load();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "bt-progress-export.json";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
    document.getElementById("importFile").addEventListener("change", async (ev)=>{
      const file = ev.target.files?.[0]; if(!file) return;
      try{
        const text = await file.text(); const parsed = JSON.parse(text);
        if(!Array.isArray(parsed)) throw new Error("–û—á–∞–∫–≤–∞–º –º–∞—Å–∏–≤ –æ—Ç –∑–∞–ø–∏—Å–∏.");
        const cleaned = [];
        for(const r of parsed){
          const date = typeof r.date==="string" ? r.date : "";
          const weight = (typeof r.weight==="number" && r.weight>0) ? r.weight : null;
          if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;
          if(date > TODAY) continue;
          cleaned.push({date, weight});
        }
        save(cleaned);
        renderTable(); renderChart();
        ev.target.value = ""; alert("–ò–º–ø–æ—Ä—Ç—ä—Ç –µ —É—Å–ø–µ—à–µ–Ω.");
      }catch(err){ console.error(err); alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç. –û—á–∞–∫–≤–∞–º JSON –º–∞—Å–∏–≤ –æ—Ç {date:'YYYY-MM-DD', weight:number>0}."); }
    });

    document.getElementById("wipe").addEventListener("click", ()=>{
      if(confirm("–ù–∞–∏—Å—Ç–∏–Ω–∞ –ª–∏ –¥–∞ –∏–∑—Ç—Ä–∏—è –≤—Å–∏—á–∫–∏ –∑–∞–ø–∏—Å–∏?")){
        save([]); renderTable(); renderChart();
      }
    });

    // –ø—ä—Ä–≤–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ä–∞–Ω–µ + –∞–≤—Ç–æ-–ø–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ —Ç–µ–≥–ª–æ—Ç–æ –∑–∞ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ –¥–∞—Ç–∞
    prefillWeightForDate(currentISO);
    renderTable(); renderChart();
  </script>
</body>
</html>
