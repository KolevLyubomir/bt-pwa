<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BT — Тегло v14</title>
  <link rel="manifest" href="manifest.webmanifest?v=14">
  <meta name="theme_color" content="#10b981">
  <link rel="icon" href="assets/icons/icon-192.png?v=14">
  <style>
    :root{--bg:#0b1215;--card:#111a1f;--text:#e6f2ef;--muted:#9fb4ad;--accent:#10b981;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
         background:linear-gradient(180deg,#071013,#0b1215);color:var(--text)}
    header{position:sticky;top:0;background:#071013aa;backdrop-filter:blur(6px);border-bottom:1px solid #1e2b30;
           padding:12px 16px;display:flex;gap:12px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}
    .badge{display:inline-block;background:#f59e0b;color:#06241b;font-weight:700;border-radius:10px;padding:2px 8px;margin-left:8px}
    main{max-width:900px;margin:20px auto;padding:0 16px 40px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1e2b30;border-radius:16px;padding:16px;box-shadow:0 10px 30px #00000040}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{border-radius:12px;border:1px solid #254046;background:#0d171b;color:var(--text);
                        padding:10px 12px;font-size:14px}
    button{background:var(--accent);border:none;color:#06241b;font-weight:700;cursor:pointer}
    button.ghost{background:#0d171b;color:#e6f2ef;border:1px solid #2a3e41}
    button.danger{background:#ef4444;color:white}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #20343a;text-align:left;font-size:14px}
    th{color:#9fb4ad;font-weight:600}
    .right{text-align:right}
    canvas{max-width:100%;height:320px}
    .pagination{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:10px}
    .pagination button{background:#0d171b;border:1px solid #2a3e41;color:#e6f2ef;padding:6px 10px;border-radius:10px;cursor:pointer}
    .pagination button.active{background:#10b981;color:#06241b;border-color:#10b981}
    .pagination .muted{color:#9fb4ad;margin-right:auto}
    .page-size select{background:#0d171b;border:1px solid #2a3e41;color:#e6f2ef;border-radius:10px;padding:6px 8px}
    .error{color:#ef4444;font-size:13px;margin-top:6px}

    /* Календар (вграден) */
    .cal-wrap{position:relative}
    .calendar{position:absolute; top:100%; left:0; z-index:20; background:#0d171b; border:1px solid #2a3e41;
              border-radius:12px; padding:10px; margin-top:6px; box-shadow:0 10px 30px #00000055; width:270px; display:none}
    .calendar.open{display:block}
    .cal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .cal-head button{background:#0f1a1f; border:1px solid #2a3e41; color:#e6f2ef; padding:4px 8px; border-radius:8px; cursor:pointer}
    .cal-title{font-weight:700; color:#e6f2ef}
    .cal-grid{display:grid; grid-template-columns:repeat(7, 1fr); gap:4px}
    .cal-dow, .cal-day{ text-align:center; padding:6px 0; border-radius:8px; }
    .cal-dow{ color:#9fb4ad; font-size:12px }
    .cal-day{ background:#0f1a1f; border:1px solid #20343a; cursor:pointer }
    .cal-day.dis{ opacity:.35; cursor:not-allowed }
    .cal-day.sel{ border-color:#10b981; outline:2px solid #10b98166 }
    .cal-foot{ display:flex; justify-content:flex-end; margin-top:8px }
    .cal-foot button{ background:#10b981; color:#06241b; border:none; border-radius:8px; padding:6px 10px; font-weight:700 }
  </style>
</head>
<body>
  <header>
    <img src="assets/icons/icon-192.png?v=14" width="28" height="28" alt="BT">
    <h1>Безопасно Тегло — Тракер <span class="badge">v14</span></h1>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 8px">Нов запис</h2>
      <div class="row">
        <div style="flex:1;min-width:220px" class="cal-wrap">
          <label for="dateText">Дата</label>
          <input id="dateText" type="text" inputmode="numeric" placeholder="ДД.ММ.ГГГГ" autocomplete="off">
          <div id="dateErr" class="error" style="display:none"></div>

          <!-- Календар -->
          <div class="calendar" id="calendar">
            <div class="cal-head">
              <button id="calPrev">‹</button>
              <div class="cal-title" id="calTitle">Септември 2025</div>
              <button id="calNext">›</button>
            </div>
            <div class="cal-grid" id="calGrid">
              <!-- дни се генерират динамично -->
            </div>
            <div class="cal-foot">
              <button id="calToday">Днес</button>
            </div>
          </div>
        </div>

        <div style="flex:1;min-width:140px">
          <label for="weight">Тегло (kg)</label>
          <input id="weight" type="number" step="0.1" min="0.1">
          <div id="weightErr" class="error" style="display:none"></div>
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="add">Добави</button>
        <button class="ghost" id="export">Експорт (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="ghost" id="importBtn">Импорт</button>
        <button class="danger" id="wipe">Изтрий всички</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Графика</h2>
      <div class="row">
        <div>
          <label for="span">Период</label>
          <select id="span">
            <option value="30">30 дни</option>
            <option value="90">90 дни</option>
            <option value="365">1 година</option>
            <option value="all">Всички</option>
          </select>
        </div>
      </div>
      <canvas id="chart"></canvas>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Записи</h2>
      <table id="table">
        <thead><tr><th>Дата</th><th>Тегло (kg)</th><th class="right">Действия</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="pagination" id="pager"></div>
    </section>
  </main>

  <script>
    /* === Формати и дати === */
    function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    const TODAY = todayISO();

    // YYYY-MM-DD -> DD.MM.YYYY
    function isoToBG(iso){
      if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return "";
      const [y,m,d]=iso.split("-");
      return `${d}.${m}.${y}`;
    }
    // DD.MM.YYYY -> YYYY-MM-DD
    function bgToISO(bg){
      const m = /^(\d{2})\.(\d{2})\.(\d{4})$/.exec(bg);
      if(!m) return "";
      const [_, dd, mm, yyyy] = m;
      return `${yyyy}-${mm}-${dd}`;
    }
    function clampToTodayISO(iso){ return iso && iso > TODAY ? TODAY : iso; }

    // локално състояние
    function load(){ try{return JSON.parse(localStorage.getItem("bt-progress")||"[]");}catch{return [];} }
    function save(d){ localStorage.setItem("bt-progress", JSON.stringify(d)); }
    function sortDescByDate(arr){ return [...arr].sort((a,b)=> b.date.localeCompare(a.date)); }
    function sortAscByDate(arr){ return [...arr].sort((a,b)=> a.date.localeCompare(b.date)); }
    function getSavedDateISO(){ return localStorage.getItem("bt-last-date") || TODAY; }
    function saveLastDateISO(iso){ localStorage.setItem("bt-last-date", iso); }

    /* === Мини графика === */
    class MiniChart{
      constructor(ctx){ this.ctx=ctx; this.data=[]; }
      render(){
        const c=this.ctx.canvas, w=c.width=c.clientWidth, h=c.height=320;
        const ctx=this.ctx; ctx.clearRect(0,0,w,h);
        const vals=this.data.filter(v=>typeof v==='number');
        ctx.fillStyle="#9fb4ad"; ctx.font="14px system-ui";
        if(vals.length<2){ ctx.fillText("Добави поне 2 записа за графика", 10, 24); return; }
        const min=Math.min(...vals), max=Math.max(...vals), pad=24;
        ctx.strokeStyle="#87f3c5"; ctx.lineWidth=2; ctx.beginPath();
        this.data.forEach((v,i)=>{
          const x=pad + (w-2*pad)*(i/(this.data.length-1));
          const y=h-pad - ((v-min)/((max-min)||1))*(h-2*pad);
          i?ctx.lineTo(x,y):ctx.moveTo(x,y);
        });
        ctx.stroke();
      }
    }

    /* === Елементи === */
    const dateText = document.getElementById("dateText");
    const dateErr  = document.getElementById("dateErr");
    const weight   = document.getElementById("weight");
    const weightErr= document.getElementById("weightErr");
    const tbody    = document.querySelector("#table tbody");
    const pager    = document.getElementById("pager");

    // Пейджинг настройки
    const PAGE_SIZES = [10,20,50,100,"all"];
    function getSavedPageSize(){
      const v = localStorage.getItem("bt-page-size");
      if(v==="all") return "all";
      const n = Number(v);
      return PAGE_SIZES.includes(n) ? n : 20;
    }
    function savePageSize(v){ localStorage.setItem("bt-page-size", v); }
    let pageSize = getSavedPageSize();
    let currentPage = 1;

    /* === Инициализация на дата (поле + календар) === */
    let currentISO = clampToTodayISO(getSavedDateISO());
    dateText.value = isoToBG(currentISO);

    // Календар
    const cal      = document.getElementById("calendar");
    const calGrid  = document.getElementById("calGrid");
    const calTitle = document.getElementById("calTitle");
    const calPrev  = document.getElementById("calPrev");
    const calNext  = document.getElementById("calNext");
    const calToday = document.getElementById("calToday");

    const MONTHS_BG = ["Януари","Февруари","Март","Април","Май","Юни","Юли","Август","Септември","Октомври","Ноември","Декември"];
    let view = (function(){
      const [y,m] = currentISO.split("-").map(Number);
      return {year:y, month:m-1}; // 0-based
    })();

    function buildCalendar(){
      // заглавие
      calTitle.textContent = `${MONTHS_BG[view.month]} ${view.year}`;

      // мрежа: Mon..Sun
      calGrid.innerHTML = "";
      const dow = ["Пн","Вт","Ср","Чт","Пт","Сб","Нд"];
      dow.forEach(d=>{
        const el=document.createElement("div");
        el.className="cal-dow";
        el.textContent=d;
        calGrid.appendChild(el);
      });

      const first = new Date(view.year, view.month, 1);
      const last  = new Date(view.year, view.month+1, 0);
      // JS: Неделя=0 → искаме Понеделник=0
      let startIdx = (first.getDay()+6)%7;
      const daysInMonth = last.getDate();

      // предходни празни (или числа от предния месец)
      for(let i=0; i<startIdx; i++){
        const el=document.createElement("div");
        el.className="cal-day dis";
        el.textContent=" ";
        calGrid.appendChild(el);
      }

      const todayISO = TODAY;
      for(let d=1; d<=daysInMonth; d++){
        const el=document.createElement("div");
        el.className="cal-day";
        el.textContent = d;

        const iso = `${view.year}-${String(view.month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        // маркирай избраната
        if(iso===currentISO) el.classList.add("sel");
        // забрани бъдещи
        if(iso > todayISO) el.classList.add("dis");

        el.addEventListener("click", ()=>{
          if(el.classList.contains("dis")) return;
          currentISO = iso;
          dateText.value = isoToBG(currentISO);
          saveLastDateISO(currentISO);
          closeCalendar();
          // презареди евентуални грешки
          dateErr.style.display="none";
        });

        calGrid.appendChild(el);
      }
    }

    function openCalendar(){
      cal.classList.add("open");
      buildCalendar();
    }
    function closeCalendar(){
      cal.classList.remove("open");
    }

    // отваряне при фокус/клик
    dateText.addEventListener("focus", openCalendar);
    dateText.addEventListener("click", openCalendar);

    // навигация
    calPrev.addEventListener("click", ()=>{
      if(view.month===0){ view.month=11; view.year--; } else view.month--;
      buildCalendar();
    });
    calNext.addEventListener("click", ()=>{
      if(view.month===11){ view.month=0; view.year++; } else view.month++;
      buildCalendar();
    });
    calToday.addEventListener("click", ()=>{
      const t = TODAY.split("-");
      view.year = Number(t[0]); view.month = Number(t[1])-1;
      currentISO = TODAY;
      dateText.value = isoToBG(currentISO);
      saveLastDateISO(currentISO);
      buildCalendar();
      closeCalendar();
    });

    // въвеждане на ръка (ДД.ММ.ГГГГ)
    dateText.addEventListener("input", ()=>{
      const iso = bgToISO(dateText.value.trim());
      if(iso){
        currentISO = clampToTodayISO(iso);
      }
    });
    dateText.addEventListener("change", ()=>{
      // нормализирай стойността (ако е бъдеща → TODAY)
      const iso = bgToISO(dateText.value.trim());
      const norm = clampToTodayISO(iso || TODAY);
      currentISO = norm;
      dateText.value = isoToBG(currentISO);
      saveLastDateISO(currentISO);
      dateErr.style.display="none";
    });

    // клик извън календара → затваряне
    document.addEventListener("click", (e)=>{
      if(cal.contains(e.target) || e.target===dateText) return;
      closeCalendar();
    });

    /* === Таблица + странициране === */
    function renderTable(){
      const allDesc = sortDescByDate(load());
      const total = allDesc.length;

      const effectivePageSize = pageSize==="all" ? total||1 : pageSize;
      const pages = Math.max(1, Math.ceil(total / effectivePageSize));
      if(currentPage > pages) currentPage = pages;

      const start = (currentPage - 1) * effectivePageSize;
      const slice = allDesc.slice(start, start + effectivePageSize);

      tbody.innerHTML="";
      slice.forEach((r, idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${isoToBG(r.date)}</td><td>${r.weight??""}</td>
        <td class="right"><button class="ghost" data-edit="${start+idx}">Редакция</button>
        <button class="danger" data-del="${start+idx}">Изтрий</button></td>`;
        tbody.appendChild(tr);
      });

      // pager
      pager.innerHTML="";
      const infoWrap = document.createElement("div");
      infoWrap.style.display="flex";
      infoWrap.style.alignItems="center";
      infoWrap.style.gap="8px";
      infoWrap.style.marginRight="auto";

      const info = document.createElement("span");
      info.className="muted";
      const from = total ? start+1 : 0;
      const to = Math.min(start + effectivePageSize, total);
      info.textContent = `${from}-${to} от ${total}`;
      infoWrap.appendChild(info);

      const sizeWrap = document.createElement("div");
      sizeWrap.className="page-size";
      const sizeSel = document.createElement("select");
      sizeSel.id = "pageSize";
      PAGE_SIZES.forEach(opt=>{
        const o = document.createElement("option");
        o.value = String(opt);
        o.textContent = (opt==="all" ? "Всички" : opt);
        if(opt===pageSize) o.selected = true;
        sizeSel.appendChild(o);
      });
      sizeWrap.appendChild(sizeSel);
      infoWrap.appendChild(sizeWrap);
      pager.appendChild(infoWrap);

      const pagesToShow = 7;
      if(pages > 1){
        if(currentPage > 1){
          const prev = document.createElement("button");
          prev.textContent = "←";
          prev.onclick = ()=>{ currentPage=Math.max(1,currentPage-1); renderTable(); };
          pager.appendChild(prev);
        }
        let first = Math.max(1, currentPage - Math.floor(pagesToShow/2));
        let last = Math.min(pages, first + pagesToShow - 1);
        first = Math.max(1, last - pagesToShow + 1);
        for(let p=first; p<=last; p++){
          const btn = document.createElement("button");
          btn.textContent = p;
          if(p===currentPage) btn.className="active";
          btn.onclick = ()=>{ currentPage=p; renderTable(); };
          pager.appendChild(btn);
        }
        if(currentPage < pages){
          const next = document.createElement("button");
          next.textContent = "→";
          next.onclick = ()=>{ currentPage=Math.min(pages,currentPage+1); renderTable(); };
          pager.appendChild(next);
        }
      }

      sizeSel.addEventListener("change", ()=>{
        const v = sizeSel.value === "all" ? "all" : Number(sizeSel.value);
        pageSize = v;
        savePageSize(v);
        currentPage = 1;
        renderTable();
      });
    }

    /* === Графика === */
    function renderChart(){
      const allAsc = sortAscByDate(load());
      let filtered = allAsc;
      const span=document.getElementById("span").value;
      if(span!=="all"){
        const days=parseInt(span,10);
        const cut=new Date(); cut.setDate(cut.getDate()-days);
        filtered = allAsc.filter(r=> new Date(r.date)>=cut );
      }
      const vals = filtered.map(r=> Number(r.weight) || null);
      const ctx=document.getElementById("chart").getContext("2d");
      const mini=new MiniChart(ctx); mini.data=vals; mini.render();
    }

    function clearForm(){
      weight.value="";
      dateErr.style.display="none"; dateErr.textContent="";
      weightErr.style.display="none"; weightErr.textContent="";
    }

    /* === Добавяне / редакция / триене === */
    document.getElementById("add").addEventListener("click",()=>{
      let iso = bgToISO(dateText.value.trim());
      if(!iso) iso = TODAY;
      if(iso > TODAY){
        dateErr.textContent = "Датата е в бъдещето. Моля, избери днешна или минала дата.";
        dateErr.style.display = "block";
        return;
      }

      const wRaw = weight.value.trim();
      const wVal = wRaw === "" ? NaN : Number(wRaw);
      if(!(wVal > 0)){
        weightErr.textContent = "Моля, въведи тегло > 0.";
        weightErr.style.display = "block";
        return;
      }

      const rec={ date: iso, weight: wVal };
      const data=load();
      const idx=data.findIndex(r=>r.date===rec.date);
      if(idx>=0) data[idx]=rec; else data.push(rec);
      save(data);
      saveLastDateISO(iso);
      currentISO = iso;
      dateText.value = isoToBG(currentISO);
      renderTable(); renderChart(); clearForm();
    });

    document.addEventListener("click",(e)=>{
      const t=e.target; if(!t.closest("#table")) return;
      const allDesc = sortDescByDate(load());
      if(t.matches("button[data-del]")){
        const iDesc = +t.getAttribute("data-del");
        const rec = allDesc[iDesc];
        let data = load();
        const i = data.findIndex(r=> r.date===rec.date);
        if(i>=0){ data.splice(i,1); save(data); renderTable(); renderChart(); }
      } else if(t.matches("button[data-edit]")){
        const iDesc = +t.getAttribute("data-edit");
        const rec = allDesc[iDesc];
        currentISO = clampToTodayISO(rec.date);
        dateText.value = isoToBG(currentISO);
        weight.value = rec.weight ?? "";
        window.scrollTo({top:0, behavior:"smooth"});
      }
    });

    /* === Експорт / Импорт / Изтриване === */
    document.getElementById("export").addEventListener("click", ()=>{
      const data = load();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "bt-progress-export.json";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById("importBtn").addEventListener("click", ()=>{
      document.getElementById("importFile").click();
    });
    document.getElementById("importFile").addEventListener("change", async (ev)=>{
      const file = ev.target.files?.[0]; if(!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        if(!Array.isArray(parsed)) throw new Error("Очаквам масив от записи.");
        const cleaned = [];
        for(const r of parsed){
          const date = typeof r.date==="string" ? r.date : "";
          const weight = (typeof r.weight==="number" && r.weight>0) ? r.weight : null;
          if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;
          if(date > TODAY) continue; // игнорирай бъдещи
          cleaned.push({date, weight});
        }
        save(cleaned);
        renderTable(); renderChart();
        ev.target.value = "";
        alert("Импортът е успешен.");
      }catch(err){
        console.error(err);
        alert("Грешка при импорт. Файлът трябва да е JSON масив от {date:'YYYY-MM-DD', weight:number>0}.");
      }
    });

    document.getElementById("wipe").addEventListener("click", ()=>{
      if(confirm("Наистина ли да изтрия всички записи?")){
        save([]); renderTable(); renderChart();
      }
    });

    // първо рендериране
    renderTable(); renderChart();
  </script>
</body>
</html>
