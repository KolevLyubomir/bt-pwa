<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>БТ App 3 — v2.10.05</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="theme-color" content="#0b1215"/>
<link rel="manifest" href="manifest.webmanifest?v=1.39"/>
<link rel="icon" href="assets/icons/icon-192.png?v=1.39"/>

<style>
:root{
  --bg:#0b1215; --card:#111a1f; --text:#e6f2ef; --muted:#9fb4ad;
  --accent:#10b981; --border:#1e2b30; --has:#c7f5df; --danger:#ef4444;
  --ctl-h:42px; --lbl-h:16px; --maxw:980px;
  --chart-label:15px; --chart-values:15px;
  --line-green:#87f3c5; --line-orange:#f59e0b; --line-neutral:#2dd4bf;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,"Noto Sans",sans-serif}

/* Горна лента */
.topbar-wrap{position:sticky;top:0;z-index:10;background:#0b1215;border-bottom:1px solid var(--border)}
.topbar{max-width:var(--maxw);margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:center;gap:10px}
.topbar .brand{display:flex;align-items:center;gap:10px;font-weight:800}
.topbar .brand img{width:24px;height:24px}
.topbar .title{font-size:18px;font-weight:800}
.topbar .badge{font-size:12px;font-weight:800;color:#06241b;background:linear-gradient(90deg,#22c55e,#14b8a6);padding:2px 8px;border-radius:10px}

/* Табове */
.tabs-wrap{background:#0b1215;border-bottom:1px solid var(--border)}
.tabs{max-width:var(--maxw);margin:0 auto;padding:10px 16px;display:flex;gap:8px}
.tab-btn{appearance:none;border:1px solid var(--border);background:#0d171b;color:#e6f2ef;
  padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:800;font-size:16px}
.tab-btn[aria-selected="true"]{color:#06241b;border-color:transparent;background:linear-gradient(90deg,#22c55e,#14b8a6)}

/* Основно */
main{max-width:var(--maxw);margin:20px auto;padding:0 16px 40px;display:grid;gap:16px;align-content:start}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
input,select,button{background:#0d171b;border:1px solid #254046;color:var(--text);
  border-radius:10px;padding:8px 10px;font-size:14px;height:var(--ctl-h)}
button{cursor:pointer} button.primary{background:var(--accent);border-color:var(--accent);color:#06241b;font-weight:700}
.lbl{height:var(--lbl-h);line-height:var(--lbl-h);font-size:12px;color:var(--muted);margin:0 0 6px 0}

/* ПАНЕЛ „Данни“ */
.row-fixed{display:flex;align-items:flex-end;gap:12px;flex-wrap:nowrap}
.f{display:flex;flex-direction:column}
.f-date{width:120px} .f-weight{width:140px}
.f-weight input{font-weight:700;font-size:18px}
.bt-only{display:flex;align-items:center;justify-content:center;width:var(--ctl-h);height:var(--ctl-h);
  border:1px solid #334a4f;background:#0d171b;border-radius:10px}
.bt-only input{width:16px;height:16px;margin:0}

/* Календар — не участва в layout (display:none, abs) */
.date-wrap{position:relative}
#dateText[readonly]{cursor:pointer}
.cal{position:absolute;z-index:50;top:calc(var(--ctl-h) + 6px);left:0;background:#0e1518;border:1px solid #20343a;border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,.35);padding:10px;display:none}
.cal.show{display:block}
.cal .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
.cal .cal-head button{padding:4px 8px;border-radius:8px}
.cal .cal-title{font-weight:700;text-transform:capitalize}
.cal-grid{display:grid;grid-template-columns:repeat(7,36px);gap:6px;justify-content:center}
.cal .dow{color:#9fb4ad;font-size:11px;text-align:center;line-height:36px;height:36px}
.cal .day{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:1px solid transparent}
.cal .day:hover{border-color:#27454a}
.cal .day.disabled{opacity:.35;pointer-events:none}
.cal .day.has{background:var(--has);color:#092218}
.cal .day.today{outline:1px dashed #5b8f98}
.cal .day.sel{background:#84e9c2;color:#041915;font-weight:700}

/* Графика и таблица */
canvas{width:100%;height:360px;display:block;margin-top:8px;background:#0b1215;border:1px solid #1a2a2f;border-radius:8px}
table{width:100%;border-collapse:collapse;table-layout:fixed}
colgroup col.date{width:80px} colgroup col.w{width:100px} colgroup col.act{width:auto}
th,td{padding:3px 4px;border-bottom:1px solid #20343a;font-size:13px;white-space:nowrap;text-align:left;vertical-align:middle}
th{color:var(--muted);font-weight:600} th.w,td.w{text-align:right}
.actions{display:inline-flex;gap:6px;align-items:center}
.actions .icon{display:inline-flex;align-items:center;justify-content:center;border:1px solid #2a3e41;background:#0d171b;border-radius:8px;padding:4px 6px;height:28px}
.actions .icon svg{width:16px;height:16px;stroke:currentColor}
.actions .danger{border-color:#3a2222;background:#161112;color:#ffd5d5}
td.actions{min-width:120px}

/* Пагинация */
.pager{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-start;margin-top:8px}
.pager .info{color:#9fb4ad;font-size:12px;margin:0 8px 0 0}
.pager button{background:#0d171b;border:1px solid #2a3e41;color:#fff;padding:4px 8px;border-radius:8px;font-size:13px}
.pager button.active{background:var(--accent);color:#06241b;border-color:var(--accent)}

/* ПАНЕЛ „Програма“ */
.dose-row{display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap;margin:8px 0 0}
.pill{display:flex;flex-direction:column;gap:6px;padding:8px 10px;background:#0d171b;border:1px solid #254046;border-radius:10px;min-width:170px}
.pill label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px}
.pill input[type="checkbox"]{width:16px;height:16px;margin:0}
.tp .lbl{margin:0}

/* Показване на панели */
.tabpanel{display:none}
.tabpanel[aria-hidden="false"]{display:block}
</style>
</head>
<body>
<!-- Горна лента -->
<div class="topbar-wrap">
  <div class="topbar">
    <div class="brand">
      <img src="assets/icons/icon-192.png?v=1.39" alt="BT"/>
      <span class="title">BT&nbsp;Безопасно Тегло —</span>
      <span class="badge">v2.10.05</span>
    </div>
  </div>
</div>

<!-- Табове -->
<div class="tabs-wrap" role="navigation" aria-label="Навигация">
  <div class="tabs" role="tablist">
    <button id="tab-data" class="tab-btn" role="tab" aria-controls="panel-data" aria-selected="true">Данни</button>
    <button id="tab-program" class="tab-btn" role="tab" aria-controls="panel-program" aria-selected="false">Програма</button>
  </div>
</div>

<!-- ПАНЕЛ: ДАННИ -->
<div id="panel-data" class="tabpanel" role="tabpanel" aria-labelledby="tab-data" aria-hidden="false">
  <main>
    <!-- Запис -->
    <section class="card">
      <h2 style="margin:0 0 10px">Запис</h2>
      <div class="row-fixed">
        <div class="f f-date">
          <div class="lbl">Дата</div>
          <div class="date-wrap">
            <input id="dateText" type="text" readonly placeholder="ДД.ММ.ГГ"/>
            <div id="cal" class="cal" role="dialog" aria-label="Календар"></div>
          </div>
        </div>
        <div class="f f-weight">
          <div class="lbl">Тегло (kg)</div>
          <input id="weight" type="number" step="0.1" min="0.1" placeholder="107.7"/>
        </div>
        <div class="f" style="width:42px">
          <div class="lbl">БТ</div>
          <label class="bt-only" title="Маркиран като БТ"><input id="btFlag" type="checkbox" checked/></label>
        </div>
        <div class="f" style="min-width:110px">
          <div class="lbl">&nbsp;</div>
          <button id="addBtn" class="primary" type="button">Добави</button>
        </div>
        <!-- инструменти -->
        <div class="f">
          <div class="lbl">&nbsp;</div>
          <div class="actions">
            <button id="exportBtn" class="icon" title="Експорт" aria-label="Експорт" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 16V4M12 4l-4 4M12 4l4 4"></path><path d="M4 20h16"></path>
              </svg>
            </button>
            <input id="importFile" type="file" accept="application/json" style="display:none"/>
            <button id="importBtn" class="icon" title="Импорт" aria-label="Импорт" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8v12M12 20l-4-4M12 20l4-4"></path><path d="M4 4h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Графика -->
    <section class="card">
      <h2 style="margin:0 0 10px">Графика</h2>
      <div><select id="aggSel" title="Агрегация">
        <option value="daily" selected>Дни (всички/страница)</option>
        <option value="weekly">Седмици (средно — всички)</option>
        <option value="monthly">Месеци (средно — всички)</option>
      </select></div>
      <canvas id="chart"></canvas>
    </section>

    <!-- Записи -->
    <section class="card">
      <h2 style="margin:0">Записи</h2>
      <div class="actions" style="margin:6px 0 8px">
        <label for="pageSize" style="font-size:12px;color:#9fb4ad">На страница:</label>
        <select id="pageSize">
          <option value="7">7 (1 сед.)</option>
          <option value="14">14 (2 сед.)</option>
          <option value="28" selected>28 (~1 мес.)</option>
          <option value="84">84 (~3 мес.)</option>
          <option value="112">112 (~4 мес.)</option>
          <option value="168">168 (~6 мес.)</option>
          <option value="336">336 (~12 мес.)</option>
          <option value="all">Всички</option>
        </select>
      </div>
      <div class="pager" id="pagerTop"></div>
      <table id="tbl">
        <colgroup><col class="date"><col class="w"><col class="act"></colgroup>
        <thead><tr><th class="date">Дата</th><th class="w">Тегло (kg)</th><th class="actions">Действия</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th class="date">Дата</th><th class="w">Тегло (kg)</th><th class="actions">Действия</th></tr></tfoot>
      </table>
      <div class="pager" id="pagerBottom"></div>
    </section>
  </main>
</div>

<!-- ПАНЕЛ: ПРОГРАМА -->
<div id="panel-program" class="tabpanel" role="tabpanel" aria-labelledby="tab-program" aria-hidden="true">
  <main>
    <section class="card" id="pkg-core">
      <h2 style="margin:0 0 10px">Основен пакет</h2>

      <!-- ProLact Slim+ -->
      <div>
        <strong>ProLact Slim+</strong>
        <div class="dose-row" role="group" aria-label="ProLact Slim+ — 2 от 3">
          <span class="pill">
            <label><input type="checkbox" id="pl-m"> Сутрин</label>
            <div id="pl-tp-m" class="tp"><div class="lbl">Час за Сутрин</div><select id="pl-sel-m"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="pl-n" checked> Обед</label>
            <div id="pl-tp-n" class="tp"><div class="lbl">Час за Обед</div><select id="pl-sel-n"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="pl-e" checked> Вечер</label>
            <div id="pl-tp-e" class="tp"><div class="lbl">Час за Вечер</div><select id="pl-sel-e"></select></div>
          </span>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--border);margin:14px 0"/>

      <!-- OMNi-Biotic HETOX light -->
      <div>
        <strong>OMNi-Biotic HETOX light</strong>
        <div class="dose-row" role="group" aria-label="HETOX — 1 от 3">
          <span class="pill">
            <label><input type="checkbox" id="he-m"> Сутрин</label>
            <div id="he-tp-m" class="tp"><div class="lbl">Час за Сутрин</div><select id="he-sel-m"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="he-n" checked> Обед</label>
            <div id="he-tp-n" class="tp"><div class="lbl">Час за Обед</div><select id="he-sel-n"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="he-e"> Вечер</label>
            <div id="he-tp-e" class="tp"><div class="lbl">Час за Вечер</div><select id="he-sel-e"></select></div>
          </span>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--border);margin:14px 0"/>

      <!-- Fortex Хитозан Плюс -->
      <div>
        <strong>Fortex Хитозан Плюс — Хитозан, Л-карнитин, Хром</strong>
        <div class="dose-row" role="group" aria-label="Хитозан Плюс">
          <span class="pill">
            <label><input type="checkbox" id="ch-m" checked disabled> Сутрин</label>
            <div id="ch-tp-m" class="tp"><div class="lbl">Час за Сутрин</div><select id="ch-sel-m"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="ch-n" checked disabled> Обед</label>
            <div id="ch-tp-n" class="tp"><div class="lbl">Час за Обед</div><select id="ch-sel-n"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="ch-e" checked disabled> Вечер</label>
            <div id="ch-tp-e" class="tp"><div class="lbl">Час за Вечер</div><select id="ch-sel-e"></select></div>
          </span>
        </div>
      </div>
    </section>

    <section class="card" id="pkg-extra">
      <h2 style="margin:0 0 10px">Допълнителен пакет</h2>
      <ul style="margin:8px 0 0; padding-left:1rem; line-height:1.5">
        <li><strong>Берберин 500–600 mg</strong> — марка по избор</li>
        <li><strong>Глюкоманан</strong> (NOW Foods)</li>
        <li><strong>EGCg</strong> — екстракт от зелен чай (NOW Foods)</li>
      </ul>
      <p style="color:#9fb4ad;font-size:12px">Добавят се по избор според индивидуалния план.</p>
    </section>

    <section class="card" id="pkg-personal">
      <h2 style="margin:0 0 10px">Личен режим</h2>
      <p style="color:#9fb4ad;font-size:12px">Свободен списък за твои добавки, витамини и др.</p>
    </section>
  </main>
</div>

<script>
"use strict";
window.__BT_VER='2.10.05';

/* Табове */
(function(){
  const tabs=[
    {btn:document.getElementById('tab-data'), panel:document.getElementById('panel-data')},
    {btn:document.getElementById('tab-program'), panel:document.getElementById('panel-program')}
  ];
  function select(i){
    tabs.forEach((t,idx)=>{const sel=idx===i;
      t.btn.setAttribute('aria-selected', String(sel));
      t.panel.setAttribute('aria-hidden', String(!sel));
    });
    try{localStorage.setItem('bt_active_tab_v21005', String(i));}catch(_){}
  }
  tabs.forEach((t,idx)=>t.btn.addEventListener('click',()=>select(idx)));
  const saved=parseInt(localStorage.getItem('bt_active_tab_v21005'),10);
  if(Number.isInteger(saved)&&saved>=0&&saved<tabs.length) select(saved); else select(0);
})();

/* Помощни за часове */
function hhmmToMin(hhmm){const [h,m]=hhmm.split(":").map(Number);return h*60+m;}
function minToHHMM(min){min=(min+1440)%1440;const h=Math.floor(min/60),m=min%60;return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");}
function fillHours(sel,startMin,endMin){
  sel.innerHTML=""; const start=Math.max(0,Math.min(startMin,23*60)), end=Math.max(start,Math.min(endMin,23*60));
  for(let t=start;t<=end;t+=60){const o=document.createElement("option");o.value=minToHHMM(t);o.textContent=o.value;sel.appendChild(o);}
}
function setSelectValue(sel,val){const o=[...sel.options].find(x=>x.value===val);if(o){sel.value=val;return true;}return false;}
function clampToRange(sel,want){if(!setSelectValue(sel,want)){if(sel.options.length) sel.value=sel.options[0].value;}}

/* ProLact Slim+ — 2 от 3 */
(function(){
  const KEY_SEL='bt_pl_sel_v21005', KEY_TIM='bt_pl_tim_v21005';
  const m=document.getElementById('pl-m'), n=document.getElementById('pl-n'), e=document.getElementById('pl-e');
  const tpM=document.getElementById('pl-tp-m'), tpN=document.getElementById('pl-tp-n'), tpE=document.getElementById('pl-tp-e');
  const selM=document.getElementById('pl-sel-m'), selN=document.getElementById('pl-sel-n'), selE=document.getElementById('pl-sel-e');
  const DEF_M="08:00", DEF_N="12:00", DEF_E="19:00";

  function saveSel(){localStorage.setItem(KEY_SEL, JSON.stringify({m:m.checked,n:n.checked,e:e.checked}));}
  function loadSel(){
    try{const r=JSON.parse(localStorage.getItem(KEY_SEL)||''); if(r){m.checked=r.m;n.checked=r.n;e.checked=r.e;return;}}catch(_){}
    m.checked=false; n.checked=true; e.checked=true;
  }
  function saveTim(t){localStorage.setItem(KEY_TIM, JSON.stringify(t));}
  function loadTim(){const d={m:DEF_M,n:DEF_N,e:DEF_E};try{const r=JSON.parse(localStorage.getItem(KEY_TIM)||'');return r?{m:r.m||d.m,n:r.n||d.n,e:r.e||d.e}:d;}catch(_){return d;}}
  function enforceTwo(clicked){
    const c=(m.checked?1:0)+(n.checked?1:0)+(e.checked?1:0);
    if(c===3){ if(clicked===e)n.checked=false; else if(clicked===n)e.checked=false; else e.checked=false; }
    else if(c<2){ if(!n.checked)n.checked=true; else if(!e.checked)e.checked=true; else if(!m.checked)m.checked=true; }
    saveSel(); updateUI();
  }
  function updateUI(){
    const t=loadTim(); const onM=m.checked,onN=n.checked,onE=e.checked;
    tpM.style.display=onM?"block":"none";
    tpN.style.display=onN?"block":"none";
    tpE.style.display=onE?"block":"none";

    if(onM){ fillHours(selM,0,23*60); clampToRange(selM,t.m||DEF_M); }
    if(onN){
      let minN=0, defN=DEF_N;
      if(onM){ const mMin=hhmmToMin(selM.value||t.m||DEF_M); minN=mMin+60; defN=minToHHMM(mMin+240); }
      fillHours(selN,minN,23*60); const effN=Math.max(hhmmToMin(t.n||defN),minN); clampToRange(selN,minToHHMM(effN));
    }
    if(onE){
      let minE=0, wantE=t.e||DEF_E;
      if(onN){ const nMin=hhmmToMin(selN.value||t.n||DEF_N); minE=nMin+60; wantE=minToHHMM(Math.max(hhmmToMin(DEF_E),nMin+240)); }
      else if(onM){ const mMin=hhmmToMin(selM.value||t.m||DEF_M); minE=mMin+60; wantE=(hhmmToMin(DEF_E)<minE)?minToHHMM(minE):DEF_E; }
      fillHours(selE,minE,23*60); clampToRange(selE,wantE);
    }
    saveTim({m:selM.value||DEF_M,n:selN.value||DEF_N,e:selE.value||DEF_E});
  }
  [m,n,e].forEach(el=>el.addEventListener('change',()=>enforceTwo(el)));
  selM.addEventListener('change',()=>{const t=loadTim(); t.m=selM.value; saveTim(t); updateUI();});
  selN.addEventListener('change',()=>{const t=loadTim(); t.n=selN.value; saveTim(t); updateUI();});
  selE.addEventListener('change',()=>{const t=loadTim(); t.e=selE.value; saveTim(t);});
  loadSel(); updateUI();
})();

/* OMNi — 1 от 3 с кеш */
(function(){
  const KEY_SEL='bt_he_sel_v21005', KM='bt_he_m_v21005', KN='bt_he_n_v21005', KE='bt_he_e_v21005';
  const m=document.getElementById('he-m'), n=document.getElementById('he-n'), e=document.getElementById('he-e');
  const tpM=document.getElementById('he-tp-m'), tpN=document.getElementById('he-tp-n'), tpE=document.getElementById('he-tp-e');
  const selM=document.getElementById('he-sel-m'), selN=document.getElementById('he-sel-n'), selE=document.getElementById('he-sel-e');
  const DEF_M="08:00", DEF_N="12:00", DEF_E="19:00";
  function saveSel(s){localStorage.setItem(KEY_SEL,s);}
  function getTime(k,d){return localStorage.getItem(k)||d;}
  function setTime(k,v){localStorage.setItem(k,v);}
  function loadSel(){const s=localStorage.getItem(KEY_SEL); if(s==="m"){m.checked=true;} else if(s==="e"){e.checked=true;} else {n.checked=true;}}
  function showOnly(w){tpM.style.display=(w==="m")?"block":"none"; tpN.style.display=(w==="n")?"block":"none"; tpE.style.display=(w==="e")?"block":"none";}
  function rebuild(w){
    fillHours(selM,0,23*60); fillHours(selN,0,23*60); fillHours(selE,0,23*60);
    if(w==="m"){showOnly("m"); setSelectValue(selM,getTime(KM,DEF_M)); setTime(KM,selM.value); saveSel("m");}
    else if(w==="e"){showOnly("e"); setSelectValue(selE,getTime(KE,DEF_E)); setTime(KE,selE.value); saveSel("e");}
    else {showOnly("n"); setSelectValue(selN,getTime(KN,DEF_N)); setTime(KN,selN.value); saveSel("n");}
  }
  function onChange(ch){
    if(ch===m){ n.checked=false; e.checked=false; rebuild("m"); }
    else if(ch===n){ m.checked=false; e.checked=false; rebuild("n"); }
    else { m.checked=false; n.checked=false; rebuild("e"); }
  }
  [m,n,e].forEach(el=>el.addEventListener('change',()=>onChange(el)));
  selM.addEventListener('change',()=>setTime(KM,selM.value));
  selN.addEventListener('change',()=>setTime(KN,selN.value));
  selE.addEventListener('change',()=>setTime(KE,selE.value));
  loadSel(); rebuild(m.checked?"m":n.checked?"n":"e");
})();

/* Хитозан — 3 фиксирани (видими), зависимости М→О→В */
(function(){
  const KEY='bt_ch_tim_v21005';
  const selM=document.getElementById('ch-sel-m');
  const selN=document.getElementById('ch-sel-n');
  const selE=document.getElementById('ch-sel-e');
  const DEF_M="08:00", DEF_N="12:00", DEF_E="19:00";
  function save(t){localStorage.setItem(KEY, JSON.stringify(t));}
  function load(){const d={m:DEF_M,n:DEF_N,e:DEF_E};try{const r=JSON.parse(localStorage.getItem(KEY)||'');return r?{m:r.m||d.m,n:r.n||d.n,e:r.e||d.e}:d;}catch(_){return d;}}
  function rebuild(from){
    const t=load();
    fillHours(selM,0,23*60); clampToRange(selM,(from==="m"?selM.value:t.m)||DEF_M);
    const mMin=hhmmToMin(selM.value||t.m||DEF_M), minN=mMin+60;
    fillHours(selN,minN,23*60); const wantN=(from==="n"?selN.value:t.n)||minToHHMM(mMin+240);
    clampToRange(selN, minToHHMM(Math.max(hhmmToMin(wantN),minN)));
    const nMin=hhmmToMin(selN.value||t.n||DEF_N), minE=nMin+60;
    fillHours(selE,minE,23*60); const defE=Math.max(hhmmToMin(DEF_E),nMin+240);
    const wantE=(from==="e"?selE.value:t.e)||minToHHMM(defE);
    clampToRange(selE, minToHHMM(Math.max(hhmmToMin(wantE),minE)));
    save({m:selM.value,n:selN.value,e:selE.value});
  }
  document.getElementById('ch-tp-m').style.display="block";
  document.getElementById('ch-tp-n').style.display="block";
  document.getElementById('ch-tp-e').style.display="block";
  selM.addEventListener('change',()=>rebuild("m"));
  selN.addEventListener('change',()=>rebuild("n"));
  selE.addEventListener('change',()=>rebuild("e"));
  rebuild(null);
})();

/* ---------- Данни (таблица/графика/импорт/експорт) ---------- */
function todayISO(){const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10);}
const TODAY=todayISO();
function isoToBG_YY(iso){if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return ""; const y=iso.slice(0,4),m=iso.slice(5,7),d=iso.slice(8,10); return d+"."+m+"."+y.slice(2);}
function bgToISO_any(bg){
  const m2=bg.match(/^(\d{2})\.(\d{2})\.(\d{2})$/); if(m2) return "20"+m2[3]+"-"+m2[2]+"-"+m2[1];
  const m4=bg.match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(m4) return m4[3]+"-"+m4[2]+"-"+m4[1];
  return "";
}
const KEY_REC="bt-progress";
function loadRecs(){try{return JSON.parse(localStorage.getItem(KEY_REC)||"[]");}catch(_){return [];}}
function saveRecs(a){localStorage.setItem(KEY_REC, JSON.stringify(a));}
function sortDesc(a){return a.slice().sort((x,y)=>y.date.localeCompare(x.date));}
function sortAsc(a){return a.slice().sort((x,y)=>x.date.localeCompare(y.date));}

const dateText=document.getElementById("dateText"), calEl=document.getElementById("cal"),
  weight=document.getElementById("weight"), addBtn=document.getElementById("addBtn"),
  tb=document.querySelector("#tbl tbody"), pagerTop=document.getElementById("pagerTop"),
  pagerBottom=document.getElementById("pagerBottom"), aggSel=document.getElementById("aggSel"),
  chart=document.getElementById("chart"), pageSizeSel=document.getElementById("pageSize"),
  exportBtn=document.getElementById("exportBtn"), importBtn=document.getElementById("importBtn"),
  importFile=document.getElementById("importFile"), btFlag=document.getElementById("btFlag");

let currentISO=localStorage.getItem("bt-last-date")||TODAY;
if(!/^\d{4}-\d{2}-\d{2}$/.test(currentISO)) currentISO=TODAY;
dateText.value=isoToBG_YY(currentISO);

function prefillFor(iso){
  const data=loadRecs(); const rec=data.find(r=>r.date===iso);
  if(rec){ weight.value=(typeof rec.weight==="number")?rec.weight:""; btFlag.checked=(rec.bt!==false); return; }
  const prev=sortDesc(data).find(r=>r.date<iso); weight.value=prev?prev.weight:""; btFlag.checked=true;
}
prefillFor(currentISO);

/* Календар */
let calYear=+currentISO.slice(0,4), calMonth=+currentISO.slice(5,7);
function ymd(y,m,d){return String(y).padStart(4,"0")+"-"+String(m).padStart(2,"0")+"-"+String(d).padStart(2,"0");}
function hasDataSet(){const s=new Set(); loadRecs().forEach(r=>s.add(r.date)); return s;}
function renderCalendar(){
  const set=hasDataSet(), y=calYear, m=calMonth;
  const first=new Date(Date.UTC(y,m-1,1));
  const startDow=(first.getUTCDay()+6)%7, daysInMonth=new Date(Date.UTC(y,m,0)).getUTCDate();
  const title=new Date(Date.UTC(y,m-1,1)).toLocaleDateString("bg-BG",{year:"numeric",month:"long"});
  let html='<div class="cal-head"><button id="calPrev" type="button">←</button><div class="cal-title">'+title+'</div><button id="calNext" type="button">→</button></div>';
  html+='<div class="cal-grid">';
  ["Пн","Вт","Ср","Чт","Пт","Сб","Нд"].forEach(x=>html+='<div class="dow">'+x+'</div>');
  for(let i=0;i<startDow;i++) html+='<div class="day disabled"></div>';
  for(let d=1; d<=daysInMonth; d++){
    const iso=ymd(y,m,d), future=(iso>TODAY);
    const cls=["day"]; if(iso===currentISO) cls.push("sel"); if(iso===TODAY) cls.push("today");
    if(set.has(iso)) cls.push("has"); if(future) cls.push("disabled");
    html+='<button type="button" class="'+cls.join(" ")+'" data-iso="'+iso+'">'+d+'</button>';
  }
  html+='</div>'; calEl.innerHTML=html;
}
function showCalendar(){renderCalendar(); calEl.classList.add("show");}
function hideCalendar(){calEl.classList.remove("show");}
dateText.addEventListener("click",(e)=>{e.stopPropagation(); calYear=+currentISO.slice(0,4); calMonth=+currentISO.slice(5,7); showCalendar();});
calEl.addEventListener("click",(e)=>{
  e.stopPropagation(); const t=e.target;
  if(t && t.id==="calPrev"){calMonth--; if(calMonth===0){calMonth=12; calYear--;} renderCalendar(); return;}
  if(t && t.id==="calNext"){calMonth++; if(calMonth===13){calMonth=1; calYear++;} renderCalendar(); return;}
  const btn=t.closest && t.closest(".day[data-iso]");
  if(btn){const iso=btn.getAttribute("data-iso"); if(iso<=TODAY){currentISO=iso; localStorage.setItem("bt-last-date",iso); dateText.value=isoToBG_YY(iso); prefillFor(iso); hideCalendar();}}
});
document.addEventListener("click",(e)=>{ if(!calEl.contains(e.target) && e.target!==dateText) hideCalendar(); });

/* Добавяне/редакция/изтриване */
addBtn.addEventListener("click", ()=>{
  const iso=currentISO; if(iso>TODAY){alert("Датата е в бъдещето."); return;}
  const w=Number(weight.value); if(!(w>0)){alert("Въведи тегло > 0."); return;}
  const data=loadRecs(), prev=sortDesc(data).find(r=>r.date<iso), next=sortAsc(data).find(r=>r.date>iso);
  let ok=true,msgs=[];
  if(prev){const minP=prev.weight*0.95, maxP=prev.weight*1.05; if(w<minP||w>maxP){ok=false; msgs.push("спрямо "+isoToBG_YY(prev.date)+": "+minP.toFixed(1)+"–"+maxP.toFixed(1)+" kg");}}
  if(next){const minN=next.weight*0.95, maxN=next.weight*1.05; if(w<minN||w>maxN){ok=false; msgs.push("спрямо "+isoToBG_YY(next.date)+": "+minN.toFixed(1)+"–"+maxN.toFixed(1)+" kg");}}
  if(!ok){alert("Извън допустимите граници:\n"+msgs.join("\n")); return;}
  const idx=data.findIndex(r=>r.date===iso);
  const rec={date:iso, weight:w, bt:!!btFlag.checked};
  if(idx>=0) data[idx]=rec; else data.push(rec);
  saveRecs(data); renderTable(); renderChart();
});

/* Таблица + пейджинг */
const PAGE_SIZES=[7,14,28,84,112,168,336,"all"];
function getPS(){const v=localStorage.getItem("bt-page-size"); if(v==="all")return "all"; const n=Number(v); return (PAGE_SIZES.indexOf(n)>=0)?n:28;}
function setPS(v){localStorage.setItem("bt-page-size",v);}
let pageSize=getPS(), currentPage=1;
(function(){const v=(pageSize==="all")?"all":String(pageSize); const opt=document.querySelector('#pageSize option[value="'+v+'"]'); if(opt) pageSizeSel.value=v;})();
pageSizeSel.addEventListener("change", ()=>{const v=pageSizeSel.value; pageSize=(v==="all")?"all":Number(v); setPS(v); currentPage=1; renderTable(); renderChart();});

let __currentSlice=[];
function buildPager(container,total,eff){
  container.innerHTML="";
  const start=(currentPage-1)*eff, from=total?start+1:0, to=Math.min(start+eff,total);
  const info=document.createElement("span"); info.className="info"; info.textContent=from+"-"+to+" от "+total; container.appendChild(info);
  const pagesTotal=Math.max(1,Math.ceil(total/eff)), frag=document.createDocumentFragment();
  function pageBtn(n,active){const b=document.createElement("button"); b.textContent=String(n); if(active) b.className="active";
    b.addEventListener("click",()=>{currentPage=n; renderTable(); renderChart();}); return b;}
  if(pagesTotal>1 && currentPage>1){const prev=document.createElement("button"); prev.textContent="←";
    prev.addEventListener("click",()=>{currentPage=Math.max(1,currentPage-1); renderTable(); renderChart();}); frag.appendChild(prev);}
  const sp=Math.max(1, Math.min(currentPage-2, Math.max(1,pagesTotal-4))), ep=Math.min(pagesTotal, sp+4);
  for(let p=sp;p<=ep;p++) frag.appendChild(pageBtn(p,p===currentPage));
  if(pagesTotal>1 && currentPage<pagesTotal){const next=document.createElement("button"); next.textContent="→";
    next.addEventListener("click",()=>{currentPage=Math.min(pagesTotal,currentPage+1); renderTable(); renderChart();}); frag.appendChild(next);}
  container.appendChild(frag);
}
function renderTable(){
  const all=sortDesc(loadRecs()), total=all.length, eff=(pageSize==="all")?(total||1):pageSize;
  const pages=Math.max(1,Math.ceil(total/eff)); if(currentPage>pages) currentPage=pages;
  const start=(currentPage-1)*eff, slice=all.slice(start,start+eff); __currentSlice=slice.slice();

  buildPager(pagerTop,total,eff);
  const tbody=document.querySelector("#tbl tbody"); tbody.innerHTML="";
  slice.forEach(r=>{
    const tr=document.createElement("tr");
    const s=Number(r.weight).toFixed(1).split(".");
    tr.innerHTML=
      '<td class="date">'+isoToBG_YY(r.date)+'</td>'+
      '<td class="w">'+s[0]+'<span style="font-size:.6em;opacity:.95">.'+s[1]+'</span></td>'+
      '<td class="actions">'+
        '<div class="actions">'+
          '<button class="icon" title="Редакция" data-edit="'+r.date+'" aria-label="Редакция" type="button">'+
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21l3-1 11-11-2-2L4 18z"></path><path d="M14 5l5 5"></path></svg>'+
          '</button>'+
          '<button class="icon danger" title="Изтрий" data-del="'+r.date+'" aria-label="Изтрий" type="button">'+
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"></path></svg>'+
          '</button>'+
        '</div>'+
      '</td>';
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-edit]').forEach(b=>{
    b.addEventListener("click",()=>{
      const iso=b.getAttribute("data-edit"); const rec=loadRecs().find(x=>x.date===iso);
      if(rec){ currentISO=iso; localStorage.setItem("bt-last-date",iso); dateText.value=isoToBG_YY(iso); prefillFor(iso); window.scrollTo({top:0,behavior:"smooth"}); }
    });
  });
  tbody.querySelectorAll('button[data-del]').forEach(b=>{
    b.addEventListener("click",()=>{
      const iso=b.getAttribute("data-del"); if(!confirm("Да изтрия записа за "+isoToBG_YY(iso)+"?")) return;
      const data=loadRecs().filter(x=>x.date!==iso); saveRecs(data); renderTable(); renderChart();
    });
  });
  buildPager(pagerBottom,total,eff);
}

/* Графика */
function weekKey(iso){
  const d=new Date(iso); d.setUTCHours(0,0,0,0); d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
  const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const week=Math.ceil((((d-yearStart)/86400000)+1)/7);
  return d.getUTCFullYear()+"-W"+String(week).padStart(2,"0");
}
function monthKey(iso){const d=new Date(iso); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");}
function labelWeek(k){const s=k.split("-W"); return "С"+s[1]+"."+String(s[0]).slice(2);}
function labelMonth(k){const s=k.split("-"); return s[1]+"."+s[0].slice(2);}
aggSel.addEventListener("change", ()=>renderChart());
function cssPx(name, fallback){const v=getComputedStyle(document.documentElement).getPropertyValue(name).trim();const n=parseFloat(v);return Number.isFinite(n)?n:fallback;}
function getChartRawData(){const mode=aggSel.value; if(mode==="daily"){const src=(__currentSlice&&__currentSlice.length)?__currentSlice.slice():sortDesc(loadRecs()); return sortAsc(src);} return sortAsc(loadRecs());}
function renderChart(){
  const ctx=chart.getContext("2d"), rect=chart.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
  chart.width=Math.round(rect.width*dpr); chart.height=Math.round(360*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
  const w=rect.width,h=360; ctx.clearRect(0,0,w,h);
  const raw=getChartRawData(); if(!raw.length){ctx.fillStyle="#9fb4ad"; ctx.font="700 "+cssPx('--chart-values',15)+"px system-ui"; ctx.fillText("Няма данни",10,26); return;}
  const mode=aggSel.value; let pts=[];
  if(mode==="daily"){ pts=raw.map(r=>({x:r.date,y:r.weight,label:isoToBG_YY(r.date),bt:(r.bt!==false)})); }
  else if(mode==="weekly"){
    const wm=new Map(); raw.forEach(r=>{const k=weekKey(r.date); (wm.get(k)||wm.set(k,[]).get(k)).push(r);});
    wm.forEach((arr,k)=>{const s=arr.reduce((a,b)=>a+b.weight,0)/arr.length; const btCount=arr.filter(z=>z.bt!==false).length;
      pts.push({x:k,y:s,label:labelWeek(k),bt:(btCount>=arr.length-btCount)});});
  } else {
    const mm=new Map(); raw.forEach(r=>{const k=monthKey(r.date); (mm.get(k)||mm.set(k,[]).get(k)).push(r);});
    mm.forEach((arr,k)=>{const s=arr.reduce((a,b)=>a+b.weight,0)/arr.length; const btCount=arr.filter(z=>z.bt!==false).length;
      pts.push({x:k,y:s,label:labelMonth(k),bt:(btCount>=arr.length-btCount)});});
  }
  pts.sort((a,b)=>a.x.localeCompare(b.x));
  const vals=pts.map(p=>p.y).filter(Number.isFinite);
  ctx.font="700 "+cssPx('--chart-values',15)+"px system-ui";
  if(vals.length<2){ctx.fillStyle="#9fb4ad"; ctx.fillText("Добави поне 2 точки",10,26); return;}
  const min=Math.min(...vals), max=Math.max(...vals);
  const padL=48,padR=18,padT=16,padB=96,n=pts.length;
  const X=i=>padL+(w-padL-padR)*(n<=1?0:i/(n-1));
  const Y=v=>h-padB-((v-min)/((max-min)||1))*(h-padT-padB);
  ctx.strokeStyle="#20343a"; ctx.lineWidth=1.1;
  ctx.beginPath(); ctx.moveTo(padL,h-padB); ctx.lineTo(w-padR,h-padB); ctx.moveTo(padL,padT); ctx.lineTo(padL,h-padB); ctx.stroke();
  for(let i=1;i<n;i++){
    const p0=pts[i-1], p1=pts[i];
    const bothBT=(p0.bt&&p1.bt), bothNon=(!p0.bt&&!p1.bt);
    ctx.strokeStyle= bothBT ? getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b'
                 : bothNon ? getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5'
                 : getComputedStyle(document.documentElement).getPropertyValue('--line-neutral').trim()||'#2dd4bf';
    ctx.lineWidth=2.0; ctx.beginPath(); ctx.moveTo(X(i-1),Y(p0.y)); ctx.lineTo(X(i),Y(p1.y)); ctx.stroke();
  }
  ctx.fillStyle="#d9ebe5"; ctx.textBaseline="middle";
  ctx.fillText(String(max.toFixed(1)),10,Y(max)); ctx.fillText(String(min.toFixed(1)),10,Y(min));
  const maxLabels=Math.min(16,n), step=Math.max(1,Math.floor(n/maxLabels));
  const green=getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5';
  const orange=getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b';
  ctx.font="700 "+cssPx('--chart-label',15)+"px system-ui";
  for(let j=0;j<n;j++){
    const p=pts[j], x0=X(j), y0=h-padB;
    ctx.beginPath(); ctx.fillStyle=p.bt?orange:green; ctx.arc(x0,Y(p.y),3,0,Math.PI*2); ctx.fill();
    if(j%step===0){ctx.save(); ctx.translate(x0,y0+64); ctx.rotate(-Math.PI/2); ctx.fillStyle="#e7faf4"; ctx.fillText(p.label,0,0); ctx.restore();}
  }
}

/* Експорт/Импорт */
exportBtn.addEventListener("click", ()=>{
  const data=loadRecs();
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="bt-progress-export.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
importBtn.addEventListener("click", ()=>importFile.click());
importFile.addEventListener("change", ()=>{
  const f=importFile.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      let arr=JSON.parse(fr.result||"[]");
      if(!Array.isArray(arr)) throw new Error("Невалиден формат");
      arr=arr.filter(r=>r && typeof r.date==="string" && typeof r.weight==="number")
             .map(r=>({date:r.date,weight:r.weight,bt:(r.bt!==false)}));
      saveRecs(arr); renderTable(); renderChart(); alert("Импортът е успешен.");
    }catch(e){ alert("Грешка при импорт: "+e.message); }
    importFile.value="";
  };
  fr.readAsText(f);
});

/* Миграции и първоначално рендериране */
function migrateDatesAndBT(){
  const arr=loadRecs(); let changed=false;
  for(let i=0;i<arr.length;i++){
    const r=arr[i];
    if(typeof r.date==="string" && !/^\d{4}-\d{2}-\d{2}$/.test(r.date)){
      const iso=bgToISO_any(r.date); if(iso){ r.date=iso; changed=true; }
    }
    if(typeof r.bt==="undefined"){ r.bt=true; changed=true; }
  }
  if(changed) saveRecs(arr);
}
function initialRender(){ migrateDatesAndBT(); prefillFor(currentISO); renderTable(); renderChart(); window.addEventListener("resize", ()=>renderChart(), {passive:true}); }
initialRender();
</script>
</body>
</html>
