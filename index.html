<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BT — Тегло v5</title>
  <link rel="manifest" href="manifest.webmanifest?v=5">
  <meta name="theme-color" content="#10b981">
  <link rel="icon" href="assets/icons/icon-192.png?v=5">
  <style>
    :root{--bg:#0b1215;--card:#111a1f;--text:#e6f2ef;--muted:#9fb4ad;--accent:#10b981;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
         background:linear-gradient(180deg,#071013,#0b1215);color:var(--text)}
    header{position:sticky;top:0;background:#071013aa;backdrop-filter:blur(6px);border-bottom:1px solid #1e2b30;
           padding:12px 16px;display:flex;gap:12px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}
    main{max-width:900px;margin:20px auto;padding:0 16px 40px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1e2b30;border-radius:16px;padding:16px;box-shadow:0 10px 30px #00000040}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{border-radius:12px;border:1px solid #254046;background:#0d171b;color:var(--text);
                        padding:10px 12px;font-size:14px}
    button{background:var(--accent);border:none;color:#06241b;font-weight:700;cursor:pointer}
    button.ghost{background:#0d171b;color:#e6f2ef;border:1px solid #2a3e41}
    button.danger{background:#ef4444;color:white}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #20343a;text-align:left;font-size:14px}
    th{color:#9fb4ad;font-weight:600}
    .right{text-align:right}
    canvas{max-width:100%;height:320px}
    .pagination{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:10px}
    .pagination button{background:#0d171b;border:1px solid #2a3e41;color:#e6f2ef;padding:6px 10px;border-radius:10px;cursor:pointer}
    .pagination button.active{background:#10b981;color:#06241b;border-color:#10b981}
    .pagination .muted{color:#9fb4ad;margin-right:auto}
  </style>
</head>
<body>
  <header>
    <img src="assets/icons/icon-192.png?v=5" width="28" height="28" alt="BT">
    <h1>Безопасно Тегло — Тракер</h1>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 8px">Нов запис</h2>
      <div class="row">
        <div style="flex:1;min-width:160px">
          <label for="date">Дата</label>
          <input id="date" type="date">
        </div>
        <div style="flex:1;min-width:140px">
          <label for="weight">Тегло (kg)</label>
          <input id="weight" type="number" step="0.1" placeholder="напр. 86.4">
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="add">Добави</button>
        <button class="ghost" id="export">Експорт (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="ghost" id="importBtn">Импорт</button>
        <button class="danger" id="wipe">Изтрий всички</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Графика</h2>
      <div class="row">
        <div>
          <label for="span">Период</label>
          <select id="span">
            <option value="30">30 дни</option>
            <option value="90">90 дни</option>
            <option value="365">1 година</option>
            <option value="all">Всички</option>
          </select>
        </div>
      </div>
      <canvas id="chart"></canvas>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Записи</h2>
      <table id="table">
        <thead><tr><th>Дата</th><th>Тегло (kg)</th><th class="right">Действия</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="pagination" id="pager"></div>
    </section>
  </main>

  <script src="chart.local.js?v=5"></script>
  <script>
    const $ = s=>document.querySelector(s);
    const dateInput=$("#date"), weightInput=$("#weight");
    const tbody = document.querySelector("#table tbody");
    const pager = $("#pager");
    const spanSelect=$("#span");

    const PAGE_SIZE = 20;
    let currentPage = 1;

    function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    dateInput.value = todayISO();

    function load(){ try{return JSON.parse(localStorage.getItem("bt-progress")||"[]");}catch{return [];} }
    function save(d){ localStorage.setItem("bt-progress", JSON.stringify(d)); }

    function sortDescByDate(arr){ return [...arr].sort((a,b)=> b.date.localeCompare(a.date)); }
    function sortAscByDate(arr){ return [...arr].sort((a,b)=> a.date.localeCompare(b.date)); }

    function renderTable(){
      const allDesc = sortDescByDate(load());
      const total = allDesc.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if(currentPage > pages) currentPage = pages;

      const start = (currentPage - 1) * PAGE_SIZE;
      const slice = allDesc.slice(start, start + PAGE_SIZE);

      tbody.innerHTML="";
      slice.forEach((r, idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td><td>${r.weight??""}</td>
        <td class="right"><button class="ghost" data-edit="${start+idx}">Редакция</button>
        <button class="danger" data-del="${start+idx}">Изтрий</button></td>`;
        tbody.appendChild(tr);
      });

      // pager
      pager.innerHTML="";
      const info = document.createElement("span");
      info.className="muted";
      const from = total? start+1 : 0;
      const to = Math.min(start + PAGE_SIZE, total);
      info.textContent = `Показани ${from}-${to} от ${total}`;
      pager.appendChild(info);

      const prev = document.createElement("button");
      prev.textContent = "←";
      prev.disabled = currentPage===1;
      prev.onclick = ()=>{ currentPage=Math.max(1,currentPage-1); renderTable(); };
      pager.appendChild(prev);

      const pagesToShow = 7;
      let first = Math.max(1, currentPage - Math.floor(pagesToShow/2));
      let last = Math.min(pages, first + pagesToShow - 1);
      first = Math.max(1, last - pagesToShow + 1);
      for(let p=first; p<=last; p++){
        const btn = document.createElement("button");
        btn.textContent = p;
        if(p===currentPage) btn.className="active";
        btn.onclick = ()=>{ currentPage=p; renderTable(); };
        pager.appendChild(btn);
      }

      const next = document.createElement("button");
      next.textContent = "→";
      next.disabled = currentPage===pages;
      next.onclick = ()=>{ currentPage=Math.min(pages,currentPage+1); renderTable(); };
      pager.appendChild(next);
    }

    function renderChart(){
      const allAsc = sortAscByDate(load());
      let filtered = allAsc;
      const span=spanSelect.value;
      if(span!=="all"){
        const days=parseInt(span,10);
        const cut=new Date(); cut.setDate(cut.getDate()-days);
        filtered = allAsc.filter(r=> new Date(r.date)>=cut );
      }
      const vals = filtered.map(r=> Number(r.weight) || null);
      const ctx=document.getElementById("chart").getContext("2d");
      const mini=new MiniChart(ctx); mini.data=vals; mini.render();
    }

    function clearForm(){ weightInput.value=""; }

    document.getElementById("add").addEventListener("click",()=>{
      const rec={ date: dateInput.value||todayISO(), weight: weightInput.value?Number(weightInput.value):null };
      const data=load();
      const idx=data.findIndex(r=>r.date===rec.date);
      if(idx>=0) data[idx]=rec; else data.push(rec);
      save(data); renderTable(); renderChart(); clearForm();
    });

    document.addEventListener("click",(e)=>{
      const t=e.target; if(!t.closest("#table")) return;
      const allDesc = sortDescByDate(load());
      if(t.matches("button[data-del]")){            /* ← поправено: ] и ) */
        const iDesc = +t.getAttribute("data-del");
        const rec = allDesc[iDesc];
        let data = load();
        const i = data.findIndex(r=> r.date===rec.date);
        if(i>=0){ data.splice(i,1); save(data); renderTable(); renderChart(); }
      } else if(t.matches("button[data-edit]")){
        const iDesc = +t.getAttribute("data-edit");
        const rec = allDesc[iDesc];
        dateInput.value = rec.date;
        weightInput.value = rec.weight ?? "";
        window.scrollTo({top:0, behavior:"smooth"});
      }
    });

    document.getElementById("export").addEventListener("click",()=>{
      const blob=new Blob([JSON.stringify(load(),null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bt-progress-export.json"; a.click(); URL.revokeObjectURL(a.href);
    });
    document.getElementById("importBtn").addEventListener("click",()=>document.getElementById("importFile").click());
    document.getElementById("importFile").addEventListener("change",(e)=>{
      const f=e.target.files[0]; if(!f) return; const r=new FileReader();
      r.onload=()=>{ try{ const data=JSON.parse(r.result); if(Array.isArray(data)){ save(data); currentPage=1; renderTable(); renderChart(); } }catch{} };
      r.readAsText(f);
    });

    if("serviceWorker" in navigator && location.protocol!=='file:'){
      window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js?v=5"));
    }

    renderTable(); renderChart();
  </script>
</body>
</html>
