<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>BT PWA v29</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    body { font-family: sans-serif; margin: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.4em; text-align: center; }
    th { background: #f0f0f0; }
    .actions button { margin: 0 2px; }
    .toolbar { text-align: right; margin-top: 1em; }
    .toolbar button { margin-left: 8px; }
  </style>
</head>
<body>
  <h1>BT PWA ‚Äì –ó–∞–ø–∏—Å–∏ (v29)</h1>

  <form id="addForm">
    <label>–î–∞—Ç–∞:
      <input type="date" id="date" required>
    </label>
    <label>–¢–µ–≥–ª–æ (kg):
      <input type="number" id="weight" step="0.1" min="0" required>
    </label>
    <button type="submit">–î–æ–±–∞–≤–∏</button>
  </form>

  <div class="toolbar">
    <button id="exportBtn" title="–ï–∫—Å–ø–æ—Ä—Ç">üì§</button>
    <button id="importBtn" title="–ò–º–ø–æ—Ä—Ç">üì•</button>
    <button id="deleteSelectedBtn" title="–ò–∑—Ç—Ä–∏–π –∏–∑–±—Ä–∞–Ω–∏—Ç–µ">üóëÔ∏è</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
  </div>

  <table id="recordsTable">
    <thead>
      <tr>
        <th></th>
        <th>–î–∞—Ç–∞</th>
        <th>–¢–µ–≥–ª–æ (kg)</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const form = document.getElementById('addForm');
    const dateInput = document.getElementById('date');
    const weightInput = document.getElementById('weight');
    const tableBody = document.querySelector('#recordsTable tbody');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

    let records = JSON.parse(localStorage.getItem('records') || '[]');

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = String(d.getFullYear()).slice(-2);
      return `${day}.${month}.${year}`;
    }

    function render() {
      tableBody.innerHTML = '';
      records.sort((a, b) => new Date(b.date) - new Date(a.date));
      for (let i = 0; i < records.length; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-index="${i}"></td>
          <td>${formatDate(records[i].date)}</td>
          <td>${parseFloat(records[i].weight).toFixed(1)}</td>
          <td class="actions">
            <button class="editBtn" data-index="${i}" title="–†–µ–¥–∞–∫—Ü–∏—è">‚úèÔ∏è</button>
            <button class="deleteBtn" data-index="${i}" title="–ò–∑—Ç—Ä–∏–π">üóëÔ∏è</button>
          </td>
        `;
        tableBody.appendChild(tr);
      }
      localStorage.setItem('records', JSON.stringify(records));
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const date = dateInput.value;
      const weight = weightInput.value;
      if (!date || !weight) return;
      records.push({ date, weight });
      render();
      form.reset();
    });

    tableBody.addEventListener('click', e => {
      if (e.target.classList.contains('deleteBtn')) {
        const idx = e.target.dataset.index;
        if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ –∑–∞–ø–∏—Å?')) {
          records.splice(idx, 1);
          render();
        }
      } else if (e.target.classList.contains('editBtn')) {
        const idx = e.target.dataset.index;
        const newWeight = prompt('–ù–æ–≤–æ —Ç–µ–≥–ª–æ (kg):', records[idx].weight);
        if (newWeight !== null) {
          records[idx].weight = newWeight;
          render();
        }
      }
    });

    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(records)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bt-progress-export.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          records = JSON.parse(reader.result);
          render();
        } catch (err) {
          alert('–ù–µ–≤–∞–ª–∏–¥–µ–Ω JSON —Ñ–∞–π–ª!');
        }
      };
      reader.readAsText(file);
    });

    deleteSelectedBtn.addEventListener('click', () => {
      const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]:checked');
      if (checkboxes.length === 0) return;
      if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ –∑–∞–ø–∏—Å–∏?')) {
        const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a,b)=>b-a);
        for (const idx of indices) {
          records.splice(idx, 1);
        }
        render();
      }
    });

    render();
  </script>
</body>
</html>
