<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>BT PWA v31-fix</title>
  <style>
    body{font-family:Arial, sans-serif;margin:20px;background:#fafafa}
    h1{text-align:center}
    .controls{text-align:right;margin-bottom:10px}
    .controls button{margin-left:6px;cursor:pointer}
    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border:1px solid #ddd;padding:4px 8px;text-align:left;white-space:nowrap}
    th{background:#f5f5f5}
    td.actions{width:80px}
    td.actions button{margin-right:4px;cursor:pointer}
    .pager{margin-top:12px;text-align:center}
    .pager button{margin:0 4px;cursor:pointer}
    canvas{max-width:100%;height:300px;margin-top:20px;background:#fff;border:1px solid #ccc}
  </style>
</head>
<body>
  <h1>–ó–∞–ø–∏—Å–∏</h1>

  <div class="controls">
    <button id="exportBtn" title="–ï–∫—Å–ø–æ—Ä—Ç">üì§</button>
    <button id="importBtn" title="–ò–º–ø–æ—Ä—Ç">üì•</button>
    <button id="deleteAllBtn" title="–ò–∑—Ç—Ä–∏–π –≤—Å–∏—á–∫–∏">üóë</button>
  </div>

  <table id="recordsTable">
    <thead>
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>–¢–µ–≥–ª–æ (kg)</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pager">
    <button id="prevPage">‚Üê</button>
    <span id="pageInfo"></span>
    <button id="nextPage">‚Üí</button>
  </div>

  <canvas id="chart"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let records = JSON.parse(localStorage.getItem('records')||'[]');
    let perPage=10, currentPage=1;
    const TODAY=new Date().toISOString().slice(0,10);

    function isoToBG_YY(iso){
      return /^\d{4}-\d{2}-\d{2}$/.test(iso)
        ? iso.split("-")[2]+"."+iso.split("-")[1]+"."+iso.split("-")[0].slice(2)
        : "";
    }

    function renderTable(){
      const tbody=document.querySelector('#recordsTable tbody');
      tbody.innerHTML='';
      const start=(currentPage-1)*perPage;
      const pageRecords=records.slice(start,start+perPage);

      for(let [idx,r] of pageRecords.entries()){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${isoToBG_YY(r.date)}</td>
          <td>${parseFloat(r.weight).toFixed(1)}</td>
          <td class="actions">
            <button class="edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π">‚úé</button>
            <button class="delete" title="–ò–∑—Ç—Ä–∏–π">üóë</button>
          </td>`;
        tr.querySelector('.delete').addEventListener('click',()=>{
          if(confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ –∑–∞–ø–∏—Å?')){
            records=records.filter(x=>x!==r);
            saveRecords();renderTable();renderChart();
          }
        });
        tbody.appendChild(tr);
      }

      const pageInfo=document.getElementById('pageInfo');
      pageInfo.textContent=`${start+1}-${start+pageRecords.length} –æ—Ç ${records.length}`;
    }

    function saveRecords(){
      localStorage.setItem('records',JSON.stringify(records));
    }

    document.getElementById('prevPage').addEventListener('click',()=>{
      if(currentPage>1){currentPage--;renderTable();renderChart();}
    });
    document.getElementById('nextPage').addEventListener('click',()=>{
      if(currentPage*perPage<records.length){currentPage++;renderTable();renderChart();}
    });

    document.getElementById('deleteAllBtn').addEventListener('click',()=>{
      if(confirm('–ù–∞–∏—Å—Ç–∏–Ω–∞ –ª–∏ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –í–°–ò–ß–ö–ò –∑–∞–ø–∏—Å–∏?')){
        records=[];saveRecords();renderTable();renderChart();
      }
    });

    // –ï–∫—Å–ø–æ—Ä—Ç
    document.getElementById('exportBtn').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(records)],{type:"application/json"});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download="bt-progress-export.json";
      a.click();
    });

    // –ò–º–ø–æ—Ä—Ç
    document.getElementById('importBtn').addEventListener('click',()=>{
      const inp=document.createElement('input');
      inp.type="file";inp.accept="application/json";
      inp.onchange=e=>{
        const file=e.target.files[0];
        if(!file)return;
        const r=new FileReader();
        r.onload=ev=>{
          try{
            const arr=JSON.parse(ev.target.result);
            const cleaned=[];
            for(const rec of arr){
              if(typeof rec.date==="string"
                 && /^\d{4}-\d{2}-\d{2}$/.test(rec.date)
                 && typeof rec.weight==="number"
                 && rec.weight>0
                 && rec.date<=TODAY){
                   cleaned.push({date:rec.date,weight:rec.weight});
              }
            }
            if(cleaned.length){records=cleaned;saveRecords();renderTable();renderChart();}
          }catch{alert("–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–∞–π–ª");}
        };
        r.readAsText(file);
      };
      inp.click();
    });

    // Chart.js
    let chart;
    function renderChart(){
      const ctx=document.getElementById('chart').getContext('2d');
      if(chart)chart.destroy();
      const sorted=[...records].sort((a,b)=>a.date.localeCompare(b.date));
      chart=new Chart(ctx,{
        type:'line',
        data:{
          labels:sorted.map(r=>isoToBG_YY(r.date)),
          datasets:[{label:'–¢–µ–≥–ª–æ (kg)',data:sorted.map(r=>r.weight),borderColor:'blue',fill:false}]
        },
        options:{responsive:true,maintainAspectRatio:false}
      });
    }

    if(records.length===0){
      records=[
        {date:'2025-09-20',weight:108.2},
        {date:'2025-09-21',weight:107.9},
        {date:'2025-09-22',weight:107.6},
        {date:'2025-09-23',weight:107.2}
      ];
      saveRecords();
    }

    renderTable();renderChart();
  </script>
</body>
</html>
