<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ë–¢ App 3 ‚Äî v2.28</title>

  <!-- –ë–µ–∑ service worker –∑–∞ –∫–µ—à -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <meta name="theme-color" content="#0b1215"/>
  <link rel="icon" href="assets/icons/icon-192.png?v=1.39"/>

  <style>
    :root{
      --bg:#0b1215; --card:#111a1f; --text:#e6f2ef; --muted:#9fb4ad;
      --accent:#10b981; --border:#1e2b30; --has:#c7f5df; --danger:#ef4444;
      --chart-label:15px; --chart-values:15px;
      --line-green:#87f3c5; --line-orange:#f59e0b; --line-neutral:#2dd4bf;
      --ctl-h:42px; --lbl-h:16px; --maxw:980px;
      --pill-w:168px;
      --weekend:#bfead7;         /* –∑–µ–ª–µ–Ω–∏–∫–∞–≤–æ-–±—è–ª–æ –∑–∞ –°–±/–ù–¥ */
      --weekend-strong:#8fd4bd;  /* –ø–æ-—Ç—ä–º–µ–Ω –Ω—é–∞–Ω—Å –∑–∞ –ø–æ-–¥–æ–±—Ä–∞ –≤–∏–¥–∏–º–æ—Å—Ç */
      --orange:#f59e0b;
      --green:#22c55e;
      --yellow:#eab308;
      --red:#ef4444;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,"Noto Sans",sans-serif
    }

    /* ===== –ì–æ—Ä–Ω–∞ –ª–µ–Ω—Ç–∞ ===== */
    .topbar-wrap{ position:sticky; top:0; z-index:10; background:#0b1215; border-bottom:1px solid var(--border); }
    .topbar{
      max-width:var(--maxw); margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .topbar .brand{ display:flex; align-items:center; gap:10px; font-weight:800 }
    .topbar .brand img{ width:24px; height:24px }
    .topbar .title{ font-size:18px; font-weight:800 }
    .topbar .badge{
      font-size:12px; font-weight:800; color:#06241b;
      background:linear-gradient(90deg,#22c55e,#14b8a6); padding:2px 8px; border-radius:10px;
    }

    /* ===== –¢–∞–±–æ–≤–µ (–ø—Ä–∞–≤–æ—ä–≥—ä–ª–Ω–∏, –±–æ–ª–¥) ===== */
    .tabs-wrap{ background:#0b1215; border-bottom:1px solid var(--border); }
    .tabs{ max-width:var(--maxw); margin:0 auto; padding:10px 16px; display:flex; gap:8px; }
    .tab-btn{
      -webkit-tap-highlight-color: transparent;
      appearance:none; border:1px solid var(--border); background:#0d171b; color:#e6f2ef;
      padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:800; font-size:16px; transition:.15s ease;
    }
    .tab-btn[aria-selected="true"]{
      color:#06241b; border-color:transparent; background:linear-gradient(90deg,#22c55e,#14b8a6);
    }

    /* ===== –û—Å–Ω–æ–≤–Ω–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ ===== */
    main{ max-width:var(--maxw); margin:20px auto; padding:0 16px 40px; display:grid; gap:16px; align-content:start }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px }

    /* ===== –°—Ç–∏–ª–æ–≤–µ –∑–∞ ‚Äû–î–∞–Ω–Ω–∏‚Äú ===== */
    .inputs-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .spacer{ flex:1 1 auto }
    .field{ display:flex; flex-direction:column; justify-content:flex-end }
    .lbl{ height:var(--lbl-h); line-height:var(--lbl-h); font-size:12px; color:var(--muted); margin:0 0 6px 0 }
    .ctl{ display:flex; align-items:center }

    input,select,button{
      background:#0d171b; border:1px solid #254046; color:var(--text);
      border-radius:10px; padding:8px 10px; font-size:14px; height:var(--ctl-h)
    }
    input[type="number"]{ appearance:textfield; -webkit-appearance:none; -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    button{ cursor:pointer } button.primary{ background:var(--accent); border-color:var(--accent); color:#06241b; font-weight:700 }

    .field.date{ width:120px }
    .field.date input{ width:100% }
    .field.weight input{ font-weight:700; font-size:18px; width:9ch }
    .field.weight input:focus{ outline:2px solid #2b6e66 }

    /* –í—Ä—ä—â–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–µ–ª–∫–∏—Ç–µ —Å–∞–º–æ –∑–∞ ‚Äû–¢–µ–≥–ª–æ (kg)‚Äù */
    .field.weight input[type="number"]{
      appearance: auto;
      -webkit-appearance: auto;
      -moz-appearance: auto;
    }
    .field.weight input[type="number"]::-webkit-inner-spin-button,
    .field.weight input[type="number"]::-webkit-outer-spin-button{
      -webkit-appearance: auto;
      margin: 0;
    }

    .bt-only{ display:flex; align-items:center; justify-content:center; width:var(--ctl-h); height:var(--ctl-h);
      border:1px solid #334a4f; background:#0d171b; border-radius:10px }
    .bt-only input{ width:16px; height:16px; margin:0 }
    .bt-only[title]{ cursor:pointer }

    table{ width:100%; border-collapse:collapse }
    colgroup col.date{ width:70px } colgroup col.w{ width:70px } colgroup col.act{ width:auto }
    th,td{ padding:3px 4px; border-bottom:1px solid #20343a; font-size:13px; line-height:1.15; white-space:nowrap; text-align:left; vertical-align:middle }
    th{ color:var(--muted); font-weight:600 }
    th.date,td.date{ padding-right:1px }
    th.w,td.w{ text-align:right; padding-left:2px }
    th.actions,td.actions{ padding-left:72px }

    .wCell{ text-align:right }
    .wSmall{ font-size:.6em; opacity:.95; margin-left:1px }

    .actions{ display:inline-flex; gap:6px; align-items:center; justify-content:flex-start }
    .icon{ display:inline-flex; align-items:center; justify-content:center; border:1px solid #2a3e41; background:#0d171b; border-radius:8px; padding:4px 6px; color:#fff; height:var(--ctl-h) }
    .icon svg{ width:16px; height:16px; stroke:currentColor; stroke-linecap:round; stroke-linejoin:round }
    .icon.danger{ border-color:#3a2222; background:#161112; color:#ffd5d5 }

    .recbar{ display:flex; align-items:center; gap:8px; justify-content:flex-start; margin:8px 0; flex-wrap:wrap }

    .pager{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:flex-start; margin-top:8px }
    .pager .info{ color:var(--muted); font-size:12px; margin:0 8px 0 0 }
    .pager button{ background:#0d171b; border:1px solid #2a3e41; color:#fff; padding:4px 8px; border-radius:8px; font-size:13px }
    .pager button.active{ background:var(--accent); color:#06241b; border-color:var(--accent) }

    canvas{ width:100%; height:360px; display:block; margin-top:8px; background:#0b1215; border:1px solid #1a2a2f; border-radius:8px }

    .date-wrap{ position:relative } #dateText[readonly]{ cursor:pointer }
    .cal{ position:absolute; z-index:10; top:calc(var(--ctl-h) + 6px); left:0; background:#0e1518; border:1px solid #20343a; border-radius:12px;
      box-shadow:0 8px 30px rgba(0,0,0,.35); padding:10px; width:auto; display:none }
    .cal.show{ display:block }
    .cal .cal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:8px }
    .cal .cal-title{ font-weight:700; text-transform:capitalize }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,36px); gap:6px; justify-content:center }
    .cal .dow{ color:var(--muted); font-size:11px; text-align:center; line-height:36px; height:36px }
    .cal .day{ width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid transparent }
    .cal .day:hover{ border-color:#27454a }
    .cal .day.disabled{ opacity:.35; pointer-events:none }
    .cal .day.has{ background:var(--has); color:#092218 }
    .cal .day.today{ outline:1px dashed #5b8f98 }
    .cal .day.sel{ background:#84e9c2; color:#041915; font-weight:700 }

    /* –ü–∞–Ω–µ–ª–∏ */
    .tabpanel{ display:none }
    .tabpanel[aria-hidden="false"]{ display:block }

    /* ===== –ü–†–û–ì–†–ê–ú–ê ‚Äî –ø—Ä–æ–¥—É–∫—Ç–∏ (–æ–±—â–æ) ===== */
    .prog-head{ display:flex; align-items:center; gap:12px; margin-bottom:6px }
    .prod-img{ width:74px; height:74px; object-fit:contain; border-radius:12px; background:#0d171b; border:1px solid #254046 }
    .prog-cap{ font-weight:800; font-size:16px }

    /* ===== –ü—Ä–æ–ª–∞–∫—Ç ‚Äî –¢–∞–±–ª–∏—Ü–∞ –î–ù–ò √ó 2 –í–†–ï–ú–ï–ù–ê ===== */
    .day-grid-wrap{ overflow-x:auto; }
    .pl-table{
      border-collapse:collapse; width:max-content; min-width:100%;
      border:1px solid var(--border); border-radius:12px; overflow:hidden;
      background:#0d171b;
    }
    .pl-table th, .pl-table td{
      border-right:1px solid #20343a; border-bottom:1px solid #20343a;
      padding:6px 8px; text-align:center; white-space:nowrap;
      font-size:12px; line-height:1.1;
    }
    .pl-table th{ color:#cfe3dd; font-weight:800; background:#0f1a1d; position:relative }
    .pl-table td{ color:#e6f2ef }
    .pl-table th:last-child, .pl-table td:last-child { border-right:none; }

    .dow-cell{ min-width:52px }                 /* –∫–æ–º–ø–∞–∫—Ç–Ω–∏ –∫–ª–µ—Ç–∫–∏ */
    .dow-badge{
      display:inline-block; padding:4px 6px; border-radius:8px; border:1px solid #2a3e41;
      font-weight:800; letter-spacing:.2px;
    }
    .dow-badge.weekend{ color:var(--weekend-strong) } /* –ø–æ-—Ç—ä–º–µ–Ω –Ω—é–∞–Ω—Å –∑–∞ –≤–∏–¥–∏–º–æ—Å—Ç */
    .dow-badge.current{ outline:1px dashed #6fa9a1; } /* –ø—É–Ω–∫—Ç–∏—Ä –∑–∞ —Ç–µ–∫—É—â –¥–µ–Ω */
    .dow-badge.active{ border-color:transparent; background:var(--orange); color:#06241b; }

    .time-cell{ min-width:60px; }
    .time-badge{
      display:inline-block; padding:4px 6px; border-radius:8px; border:1px solid #2a3e41; font-weight:700;
    }
    .time-badge.edit{ outline:1px dashed #6fa9a1; }
    .time-badge.sel{ background:#1b2a2e; border-color:#35535a; }

    .pl-actions{ display:flex; align-items:center; justify-content:center; gap:16px; margin-top:10px; }
    .round-btn{
      width:56px; height:56px; border-radius:50%; border:2px solid #234046; background:#0f181b; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-weight:800; user-select:none;
    }
    .round-btn.green{ background:var(--green); color:#06241b; }
    .round-btn.yellow{ background:var(--yellow); color:#06241b; }
    .round-btn.red{ background:var(--red); color:#fff; }

    .action-tile{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid #214047; background:#0f181b; border-radius:12px; padding:10px 16px; cursor:pointer;
      font-weight:800;
    }
    .action-tile svg{ width:18px; height:18px; stroke:currentColor }

    /* ===== –ö—Ä—ä–≥–æ–≤ —á–∞—Å–æ–≤–Ω–∏–∫ (modal) ===== */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.show{ display:flex; }
    .modal-card{
      width:320px; background:#0e1518; border:1px solid #20343a; border-radius:14px; padding:14px; color:#e6f2ef;
      box-shadow:0 8px 40px rgba(0,0,0,.45);
    }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
    .modal-title{ font-weight:800 }
    .ring{
      width:280px; height:280px; margin:8px auto; position:relative;
    }
    .ring svg{ width:280px; height:280px; display:block; }
    .ring-center{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:112px; height:64px; display:flex; align-items:center; justify-content:center;
      background:#0f181b; border:1px dashed #2f4c52; border-radius:10px; font-weight:900; font-size:20px;
    }
    .modal-actions{ display:flex; align-items:center; justify-content:flex-end; gap:8px; }
    .btn{ border:1px solid #2a3e41; background:#0d171b; color:#e6f2ef; border-radius:10px; padding:8px 12px; cursor:pointer; }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#06241b; font-weight:900 }

    @media (max-width: 380px){
      :root{ --pill-w:156px; }
      .prod-img{ width:64px; height:64px; border-radius:10px; }
      .pl-table th, .pl-table td{ font-size:11px; padding:5px 6px; }
      .dow-cell{ min-width:44px }
      .time-cell{ min-width:52px }
    }
  </style>
</head>
<body>

  <!-- –ì–æ—Ä–Ω–∞ –ª–µ–Ω—Ç–∞ -->
  <div class="topbar-wrap">
    <div class="topbar">
      <div class="brand">
        <img src="assets/icons/icon-192.png?v=1.39" alt="BT"/>
        <span class="title">BT&nbsp;–ë–µ–∑–æ–ø–∞—Å–Ω–æ –¢–µ–≥–ª–æ ‚Äî</span>
        <span class="badge">v2.28</span>
      </div>
    </div>
  </div>

  <!-- –¢–∞–±–æ–≤–µ -->
  <div class="tabs-wrap" role="navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="tabs" role="tablist">
      <button id="tab-data" class="tab-btn" role="tab" aria-controls="panel-data" aria-selected="true">–î–∞–Ω–Ω–∏</button>
      <button id="tab-program" class="tab-btn" role="tab" aria-controls="panel-program" aria-selected="false">–ü—Ä–æ–≥—Ä–∞–º–∞</button>
    </div>
  </div>

  <!-- –ü–ê–ù–ï–õ: –î–ê–ù–ù–ò -->
  <div id="panel-data" class="tabpanel" role="tabpanel" aria-labelledby="tab-data" aria-hidden="false">
    <main>
      <!-- –ó–∞–ø–∏—Å -->
      <section class="card">
        <h2 style="margin:0 0 10px">–ó–∞–ø–∏—Å</h2>

        <div class="inputs-row">
          <div class="inputs-row" style="gap:10px">
            <div class="field date">
              <div class="lbl">–î–∞—Ç–∞</div>
              <div class="ctl date-wrap">
                <input id="dateText" type="text" readonly placeholder="–î–î.–ú–ú.–ì–ì"/>
                <div id="cal" class="cal" role="dialog" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä"></div>
              </div>
            </div>

            <div class="field weight">
              <div class="lbl">–¢–µ–≥–ª–æ (kg)</div>
              <div class="ctl"><input id="weight" type="number" step="0.1" min="0.1" placeholder="107.7"/></div>
            </div>

            <div class="field" style="min-width:var(--ctl-h)">
              <div class="lbl"></div>
              <label class="bt-only" title="–ú–∞—Ä–∫–∏—Ä–∞–Ω –∫–∞—Ç–æ –ë–¢"><input id="btFlag" type="checkbox" checked/></label>
            </div>

            <div class="field" style="min-width:100px">
              <div class="lbl"></div>
              <button id="addBtn" class="primary" type="button" style="height:var(--ctl-h); min-width:100px">–î–æ–±–∞–≤–∏</button>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="inputs-row" style="gap:8px">
            <div class="field">
              <div class="lbl"></div>
              <button id="exportBtn" class="icon" title="–ï–∫—Å–ø–æ—Ä—Ç" aria-label="–ï–∫—Å–ø–æ—Ä—Ç" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 16V4M12 4l-4 4M12 4l4 4"></path><path d="M4 20h16"></path>
                </svg>
              </button>
            </div>
            <div class="field">
              <div class="lbl"></div>
              <input id="importFile" type="file" accept="application/json" style="display:none"/>
              <button id="importBtn" class="icon" title="–ò–º–ø–æ—Ä—Ç" aria-label="–ò–º–ø–æ—Ä—Ç" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 8v12M12 20l-4-4M12 20l4-4"></path><path d="M4 4h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∞ -->
      <section class="card">
        <h2 style="margin:0 0 10px">–ì—Ä–∞—Ñ–∏–∫–∞</h2>
        <div class="inputs-row">
          <select id="aggSel" title="–ê–≥—Ä–µ–≥–∞—Ü–∏—è">
            <option value="daily" selected>–î–Ω–µ–≤–Ω–∏</option>
            <option value="weekly">–°–µ–¥–º–∏—á–Ω–∏</option>
            <option value="monthly">–ú–µ—Å–µ—á–Ω–∏</option>
          </select>
        </div>
        <canvas id="chart"></canvas>
      </section>

      <!-- –ó–∞–ø–∏—Å–∏ -->
      <section class="card">
        <h2 style="margin:0">–ó–∞–ø–∏—Å–∏</h2>

        <div class="recbar">
          <label for="pageSize" style="font-size:12px;color:var(--muted)">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞:</label>
          <select id="pageSize">
            <option value="7">7 (1 —Å–µ–¥.)</option>
            <option value="14">14 (2 —Å–µ–¥.)</option>
            <option value="28" selected>28 (~1 –º–µ—Å.)</option>
            <option value="84">84 (~3 –º–µ—Å.)</option>
            <option value="112">112 (~4 –º–µ—Å.)</option>
            <option value="168">168 (~6 –º–µ—Å.)</option>
            <option value="336">336 (~12 –º–µ—Å.)</option>
            <option value="all">–í—Å–∏—á–∫–∏</option>
          </select>
        </div>

        <div class="pager" id="pagerTop"></div>
        <table id="tbl">
          <colgroup><col class="date"><col class="w"><col class="act"></colgroup>
          <thead id="theadTop">
            <tr>
              <th class="date">–î–∞—Ç–∞</th>
              <th class="w">–¢–µ–≥–ª–æ (kg)</th>
              <th class="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="tfootBottom">
            <tr>
              <th class="date">–î–∞—Ç–∞</th>
              <th class="w">–¢–µ–≥–ª–æ (kg)</th>
              <th class="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </tfoot>
        </table>
        <div class="pager" id="pagerBottom"></div>
      </section>
    </main>
  </div>

  <!-- –ü–ê–ù–ï–õ: –ü–†–û–ì–†–ê–ú–ê -->
  <div id="panel-program" class="tabpanel" role="tabpanel" aria-labelledby="tab-program" aria-hidden="true">
    <main>
      <!-- üü© –û—Å–Ω–æ–≤–µ–Ω –ø–∞–∫–µ—Ç -->
      <section class="card" id="pkg-core">
        <h2 style="margin:0 0 10px">–û—Å–Ω–æ–≤–µ–Ω –ø–∞–∫–µ—Ç</h2>

        <!-- ProLact Slim+ ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –î–ù–ò √ó 2 –í–†–ï–ú–ï–ù–ê -->
        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/prolact.webp" alt="ProLact Slim+"/>
            <span class="prog-cap">ProLact Slim+</span>
          </div>

          <div class="day-grid-wrap">
            <table class="pl-table" id="pl-table">
              <thead>
                <tr id="pl-dow-row">
                  <!-- –ø–æ–ø—ä–ª–≤–∞ —Å–µ –¥–∏–Ω–∞–º–∏—á–Ω–æ —Å –ü–Ω‚Ä¶–ù–¥ -->
                </tr>
              </thead>
              <tbody>
                <tr id="pl-t1-row"></tr>
                <tr id="pl-t2-row"></tr>
              </tbody>
            </table>
          </div>

          <div class="pl-actions">
            <button id="pl-change-time" class="action-tile" type="button" title="–ü—Ä–æ–º—è–Ω–∞ –Ω–∞ –≤—Ä–µ–º–µ—Ç–æ">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="9"></circle>
                <path d="M12 7v5l3 3"></path>
              </svg>
              <span>–ü—Ä–æ–º—è–Ω–∞ –Ω–∞ –≤—Ä–µ–º–µ—Ç–æ</span>
            </button>

            <button id="pl-flag" class="round-btn" type="button" title="–°—ä—Å—Ç–æ—è–Ω–∏–µ"></button>
          </div>
        </div>

        <hr class="prog-sep" style="border:0;border-top:1px solid var(--border);margin:14px 0"/>

        <!-- OMNi-Biotic HETOX light (—Å–µ–≥–∞—à–Ω–∏—è—Ç –∫–æ–º–ø–∞–∫—Ç UI) -->
        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/omni-hetox-light.png" alt="OMNi-Biotic HETOX light"/>
            <span class="prog-cap">OMNi-Biotic HETOX light</span>
          </div>
          <p style="margin:6px 0 0;color:var(--muted);font-size:13px">–û–±–µ–¥ ‚Äî –µ–¥–Ω–æ–∫—Ä–∞—Ç–µ–Ω –ø—Ä–∏–µ–º (—Ä–µ–¥–∞–∫—Ü–∏—è—Ç–∞ –æ—Å—Ç–∞–≤–∞ –∫–∞–∫—Ç–æ –¥–æ—Å–µ–≥–∞).</p>
        </div>

        <hr class="prog-sep" style="border:0;border-top:1px solid var(--border);margin:14px 0"/>

        <!-- Fortex –•–∏—Ç–æ–∑–∞–Ω –ü–ª—é—Å (–∫–æ–º–ø–∞–∫—Ç) -->
        <div>
          <div class="prog-head">
            <img class="prod-img" src="assets/products/chitosan-plus.webp" alt="Fortex –•–∏—Ç–æ–∑–∞–Ω –ü–ª—é—Å"/>
            <span class="prog-cap">Fortex –•–∏—Ç–æ–∑–∞–Ω –ü–ª—é—Å</span>
          </div>
          <p style="margin:6px 0 0;color:var(--muted);font-size:13px">3 –ø—Ä–∏–µ–º–∞ (—Å—É—Ç—Ä–∏–Ω/–æ–±–µ–¥/–≤–µ—á–µ—Ä) ‚Äî —Ç–µ–∫—É—â–∞—Ç–∞ –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–≤–∞.</p>
        </div>
      </section>

      <!-- üü® –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω –ø–∞–∫–µ—Ç -->
      <section class="card" id="pkg-extra">
        <h2 style="margin:0 0 10px">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω –ø–∞–∫–µ—Ç</h2>
        <ul style="margin:8px 0 0; padding-left:1rem; line-height:1.5">
          <li><strong>–ë–µ—Ä–±–µ—Ä–∏–Ω 500‚Äì600 mg</strong> ‚Äî –º–∞—Ä–∫–∞ –ø–æ –∏–∑–±–æ—Ä</li>
          <li><strong>–ì–ª—é–∫–æ–º–∞–Ω–∞–Ω</strong> (<em>NOW Foods</em>)</li>
          <li><strong>EGCg</strong> ‚Äî –µ–∫—Å—Ç—Ä–∞–∫—Ç –æ—Ç –∑–µ–ª–µ–Ω —á–∞–π (<em>NOW Foods</em>)</li>
        </ul>
      </section>

      <!-- üíä –õ–∏—á–µ–Ω —Ä–µ–∂–∏–º -->
      <section class="card" id="pkg-personal">
        <h2 style="margin:0 0 10px">–õ–∏—á–µ–Ω —Ä–µ–∂–∏–º</h2>
        <p style="margin:0 0 8px; color:#9fb4ad">
          –¢—É–∫ –≤–∫–ª—é—á–≤–∞—à –¥—Ä—É–≥–∏ –¥–æ–±–∞–≤–∫–∏/–≤–∏—Ç–∞–º–∏–Ω–∏/–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∏ –∏–∑–≤—ä–Ω –æ—Å–Ω–æ–≤–Ω–∞—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–∞.
        </p>
        <ul style="margin:8px 0 0; padding-left:1rem; line-height:1.5">
          <li><em>–ü—Ä–∏–º–µ—Ä:</em> –ú–∞–≥–Ω–µ–∑–∏–π –±–∏—Å–≥–ª–∏—Ü–∏–Ω–∞—Ç</li>
          <li><em>–ü—Ä–∏–º–µ—Ä:</em> –í–∏—Ç–∞–º–∏–Ω D3 + K2</li>
          <li><em>–ü—Ä–∏–º–µ—Ä:</em> –û–º–µ–≥–∞-3</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- ===== MODAL: –ö—Ä—ä–≥–æ–≤ —á–∞—Å–æ–≤–Ω–∏–∫ ===== -->
  <div id="ringModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="ringTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div id="ringTitle" class="modal-title">–ò–∑–±–æ—Ä –Ω–∞ –≤—Ä–µ–º–µ</div>
        <button id="ringCancel" class="btn" type="button">–û—Ç–∫–∞–∑</button>
      </div>
      <div class="ring" id="ringBox">
        <!-- SVG —á–∞—Å–æ–≤–Ω–∏–∫ (—á–∞—Å–æ–≤–µ + –º–∏–Ω—É—Ç–∏) -->
        <svg viewBox="0 0 280 280" id="ringSvg"></svg>
        <div id="ringCenter" class="ring-center">08:00</div>
      </div>
      <div class="modal-actions">
        <button id="ringOk" class="btn primary" type="button">–ó–∞–ø–∞–∑–∏</button>
      </div>
    </div>
  </div>

  <script>
  "use strict";
  // –í–µ—Ä—Å–∏—è
  window.__BT_VER = '2.28';

  /* ===== –¢–∞–± –ª–æ–≥–∏–∫–∞ ===== */
  (function(){
    const tabs = [
      {btn: document.getElementById('tab-data'), panel: document.getElementById('panel-data')},
      {btn: document.getElementById('tab-program'), panel: document.getElementById('panel-program')}
    ];
    function select(i){
      tabs.forEach((t,idx)=>{
        const sel = idx===i;
        t.btn.setAttribute('aria-selected', String(sel));
        t.panel.setAttribute('aria-hidden', String(!sel));
      });
      try{ localStorage.setItem('bt_active_tab_v228', String(i)); }catch(_){}
    }
    tabs.forEach((t,idx)=> t.btn.addEventListener('click', ()=>select(idx)));
    try{
      const saved = parseInt(localStorage.getItem('bt_active_tab_v228'),10);
      if(Number.isInteger(saved) && saved>=0 && saved<tabs.length) select(saved); else select(0);
    }catch(_){ select(0); }
  })();

  /* ===== –ü–æ–º–æ—â–Ω–∏ –∑–∞ –¥–∞—Ç–∏ ===== */
  function todayISO(){ var d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
  var TODAY = todayISO();
  function isoToBG_YY(iso){ if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return ""; var y=iso.slice(0,4), m=iso.slice(5,7), d=iso.slice(8,10); return d+"."+m+"."+y.slice(2); }
  function bgToISO_any(bg){
    var m2=bg.match(/^(\d{2})\.(\d{2})\.(\d{2})$/); if(m2) return "20"+m2[3]+"-"+m2[2]+"-"+m2[1];
    var m4=bg.match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(m4) return m4[3]+"-"+m4[2]+"-"+m4[1];
    return "";
  }

  /* ===== –õ–æ–∫–∞–ª–Ω–æ —Å—ä—Ö—Ä. –Ω–∞ –∑–∞–ø–∏—Å–∏ (–î–∞–Ω–Ω–∏) ===== */
  var KEY="bt-progress";
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||"[]"); }catch(_) { return []; } }
  function save(a){ localStorage.setItem(KEY, JSON.stringify(a)); }
  function sortDesc(a){ return a.slice().sort((x,y)=>y.date.localeCompare(x.date)); }
  function sortAsc(a){ return a.slice().sort((x,y)=>x.date.localeCompare(y.date)); }

  var dateText=document.getElementById("dateText"), calEl=document.getElementById("cal"),
      weight=document.getElementById("weight"), addBtn=document.getElementById("addBtn"),
      tb=document.querySelector("#tbl tbody"), pagerTop=document.getElementById("pagerTop"),
      pagerBottom=document.getElementById("pagerBottom"), aggSel=document.getElementById("aggSel"),
      chart=document.getElementById("chart"), pageSizeSel=document.getElementById("pageSize"),
      exportBtn=document.getElementById("exportBtn"), importBtn=document.getElementById("importBtn"),
      importFile=document.getElementById("importFile"), btFlag=document.getElementById("btFlag");

  var currentISO=localStorage.getItem("bt-last-date")||TODAY;
  if(!/^\d{4}-\d{2}-\d{2}$/.test(currentISO)) currentISO=TODAY;
  dateText.value=isoToBG_YY(currentISO);
  function prefillFor(iso){
    var data=load(); var rec=data.find(r=>r.date===iso);
    if(rec){
      weight.value=(typeof rec.weight==="number")?rec.weight:"";
      btFlag.checked = (rec.bt!==false);
      return;
    }
    var prev=sortDesc(data).find(r=>r.date<iso);
    weight.value=prev?prev.weight:"";
    btFlag.checked=true;
  }
  prefillFor(currentISO);

  /* –ö–∞–ª–µ–Ω–¥–∞—Ä –º–∏–Ω–∏ */
  var calYear=+currentISO.slice(0,4), calMonth=+currentISO.slice(5,7);
  function ymd(y,m,d){ return String(y).padStart(4,"0")+"-"+String(m).padStart(2,"0")+"-"+String(d).padStart(2,"0"); }
  function hasDataSet(){ var s=new Set(); load().forEach(r=>s.add(r.date)); return s; }
  function renderCalendar(){
    var set=hasDataSet(), y=calYear, m=calMonth;
    var first=new Date(Date.UTC(y,m-1,1));
    var startDow=(first.getUTCDay()+6)%7;
    var daysInMonth=new Date(Date.UTC(y,m,0)).getUTCDate();
    var title=new Date(Date.UTC(y,m-1,1)).toLocaleDateString("bg-BG",{year:"numeric",month:"long"});
    var html='<div class="cal-head"><button id="calPrev" type="button">‚Üê</button><div class="cal-title">'+title+'</div><button id="calNext" type="button">‚Üí</button></div>';
    html+='<div class="cal-grid">';
    ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–ù–¥"].forEach(x=>html+='<div class="dow">'+x+'</div>');
    for(var i=0;i<startDow;i++) html+='<div class="day disabled"></div>';
    for(var d=1; d<=daysInMonth; d++){
      var iso=ymd(y,m,d), future=(iso>TODAY);
      var cls=["day"]; if(iso===currentISO) cls.push("sel"); if(iso===TODAY) cls.push("today");
      if(set.has(iso)) cls.push("has"); if(future) cls.push("disabled");
      html+='<button type="button" class="'+cls.join(" ")+'" data-iso="'+iso+'">'+d+'</button>';
    }
    html+='</div>';
    calEl.innerHTML=html;
  }
  function showCalendar(){ renderCalendar(); calEl.classList.add("show"); }
  function hideCalendar(){ calEl.classList.remove("show"); }
  dateText.addEventListener("click",(e)=>{ e.stopPropagation(); calYear=+currentISO.slice(0,4); calMonth=+currentISO.slice(5,7); showCalendar(); });
  calEl.addEventListener("click",(e)=>{
    e.stopPropagation(); var t=e.target;
    if(t && t.id==="calPrev"){ calMonth--; if(calMonth===0){calMonth=12; calYear--; } renderCalendar(); return; }
    if(t && t.id==="calNext"){ calMonth++; if(calMonth===13){calMonth=1; calYear++; } renderCalendar(); return; }
    var btn=t.closest && t.closest(".day[data-iso]");
    if(btn){ var iso=btn.getAttribute("data-iso"); if(iso<=TODAY){ currentISO=iso; localStorage.setItem("bt-last-date",iso); dateText.value=isoToBG_YY(iso); prefillFor(iso); hideCalendar(); } }
  });
  document.addEventListener("click",(e)=>{ if(!calEl.contains(e.target) && e.target!==dateText) hideCalendar(); });

  addBtn.addEventListener("click", ()=>{
    var iso=currentISO;
    if(iso>TODAY){ alert("–î–∞—Ç–∞—Ç–∞ –µ –≤ –±—ä–¥–µ—â–µ—Ç–æ."); return; }
    var w=Number(weight.value); if(!(w>0)){ alert("–í—ä–≤–µ–¥–∏ —Ç–µ–≥–ª–æ > 0."); return; }

    var data=load(), prev=sortDesc(data).find(r=>r.date<iso), next=sortAsc(data).find(r=>r.date>iso);
    var ok=true, msgs=[];
    if(prev){ var minP=prev.weight*0.95, maxP=prev.weight*1.05; if(w<minP||w>maxP){ ok=false; msgs.push("—Å–ø—Ä—è–º–æ "+isoToBG_YY(prev.date)+": "+minP.toFixed(1)+"‚Äì"+maxP.toFixed(1)+" kg"); } }
    if(next){ var minN=next.weight*0.95, maxN=next.weight*1.05; if(w<minN||w>maxN){ ok=false; msgs.push("—Å–ø—Ä—è–º–æ "+isoToBG_YY(next.date)+": "+minN.toFixed(1)+"‚Äì"+maxN.toFixed(1)+" kg"); } }
    if(!ok){ alert("–ò–∑–≤—ä–Ω –¥–æ–ø—É—Å—Ç–∏–º–∏—Ç–µ –≥—Ä–∞–Ω–∏—Ü–∏:\n"+msgs.join("\n")); return; }

    var idx=data.findIndex(r=>r.date===iso);
    var rec={date: iso, weight: w, bt: !!btFlag.checked};
    if(idx>=0) data[idx]=rec; else data.push(rec);
    save(data);
    renderTable(); renderChart();
  });

  var PAGE_SIZES=[7,14,28,84,112,168,336,"all"];
  function getPS(){ var v=localStorage.getItem("bt-page-size"); if(v==="all") return "all"; var n=Number(v); return (PAGE_SIZES.indexOf(n)>=0)?n:28; }
  function setPS(v){ localStorage.setItem("bt-page-size",v); }
  var pageSize=getPS(), currentPage=1;
  (function(){ var v=(pageSize==="all")?"all":String(pageSize); var opt=document.querySelector('#pageSize option[value="'+v+'"]'); if(opt) pageSizeSel.value=v; })();
  pageSizeSel.addEventListener("change", ()=>{ var v=pageSizeSel.value; pageSize=(v==="all")?"all":Number(v); setPS(v); currentPage=1; renderTable(); renderChart(); });

  var __currentSlice=[];

  function buildPager(container,total,eff){
    container.innerHTML="";
    var start=(currentPage-1)*eff, from=total?start+1:0, to=Math.min(start+eff,total);
    var info=document.createElement("span"); info.className="info"; info.textContent=from+"-"+to+" –æ—Ç "+total; container.appendChild(info);

    var pagesTotal=Math.max(1,Math.ceil(total/eff)), frag=document.createDocumentFragment();
    function pageBtn(n,active){ var b=document.createElement("button"); b.textContent=String(n); if(active) b.className="active";
      b.addEventListener("click",()=>{currentPage=n; renderTable(); renderChart();}); return b; }
    if(pagesTotal>1 && currentPage>1){ var prev=document.createElement("button"); prev.textContent="‚Üê";
      prev.addEventListener("click",()=>{currentPage=Math.max(1,currentPage-1); renderTable(); renderChart();}); frag.appendChild(prev); }
    if(pagesTotal<=5){ for(var p=1;p<=pagesTotal;p++) frag.appendChild(pageBtn(p,p===currentPage)); }
    else{ var sp=currentPage-2; if(sp<1) sp=1; if(sp+4>pagesTotal) sp=pagesTotal-4; for(var pp=sp; pp<=sp+4; pp++) frag.appendChild(pageBtn(pp,pp===currentPage)); }
    if(pagesTotal>1 && currentPage<pagesTotal){ var next=document.createElement("button"); next.textContent="‚Üí";
      next.addEventListener("click",()=>{currentPage=Math.min(pagesTotal,currentPage+1); renderTable(); renderChart();}); frag.appendChild(next); }
    container.appendChild(frag);
  }

  function renderTable(){
    var all=sortDesc(load()), total=all.length, eff=(pageSize==="all")?(total||1):pageSize;
    var pages=Math.max(1,Math.ceil(total/eff)); if(currentPage>pages) currentPage=pages;
    var start=(currentPage-1)*eff, slice=all.slice(start,start+eff); __currentSlice=slice.slice();

    buildPager(pagerTop,total,eff);
    tb.innerHTML="";
    slice.forEach((r)=>{
      var tr=document.createElement("tr");
      var s=Number(r.weight).toFixed(1).split(".");
      tr.innerHTML =
        '<td class="date">'+isoToBG_YY(r.date)+'</td>'+
        '<td class="w wCell"><span class="wInt">'+s[0]+'</span><span class="wSmall">.'+s[1]+'</span></td>'+
        '<td class="actions">'+
          '<div class="actions">'+
            '<button class="icon" title="–†–µ–¥–∞–∫—Ü–∏—è" data-edit="'+r.date+'" aria-label="–†–µ–¥–∞–∫—Ü–∏—è" type="button">'+
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21l3-1 11-11-2-2L4 18z"></path><path d="M14 5l5 5"></path></svg>'+
            '</button>'+
            '<button class="icon danger" title="–ò–∑—Ç—Ä–∏–π" data-del="'+r.date+'" aria-label="–ò–∑—Ç—Ä–∏–π" type="button">'+
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"></path></svg>'+
            '</button>'+
          '</div>'+
        '</td>';
      tb.appendChild(tr);
    });
    Array.from(tb.querySelectorAll('button[data-edit]')).forEach((b)=>{
      b.addEventListener("click",()=>{
        var iso=b.getAttribute("data-edit"); var rec=load().find(x=>x.date===iso);
        if(rec){
          currentISO=iso; localStorage.setItem("bt-last-date",iso);
          dateText.value=isoToBG_YY(iso); prefillFor(iso);
          window.scrollTo({top:0,behavior:"smooth"});
        }
      });
    });
    Array.from(tb.querySelectorAll('button[data-del]')).forEach((b)=>{
      b.addEventListener("click",()=>{
        var iso=b.getAttribute("data-del"); if(!confirm("–î–∞ –∏–∑—Ç—Ä–∏—è –∑–∞–ø–∏—Å–∞ –∑–∞ "+isoToBG_YY(iso)+"?")) return;
        var data=load().filter(x=>x.date!==iso); save(data); renderTable(); renderChart();
      });
    });
    buildPager(pagerBottom,total,eff);
  }

  /* ===== –ì—Ä–∞—Ñ–∏–∫–∞ (canvas) ‚Äî —Å—ä–∫—Ä–∞—Ç–µ–Ω–∞—Ç–∞ —Ç–∏ –≤–µ—Ä—Å–∏—è, –±–µ–∑ –ø—Ä–æ–º–µ–Ω–∏ –≤ –ª–æ–≥–∏–∫–∞—Ç–∞ ===== */
  function cssPx(name, fallback){
    var v=getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    var n=parseFloat(v); return Number.isFinite(n)?n:fallback;
  }
  function weekKey(iso){
    var d=new Date(iso); d.setUTCHours(0,0,0,0); d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
    var yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
    var week=Math.ceil((((d-yearStart)/86400000)+1)/7);
    return d.getUTCFullYear()+"-W"+String(week).padStart(2,"0");
  }
  function monthKey(iso){ var d=new Date(iso); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); }
  function labelWeek(k){ var s=k.split("-W"); return "–°"+s[1]+"."+String(s[0]).slice(2); }
  function labelMonth(k){ var s=k.split("-"); return s[1]+"."+String(s[0]).slice(2); }
  function getChartRawData(){
    var mode=aggSel.value;
    if(mode==="daily"){ var src=(__currentSlice && __currentSlice.length)?__currentSlice.slice():sortDesc(load()); return sortAsc(src); }
    return sortAsc(load());
  }
  function renderChart(){
    var ctx=chart.getContext("2d"), rect=chart.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
    chart.width=Math.round(rect.width*dpr); chart.height=Math.round(360*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
    var w=rect.width, h=360; ctx.clearRect(0,0,w,h);

    var raw=getChartRawData(); if(!raw.length){
      ctx.fillStyle="#9fb4ad";
      ctx.font="700 "+cssPx('--chart-values', 15)+"px system-ui";
      ctx.fillText("–ù—è–º–∞ –¥–∞–Ω–Ω–∏",10,26);
      return;
    }

    var mode=aggSel.value, pts=[];
    if(mode==="daily"){
      pts=raw.map(r=>({x:r.date,y:r.weight,label:isoToBG_YY(r.date), bt:(r.bt!==false)}));
    } else if(mode==="weekly"){
      var wm=new Map();
      raw.forEach(r=>{ var k=weekKey(r.date); (wm.get(k)||wm.set(k,[]).get(k)).push(r); });
      wm.forEach((arr,k)=>{
        var s=0; for(var i=0;i<arr.length;i++) s+=arr[i].weight;
        var btCount=arr.filter(z=>z.bt!==false).length;
        pts.push({x:k,y:s/arr.length,label:labelWeek(k), bt:(btCount>=arr.length-btCount)});
      });
    } else {
      var mm=new Map();
      raw.forEach(r=>{ var k=monthKey(r.date); (mm.get(k)||mm.set(k,[]).get(k)).push(r); });
      mm.forEach((arr,k)=>{
        var s=0; for(var i=0;i<arr.length;i++) s+=arr[i].weight;
        var btCount=arr.filter(z=>z.bt!==false).length;
        pts.push({x:k,y:s/arr.length,label:labelMonth(k), bt:(btCount>=arr.length-btCount)});
      });
    }

    pts.sort((a,b)=>a.x.localeCompare(b.x));
    var vals=pts.map(p=>p.y).filter(n=>typeof n==="number");
    ctx.font="700 "+cssPx('--chart-values', 15)+"px system-ui";
    if(vals.length<2){ ctx.fillStyle="#9fb4ad"; ctx.fillText("–î–æ–±–∞–≤–∏ –ø–æ–Ω–µ 2 —Ç–æ—á–∫–∏",10,26); return; }

    var min=Math.min(...vals), max=Math.max(...vals);
    var padL=48, padR=18, padT=16, padB=96, n=pts.length;
    function X(i){ return padL+(w-padL-padR)*(n<=1?0:i/(n-1)); }
    function Y(v){ return h-padB-((v-min)/((max-min)||1))*(h-padT-padB); }

    ctx.strokeStyle="#20343a"; ctx.lineWidth=1.1;
    ctx.beginPath(); ctx.moveTo(padL,h-padB); ctx.lineTo(w-padR,h-padB); ctx.moveTo(padL,padT); ctx.lineTo(padL,h-padB); ctx.stroke();

    for(var i=1;i<n;i++){
      var p0=pts[i-1], p1=pts[i];
      var bothBT = (p0.bt && p1.bt);
      var bothNon = (!p0.bt && !p1.bt);
      ctx.strokeStyle = bothBT ? (getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b')
                      : bothNon ? (getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5')
                      : (getComputedStyle(document.documentElement).getPropertyValue('--line-neutral').trim()||'#2dd4bf');
      ctx.lineWidth=2.0;
      ctx.beginPath();
      ctx.moveTo(X(i-1), Y(p0.y));
      ctx.lineTo(X(i),   Y(p1.y));
      ctx.stroke();
    }

    ctx.fillStyle="#d9ebe5"; ctx.textBaseline="middle";
    ctx.fillText(String(max.toFixed(1)),10,Y(max)); ctx.fillText(String(min.toFixed(1)),10,Y(min));

    var maxLabels=Math.min(16,n), step=Math.max(1,Math.floor(n/maxLabels));
    var green=getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5';
    var orange=getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b';
    ctx.font="700 "+cssPx('--chart-label', 15)+"px system-ui";
    for(var j=0;j<n;j++){
      var pe=pts[j], x0=X(j), y0=h-padB;
      ctx.beginPath();
      ctx.fillStyle = pe.bt ? orange : green;
      const yVal = Y(pe.y);
      ctx.arc(x0, yVal, 3, 0, Math.PI*2);
      ctx.fill();

      /* –º–∞–ª—ä–∫ –µ—Ç–∏–∫–µ—Ç –ø—Ä–∏ –≤—Å—è–∫–∞ —Ç–æ—á–∫–∞ */
      ctx.save();
      ctx.font = "600 11px system-ui";
      ctx.fillStyle = "#9fb4ad";
      ctx.textBaseline = "bottom";
      ctx.textAlign = "left";
      const txt = pe.y.toFixed(1);
      const tw = ctx.measureText(txt).width;
      let xText = x0 + 5;
      if (xText + tw > w - padR - 2) xText = (w - padR - 2) - tw;
      if (xText < padL + 2) xText = padL + 2;
      ctx.fillText(txt, xText, yVal - 4);
      ctx.restore();

      if(j%step===0){
        ctx.save(); ctx.translate(x0,y0+64); ctx.rotate(-Math.PI/2);
        ctx.fillStyle="#e7faf4"; ctx.fillText(pe.label,0,0); ctx.restore();
      }
    }
  }
  aggSel.addEventListener("change", ()=>renderChart());

  /* ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ ‚Äû–î–∞–Ω–Ω–∏‚Äú ===== */
  function migrateDatesAndBT(){
    var arr=load(), changed=false;
    for(var i=0;i<arr.length;i++){
      var r=arr[i];
      if(typeof r.date==="string" && !/^\d{4}-\d{2}-\d{2}$/.test(r.date)){
        var iso=bgToISO_any(r.date); if(iso){ r.date=iso; changed=true; }
      }
      if(typeof r.bt==="undefined"){ r.bt=true; changed=true; }
    }
    if(changed) save(arr);
  }
  function initialRender(){
    migrateDatesAndBT();
    prefillFor(currentISO);
    renderTable(); renderChart();
    window.addEventListener("resize", ()=>renderChart(), {passive:true});
  }
  initialRender();

  /* ===== –ü–†–û–ì–†–ê–ú–ê ‚Üí ProLact Slim+ (—Ç–∞–±–ª–∏—Ü–∞ –¥–Ω–∏ √ó 2 –≤—Ä–µ–º–µ–Ω–∞) ===== */
  (function(){
    const DOW = ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–ù–¥"];
    const KEY_TIMES = "bt_pl_grid_v228";        // { d0:{t1:"08:00",t2:"19:00"}, ..., d6:{...}}
    const KEY_FLAG  = "bt_pl_flag_v228";        // "green" | "yellow" | "red"
    const DEF_T1 = "08:00"; const DEF_T2 = "19:00";

    const dowRow = document.getElementById("pl-dow-row");
    const t1Row  = document.getElementById("pl-t1-row");
    const t2Row  = document.getElementById("pl-t2-row");
    const btnFlag= document.getElementById("pl-flag");
    const btnTime= document.getElementById("pl-change-time");

    /* —Ç–µ–∫—É—â –¥–µ–Ω (0=–ü–Ω ... 6=–ù–¥) */
    function todayIndex(){
      const js = new Date().getDay(); // 0=Sun..6=Sat
      return (js===0)?6:(js-1);
    }
    const TODAY_IDX = todayIndex();

    /* state */
    function ensure(){
      try{
        const r=JSON.parse(localStorage.getItem(KEY_TIMES)||'');
        if(r && typeof r==="object"){ return r; }
      }catch(_){}
      const seed = {};
      for(let i=0;i<7;i++) seed["d"+i] = { t1: DEF_T1, t2: DEF_T2 };
      localStorage.setItem(KEY_TIMES, JSON.stringify(seed));
      return seed;
    }
    function loadTimes(){ try{ return JSON.parse(localStorage.getItem(KEY_TIMES))||ensure(); }catch(_){ return ensure(); } }
    function saveTimes(obj){ localStorage.setItem(KEY_TIMES, JSON.stringify(obj)); }

    function loadFlag(){ return localStorage.getItem(KEY_FLAG)||"green"; }
    function saveFlag(v){ localStorage.setItem(KEY_FLAG, v); }

    let state = loadTimes();
    let selDay = TODAY_IDX;        // –∫–æ–π –¥–µ–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–º–µ (—Ä–∞–º–∫–∞—Ç–∞ –≤ –æ—Ä–∞–Ω–∂–µ–≤–æ)
    let editCell = { row:1, col: TODAY_IDX }; // –∫–æ—è –∫–ª–µ—Ç–∫–∞ (t1 –∏–ª–∏ t2) ‚Äî –≤–∏–∑—É–∞–ª–Ω–æ —Å–∞–º–æ –∑–µ–ª–µ–Ω–æ –ø–æ–¥—á–µ—Ä—Ç–∞–≤–∞–Ω–µ

    /* –†–µ–Ω–¥–µ—Ä: –∑–∞–≥–ª–∞–≤–µ–Ω —Ä–µ–¥ —Å –¥–Ω–∏ */
    function renderDow(){
      dowRow.innerHTML = "";
      for(let i=0;i<7;i++){
        const th = document.createElement("th");
        th.className = "dow-cell";
        const isWeekend = (i===5 || i===6);
        const badge = document.createElement("span");
        badge.className = "dow-badge"+(isWeekend?" weekend":"");
        if(i===TODAY_IDX) badge.classList.add("current");
        if(i===selDay)    badge.classList.add("active");  // —Å–∞–º–æ –∏–∑–±—Ä–∞–Ω–∏—è –¥–µ–Ω –µ –æ—Ä–∞–Ω–∂–µ–≤
        badge.textContent = DOW[i];
        badge.title = "–î–µ–Ω: "+DOW[i];
        badge.addEventListener("click", ()=>{ selDay=i; renderAll(); });
        th.appendChild(badge);
        dowRow.appendChild(th);
      }
    }
    /* –†–µ–¥–æ–≤–µ —Å –≤—Ä–µ–º–µ–Ω–∞ */
    function two(n){ return String(n).padStart(2,"0"); }
    function tdTime(dayIdx, which){ // which=1|2
      const td = document.createElement("td");
      td.className = "time-cell";
      const tstr = state["d"+dayIdx][which===1?"t1":"t2"];
      const b = document.createElement("span");
      b.className = "time-badge";
      if(editCell.col===dayIdx && ((which===1 && editCell.row===1) || (which===2 && editCell.row===2))){
        b.classList.add("edit");
      }
      b.textContent = tstr;
      b.title = "–ü—Ä–æ–º–µ–Ω–∏ "+(which===1?"I":"II")+" –≤—Ä–µ–º–µ –∑–∞ "+DOW[dayIdx];
      b.addEventListener("click", ()=>{
        selDay = dayIdx;
        editCell = { row: which, col: dayIdx };
        openRing(tstr, (val)=>{
          state["d"+dayIdx][which===1?"t1":"t2"]=val;
          saveTimes(state);
          renderAll();
        });
      });
      td.appendChild(b);
      return td;
    }
    function renderTimes(){
      t1Row.innerHTML = ""; t2Row.innerHTML="";
      for(let i=0;i<7;i++){ t1Row.appendChild(tdTime(i,1)); }
      for(let i=0;i<7;i++){ t2Row.appendChild(tdTime(i,2)); }
    }

    /* –§–ª–∞–≥ –±—É—Ç–æ–Ω (–∑–µ–ª–µ–Ω–æ ‚Üí –∂—ä–ª—Ç–æ ‚Üí —á–µ—Ä–≤–µ–Ω–æ) */
    function paintFlag(){
      const v = loadFlag();
      btnFlag.className = "round-btn "+v;
      btnFlag.textContent = "";
      if(v==="green"){ btnFlag.textContent="OK"; }
      else if(v==="yellow"){ btnFlag.textContent="!"; }
      else { btnFlag.textContent="X"; }
    }
    btnFlag.addEventListener("click", ()=>{
      const v = loadFlag();
      const next = (v==="green")?"yellow":(v==="yellow")?"red":"green";
      saveFlag(next); paintFlag();
    });

    /* –ë—É—Ç–æ–Ω ‚Äû–ü—Ä–æ–º—è–Ω–∞ –Ω–∞ –≤—Ä–µ–º–µ—Ç–æ‚Äú ‚Äî –æ—Ç–≤–∞—Ä—è —Ä–µ–¥–∞–∫—Ü–∏—è –∑–∞ —Ç–µ–∫—É—â–æ —Å–µ–ª–µ–∫—Ç–∏—Ä–∞–Ω–∏—è —Å–ª–æ—Ç */
    btnTime.addEventListener("click", ()=>{
      const t = state["d"+selDay][editCell.row===1?"t1":"t2"];
      openRing(t, (val)=>{
        state["d"+selDay][editCell.row===1?"t1":"t2"]=val;
        saveTimes(state);
        renderAll();
      });
    });

    function renderAll(){
      state = loadTimes();
      renderDow();
      renderTimes();
      paintFlag();
    }

    renderAll();

    /* ===== –ö—Ä—ä–≥–æ–≤ —á–∞—Å–æ–≤–Ω–∏–∫ ‚Äî –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è (SVG) ===== */
    const modal = document.getElementById('ringModal');
    const ringSvg = document.getElementById('ringSvg');
    const ringCenter = document.getElementById('ringCenter');
    const btnOk  = document.getElementById('ringOk');      // –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è ‚Ññ1 (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–∞)
    const btnCan = document.getElementById('ringCancel');  // –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è ‚Ññ1 (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–∞)

    let ring = {
      hour: 8, minute: 0,
      phase: "hour", // "hour" ‚Üí "minute"
      onDone: null
    };

    function polar(cx, cy, r, angleDeg){
      const a = (angleDeg - 90) * Math.PI/180;
      return { x: cx + r*Math.cos(a), y: cy + r*Math.sin(a) };
    }

    function drawRing(){
      const cx=140, cy=140;
      ringSvg.innerHTML = "";

      // —Ñ–æ–Ω
      const bg = document.createElementNS("http://www.w3.org/2000/svg","circle");
      bg.setAttribute("cx", cx); bg.setAttribute("cy", cy); bg.setAttribute("r", 120);
      bg.setAttribute("fill", "#0f181b"); bg.setAttribute("stroke", "#27454a"); bg.setAttribute("stroke-width", "2");
      ringSvg.appendChild(bg);

      const labels = ring.phase==="hour" ? 24 : 60;
      const step = 360/labels;

      for(let i=0;i<labels;i++){
        const ang = i*step;
        const p = polar(cx,cy, 100, ang);
        const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
        txt.setAttribute("x", p.x); txt.setAttribute("y", p.y);
        txt.setAttribute("text-anchor","middle");
        txt.setAttribute("dominant-baseline","central");
        txt.setAttribute("fill", (ring.phase==="minute" && (i%5)!==0) ? "#56757a" : "#bfe3da");
        txt.setAttribute("font-size", (ring.phase==="hour" ? 11 : (i%5===0?10:0))); // –º–∏–Ω—É—Ç–Ω–∏—Ç–µ –Ω–µ-–∫—Ä–∞—Ç–Ω–∏ –Ω–∞ 5 —Å–∞ –º–∏–Ω–∏
        txt.style.userSelect="none";
        if(ring.phase==="hour"){
          txt.textContent = String(i);
        }else{
          txt.textContent = (i%5===0)? String(i).padStart(2,"0") : "¬∑"; // —á–µ—Ä—Ç–∏—á–∫–∏/—Ç–æ—á–∫–∏ –∑–∞ –º–∏–Ω—É—Ç–∏ –º–µ–∂–¥—É 5-—Ü–∏—Ç–µ
        }
        ringSvg.appendChild(txt);
      }

      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä
      const val = ring.phase==="hour" ? ring.hour : ring.minute;
      const angSel = val*step;
      const pSel = polar(cx,cy, 74, angSel);
      const dot = document.createElementNS("http://www.w3.org/2000/svg","circle");
      dot.setAttribute("cx", pSel.x); dot.setAttribute("cy", pSel.y);
      dot.setAttribute("r", 6); dot.setAttribute("fill", "#22c55e");
      ringSvg.appendChild(dot);

      ringCenter.textContent = String(ring.hour).padStart(2,"0")+":"+String(ring.minute).padStart(2,"0");
    }

    function pickAt(x, y){
      const rect = ringSvg.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top  + rect.height/2;
      const dx = x - cx, dy = y - cy;
      let ang = Math.atan2(dy, dx)*180/Math.PI + 90;
      if(ang<0) ang += 360;
      const labels = ring.phase==="hour" ? 24 : 60;
      const step = 360/labels;
      const idx = Math.round(ang/step) % labels;
      if(ring.phase==="hour") ring.hour = idx; else ring.minute = idx;
      drawRing();
    }

    function openRing(hhmm, onDone){
      const [H,M] = (hhmm||"08:00").split(":").map(n=>parseInt(n,10));
      ring.hour = Number.isFinite(H)?H:8;
      ring.minute = Number.isFinite(M)?M:0;
      ring.phase = "hour";
      ring.onDone = onDone || null;
      drawRing();
      modal.classList.add("show");
    }
    function closeRing(){ modal.classList.remove("show"); }

    ringSvg.addEventListener("click",(e)=>{
      pickAt(e.clientX, e.clientY);
      if(ring.phase==="hour") ring.phase="minute"; else ring.phase="hour";
      drawRing();
    });

    // —Å–ª—É—à–∞—Ç–µ–ª–∏—Ç–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–∏—Ç–µ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏ (–Ω—è–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ const!)
    btnCan.addEventListener('click', closeRing);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeRing(); });
    btnOk.addEventListener('click', ()=>{
      const hhmm = String(ring.hour).padStart(2,"0")+":"+String(ring.minute).padStart(2,"0");
      if(typeof ring.onDone === 'function') ring.onDone(hhmm);
      closeRing();
    });
  })();
  </script>
</body>
</html>
