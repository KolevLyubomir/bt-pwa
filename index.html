<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BT App — v2.1.13</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <meta name="theme-color" content="#0b1215"/>

  <style>
    :root{
      --bg:#0b1215; --card:#111a1f; --text:#e6f2ef; --muted:#9fb4ad;
      --accent:#22c55e; --border:#1e2b30; --warn:#f59e0b; --over:#facc15;
      --ok:#22c55e; --neutral:#0d171b;
      --sel-outline:#2f4b52;
      --maxw:980px;
      --pl-font:12px; --pl-pad:3px; --pl-minw:46px;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,"Noto Sans",sans-serif
    }

    .wrap{ max-width:var(--maxw); margin:16px auto; padding:0 16px; display:grid; gap:16px }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
    h2{ margin:0 0 10px; font-size:18px }
    .prog-prod + .prog-prod{ margin-top:14px; padding-top:14px; border-top:1px solid var(--border) }

    /* глава на продукт */
    .prog-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px }
    .prog-head-main{ display:flex; align-items:center; gap:10px; min-width:0 }
    .prod-img{ width:64px; height:64px; object-fit:contain; border-radius:10px; background:#0d171b; border:1px solid #254046 }
    .prog-cap{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

    /* бутон за „Прием“ вдясно (на реда на продукта) */
    .prog-intake-btn{
      border-radius:999px; border:1px solid #24343a; background:var(--neutral); color:var(--text);
      width:34px; height:34px; display:flex; align-items:center; justify-content:center;
      transition:transform .04s ease; padding:0;
    }
    .prog-intake-btn:active{ transform:scale(.96) }
    .prog-intake-btn .clk-btn-icon svg{
      width:34px; height:34px; /* базова иконка */
      transform:scale(1.7); /* +~20% спрямо преди (1.4 → 1.7) */
      transform-origin:50% 50%;
    }
    .prog-intake-btn.upcoming{ background:var(--warn); border-color:var(--warn); color:#041306 }
    .prog-intake-btn.overdue{
      background:var(--over); border-color:var(--over); color:#3b1f00;
      animation:intakeBlink 1s ease-in-out infinite;
    }
    .prog-intake-btn.done{ background:var(--ok); border-color:var(--ok); color:#06241b }

    @keyframes intakeBlink{
      0%,100%{ box-shadow:0 0 0 0 rgba(250,204,21,0); }
      50%{ box-shadow:0 0 0 3px rgba(250,204,21,.9); }
    }

    /* кутии за часовете (Omni/Chitosan) */
    .prog-row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .prog-pill{
      display:flex; flex-direction:column; gap:6px;
      padding:8px 10px; background:#0d171b; border:1px solid #254046; border-radius:10px;
      min-width:156px;
    }
    .time-wrap{ display:flex; align-items:center; gap:6px }
    .time-row{ display:flex; align-items:center; gap:4px }
    .time-row select{ min-width:54px; height:36px; padding:6px 8px; font-size:14px; background:#0d171b; color:var(--text); border:1px solid #254046; border-radius:8px }
    select option.strong{ font-weight:700 }

    /* Таблица ProLact – два реда (08:00 / 19:00) */
    .pl-wrap{ overflow-x:hidden }
    .pl-table{ width:100%; border-collapse:separate; border-spacing:3px; table-layout:fixed }
    .pl-table th, .pl-table td{
      border:1px solid #20343a; border-radius:10px; text-align:center;
      padding:var(--pl-pad); font-size:var(--pl-font); line-height:1.05; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      min-width:var(--pl-minw);
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
      background:transparent; color:var(--text);
    }
    .pl-day{ cursor:pointer; user-select:none; font-weight:800 }
    .pl-day.weekend{ color:#f97373; background:transparent } /* уикенд без фон, светло червени букви */
    .pl-day.today{ border-color:var(--warn); border-style:solid } /* винаги видим бордер за текущия ден */

    .pl-time-cell{ cursor:pointer; user-select:none; font-weight:800; position:relative; background:transparent }
    .pl-time-cell.active-day{ box-shadow:0 0 0 1px var(--sel-outline) inset } /* сив контур, не изчезва */

    /* състояния на слот за прием */
    .pl-time-cell.int-upcoming{ background:#3d3310; border-color:#6b5314 }
    .pl-time-cell.int-overdue{
      background:#3d3310; border-color:#facc15;
      animation:plOverdueBlink 1s ease-in-out infinite;
    }
    .pl-time-cell.int-done{ background:#15803d; border-color:#22c55e }

    @keyframes plOverdueBlink{
      0%,100%{ box-shadow:0 0 0 0 rgba(250,204,21,0) }
      50%{ box-shadow:0 0 0 2px rgba(250,204,21,.9) }
    }

    /* Модал: часовник с ролери */
    .clk{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100 }
    .clk.show{ display:flex; align-items:center; justify-content:center }
    .clk-card{
      background:#0e1519; border:1px solid #20343a; border-radius:16px;
      padding:12px 12px 14px; width:330px; max-width:92vw;
      box-shadow:0 10px 40px rgba(0,0,0,.5); position:relative; outline:none;
    }
    .clk-header{ margin-bottom:6px; padding:0 2px 4px; text-align:center }
    .clk-product-title{ font-size:13px; font-weight:700; margin-bottom:2px }
    .clk-day{ font-size:11px; opacity:.8; color:var(--muted); text-transform:lowercase }

    .clk-face{ position:relative; width:290px; height:290px; margin:0 auto; border-radius:50%; border:1px solid #294047; background:#0b1317; touch-action:none }
    .clk-ring{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); border-radius:50% }
    .clk-ring.hours{ width:190px; height:190px }
    .clk-ring.mins{ width:260px; height:260px }

    .clk-tick{
      position:absolute; display:flex; align-items:center; justify-content:center;
      border-radius:50%; user-select:none; transition:background .15s, border-color .15s, transform .12s;
      color:#d6ece6; background:#0f1a1d; border:1px solid transparent;
    }
    .clk-tick.hour{ width:30px; height:30px; font-weight:700 }
    .clk-tick.hour.sel{ background:var(--ok); color:#06241b; transform:scale(1.06) }
    .clk-tick.strong{ font-weight:900 }
    .clk-tick.minor{ width:8px; height:8px; font-size:9px; color:#6b8b92; background:#0b1317 }
    .clk-tick.minor.sel{ background:var(--ok); border-color:var(--ok); color:#06241b; transform:scale(1.2) }
    .clk-tick.quarter{ font-size:14px; font-weight:800 }

    .clk-hand{ position:absolute; left:50%; top:50%; transform-origin:50% 100%; pointer-events:none }
    .clk-hand.hour{ width:6px; height:68px; background:#e7faf4; border-radius:3px; transform:translate(-50%,-100%) rotate(0deg); box-shadow:0 0 0 1px #0b1215 inset }
    .clk-hand.min{ width:3px; height:96px; background:#cde7df; border-radius:2px; transform:translate(-50%,-100%) rotate(0deg); box-shadow:0 0 0 1px #0b1215 inset }
    .clk-center-dot{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:10px; height:10px; background:#fff; border-radius:50%; box-shadow:0 0 0 2px #0b1217 }

    .clk-read{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:#10191c; border:1px solid #294047; border-radius:6px;
      padding:3px 6px; font-weight:800; text-align:center; display:flex; align-items:center; gap:3px; font-size:18px; user-select:none;
    }
    .clk-read.editing{ border-color:#ffffff; cursor:text }
    .clk-read-part{ display:flex; align-items:center; gap:1px }
    .clk-digit{ min-width:0.9ch; text-align:center; color:#e6f2ef; position:relative; line-height:1.1 }
    .clk-read-colon{ padding:0 3px; opacity:.9; position:relative; top:-1px }

    @keyframes clkBlink{ 0%,49%{opacity:1} 50%,100%{opacity:0} }
    .clk-read.editing .clk-digit.active::after{
      content:""; position:absolute; left:0; right:0; bottom:-1px; height:2px; background:#e6f2ef; border-radius:2px; animation:clkBlink 1s steps(2,start) infinite;
    }

    .clk-actions{ margin-top:8px }
    .clk-actions-row{ display:flex; justify-content:space-between; align-items:flex-end; gap:8px }
    .clk-actions-group{ display:flex; gap:8px }

    .clk-btn{
      border-radius:999px; border:1px solid #24343a; background:var(--neutral); color:var(--text);
      width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      transition:background .12s,border-color .12s,transform .04s; -webkit-tap-highlight-color:transparent;
    }
    .clk-btn:active{ transform:scale(.96) }
    .clk-btn.primary{ background:var(--ok); border-color:var(--ok); color:#06241b }
    .clk-btn.audio{ background:#0d171b; border-color:#24343a; color:var(--text) }
    .clk-btn.audio.on{ background:#3b1113; border-color:#6b1414; color:#ffe0e0 }
    .clk-btn.audio.off{ background:var(--ok); border-color:var(--ok); color:#06241b }
    .clk-btn.empty{ visibility:hidden; pointer-events:none }

    /* иконки в модала */
    .clk-btn-icon{ display:inline-flex; align-items:center; justify-content:center }
    .clk-btn-icon svg{ width:38px; height:38px } /* Intake/Audio еднакви визуално големи */

    .clk-btn.intake .clk-btn-icon svg{
      transform:scale(1.7); /* +~20% */
      transform-origin:50% 50%;
    }

    .clk-btn.intake.upcoming{ background:var(--warn); border-color:var(--warn); color:#041306 }
    .clk-btn.intake.overdue{ background:var(--over); border-color:var(--over); color:#3b1f00; animation:intakeBlink 1s ease-in-out infinite }
    .clk-btn.intake.done{ background:var(--ok); border-color:var(--ok); color:#06241b }

    .clk-btn.audio svg .icon-sound{ display:none }
    .clk-btn.audio svg .icon-mute{ display:block }
    .clk-btn.audio.off svg .icon-sound{ display:block }
    .clk-btn.audio.off svg .icon-mute{ display:none }

    @media (max-width:380px){
      .clk-card{ width:306px }
      .clk-face{ width:272px; height:272px }
      .clk-ring.hours{ width:180px; height:180px }
      .clk-ring.mins{ width:248px; height:248px }
      .clk-hand.hour{ height:64px } .clk-hand.min{ height:90px }
    }
  </style>
</head>
<body>

  <main class="wrap">
    <section class="card" id="pkg-core">
      <h2>Основен пакет</h2>

      <!-- ProLact Slim+ -->
      <div class="prog-prod" data-prod="pl" id="prod-pl">
        <div class="prog-head">
          <div class="prog-head-main">
            <img class="prod-img" src="assets/products/prolact.webp" alt="ProLact Slim+"/>
            <span class="prog-cap">ProLact Slim+</span>
          </div>
          <button id="btnProgIntakePL" class="prog-intake-btn" title="Прием ProLact Slim+" style="display:none">
            <span class="clk-btn-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <g transform="translate(0,3)">
                  <circle cx="9" cy="9" r="5.25"></circle>
                  <path d="M9 6.5v3l2 1.5"></path>
                  <rect x="12.5" y="11" width="7" height="4" rx="2"></rect>
                  <path d="M13 11.5l5 3"></path>
                </g>
              </svg>
            </span>
          </button>
        </div>

        <div class="pl-wrap">
          <table class="pl-table" id="pl-table">
            <thead>
            <tr>
              <th class="pl-day" data-dow="1">Пн</th>
              <th class="pl-day" data-dow="2">Вт</th>
              <th class="pl-day" data-dow="3">Ср</th>
              <th class="pl-day" data-dow="4">Чт</th>
              <th class="pl-day" data-dow="5">Пт</th>
              <th class="pl-day weekend" data-dow="6">Сб</th>
              <th class="pl-day weekend" data-dow="0">Нд</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td class="pl-time-cell" data-row="0" data-dow="1">08:00</td>
              <td class="pl-time-cell" data-row="0" data-dow="2">08:00</td>
              <td class="pl-time-cell" data-row="0" data-dow="3">08:00</td>
              <td class="pl-time-cell" data-row="0" data-dow="4">08:00</td>
              <td class="pl-time-cell" data-row="0" data-dow="5">08:00</td>
              <td class="pl-time-cell" data-row="0" data-dow="6">08:00</td>
              <td class="pl-time-cell" data-row="0" data-dow="0">08:00</td>
            </tr>
            <tr>
              <td class="pl-time-cell" data-row="1" data-dow="1">19:00</td>
              <td class="pl-time-cell" data-row="1" data-dow="2">19:00</td>
              <td class="pl-time-cell" data-row="1" data-dow="3">19:00</td>
              <td class="pl-time-cell" data-row="1" data-dow="4">19:00</td>
              <td class="pl-time-cell" data-row="1" data-dow="5">19:00</td>
              <td class="pl-time-cell" data-row="1" data-dow="6">19:00</td>
              <td class="pl-time-cell" data-row="1" data-dow="0">19:00</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- OMNi-Biotic HETOX light (1 ред — 12:00) -->
      <div class="prog-prod" data-prod="om" id="prod-om">
        <div class="prog-head">
          <div class="prog-head-main">
            <img class="prod-img" src="assets/products/omni-hetox-light.png" alt="OMNi-Biotic HETOX light"/>
            <span class="prog-cap">OMNi-Biotic HETOX light</span>
          </div>
          <button id="btnProgIntakeOM" class="prog-intake-btn" title="Прием OMNi-Biotic HETOX light" style="display:none">
            <span class="clk-btn-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <g transform="translate(0,3)">
                  <circle cx="9" cy="9" r="5.25"></circle>
                  <path d="M9 6.5v3l2 1.5"></path>
                  <rect x="12.5" y="11" width="7" height="4" rx="2"></rect>
                  <path d="M13 11.5l5 3"></path>
                </g>
              </svg>
            </span>
          </button>
        </div>

        <div class="prog-row" role="group" aria-label="OMNi-Biotic HETOX light">
          <span class="prog-pill">
            <div class="time-wrap">
              <div class="time-row">
                <select id="he-hh"></select><span>:</span><select id="he-mm"></select>
              </div>
            </div>
          </span>
        </div>
      </div>

      <!-- Fortex Хитозан Плюс (3 реда — 08:00, 12:00, 19:00) -->
      <div class="prog-prod" data-prod="ch" id="prod-ch">
        <div class="prog-head">
          <div class="prog-head-main">
            <img class="prod-img" src="assets/products/chitosan-plus.webp" alt="Fortex Хитозан Плюс"/>
            <span class="prog-cap">Fortex Хитозан Плюс</span>
          </div>
          <button id="btnProgIntakeCH" class="prog-intake-btn" title="Прием Fortex Хитозан Плюс" style="display:none">
            <span class="clk-btn-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <g transform="translate(0,3)">
                  <circle cx="9" cy="9" r="5.25"></circle>
                  <path d="M9 6.5v3l2 1.5"></path>
                  <rect x="12.5" y="11" width="7" height="4" rx="2"></rect>
                  <path d="M13 11.5l5 3"></path>
                </g>
              </svg>
            </span>
          </button>
        </div>

        <div class="prog-row" role="group" aria-label="Хитозан Плюс">
          <span class="prog-pill">
            <div class="time-wrap"><div class="time-row">
              <select id="ch-hh-m"></select><span>:</span><select id="ch-mm-m"></select>
            </div></div>
          </span>
          <span class="prog-pill">
            <div class="time-wrap"><div class="time-row">
              <select id="ch-hh-n"></select><span>:</span><select id="ch-mm-n"></select>
            </div></div>
          </span>
          <span class="prog-pill">
            <div class="time-wrap"><div class="time-row">
              <select id="ch-hh-e"></select><span>:</span><select id="ch-mm-e"></select>
            </div></div>
          </span>
        </div>
      </div>
    </section>
  </main>

  <!-- Модал (часовник с ролери) -->
  <div class="clk" id="clk" aria-hidden="true">
    <div class="clk-card" id="clkCard" role="dialog" aria-label="Избор на време">
      <div class="clk-header">
        <div id="clk-product" class="clk-product-title"></div>
        <div id="clk-weekday" class="clk-day"></div>
      </div>

      <div class="clk-face" id="clkFace">
        <div class="clk-ring mins" id="ringM"></div>
        <div class="clk-ring hours" id="ringH"></div>
        <div class="clk-hand hour" id="handH"></div>
        <div class="clk-hand min" id="handM"></div>
        <div class="clk-center-dot"></div>

        <div class="clk-read" id="clkRead">
          <div id="clkH" class="clk-read-part" data-part="H">
            <span class="clk-digit" data-pos="1"></span>
            <span class="clk-digit" data-pos="2"></span>
          </div>
          <span class="clk-read-colon">:</span>
          <div id="clkM" class="clk-read-part" data-part="M">
            <span class="clk-digit" data-pos="3"></span>
            <span class="clk-digit" data-pos="4"></span>
          </div>
        </div>
      </div>

      <input id="clkKeyInput" type="tel" inputmode="numeric" pattern="[0-9]*" autocomplete="off"
             style="position:absolute; opacity:0; height:0; width:0; border:0; padding:0; pointer-events:none;"/>

      <div class="clk-actions">
        <div class="clk-actions-row">
          <!-- Прием (голям) -->
          <button id="btnIntake" class="clk-btn intake" type="button" title="Прием">
            <span class="clk-btn-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <g transform="translate(0,3)">
                  <circle cx="9" cy="9" r="5.25"></circle>
                  <path d="M9 6.5v3l2 1.5"></path>
                  <rect x="12.5" y="11" width="7" height="4" rx="2"></rect>
                  <path d="M13 11.5l5 3"></path>
                </g>
              </svg>
            </span>
          </button>

          <div class="clk-actions-group">
            <button id="btnSaveOne" class="clk-btn primary" type="button" title="Запис за този ден">
              <span class="clk-btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 13l4 4L19 7"></path></svg>
              </span>
            </button>
            <button id="btnSaveAllDays" class="clk-btn primary" type="button" title="Запис за всички дни от този ред">
              <span class="clk-btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 13l3 3 5-7"></path><path d="M11 13l3 3 6-8"></path></svg>
              </span>
            </button>
          </div>

          <!-- Аудио (голям, еднакъв размер с Прием) -->
          <button id="btnAudio" class="clk-btn audio" type="button" title="Аудио вкл/изкл за този час">
            <span class="clk-btn-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <g class="icon-sound">
                  <path d="M5 9v6h3l4 4V5L8 9H5z"></path>
                  <path d="M16 9a3 3 0 0 1 0 6"></path>
                </g>
                <g class="icon-mute">
                  <path d="M5 9v6h3l4 4V5L8 9H5z"></path>
                  <path d="M18 9l-4 4m0-4l4 4"></path>
                </g>
              </svg>
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
"use strict";

/* ===== Utilities ===== */
function two(n){ return String(n).padStart(2,"0"); }
function todayISO(){
  var d=new Date();
  d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  return d.toISOString().slice(0,10);
}
var TODAY = todayISO();

/* ===== Build Select helpers ===== */
function buildHourRange(sel, fromH, toH){
  sel.innerHTML="";
  for(let h=fromH; h<=toH; h++){
    const o=document.createElement("option");
    o.value=two(h); o.textContent=o.value;
    if(h===8 || h===12 || h===19) o.className="strong";
    sel.appendChild(o);
  }
}
function buildMinutes5(sel){
  sel.innerHTML="";
  for(let m=0; m<60; m+=5){
    const o=document.createElement("option");
    o.value=two(m); o.textContent=o.value;
    if(m%15===0) o.className="strong";
    sel.appendChild(o);
  }
}
function setSel(sel,val){ const opt=[...sel.options].find(o=>o.value===val); if(opt){ sel.value=val; return true;} return false; }
function timeStrToMin(str){
  const parts=(str||"00:00").split(":");
  let h=parseInt(parts[0],10), m=parseInt(parts[1],10);
  if(!Number.isFinite(h)) h=0;
  if(!Number.isFinite(m)) m=0;
  if(h<0) h=0; if(h>23) h=23;
  if(m<0) m=0; if(m>59) m=59;
  return h*60+m;
}

/* ===== OMNI (1 ред) ===== */
(function(){
  const KEY='bt_he_omni_time_v1';
  const DEF="12:00";
  const hh=document.getElementById('he-hh');
  const mm=document.getElementById('he-mm');
  if(!hh || !mm) return;
  buildHourRange(hh,6,21);
  buildMinutes5(mm);

  function load(){
    try{
      const v=localStorage.getItem(KEY);
      if(typeof v==="string" && /^\\d{2}:\\d{2}$/.test(v)) return v;
    }catch(_){}
    localStorage.setItem(KEY,DEF);
    return DEF;
  }
  function save(str){ localStorage.setItem(KEY,str); }
  function setFromStr(str){
    const parts=(str||DEF).split(":");
    const H=parts[0]||"12"; const M=parts[1]||"00";
    if(!setSel(hh,H)) hh.value="12";
    if(!setSel(mm,M)) mm.value="00";
  }
  function getStr(){ return (hh.value||"12")+":"+(mm.value||"00"); }

  const start = load();
  setFromStr(start);
  [hh,mm].forEach(sel=> sel.addEventListener('change', ()=> save(getStr())));
})();

/* ===== CHITOSAN (3 реда) ===== */
(function(){
  const DEF={m:"08:00", n:"12:00", e:"19:00"};
  const KEY='bt_ch_tim_v230';

  const hhM=document.getElementById('ch-hh-m'), mmM=document.getElementById('ch-mm-m');
  const hhN=document.getElementById('ch-hh-n'), mmN=document.getElementById('ch-mm-n');
  const hhE=document.getElementById('ch-hh-e'), mmE=document.getElementById('ch-mm-e');

  buildHourRange(hhM,0,9);  buildMinutes5(mmM);
  buildHourRange(hhN,10,17); buildMinutes5(mmN);
  buildHourRange(hhE,18,23); buildMinutes5(mmE);

  function ensure(){
    try{
      const r=JSON.parse(localStorage.getItem(KEY)||'');
      if(r&&r.m&&r.n&&r.e) return r;
    }catch(_){}
    const def={...DEF};
    localStorage.setItem(KEY, JSON.stringify(def));
    return def;
  }
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY))||ensure(); }catch(_){ return ensure(); } }
  function save(t){ localStorage.setItem(KEY, JSON.stringify(t)); }

  function setFromStr(hhSel, mmSel, str){
    const [H,M]=(str||"").split(":");
    if(!setSel(hhSel,H)) hhSel.value=hhSel.options[0].value;
    if(!setSel(mmSel,M)) mmSel.value="00";
  }
  function getStr(hhSel, mmSel){ return (hhSel.value||"00")+":"+(mmSel.value||"00"); }

  const t0=ensure();
  setFromStr(hhM,mmM,t0.m); setFromStr(hhN,mmN,t0.n); setFromStr(hhE,mmE,t0.e);

  function write(){
    save({ m:getStr(hhM,mmM), n:getStr(hhN,mmN), e:getStr(hhE,mmE) });
  }
  [hhM,mmM,hhN,mmN,hhE,mmE].forEach(sel=> sel.addEventListener('change', write));
  write();
})();

/* ===== ProLact: таблица 2 реда, състояния, модал, пренареждане ===== */
(function(){
  const TABLE = document.getElementById('pl-table'); if(!TABLE) return;

  const btnPL = document.getElementById('btnProgIntakePL');
  const btnOM = document.getElementById('btnProgIntakeOM');
  const btnCH = document.getElementById('btnProgIntakeCH');

  const prodPL = document.getElementById('prod-pl');
  const prodOM = document.getElementById('prod-om');
  const prodCH = document.getElementById('prod-ch');
  const pkgCore = document.getElementById('pkg-core');

  const INTAKE_LOG_KEY='bt_intake_log_v1';

  function getTodayDow(){ return (new Date()).getDay(); }

  const KEY='bt_pl_grid_v230';
  const DEF_T1 = ["08:00","08:00","08:00","08:00","08:00","08:00","08:00"];
  const DEF_T2 = ["19:00","19:00","19:00","19:00","19:00","19:00","19:00"];

  function loadState(){
    try{
      const r=JSON.parse(localStorage.getItem(KEY)||"");
      if(r && r.times && r.times.length>=1 && r.flag && r.flag.length===r.times.length){
        if(typeof r.todayDow!=="number") r.todayDow=getTodayDow();
        if(typeof r.activeDow!=="number") r.activeDow=r.todayDow;
        return r;
      }
    }catch(_){}
    const init = {
      times:[ [...DEF_T1], [...DEF_T2] ],
      flag:[ [0,0,0,0,0,0,0],[0,0,0,0,0,0,0] ],
      todayDow:getTodayDow(),
      activeDow:getTodayDow()
    };
    localStorage.setItem(KEY, JSON.stringify(init));
    return init;
  }
  function saveState(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }

  function loadIntakeLog(){
    try{
      const raw = localStorage.getItem(INTAKE_LOG_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return [];
      const filtered = arr.filter(e=>e && e.date===TODAY);
      if(filtered.length !== arr.length){
        localStorage.setItem(INTAKE_LOG_KEY, JSON.stringify(filtered));
      }
      return filtered;
    }catch(_){ return []; }
  }
  function saveIntakeLog(arr){ localStorage.setItem(INTAKE_LOG_KEY, JSON.stringify(arr)); }

  let state = loadState();

  function refreshActiveColumnHighlight(){
    const cells = TABLE.querySelectorAll('.pl-time-cell');
    cells.forEach(cell=> cell.classList.remove('active-day'));
    if(typeof state.activeDow === "number"){
      cells.forEach(cell=>{
        const dow = Number(cell.getAttribute('data-dow'));
        if(dow === state.activeDow){ cell.classList.add('active-day'); }
      });
    }
  }
  function refreshDays(){
    const ths = TABLE.querySelectorAll('thead .pl-day');
    ths.forEach(th=>{
      const dow = Number(th.getAttribute('data-dow'));
      th.classList.toggle('today', dow===state.todayDow);
      th.classList.toggle('active', dow===state.activeDow);
    });
    refreshActiveColumnHighlight();
  }
  function renderTimes(){
    const seq=[1,2,3,4,5,6,0];
    for(let row=0; row<state.times.length; row++){
      for(let i=0;i<7;i++){
        const dow = seq[i], idx=(dow===0?6:dow-1);
        const cell = TABLE.querySelector('.pl-time-cell[data-row="'+row+'"][data-dow="'+dow+'"]');
        if(!cell) continue;
        cell.textContent = state.times[row][idx];
        cell.classList.remove('int-upcoming','int-done','int-overdue','active-day');
      }
    }
    refreshActiveColumnHighlight();
  }

  function getSlotStatePL(row,dow){
    const now = new Date(), todayDow = now.getDay();
    if(dow !== todayDow) return 'normal';
    const idx = (dow===0?6:dow-1);
    const tStr = state.times[row][idx];
    const planMin = timeStrToMin(tStr);
    const nowMin = now.getHours()*60 + now.getMinutes();
    const log = loadIntakeLog();
    const has = log.some(e=>e && e.date===TODAY && e.dow===dow && e.row===row && e.prod==='pl');
    if(has) return 'done';
    if(nowMin >= planMin) return 'overdue';
    if(nowMin >= planMin - 30) return 'upcoming';
    return 'normal';
  }
  function getSlotStateOM(){
    const now = new Date(), todayDow = now.getDay();
    const v = localStorage.getItem('bt_he_omni_time_v1') || "12:00";
    const planMin = timeStrToMin(v);
    const nowMin = now.getHours()*60 + now.getMinutes();
    const log = loadIntakeLog();
    const has = log.some(e=>e && e.date===TODAY && e.prod==='om');
    if(has) return 'done';
    if(nowMin >= planMin) return 'overdue';
    if(nowMin >= planMin - 30) return 'upcoming';
    return 'normal';
  }
  function getSlotStateCH(){
    const now = new Date();
    const t = JSON.parse(localStorage.getItem('bt_ch_tim_v230')||'{"m":"08:00","n":"12:00","e":"19:00"}');
    const times=[t.m,t.n,t.e].map(timeStrToMin);
    const nowMin = now.getHours()*60 + now.getMinutes();
    const log = loadIntakeLog();
    const has = log.some(e=>e && e.date===TODAY && e.prod==='ch');
    if(has) return 'done';

    // най-близък план за днешния ден
    let best = Math.min(...times);
    let status='normal';
    for(const plan of times){
      if(nowMin >= plan) status='overdue';
      else if(nowMin >= plan - 30) status='upcoming';
    }
    return status;
  }

  function updateIntakeStatesPL(){
    const now = new Date();
    const todayDow = now.getDay();
    state.todayDow = todayDow;
    saveState(state);

    const cells = TABLE.querySelectorAll('.pl-time-cell');
    cells.forEach(cell=>{
      cell.classList.remove('int-upcoming','int-done','int-overdue');
      const row = Number(cell.getAttribute('data-row'));
      const dow = Number(cell.getAttribute('data-dow'));
      if(dow!==todayDow) return;
      const st = getSlotStatePL(row,dow);
      if(st==='upcoming') cell.classList.add('int-upcoming');
      else if(st==='overdue') cell.classList.add('int-overdue');
      else if(st==='done') cell.classList.add('int-done');
    });
    refreshActiveColumnHighlight();
  }

  /* ==== Right-side intake buttons visibility/status ==== */
  function setBtnState(btn, st){
    if(!btn) return;
    btn.style.display = (st==='normal') ? 'none' : 'flex';
    btn.classList.remove('upcoming','overdue','done');
    if(st==='upcoming') btn.classList.add('upcoming');
    else if(st==='overdue') btn.classList.add('overdue');
    else if(st==='done') btn.classList.add('done');
  }

  function computeAndUpdateButtons(){
    // PL: ако някой от двете слота е upcoming/overdue → показваме бутона със статуса с по-висок приоритет
    if(btnPL){
      const dow = (new Date()).getDay();
      const st0 = getSlotStatePL(0,dow), st1 = getSlotStatePL(1,dow);
      const pri = (s)=> s==='overdue'?3 : s==='upcoming'?2 : s==='done'?1 : 0;
      const best = pri(st0) >= pri(st1) ? st0 : st1;
      setBtnState(btnPL, best);
      btnPL.dataset.row = pri(st0) >= pri(st1) ? "0" : "1";
      btnPL.dataset.dow = String(dow);
    }
    if(btnOM){
      const st = getSlotStateOM();
      setBtnState(btnOM, st);
    }
    if(btnCH){
      const st = getSlotStateCH();
      setBtnState(btnCH, st);
    }
  }

  /* ==== Auto re-order products so active is on top ==== */
  function reorderProducts(){
    if(!pkgCore) return;
    const items = [prodPL, prodOM, prodCH].filter(Boolean);
    // приоритет: overdue (2) > upcoming (1) > done/normal (0)
    function scoreFor(prod){
      if(prod===prodPL){
        const dow=(new Date()).getDay();
        const s0=getSlotStatePL(0,dow), s1=getSlotStatePL(1,dow);
        const pri = (s)=> s==='overdue'?2 : s==='upcoming'?1 : 0;
        return Math.max(pri(s0), pri(s1));
      }
      if(prod===prodOM){
        const s=getSlotStateOM();
        return s==='overdue'?2 : s==='upcoming'?1 : 0;
      }
      if(prod===prodCH){
        const s=getSlotStateCH();
        return s==='overdue'?2 : s==='upcoming'?1 : 0;
      }
      return 0;
    }
    items.sort((a,b)=> scoreFor(b)-scoreFor(a));
    const anchor = pkgCore.querySelector('h2');
    items.forEach(el=> el && pkgCore.appendChild(el)); // премества ги в реда на активност
  }

  /* ==== Intake log toggles ==== */
  function toggleIntakePL(row,dow){
    let log = loadIntakeLog();
    const idxEntry = log.findIndex(e=>e && e.date===TODAY && e.dow===dow && e.row===row && e.prod==='pl');
    if(idxEntry>=0){ log.splice(idxEntry,1); saveIntakeLog(log); return false; }
    log.push({ ts:new Date().toISOString(), date:TODAY, prod:'pl', dow, row }); saveIntakeLog(log); return true;
  }
  function toggleIntakeOM(){
    let log = loadIntakeLog();
    const idx = log.findIndex(e=>e && e.date===TODAY && e.prod==='om');
    if(idx>=0){ log.splice(idx,1); saveIntakeLog(log); return false; }
    log.push({ ts:new Date().toISOString(), date:TODAY, prod:'om' }); saveIntakeLog(log); return true;
  }
  function toggleIntakeCH(){
    let log = loadIntakeLog();
    const idx = log.findIndex(e=>e && e.date===TODAY && e.prod==='ch');
    if(idx>=0){ log.splice(idx,1); saveIntakeLog(log); return false; }
    log.push({ ts:new Date().toISOString(), date:TODAY, prod:'ch' }); saveIntakeLog(log); return true;
  }

  /* ==== Модал часовник, редакция на PL клетки ==== */
  const Modal = document.getElementById('clk');
  const Card  = document.getElementById('clkCard');
  const face  = document.getElementById('clkFace');
  const ringH = document.getElementById('ringH');
  const ringM = document.getElementById('ringM');
  const handH = document.getElementById('handH');
  const handM = document.getElementById('handM');
  const readBox  = document.getElementById('clkRead');
  const keyInput = document.getElementById('clkKeyInput');
  const btnSaveOne   = document.getElementById('btnSaveOne');
  const btnSaveAll   = document.getElementById('btnSaveAllDays');
  const btnIntake    = document.getElementById('btnIntake');
  const btnAudio     = document.getElementById('btnAudio');
  const clkProductEl = document.getElementById('clk-product');
  const clkWeekdayEl = document.getElementById('clk-weekday');

  let selRow=0, selDow=1, activeCell=null;
  let H=8, M=0, focusHM='H';
  let ampmCycle = 0, lastDispHour = 12;
  let digits = {d1:0,d2:0,d3:0,d4:0};
  let editPos = 1, isEditing=false;

  function hour24ToDisp(h24){ const cycle = (h24>=13)?1:0; const disp = ((h24-1)%12)+1; return {disp, cycle}; }
  function dispToHour24(disp, cycle){ return cycle===0? disp : (disp===12?24:disp+12); }
  function recomputeAmpmFromTime(){
    ampmCycle = (H>=13 || H===24) ? 1 : 0;
    const d = hour24ToDisp(H); lastDispHour = d.disp;
  }
  function syncDigitsFromTime(){
    const hDisp = (H===24 ? 0 : H), hs = two(hDisp), ms = two(M);
    digits.d1=+hs[0]||0; digits.d2=+hs[1]||0; digits.d3=+ms[0]||0; digits.d4=+ms[1]||0;
  }
  function renderDigits(){
    const map={1:digits.d1,2:digits.d2,3:digits.d3,4:digits.d4};
    for(let pos=1;pos<=4;pos++){
      const span = readBox.querySelector('.clk-digit[data-pos="'+pos+'"]');
      if(span){ span.textContent = String(map[pos]); span.classList.toggle('active', isEditing && pos===editPos); }
    }
  }
  function updateRead(){ renderDigits(); }
  function setHands(){
    const d = hour24ToDisp(H);
    const degH = (d.disp%12)*30 + (M/60)*30;
    const degM = M*6;
    handH.style.transform = 'translate(-50%,-100%) rotate('+degH+'deg)';
    handM.style.transform = 'translate(-50%,-100%) rotate('+degM+'deg)';
  }
  function clear(node){ while(node.firstChild) node.removeChild(node.firstChild); }

  function buildHours(){
    clear(ringH);
    for(let i=1;i<=12;i++){
      const el=document.createElement('div');
      el.className='clk-tick hour'+((i===12||i===3||i===6||i===9)?' strong':'');
      el.dataset.disp=String(i);
      el.textContent = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"][i-1];
      const ang = (Math.PI*2) * (i%12)/12 - Math.PI/2;
      const R=76, SIZE=30;
      const x=Math.cos(ang)*R, y=Math.sin(ang)*R;
      el.style.width=SIZE+'px'; el.style.height=SIZE+'px';
      el.style.left='calc(50% + '+(x-SIZE/2)+'px)'; el.style.top='calc(50% + '+(y-SIZE/2)+'px)';
      const h24 = dispToHour24(i, ampmCycle);
      if(h24===H) el.classList.add('sel');
      el.addEventListener('click', ()=>{ H = dispToHour24(i, ampmCycle); recomputeAmpmFromTime(); syncDigitsFromTime(); updateRead(); setHands(); buildHours(); focusHM='H'; });
      ringH.appendChild(el);
    }
  }
  function refreshMinuteTicks(){
    const children = ringM? Array.from(ringM.children):[];
    children.forEach(el=>{
      const m = parseInt(el.dataset.min,10); if(!Number.isFinite(m)) return;
      const isMajor = (m%5===0);
      el.classList.toggle('sel', m===M);
      el.textContent = isMajor? (m===0? "60" : two(m)) : '·';
    });
  }
  function buildMins(){
    clear(ringM);
    for(let m=0;m<60;m++){
      const isMajor=(m%5===0), isQuarter=(m===0||m===15||m===30||m===45);
      let cls='clk-tick'; cls += isMajor ? ' strong' : ' minor'; if(isQuarter) cls+=' quarter';
      const el=document.createElement('div'); el.className=cls; el.dataset.min=String(m);
      el.textContent = isMajor? (m===0? "60" : two(m)) : '·';
      const ang=(Math.PI*2)*(m/60)-Math.PI/2, R=isMajor?120:108, size=isMajor?20:8, x=Math.cos(ang)*R, y=Math.sin(ang)*R;
      el.style.width=size+'px'; el.style.height=size+'px';
      el.style.left='calc(50% + '+(x-size/2)+'px)'; el.style.top='calc(50% + '+(y-size/2)+'px)';
      el.addEventListener('click',()=>{ M=m; recomputeAmpmFromTime(); syncDigitsFromTime(); updateRead(); setHands(); refreshMinuteTicks(); buildHours(); focusHM='M'; });
      ringM.appendChild(el);
    }
    refreshMinuteTicks();
  }

  function showClk(row,dow,initial, cell){
    if(activeCell) activeCell.classList.remove('sel'); activeCell=cell; if(activeCell) activeCell.classList.add('sel');
    selRow=row; selDow=dow; state.activeDow=dow; saveState(state); refreshDays();

    if(clkProductEl) clkProductEl.textContent = "ProLact Slim+";
    if(clkWeekdayEl){
      var names=['неделя','понеделник','вторник','сряда','четвъртък','петък','събота'];
      clkWeekdayEl.textContent = names[dow]||"";
    }

    const idx=(dow===0?6:dow-1);
    const parts=(initial||state.times[row][idx]).split(':');
    let h=parseInt(parts[0],10); let m=parseInt(parts[1],10);
    if(!Number.isFinite(h)) h=8; if(!Number.isFinite(m)) m=0;
    if(h===0) h=24;
    H=h; M=m;

    recomputeAmpmFromTime(); syncDigitsFromTime(); editPos=1; isEditing=false;
    updateRead(); setHands(); buildHours(); buildMins();

    updateIntakeButtonForCurrent();
    updateAudioButtonForCurrent();

    Modal.classList.add('show'); Modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
  }
  function hideClk(){ Modal.classList.remove('show'); Modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; if(activeCell){ activeCell.classList.remove('sel'); activeCell=null; } stopEditing(); }

  TABLE.querySelectorAll('.pl-time-cell').forEach(td=>{
    td.addEventListener('click', ()=>{
      const row = Number(td.getAttribute('data-row'));
      const dow = Number(td.getAttribute('data-dow'));
      showClk(row, dow, td.textContent.trim(), td);
    });
  });
  TABLE.querySelectorAll('thead .pl-day').forEach(th=>{
    th.addEventListener('click', ()=>{ state.activeDow = Number(th.getAttribute('data-dow')); saveState(state); refreshDays(); });
  });
  Modal.addEventListener('click',(e)=>{ if(e.target===Modal) hideClk(); });

  /* intake status inside modal for current PL slot */
  function updateIntakeButtonForCurrent(){
    if(!btnIntake) return;
    btnIntake.classList.remove('upcoming','overdue','done');
    const st = getSlotStatePL(selRow, selDow);
    if(st==='upcoming') btnIntake.classList.add('upcoming');
    else if(st==='overdue') btnIntake.classList.add('overdue');
    else if(st==='done') btnIntake.classList.add('done');
  }
  function updateAudioButtonForCurrent(){
    if(!btnAudio) return;
    btnAudio.classList.remove('on','off');
    const idx = (selDow===0?6:selDow-1);
    const f = (state.flag[selRow] && state.flag[selRow][idx])|0;
    btnAudio.classList.add( f===2 ? 'off' : 'on' );
  }

  function normalizeColumnAfterChange(rowIndex, dayIdx, newMinutes){
    const N = state.times.length, MAX=23*60+59;
    const col=new Array(N);
    for(let r=0;r<N;r++){
      const parts=(state.times[r][dayIdx]||"00:00").split(':');
      let h=parseInt(parts[0],10), m=parseInt(parts[1],10);
      if(!Number.isFinite(h)) h=0; if(!Number.isFinite(m)) m=0;
      if(h<0) h=0; if(h>23) h=23; if(m<0) m=0; if(m>59) m=59;
      col[r]=h*60+m;
    }
    let k=rowIndex, minAllowed=(k>0)?(col[k-1]+1):0, maxAllowed=MAX-((N-1)-k);
    let nm=newMinutes; if(nm<minAllowed) nm=minAllowed; if(nm>maxAllowed) nm=maxAllowed; col[k]=nm;
    for(let r=k+1;r<N;r++){ if(col[r]<=col[r-1]) col[r]=col[r-1]+1; }
    if(col[N-1]>MAX){ col[N-1]=MAX; for(let r=N-2;r>=0;r--){ if(col[r]>=col[r+1]) col[r]=Math.max(0,col[r+1]-1); } }
    for(let r=0;r<N;r++){ const h=Math.floor(col[r]/60), m=col[r]%60; state.times[r][dayIdx]=two(h)+":"+two(m); }
  }

  function applyTimeForCurrentCell(normalizeAllDays){
    const idx=(selDow===0?6:selDow-1);
    const hSave=(H===24?0:H);
    const newMinutes=hSave*60+M;
    if(normalizeAllDays){ for(let d=0; d<7; d++){ normalizeColumnAfterChange(selRow,d,newMinutes); } }
    else{ normalizeColumnAfterChange(selRow,idx,newMinutes); }
  }

  /* Editing via numpad in modal */
  function startEditing(pos){ isEditing=true; readBox.classList.add('editing'); editPos=(typeof pos==="number")?pos:editPos; renderDigits(); keyInput.value=""; keyInput.focus(); }
  function stopEditing(){
    if(isEditing){
      const hourCandidate = digits.d1*10 + digits.d2;
      const minCandidate  = digits.d3*10 + digits.d4;
      if(hourCandidate<=24 && minCandidate<=60){ const hh=(hourCandidate===0?24:hourCandidate), mm=(minCandidate===60?0:minCandidate); H=hh; M=mm; }
      else{ syncDigitsFromTime(); }
      updateRead(); setHands(); buildMins(); buildHours();
    }
    isEditing=false; readBox.classList.remove('editing'); renderDigits(); keyInput.blur(); keyInput.value="";
  }

  function handleDigit(d){
    if(editPos===1) digits.d1=d; else if(editPos===2) digits.d2=d; else if(editPos===3) digits.d3=d; else digits.d4=d;
    const hourCandidate = digits.d1*10 + digits.d2;
    const minCandidate  = digits.d3*10 + digits.d4;
    if(hourCandidate<=24 && minCandidate<=60){
      const hh=(hourCandidate===0?24:hourCandidate), mm=(minCandidate===60?0:minCandidate);
      H=hh; M=mm; recomputeAmpmFromTime(); syncDigitsFromTime(); updateRead(); setHands(); buildMins(); buildHours();
    }
    if(editPos<4) editPos++; renderDigits();
  }

  readBox.addEventListener('click',(ev)=>{
    const digitSpan = ev.target.closest('.clk-digit');
    const pos = digitSpan ? (Number(digitSpan.getAttribute('data-pos'))||editPos) : editPos;
    if(!isEditing) startEditing(pos); else { editPos=pos; renderDigits(); keyInput.focus(); }
  });
  keyInput.addEventListener('keydown',(ev)=>{
    const k=ev.key;
    if(k==='Escape'){ ev.preventDefault(); hideClk(); return; }
    if(!isEditing) return;
    if(k>='0' && k<='9'){ ev.preventDefault(); handleDigit(+k); return; }
    if(k==='Backspace' || k==='Delete'){ ev.preventDefault(); if(editPos===1) digits.d1=0; else if(editPos===2) digits.d2=0; else if(editPos===3) digits.d3=0; else digits.d4=0; renderDigits(); return; }
    if(k==='ArrowLeft'){ ev.preventDefault(); editPos=Math.max(1,editPos-1); renderDigits(); return; }
    if(k==='ArrowRight'){ ev.preventDefault(); editPos=Math.min(4,editPos+1); renderDigits(); return; }
  });
  keyInput.addEventListener('input', ()=>{
    if(!isEditing){ keyInput.value=""; return; }
    const txt = keyInput.value || ""; keyInput.value="";
    const nums = txt.replace(/\\D+/g,"");
    for(const ch of nums){ const d = ch.charCodeAt(0)-48; if(d>=0 && d<=9) handleDigit(d); }
  });
  document.addEventListener('click',(e)=>{
    if(!isEditing) return;
    if(readBox.contains(e.target) || e.target===keyInput) return;
    stopEditing();
  });

  /* modal buttons */
  btnSaveOne.addEventListener('click', ()=>{
    applyTimeForCurrentCell(false); saveState(state); renderTimes(); updateIntakeStatesPL(); hideClk();
    computeAndUpdateButtons(); reorderProducts();
  });
  btnSaveAll.addEventListener('click', ()=>{
    applyTimeForCurrentCell(true); saveState(state); renderTimes(); updateIntakeStatesPL(); hideClk();
    computeAndUpdateButtons(); reorderProducts();
  });
  btnAudio.addEventListener('click', ()=>{
    const idx=(selDow===0?6:selDow-1);
    const cur=(state.flag[selRow] && state.flag[selRow][idx])|0;
    const next=(cur===2?0:2);
    state.flag[selRow][idx]=next; saveState(state);
    renderTimes(); updateIntakeStatesPL(); hideClk();
  });
  btnIntake.addEventListener('click', ()=>{
    const nowDone = toggleIntakePL(selRow, selDow);
    updateIntakeStatesPL(); computeAndUpdateButtons(); reorderProducts();
  });

  /* right side buttons clicks */
  if(btnPL){
    btnPL.addEventListener('click', ()=>{
      const dow=(new Date()).getDay();
      // разчитаме dataset.row от computeAndUpdateButtons()
      const row = Number(btnPL.dataset.row||"0");
      toggleIntakePL(row,dow);
      updateIntakeStatesPL(); computeAndUpdateButtons(); reorderProducts();
    });
  }
  if(btnOM){
    btnOM.addEventListener('click', ()=>{
      toggleIntakeOM(); computeAndUpdateButtons(); reorderProducts();
    });
  }
  if(btnCH){
    btnCH.addEventListener('click', ()=>{
      toggleIntakeCH(); computeAndUpdateButtons(); reorderProducts();
    });
  }

  /* init */
  function initPL(){
    refreshDays(); renderTimes(); updateIntakeStatesPL();
    computeAndUpdateButtons(); reorderProducts();
    setInterval(()=>{ updateIntakeStatesPL(); computeAndUpdateButtons(); reorderProducts(); }, 60000);
  }
  initPL();
})();
</script>
</body>
</html>
