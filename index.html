<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BT — Тегло v29</title>
  <link rel="manifest" href="manifest.webmanifest?v=29">
  <meta name="theme_color" content="#10b981">
  <link rel="icon" href="assets/icons/icon-192.png?v=29">
  <style>
    :root{--bg:#0b1215;--card:#111a1f;--text:#e6f2ef;--muted:#9fb4ad;--accent:#10b981;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,'Noto Sans',sans-serif;background:#0b1215;color:var(--text)}
    header{position:sticky;top:0;background:#071013aa;backdrop-filter:blur(6px);border-bottom:1px solid #1e2b30;padding:12px 16px;display:flex;gap:12px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}.badge{background:#22c55e;color:#06241b;border-radius:10px;padding:2px 8px;margin-left:8px}
    main{max-width:1000px;margin:20px auto;padding:0 16px 40px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1e2b30;border-radius:16px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}.row.end{justify-content:flex-end;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{border-radius:10px;border:1px solid #254046;background:#0d171b;color:var(--text);padding:8px 10px;font-size:14px}
    input[readonly]{cursor:pointer}
    button{background:var(--accent);border:none;color:#06241b;font-weight:700;cursor:pointer}

    table{width:100%;border-collapse:collapse}th,td{padding:6px 8px;border-bottom:1px solid #20343a;font-size:14px}
    th{color:#9fb4ad;font-weight:600}
    th.comp,td.comp{width:1%;white-space:nowrap}
    th.date,td.date{width:1%;white-space:nowrap}
    td.w{text-align:right;font-variant-numeric:tabular-nums;width:1%;white-space:nowrap}

    .icon-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;padding:6px 8px;border-radius:8px;border:1px solid #2a3e41;background:#0d171b;color:#e6f2ef}
    .icon-btn svg{width:16px;height:16px}
    .icon-btn.danger{border-color:#3a2222;background:#161112;color:#ffd5d5}
    .icon-btn .label{position:absolute;left:50%;bottom:calc(100% + 8px);transform:translate(-50%,-6px);background:#0d171b;border:1px solid #2a3e41;border-radius:8px;padding:4px 8px;font-size:12px;white-space:nowrap;opacity:0;transition:.15s}
    .icon-btn:hover .label{opacity:1;transform:translate(-50%,0)}
    .chk{width:16px;height:16px;accent-color:#10b981}

    .pagination{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:10px}
    .pagination button{background:#0d171b;border:1px solid #2a3e41;color:#e6f2ef;padding:6px 10px;border-radius:10px}
    .pagination button.active{background:#10b981;color:#06241b;border-color:#10b981}
    .pagination .muted{color:#9fb4ad;margin-right:auto}

    canvas{max-width:100%;height:360px;margin-top:4px}

    /* модал */
    .modal-backdrop{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#0d171b;border:1px solid #2a3e41;border-radius:12px;padding:16px;width:min(420px,calc(100% - 32px))}
    .modal h3{margin:0 0 8px;font-size:16px}
    .modal p{margin:0 0 12px;color:#cfe1dc}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <header>
    <img src="assets/icons/icon-192.png?v=29" width="28" height="28" alt="BT">
    <h1>Безопасно Тегло — Тракер <span class="badge">v29</span></h1>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 8px">Нов запис</h2>
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label for="dateText">Дата</label>
          <input id="dateText" type="text" inputmode="none" placeholder="ДД.ММ.ГГ" autocomplete="off" readonly>
        </div>
        <div style="flex:1;min-width:140px">
          <label for="weight">Тегло (kg)</label>
          <input id="weight" type="number" step="0.1" min="0.1">
        </div>
      </div>

      <div class="row end" style="margin-top:8px; gap:8px">
        <button class="icon-btn" id="export" aria-label="Експорт" title="Експорт">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v12m0 0l-4-4m4 4l4-4"/><path d="M5 21h14"/></svg>
          <span class="label">Експорт</span>
        </button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="icon-btn" id="importBtn" aria-label="Импорт" title="Импорт">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21V9m0 0l4 4m-4-4L8 13"/><path d="M5 3h14"/></svg>
          <span class="label">Импорт</span>
        </button>
        <!-- Няма „Изтрий всички“ във v29 -->
        <button class="icon-btn danger" id="deleteSelected" title="Изтрий избраните" aria-label="Изтрий избраните" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"/></svg>
          <span class="label">Изтрий избраните</span>
        </button>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="add">Добави</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Графика</h2>
      <div class="row"><div>
        <label for="span">Агрегация</label>
        <select id="span">
          <option value="daily" selected>Дни (всички)</option>
          <option value="weekly">Седмици (средно)</option>
          <option value="monthly">Месеци (средно)</option>
        </select>
      </div></div>
      <canvas id="chart"></canvas>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Записи</h2>
      <table id="table">
        <thead>
          <tr>
            <th class="comp"><input type="checkbox" id="checkAll" class="chk" title="Маркирай всички"></th>
            <th class="date">Дата</th>
            <th class="comp w">Тегло (kg)</th>
            <th class="comp">Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="pagination" id="pager"></div>
    </section>
  </main>

  <!-- Модал за потвърждение -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">Потвърждение</h3>
      <p id="confirmMsg">Да изтрия избраните записи?</p>
      <div class="actions">
        <button class="ghost" id="confirmCancel">Отказ</button>
        <button class="danger" id="confirmOk">Изтрий</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Дати/формати ===== */
    function todayISO(){const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,10)}
    const TODAY=todayISO();
    const isoToBG_YY = iso => /^\d{4}-\d{2}-\d{2}$/.test(iso) ? (iso.split("-")[2]+"."+iso.split("-")[1]+"."+iso.split("-")[0].slice(2)) : "";

    /* Хранилище */
    function load(){ try{return JSON.parse(localStorage.getItem("bt-progress")||"[]");}catch{return [];} }
    function save(d){ localStorage.setItem("bt-progress", JSON.stringify(d)); }
    function sortDescByDate(arr){ return [...arr].sort((a,b)=> b.date.localeCompare(a.date)); }
    function sortAscByDate(arr){ return [...arr].sort((a,b)=> a.date.localeCompare(b.date)); }
    function lastRecordBefore(iso){ const data=sortDescByDate(load()); for(const r of data){ if(r.date<iso && typeof r.weight==="number") return r; } return null; }
    function firstRecordAfter(iso){ const data=sortAscByDate(load()); for(const r of data){ if(r.date>iso && typeof r.weight==="number") return r; } return null; }

    /* Елементи */
    const dateText=document.getElementById("dateText");
    const weight=document.getElementById("weight");
    const tbody=document.querySelector("#table tbody");
    const pager=document.getElementById("pager");
    const spanSel=document.getElementById("span");
    const checkAll=document.getElementById("checkAll");
    const btnDeleteSelected=document.getElementById("deleteSelected");

    // пейджинг
    const PAGE_SIZES=[10,20,50,100,"all"];
    const getSavedPageSize=()=>{const v=localStorage.getItem("bt-page-size"); if(v==="all") return "all"; const n=Number(v); return PAGE_SIZES.includes(n)?n:20;};
    const savePageSize=v=>localStorage.setItem("bt-page-size",v);
    let pageSize=getSavedPageSize();
    let currentPage=1;

    // текуща дата (ISO) → показваме ДД.ММ.ГГ
    function initCurrentISO(){
      let iso = localStorage.getItem("bt-last-date") || TODAY;
      if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) iso=TODAY;
      return iso;
    }
    let currentISO = initCurrentISO();
    dateText.value = isoToBG_YY(currentISO);

    // скрит date picker
    const hiddenDate = document.createElement("input");
    hiddenDate.type = "date"; hiddenDate.style.position="fixed"; hiddenDate.style.left="-9999px";
    document.body.appendChild(hiddenDate);
    hiddenDate.addEventListener("change", ()=>{
      const iso = hiddenDate.value; if(!iso) return;
      currentISO = iso; localStorage.setItem("bt-last-date", iso);
      dateText.value = isoToBG_YY(iso); prefillWeightForDate(iso);
    });
    dateText.addEventListener("click", ()=>{
      hiddenDate.value = currentISO;
      hiddenDate.showPicker ? hiddenDate.showPicker() : hiddenDate.focus();
    });

    function prefillWeightForDate(iso){
      const rec = load().find(r=>r.date===iso);
      if(rec && typeof rec.weight==="number"){ weight.value = rec.weight; return; }
      const prev = lastRecordBefore(iso);
      weight.value = (prev && typeof prev.weight==="number") ? prev.weight : "";
    }
    prefillWeightForDate(currentISO);

    /* Добавяне / редакция с ±5% проверка */
    document.getElementById("add").addEventListener("click", ()=>{
      const iso = currentISO;
      if(iso > TODAY){ alert("Датата е в бъдещето."); return; }
      const w = Number(weight.value);
      if(!(w>0)){ alert("Въведи тегло > 0."); return; }

      const prev = lastRecordBefore(iso);
      const next = firstRecordAfter(iso);
      let ok=true, msgs=[];
      if(prev){ const min=prev.weight*0.95, max=prev.weight*1.05; if(w<min||w>max){ok=false;msgs.push(`спрямо ${isoToBG_YY(prev.date)}: ${min.toFixed(1)}–${max.toFixed(1)} kg`);} }
      if(next){ const min=next.weight*0.95, max=next.weight*1.05; if(w<min||w>max){ok=false;msgs.push(`спрямо ${isoToBG_YY(next.date)}: ${min.toFixed(1)}–${max.toFixed(1)} kg`);} }
      if(!ok){ alert("Извън допустимите граници:\n"+msgs.join("\n")); return; }

      const data=load(); const idx=data.findIndex(r=>r.date===iso);
      const rec={date:iso, weight:w};
      if(idx>=0) data[idx]=rec; else data.push(rec);
      save(data); localStorage.setItem("bt-last-date", iso);
      renderTable(); renderChart();
    });

    /* Таблица + странициране */
    const selected = new Set();
    function renderTable(){
      const allDesc = sortDescByDate(load());
      const total = allDesc.length;
      const eff = pageSize==="all" ? total||1 : pageSize;
      const pages = Math.max(1, Math.ceil(total/eff));
      if(currentPage>pages) currentPage=pages;
      const start=(currentPage-1)*eff;
      const slice=allDesc.slice(start, start+eff);

      tbody.innerHTML="";
      slice.forEach((r, idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td class="comp"><input type="checkbox" class="chk rowchk" data-date="${r.date}"></td>
          <td class="date">${isoToBG_YY(r.date)}</td>
          <td class="w">${(typeof r.weight==="number")?r.weight.toFixed(1):""}</td>
          <td class="comp">
            <div class="actions" style="display:inline-flex;gap:6px">
              <button class="icon-btn" title="Редакция" data-edit="${start+idx}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21l3-1 11-11-2-2L4 18l-1 3z"/><path d="M14 5l5 5"/></svg>
                <span class="label">Редакция</span>
              </button>
              <button class="icon-btn danger" title="Маркирай за изтриване" data-markdel="${r.date}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4h8v2M7 6l1 14h8l1-14"/></svg>
                <span class="label">Маркирай</span>
              </button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('input.rowchk').forEach(b=>{
        b.checked = selected.has(b.dataset.date);
        b.addEventListener('change', ()=>{
          if(b.checked) selected.add(b.dataset.date);
          else selected.delete(b.dataset.date);
          btnDeleteSelected.disabled = selected.size===0;
          if(!b.checked) checkAll.checked=false;
        });
      });

      pager.innerHTML="";
      const info=document.createElement("span"); info.className="muted";
      const from = total? start+1 : 0; const to = Math.min(start+eff,total);
      info.textContent = `${from}-${to} от ${total}`;
      pager.appendChild(info);

      const sizeSel=document.createElement("select");
      [10,20,50,100,"all"].forEach(o=>{
        const opt=document.createElement("option");
        opt.value=o; opt.textContent=(o==="all"?"Всички":o);
        if(o===pageSize) opt.selected=true;
        sizeSel.appendChild(opt);
      });
      sizeSel.onchange=()=>{ pageSize=sizeSel.value==="all"?"all":Number(sizeSel.value); savePageSize(pageSize); currentPage=1; renderTable(); };
      pager.appendChild(sizeSel);

      const totalPages=Math.max(1, Math.ceil(total/(pageSize==="all"? total||1 : pageSize)));
      if(totalPages>1){
        if(currentPage>1){ const prev=document.createElement("button"); prev.textContent="←"; prev.onclick=()=>{currentPage--;renderTable();}; pager.appendChild(prev); }
        for(let p=Math.max(1,currentPage-3); p<=Math.min(totalPages,currentPage+3); p++){
          const btn=document.createElement("button"); btn.textContent=p; if(p===currentPage) btn.className="active";
          btn.onclick=()=>{currentPage=p; renderTable();}; pager.appendChild(btn);
        }
        if(currentPage<totalPages){ const next=document.createElement("button"); next.textContent="→"; next.onclick=()=>{currentPage++;renderTable();}; pager.appendChild(next); }
      }
    }

    checkAll.addEventListener('change', ()=>{
      const boxes=tbody.querySelectorAll('input.rowchk');
      if(checkAll.checked){ boxes.forEach(b=>{ b.checked=true; selected.add(b.dataset.date); }); }
      else { boxes.forEach(b=>{ b.checked=false; selected.delete(b.dataset.date); }); }
      btnDeleteSelected.disabled = selected.size===0;
    });

    document.addEventListener("click",(e)=>{
      const markBtn = e.target.closest('button[data-markdel]');
      const editBtn = e.target.closest('button[data-edit]');
      if(markBtn){
        const iso = markBtn.getAttribute('data-markdel');
        const chk = tbody.querySelector(`input.rowchk[data-date="${iso}"]`);
        if(chk){ chk.checked=!chk.checked; chk.dispatchEvent(new Event('change')); }
      }
      if(editBtn){
        const iDesc = +editBtn.getAttribute("data-edit");
        const rec = sortDescByDate(load())[iDesc];
        dateText.value = isoToBG_YY(rec.date);
        currentISO = rec.date;
        weight.value = (typeof rec.weight==="number")? rec.weight.toFixed(1) : "";
        window.scrollTo({top:0, behavior:"smooth"});
      }
    });

    /* Потвърждение за изтриване (модал) */
    const modalBackdrop=document.getElementById("modalBackdrop");
    const confirmMsg=document.getElementById("confirmMsg");
    const confirmOk=document.getElementById("confirmOk");
    const confirmCancel=document.getElementById("confirmCancel");
    function openConfirm(message){
      confirmMsg.textContent = message || "Да изтрия избраните записи?";
      modalBackdrop.style.display="flex";
      return new Promise(res=>{
        function off(){ confirmOk.onclick=null; confirmCancel.onclick=null; modalBackdrop.style.display="none"; }
        confirmOk.onclick=()=>{ off(); res(true); };
        confirmCancel.onclick=()=>{ off(); res(false); };
      });
    }
    btnDeleteSelected.addEventListener('click', async ()=>{
      const items = Array.from(document.querySelectorAll('input.rowchk:checked')).map(x=>x.dataset.date);
      if(!items.length) return;
      const ok = await openConfirm(`Да изтрия избраните ${items.length} записа?`);
      if(!ok) return;
      const before = load();
      const after  = before.filter(r=> !items.includes(r.date));
      save(after);
      document.getElementById("checkAll").checked=false;
      renderTable(); renderChart();
    });

    /* Експорт / Импорт */
    document.getElementById("export").addEventListener("click", ()=>{
      const data = load();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="bt-progress-export.json";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
    document.getElementById("importFile").addEventListener("change", async (ev)=>{
      const file = ev.target.files?.[0]; if(!file) return;
      try{
        const text = await file.text(); const parsed = JSON.parse(text);
        if(!Array.isArray(parsed)) throw new Error();
        const cleaned=[];
        for(const r of parsed){
          if(typeof r.date==="string" && /^\d{4}-\d{2}-\d{2}$/.test(r.date) && typeof r.weight==="number" && r.weight>0 && r.date<=TODAY){
            cleaned.push({date:r.date, weight:r.weight});
          }
        }
        save(cleaned);
        renderTable(); renderChart();
        alert("Импортът е успешен.");
      }catch{ alert("Невалиден JSON (очаквам масив от {date:'YYYY-MM-DD', weight:number})."); }
      ev.target.value="";
    });

    /* Графика + агрегация (средно за седмица/месец) */
    const chart=document.getElementById("chart");
    function weekKey(d){ d=new Date(d); d.setUTCHours(0,0,0,0); d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7)); const yStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); const w=Math.ceil((((d-yStart)/86400000)+1)/7); return d.getUTCFullYear()+"-W"+String(w).padStart(2,"0");}
    function monthKey(d){const dd=new Date(d); return dd.getFullYear()+"-"+String(dd.getMonth()+1).padStart(2,"0")}
    function labelWeek(key){const [y,w]=key.split("-W"); return "С"+w+"."+String(y).slice(2)}
    function labelMonth(key){const [y,m]=key.split("-"); return m+"."+String(y).slice(2)}
    spanSel.onchange=renderChart;

    function renderChart(){
      const ctx=chart.getContext("2d"); const w=chart.width=chart.clientWidth, h=chart.height=360; ctx.clearRect(0,0,w,h);
      const raw=sortAscByDate(load()); if(!raw.length){ctx.fillStyle="#9fb4ad";ctx.fillText("Няма данни",10,22);return}
      let points=[];
      if(spanSel.value==="daily"){
        points=raw.map(r=>({x:r.date,label:isoToBG_YY(r.date),y:r.weight}));
      }else if(spanSel.value==="weekly"){
        const map=new Map(); raw.forEach(r=>{const k=weekKey(r.date); const a=map.get(k)||[]; a.push(r.weight); map.set(k,a)});
        points=[...map.entries()].map(([k,a])=>({x:k,label:labelWeek(k),y:a.reduce((s,v)=>s+v,0)/a.length}));
      }else{
        const map=new Map(); raw.forEach(r=>{const k=monthKey(r.date); const a=map.get(k)||[]; a.push(r.weight); map.set(k,a)});
        points=[...map.entries()].map(([k,a])=>({x:k,label:labelMonth(k),y:a.reduce((s,v)=>s+v,0)/a.length}));
      }
      points.sort((a,b)=>a.x.localeCompare(b.x));
      const vals=points.map(p=>p.y).filter(n=>typeof n==="number");
      if(vals.length<2){ctx.fillStyle="#9fb4ad";ctx.fillText("Добави поне 2 точки",10,22);return}
      const min=Math.min(...vals), max=Math.max(...vals), padL=36,padR=14,padT=12,padB=84, n=points.length;
      const X=i=>padL+(w-padL-padR)*(n<=1?0:i/(n-1)), Y=v=>h-padB-((v-min)/((max-min)||1))*(h-padT-padB);
      ctx.strokeStyle="#20343a"; ctx.beginPath(); ctx.moveTo(padL,h-padB); ctx.lineTo(w-padR,h-padB); ctx.moveTo(padL,padT); ctx.lineTo(padL,h-padB); ctx.stroke();
      ctx.strokeStyle="#87f3c5"; ctx.lineWidth=2; ctx.beginPath(); for(let i=0;i<n;i++){const p=points[i]; const x=X(i), y=Y(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y)} ctx.stroke();
      ctx.fillStyle="#9fb4ad"; ctx.textBaseline="middle"; ctx.fillText(String(max),6,Y(max)); ctx.fillText(String(min),6,Y(min));
      const maxLabels=Math.min(14,n), step=Math.max(1,Math.floor(n/maxLabels));
      for(let i=0;i<n;i+=step){const p=points[i]; const x=X(i), y=h-padB+64; ctx.beginPath(); ctx.arc(x,h-padB,2,0,6.283); ctx.fill(); ctx.save(); ctx.translate(x,y); ctx.rotate(-Math.PI/2); ctx.fillText(p.label,0,0); ctx.restore();}
    }

    (function init(){renderTable(); renderChart();})();
  </script>
</body>
</html>
