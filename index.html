<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–ë–¢ App 3 ‚Äî v2.10.03</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<meta name="theme-color" content="#0b1215"/>
<link rel="manifest" href="manifest.webmanifest?v=1.39"/>
<link rel="icon" href="assets/icons/icon-192.png?v=1.39"/>

<style>
:root{
  --bg:#0b1215; --card:#111a1f; --text:#e6f2ef; --muted:#9fb4ad;
  --accent:#10b981; --border:#1e2b30; --has:#c7f5df;
  --ctl-h:42px; --lbl-h:16px; --maxw:980px;
  --chart-label:15px; --chart-values:15px;
  --line-green:#87f3c5; --line-orange:#f59e0b; --line-neutral:#2dd4bf;
}
*{box-sizing:border-box} html,body{height:100%} body{
  margin:0; background:var(--bg); color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,"Noto Sans",sans-serif;
}

/* –ì–æ—Ä–Ω–∞ –ª–µ–Ω—Ç–∞ */
.topbar-wrap{position:sticky;top:0;z-index:10;background:#0b1215;border-bottom:1px solid var(--border)}
.topbar{max-width:var(--maxw);margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:center;gap:10px}
.topbar .brand{display:flex;align-items:center;gap:10px;font-weight:800}
.topbar .brand img{width:24px;height:24px}
.topbar .title{font-size:18px;font-weight:800}
.topbar .badge{font-size:12px;font-weight:800;color:#06241b;background:linear-gradient(90deg,#22c55e,#14b8a6);padding:2px 8px;border-radius:10px}

/* –¢–∞–±–æ–≤–µ */
.tabs-wrap{background:#0b1215;border-bottom:1px solid var(--border)}
.tabs{max-width:var(--maxw);margin:0 auto;padding:10px 16px;display:flex;gap:8px}
.tab-btn{appearance:none;border:1px solid var(--border);background:#0d171b;color:#e6f2ef;
  padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:800;font-size:16px}
.tab-btn[aria-selected="true"]{color:#06241b;border-color:transparent;background:linear-gradient(90deg,#22c55e,#14b8a6)}

/* –û—Å–Ω–æ–≤–Ω–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ */
main{max-width:var(--maxw);margin:20px auto;padding:0 16px 40px;display:grid;gap:16px;align-content:start}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}

/* –§–æ—Ä–º –∫–æ–Ω—Ç—Ä–æ–ª–∏ */
input,select,button{background:#0d171b;border:1px solid #254046;color:var(--text);
  border-radius:10px;padding:8px 10px;font-size:14px;height:var(--ctl-h)}
button.primary{background:var(--accent);border-color:var(--accent);color:#06241b;font-weight:700;min-width:110px}
.lbl{height:var(--lbl-h);line-height:var(--lbl-h);font-size:12px;color:var(--muted);margin:0 0 6px 0}
.bt-only{display:flex;align-items:center;justify-content:center;width:var(--ctl-h);height:var(--ctl-h);
  border:1px solid #334a4f;background:#0d171b;border-radius:10px}
.bt-only input{width:16px;height:16px;margin:0}

/* ‚Äû–ó–∞–ø–∏—Å‚Äú ‚Äî —Ñ–∏–∫—Å–∏—Ä–∞–Ω–∞ grid –ø–æ–¥—Ä–µ–¥–±–∞ 4 –∫–æ–ª–æ–Ω–∏ */
.form-grid{
  display:grid; grid-template-columns: 140px 140px 60px 120px; gap:12px; align-items:end;
}
.field{display:flex;flex-direction:column}
.field.date{width:140px}
.field.weight input{font-weight:700;font-size:18px}

/* –ö–∞–ª–µ–Ω–¥–∞—Ä */
.date-wrap{position:relative} #dateText[readonly]{cursor:pointer}
.cal{position:absolute;z-index:50;top:calc(var(--ctl-h) + 8px);left:0;background:#0e1518;border:1px solid #20343a;border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,.35);padding:10px;display:none}
.cal.show{display:block}
.cal .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
.cal .cal-head button{padding:4px 8px;border-radius:8px}
.cal .cal-title{font-weight:700;text-transform:capitalize}
.cal-grid{display:grid;grid-template-columns:repeat(7,36px);gap:6px;justify-content:center}
.cal .dow{color:#9fb4ad;font-size:11px;text-align:center;line-height:36px;height:36px}
.cal .day{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:1px solid transparent}
.cal .day:hover{border-color:#27454a}
.cal .day.disabled{opacity:.35;pointer-events:none}
.cal .day.has{background:var(--has);color:#092218}
.cal .day.today{outline:1px dashed #5b8f98}
.cal .day.sel{background:#84e9c2;color:#041915;font-weight:700}

/* –¢–∞–±–ª–∏—Ü–∞ + –≥—Ä–∞—Ñ–∏–∫–∞ */
table{width:100%;border-collapse:collapse}
colgroup col.date{width:70px} colgroup col.w{width:70px} colgroup col.act{width:auto}
th,td{padding:3px 4px;border-bottom:1px solid #20343a;font-size:13px;white-space:nowrap;text-align:left;vertical-align:middle}
th{color:#9fb4ad;font-weight:600} th.w,td.w{text-align:right}
.wSmall{font-size:.6em;opacity:.95;margin-left:1px}
.pager{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:flex-start;margin-top:8px}
.pager .info{color:#9fb4ad;font-size:12px;margin:0 8px 0 0}
.pager button{background:#0d171b;border:1px solid #2a3e41;color:#fff;padding:4px 8px;border-radius:8px;font-size:13px}
.pager button.active{background:var(--accent);color:#06241b;border-color:var(--accent)}
canvas{width:100%;height:360px;display:block;margin-top:8px;background:#0b1215;border:1px solid #1a2a2f;border-radius:8px}

/* ‚Äû–ü—Ä–æ–≥—Ä–∞–º–∞‚Äú */
.dose-row{display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap;margin:8px 0 0}
.pill{display:flex;flex-direction:column;gap:6px;padding:8px 10px;background:#0d171b;border:1px solid #254046;border-radius:10px;min-width:170px}
.pill label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px}
.pill input[type="checkbox"]{width:16px;height:16px;margin:0}
.tp .lbl{margin:0}
.tabpanel[aria-hidden="true"]{display:none}
</style>
</head>
<body>

<!-- –ì–æ—Ä–Ω–∞ –ª–µ–Ω—Ç–∞ -->
<div class="topbar-wrap">
  <div class="topbar">
    <div class="brand">
      <img src="assets/icons/icon-192.png?v=1.39" alt="BT"/>
      <span class="title">BT&nbsp;–ë–µ–∑–æ–ø–∞—Å–Ω–æ –¢–µ–≥–ª–æ ‚Äî</span>
      <span class="badge">v2.10.03</span>
    </div>
  </div>
</div>

<!-- –¢–∞–±–æ–≤–µ -->
<div class="tabs-wrap" role="navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
  <div class="tabs" role="tablist">
    <button id="tab-data" class="tab-btn" role="tab" aria-controls="panel-data" aria-selected="true">–î–∞–Ω–Ω–∏</button>
    <button id="tab-program" class="tab-btn" role="tab" aria-controls="panel-program" aria-selected="false">–ü—Ä–æ–≥—Ä–∞–º–∞</button>
  </div>
</div>

<!-- –ü–ê–ù–ï–õ: –î–ê–ù–ù–ò -->
<div id="panel-data" class="tabpanel" role="tabpanel" aria-labelledby="tab-data" aria-hidden="false">
  <main>
    <!-- –ó–∞–ø–∏—Å -->
    <section class="card">
      <h2 style="margin:0 0 10px">–ó–∞–ø–∏—Å</h2>
      <div class="form-grid">
        <div class="field date">
          <div class="lbl">–î–∞—Ç–∞</div>
          <div class="date-wrap">
            <input id="dateText" type="text" readonly placeholder="–î–î.–ú–ú.–ì–ì"/>
            <div id="cal" class="cal" role="dialog" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä"></div>
          </div>
        </div>
        <div class="field weight">
          <div class="lbl">–¢–µ–≥–ª–æ (kg)</div>
          <input id="weight" type="number" step="0.1" min="0.1" placeholder="107.7"/>
        </div>
        <div class="field">
          <div class="lbl">–ë–¢</div>
          <label class="bt-only" title="–ú–∞—Ä–∫–∏—Ä–∞–Ω –∫–∞—Ç–æ –ë–¢"><input id="btFlag" type="checkbox" checked/></label>
        </div>
        <div class="field">
          <div class="lbl">&nbsp;</div>
          <button id="addBtn" class="primary" type="button">–î–æ–±–∞–≤–∏</button>
        </div>
      </div>
    </section>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∞ -->
    <section class="card">
      <h2 style="margin:0 0 10px">–ì—Ä–∞—Ñ–∏–∫–∞</h2>
      <div>
        <select id="aggSel" title="–ê–≥—Ä–µ–≥–∞—Ü–∏—è">
          <option value="daily" selected>–î–Ω–∏ (–≤—Å–∏—á–∫–∏/—Å—Ç—Ä–∞–Ω–∏—Ü–∞)</option>
          <option value="weekly">–°–µ–¥–º–∏—Ü–∏ (—Å—Ä–µ–¥–Ω–æ ‚Äî –≤—Å–∏—á–∫–∏)</option>
          <option value="monthly">–ú–µ—Å–µ—Ü–∏ (—Å—Ä–µ–¥–Ω–æ ‚Äî –≤—Å–∏—á–∫–∏)</option>
        </select>
      </div>
      <canvas id="chart"></canvas>
    </section>

    <!-- –ó–∞–ø–∏—Å–∏ -->
    <section class="card">
      <h2 style="margin:0">–ó–∞–ø–∏—Å–∏</h2>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <label for="pageSize" style="font-size:12px;color:#9fb4ad">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞:</label>
        <select id="pageSize">
          <option value="7">7 (1 —Å–µ–¥.)</option>
          <option value="14">14 (2 —Å–µ–¥.)</option>
          <option value="28" selected>28 (~1 –º–µ—Å.)</option>
          <option value="84">84 (~3 –º–µ—Å.)</option>
          <option value="112">112 (~4 –º–µ—Å.)</option>
          <option value="168">168 (~6 –º–µ—Å.)</option>
          <option value="336">336 (~12 –º–µ—Å.)</option>
          <option value="all">–í—Å–∏—á–∫–∏</option>
        </select>
      </div>
      <div class="pager" id="pagerTop"></div>
      <table id="tbl">
        <colgroup><col class="date"><col class="w"><col class="act"></colgroup>
        <thead><tr><th class="date">–î–∞—Ç–∞</th><th class="w">–¢–µ–≥–ª–æ (kg)</th><th class="actions">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th class="date">–î–∞—Ç–∞</th><th class="w">–¢–µ–≥–ª–æ (kg)</th><th class="actions">–î–µ–π—Å—Ç–≤–∏—è</th></tr></tfoot>
      </table>
      <div class="pager" id="pagerBottom"></div>
    </section>
  </main>
</div>

<!-- –ü–ê–ù–ï–õ: –ü–†–û–ì–†–ê–ú–ê -->
<div id="panel-program" class="tabpanel" role="tabpanel" aria-labelledby="tab-program" aria-hidden="true">
  <main>
    <!-- –û—Å–Ω–æ–≤–µ–Ω –ø–∞–∫–µ—Ç -->
    <section class="card" id="pkg-core">
      <h2 style="margin:0 0 10px">–û—Å–Ω–æ–≤–µ–Ω –ø–∞–∫–µ—Ç</h2>

      <!-- ProLact Slim+ -->
      <div>
        <strong>ProLact Slim+</strong>
        <div class="dose-row" role="group" aria-label="ProLact Slim+ ‚Äî 2 –æ—Ç 3">
          <span class="pill">
            <label><input type="checkbox" id="pl-m"> –°—É—Ç—Ä–∏–Ω</label>
            <div id="pl-tp-m" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –°—É—Ç—Ä–∏–Ω</div><select id="pl-sel-m"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="pl-n" checked> –û–±–µ–¥</label>
            <div id="pl-tp-n" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –û–±–µ–¥</div><select id="pl-sel-n"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="pl-e" checked> –í–µ—á–µ—Ä</label>
            <div id="pl-tp-e" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –í–µ—á–µ—Ä</div><select id="pl-sel-e"></select></div>
          </span>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--border);margin:14px 0"/>

      <!-- OMNi-Biotic HETOX light -->
      <div>
        <strong>OMNi-Biotic HETOX light</strong>
        <div class="dose-row" role="group" aria-label="HETOX ‚Äî 1 –æ—Ç 3">
          <span class="pill">
            <label><input type="checkbox" id="he-m"> –°—É—Ç—Ä–∏–Ω</label>
            <div id="he-tp-m" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –°—É—Ç—Ä–∏–Ω</div><select id="he-sel-m"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="he-n" checked> –û–±–µ–¥</label>
            <div id="he-tp-n" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –û–±–µ–¥</div><select id="he-sel-n"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="he-e"> –í–µ—á–µ—Ä</label>
            <div id="he-tp-e" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –í–µ—á–µ—Ä</div><select id="he-sel-e"></select></div>
          </span>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--border);margin:14px 0"/>

      <!-- Fortex –•–∏—Ç–æ–∑–∞–Ω –ü–ª—é—Å -->
      <div>
        <strong>Fortex –•–∏—Ç–æ–∑–∞–Ω –ü–ª—é—Å ‚Äî –•–∏—Ç–æ–∑–∞–Ω, –õ-–∫–∞—Ä–Ω–∏—Ç–∏–Ω, –•—Ä–æ–º</strong>
        <div class="dose-row" role="group" aria-label="–•–∏—Ç–æ–∑–∞–Ω –ü–ª—é—Å">
          <span class="pill">
            <label><input type="checkbox" id="ch-m" checked disabled> –°—É—Ç—Ä–∏–Ω</label>
            <div id="ch-tp-m" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –°—É—Ç—Ä–∏–Ω</div><select id="ch-sel-m"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="ch-n" checked disabled> –û–±–µ–¥</label>
            <div id="ch-tp-n" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –û–±–µ–¥</div><select id="ch-sel-n"></select></div>
          </span>
          <span class="pill">
            <label><input type="checkbox" id="ch-e" checked disabled> –í–µ—á–µ—Ä</label>
            <div id="ch-tp-e" class="tp"><div class="lbl">–ß–∞—Å –∑–∞ –í–µ—á–µ—Ä</div><select id="ch-sel-e"></select></div>
          </span>
        </div>
      </div>
    </section>

    <!-- –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω –ø–∞–∫–µ—Ç -->
    <section class="card" id="pkg-extra">
      <h2 style="margin:0 0 10px">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω –ø–∞–∫–µ—Ç</h2>
      <ul style="margin:8px 0 0; padding-left:1rem; line-height:1.5">
        <li><strong>–ë–µ—Ä–±–µ—Ä–∏–Ω 500‚Äì600 mg</strong> ‚Äî –º–∞—Ä–∫–∞ –ø–æ –∏–∑–±–æ—Ä</li>
        <li><strong>–ì–ª—é–∫–æ–º–∞–Ω–∞–Ω</strong> (NOW Foods)</li>
        <li><strong>EGCg</strong> ‚Äî –µ–∫—Å—Ç—Ä–∞–∫—Ç –æ—Ç –∑–µ–ª–µ–Ω —á–∞–π (NOW Foods)</li>
      </ul>
      <p style="color:#9fb4ad;font-size:12px">–î–æ–±–∞–≤—è—Ç —Å–µ –ø–æ –∏–∑–±–æ—Ä —Å–ø–æ—Ä–µ–¥ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏—è –ø–ª–∞–Ω.</p>
    </section>

    <!-- –õ–∏—á–µ–Ω —Ä–µ–∂–∏–º -->
    <section class="card" id="pkg-personal">
      <h2 style="margin:0 0 10px">–õ–∏—á–µ–Ω —Ä–µ–∂–∏–º</h2>
      <p style="color:#9fb4ad;font-size:12px">–°–≤–æ–±–æ–¥–µ–Ω —Å–ø–∏—Å—ä–∫ –∑–∞ —Ç–≤–æ–∏ –¥–æ–±–∞–≤–∫–∏, –≤–∏—Ç–∞–º–∏–Ω–∏ –∏ –¥—Ä.</p>
    </section>
  </main>
</div>

<script>
"use strict";
window.__BT_VER='2.10.03';

/* –¢–∞–± –ª–æ–≥–∏–∫–∞ */
(function(){
  const tabs=[
    {btn:document.getElementById('tab-data'), panel:document.getElementById('panel-data')},
    {btn:document.getElementById('tab-program'), panel:document.getElementById('panel-program')}
  ];
  function select(i){
    tabs.forEach((t,idx)=>{
      const sel=(idx===i);
      t.btn.setAttribute('aria-selected', String(sel));
      t.panel.setAttribute('aria-hidden', String(!sel));
    });
    try{localStorage.setItem('bt_active_tab_v21003', String(i));}catch(_){}
  }
  tabs.forEach((t,idx)=>t.btn.addEventListener('click',()=>select(idx)));
  const saved=parseInt(localStorage.getItem('bt_active_tab_v21003'),10);
  if(Number.isInteger(saved) && saved>=0 && saved<tabs.length) select(saved); else select(0);
})();

/* –ü–æ–º–æ—â–Ω–∏ –∑–∞ —á–∞—Å–æ–≤–µ */
function hhmmToMin(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60+m; }
function minToHHMM(min){ min=(min+1440)%1440; const h=Math.floor(min/60), m=min%60; return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"); }
function fillHours(sel, startMin, endMin){
  sel.innerHTML="";
  const start=Math.max(0, Math.min(startMin, 23*60));
  const end=Math.max(start, Math.min(endMin, 23*60));
  for(let t=start; t<=end; t+=60){
    const o=document.createElement("option");
    o.value=minToHHMM(t); o.textContent=o.value; sel.appendChild(o);
  }
}
function setSelectValue(sel, val){ const o=[...sel.options].find(x=>x.value===val); if(o){sel.value=val;return true;} return false; }
function clampToRange(sel, want){ if(!setSelectValue(sel, want)){ if(sel.options.length) sel.value=sel.options[0].value; } }

/* ProLact Slim+ ‚Äî 2 –æ—Ç 3, —Ç–∞–π–º–µ—Ä–∏ –ø–æ–¥ –∞–∫—Ç–∏–≤–Ω–∏—Ç–µ */
(function(){
  const KEY_SEL='bt_pl_sel_v21003';
  const KEY_TIM='bt_pl_tim_v21003';
  const m=document.getElementById('pl-m'), n=document.getElementById('pl-n'), e=document.getElementById('pl-e');
  const tpM=document.getElementById('pl-tp-m'), tpN=document.getElementById('pl-tp-n'), tpE=document.getElementById('pl-tp-e');
  const selM=document.getElementById('pl-sel-m'), selN=document.getElementById('pl-sel-n'), selE=document.getElementById('pl-sel-e');
  const DEF_M="08:00", DEF_N="12:00", DEF_E="19:00";

  function saveSel(){ localStorage.setItem(KEY_SEL, JSON.stringify({m:m.checked,n:n.checked,e:e.checked})); }
  function saveTim(t){ localStorage.setItem(KEY_TIM, JSON.stringify(t)); }
  function loadSel(){
    try{const r=JSON.parse(localStorage.getItem(KEY_SEL)||''); if(r) {m.checked=r.m; n.checked=r.n; e.checked=r.e; return;}}catch(_){}
    m.checked=false; n.checked=true; e.checked=true;
  }
  function loadTim(){
    const t={m:DEF_M,n:DEF_N,e:DEF_E};
    try{const r=JSON.parse(localStorage.getItem(KEY_TIM)||''); if(r){t.m=r.m||t.m; t.n=r.n||t.n; t.e=r.e||t.e;}}catch(_){}
    return t;
  }

  function enforceTwo(clicked){
    const c=(m.checked?1:0)+(n.checked?1:0)+(e.checked?1:0);
    if(c===3){
      if(clicked===e) n.checked=false;
      else if(clicked===n) e.checked=false;
      else e.checked=false;
    } else if(c<2){
      if(!n.checked) n.checked=true;
      else if(!e.checked) e.checked=true;
      else if(!m.checked) m.checked=true;
    }
    saveSel(); updateUI();
  }

  function updateUI(){
    const t=loadTim();
    const onM=m.checked, onN=n.checked, onE=e.checked;
    tpM.style.display=onM?"block":"none";
    tpN.style.display=onN?"block":"none";
    tpE.style.display=onE?"block":"none";

    if(onM){ fillHours(selM,0,23*60); clampToRange(selM,t.m||DEF_M); }
    if(onN){
      let minN=0, defN=DEF_N;
      if(onM){ const mMin=hhmmToMin(selM.value||t.m||DEF_M); minN=mMin+60; defN=minToHHMM(mMin+240); }
      fillHours(selN,minN,23*60);
      const effN=Math.max(hhmmToMin(t.n||defN), minN);
      clampToRange(selN, minToHHMM(effN));
    }
    if(onE){
      let minE=0, wantE=t.e||DEF_E;
      if(onN){
        const nMin=hhmmToMin(selN.value||t.n||DEF_N);
        minE=nMin+60; wantE=minToHHMM(Math.max(hhmmToMin(DEF_E), nMin+240));
      } else if(onM){
        const mMin=hhmmToMin(selM.value||t.m||DEF_M);
        minE=mMin+60; wantE=(hhmmToMin(DEF_E)<minE)?minToHHMM(minE):DEF_E;
      }
      fillHours(selE,minE,23*60); clampToRange(selE, wantE);
    }
    saveTim({m:selM.value||DEF_M, n:selN.value||DEF_N, e:selE.value||DEF_E});
  }

  [m,n,e].forEach(el=>el.addEventListener('change',()=>enforceTwo(el)));
  selM.addEventListener('change',()=>{const t=loadTim(); t.m=selM.value; saveTim(t); updateUI();});
  selN.addEventListener('change',()=>{const t=loadTim(); t.n=selN.value; saveTim(t); updateUI();});
  selE.addEventListener('change',()=>{const t=loadTim(); t.e=selE.value; saveTim(t);});

  loadSel(); updateUI();
})();

/* OMNi-Biotic ‚Äî 1 –æ—Ç 3, –Ω–µ–∑–∞–≤–∏—Å–∏–º –∫–µ—à M/N/E + –¥–µ—Ñ–æ–ª—Ç–∏ 08/12/19 */
(function(){
  const KEY_SEL='bt_he_sel_v21003', KM='bt_he_m_v21003', KN='bt_he_n_v21003', KE='bt_he_e_v21003';
  const m=document.getElementById('he-m'), n=document.getElementById('he-n'), e=document.getElementById('he-e');
  const tpM=document.getElementById('he-tp-m'), tpN=document.getElementById('he-tp-n'), tpE=document.getElementById('he-tp-e');
  const selM=document.getElementById('he-sel-m'), selN=document.getElementById('he-sel-n'), selE=document.getElementById('he-sel-e');
  const DEF_M="08:00", DEF_N="12:00", DEF_E="19:00";

  function saveSel(s){ localStorage.setItem(KEY_SEL,s); }
  function getTime(k,def){ return localStorage.getItem(k) || def; }
  function setTime(k,v){ localStorage.setItem(k,v); }
  function loadSel(){
    const s=localStorage.getItem(KEY_SEL);
    if(s==="m"){ m.checked=true; n.checked=false; e.checked=false; }
    else if(s==="e"){ m.checked=false; n.checked=false; e.checked=true; }
    else { m.checked=false; n.checked=true; e.checked=false; }
  }
  function showOnly(w){
    tpM.style.display=(w==="m")?"block":"none";
    tpN.style.display=(w==="n")?"block":"none";
    tpE.style.display=(w==="e")?"block":"none";
  }
  function rebuild(w){
    fillHours(selM,0,23*60); fillHours(selN,0,23*60); fillHours(selE,0,23*60);
    if(w==="m"){ showOnly("m"); setSelectValue(selM,getTime(KM,DEF_M)); setTime(KM,selM.value); saveSel("m"); }
    else if(w==="e"){ showOnly("e"); setSelectValue(selE,getTime(KE,DEF_E)); setTime(KE,selE.value); saveSel("e"); }
    else { showOnly("n"); setSelectValue(selN,getTime(KN,DEF_N)); setTime(KN,selN.value); saveSel("n"); }
  }
  function onChange(ch){
    if(ch===m){ n.checked=false; e.checked=false; rebuild("m"); }
    else if(ch===n){ m.checked=false; e.checked=false; rebuild("n"); }
    else { m.checked=false; n.checked=false; rebuild("e"); }
  }
  [m,n,e].forEach(el=>el.addEventListener('change',()=>onChange(el)));
  selM.addEventListener('change',()=>setTime(KM,selM.value));
  selN.addEventListener('change',()=>setTime(KN,selN.value));
  selE.addEventListener('change',()=>setTime(KE,selE.value));
  loadSel(); rebuild(m.checked?"m":n.checked?"n":"e");
})();

/* –•–∏—Ç–æ–∑–∞–Ω –ü–ª—é—Å ‚Äî 3 —Ñ–∏–∫—Å–∏—Ä–∞–Ω–∏, —Å–µ–ª–µ–∫—Ç–∏—Ç–µ –≤–∏–Ω–∞–≥–∏ –≤–∏–¥–∏–º–∏; –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ M‚ÜíN‚ÜíE */
(function(){
  const KEY='bt_ch_tim_v21003';
  const selM=document.getElementById('ch-sel-m');
  const selN=document.getElementById('ch-sel-n');
  const selE=document.getElementById('ch-sel-e');
  const DEF_M="08:00", DEF_N="12:00", DEF_E="19:00";

  function save(t){ localStorage.setItem(KEY, JSON.stringify(t)); }
  function load(){
    const t={m:DEF_M,n:DEF_N,e:DEF_E};
    try{const r=JSON.parse(localStorage.getItem(KEY)||''); if(r){t.m=r.m||t.m; t.n=r.n||t.n; t.e=r.e||t.e;}}catch(_){}
    return t;
  }

  function rebuild(from){
    const t=load();
    fillHours(selM,0,23*60);
    clampToRange(selM,(from==="m"?selM.value:t.m)||DEF_M);

    const mMin=hhmmToMin(selM.value||t.m||DEF_M);
    const minN=mMin+60;
    fillHours(selN,minN,23*60);
    const wantN=(from==="n"?selN.value:t.n) || minToHHMM(mMin+240);
    clampToRange(selN, minToHHMM(Math.max(hhmmToMin(wantN),minN)));

    const nMin=hhmmToMin(selN.value||t.n||DEF_N);
    const minE=nMin+60;
    fillHours(selE,minE,23*60);
    const defE=Math.max(hhmmToMin(DEF_E), nMin+240);
    const wantE=(from==="e"?selE.value:t.e) || minToHHMM(defE);
    clampToRange(selE, minToHHMM(Math.max(hhmmToMin(wantE),minE)));

    save({m:selM.value,n:selN.value,e:selE.value});
  }

  document.getElementById('ch-tp-m').style.display="block";
  document.getElementById('ch-tp-n').style.display="block";
  document.getElementById('ch-tp-e').style.display="block";

  selM.addEventListener('change',()=>rebuild("m"));
  selN.addEventListener('change',()=>rebuild("n"));
  selE.addEventListener('change',()=>rebuild("e"));
  rebuild(null);
})();

/* –î–∞–Ω–Ω–∏ (—Ç–∞–±–ª–∏—Ü–∞/–≥—Ä–∞—Ñ–∏–∫–∞/–∏–º–ø–æ—Ä—Ç/–µ–∫—Å–ø–æ—Ä—Ç) */
function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
const TODAY=todayISO();
function isoToBG_YY(iso){ if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return ""; const y=iso.slice(0,4),m=iso.slice(5,7),d=iso.slice(8,10); return d+"."+m+"."+y.slice(2); }
function bgToISO_any(bg){
  const m2=bg.match(/^(\d{2})\.(\d{2})\.(\d{2})$/); if(m2) return "20"+m2[3]+"-"+m2[2]+"-"+m2[1];
  const m4=bg.match(/^(\d{2})\.(\d{2})\.(\d{4})$/); if(m4) return m4[3]+"-"+m4[2]+"-"+m4[1];
  return "";
}
const KEY_REC="bt-progress";
function loadRecs(){ try{ return JSON.parse(localStorage.getItem(KEY_REC)||"[]"); }catch(_){ return []; } }
function saveRecs(a){ localStorage.setItem(KEY_REC, JSON.stringify(a)); }
function sortDesc(a){ return a.slice().sort((x,y)=>y.date.localeCompare(x.date)); }
function sortAsc(a){ return a.slice().sort((x,y)=>x.date.localeCompare(y.date)); }

const dateText=document.getElementById("dateText"), calEl=document.getElementById("cal"),
  weight=document.getElementById("weight"), addBtn=document.getElementById("addBtn"),
  tb=document.querySelector("#tbl tbody"), pagerTop=document.getElementById("pagerTop"),
  pagerBottom=document.getElementById("pagerBottom"), aggSel=document.getElementById("aggSel"),
  chart=document.getElementById("chart"), pageSizeSel=document.getElementById("pageSize"),
  btFlag=document.getElementById("btFlag");

let currentISO=localStorage.getItem("bt-last-date")||TODAY;
if(!/^\d{4}-\d{2}-\d{2}$/.test(currentISO)) currentISO=TODAY;
dateText.value=isoToBG_YY(currentISO);

function prefillFor(iso){
  const data=loadRecs(); const rec=data.find(r=>r.date===iso);
  if(rec){ weight.value=(typeof rec.weight==="number")?rec.weight:""; btFlag.checked=(rec.bt!==false); return; }
  const prev=sortDesc(data).find(r=>r.date<iso);
  weight.value=prev?prev.weight:""; btFlag.checked=true;
}
prefillFor(currentISO);

/* –ö–∞–ª–µ–Ω–¥–∞—Ä */
let calYear=+currentISO.slice(0,4), calMonth=+currentISO.slice(5,7);
function ymd(y,m,d){ return String(y).padStart(4,"0")+"-"+String(m).padStart(2,"0")+"-"+String(d).padStart(2,"0"); }
function hasDataSet(){ const s=new Set(); loadRecs().forEach(r=>s.add(r.date)); return s; }
function renderCalendar(){
  const set=hasDataSet(), y=calYear, m=calMonth;
  const first=new Date(Date.UTC(y,m-1,1));
  const startDow=(first.getUTCDay()+6)%7;
  const daysInMonth=new Date(Date.UTC(y,m,0)).getUTCDate();
  const title=new Date(Date.UTC(y,m-1,1)).toLocaleDateString("bg-BG",{year:"numeric",month:"long"});
  let html='<div class="cal-head"><button id="calPrev" type="button">‚Üê</button><div class="cal-title">'+title+'</div><button id="calNext" type="button">‚Üí</button></div>';
  html+='<div class="cal-grid">';
  ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–ù–¥"].forEach(x=>html+='<div class="dow">'+x+'</div>');
  for(let i=0;i<startDow;i++) html+='<div class="day disabled"></div>';
  for(let d=1; d<=daysInMonth; d++){
    const iso=ymd(y,m,d), future=(iso>TODAY);
    const cls=["day"]; if(iso===currentISO) cls.push("sel"); if(iso===TODAY) cls.push("today");
    if(set.has(iso)) cls.push("has"); if(future) cls.push("disabled");
    html+='<button type="button" class="'+cls.join(" ")+'" data-iso="'+iso+'">'+d+'</button>';
  }
  html+='</div>'; calEl.innerHTML=html;
}
function showCalendar(){ renderCalendar(); calEl.classList.add("show"); }
function hideCalendar(){ calEl.classList.remove("show"); }
dateText.addEventListener("click",(e)=>{ e.stopPropagation(); calYear=+currentISO.slice(0,4); calMonth=+currentISO.slice(5,7); showCalendar(); });
calEl.addEventListener("click",(e)=>{
  e.stopPropagation(); const t=e.target;
  if(t && t.id==="calPrev"){ calMonth--; if(calMonth===0){calMonth=12; calYear--; } renderCalendar(); return; }
  if(t && t.id==="calNext"){ calMonth++; if(calMonth===13){calMonth=1; calYear++; } renderCalendar(); return; }
  const btn=t.closest && t.closest(".day[data-iso]");
  if(btn){ const iso=btn.getAttribute("data-iso"); if(iso<=TODAY){ currentISO=iso; localStorage.setItem("bt-last-date",iso); dateText.value=isoToBG_YY(iso); prefillFor(iso); hideCalendar(); } }
});
document.addEventListener("click",(e)=>{ if(!calEl.contains(e.target) && e.target!==dateText) hideCalendar(); });

/* –î–æ–±–∞–≤—è–Ω–µ –∑–∞–ø–∏—Å */
addBtn.addEventListener("click", ()=>{
  const iso=currentISO;
  if(iso>TODAY){ alert("–î–∞—Ç–∞—Ç–∞ –µ –≤ –±—ä–¥–µ—â–µ—Ç–æ."); return; }
  const w=Number(weight.value); if(!(w>0)){ alert("–í—ä–≤–µ–¥–∏ —Ç–µ–≥–ª–æ > 0."); return; }

  const data=loadRecs(), prev=sortDesc(data).find(r=>r.date<iso), next=sortAsc(data).find(r=>r.date>iso);
  let ok=true, msgs=[];
  if(prev){ const minP=prev.weight*0.95, maxP=prev.weight*1.05; if(w<minP||w>maxP){ ok=false; msgs.push("—Å–ø—Ä—è–º–æ "+isoToBG_YY(prev.date)+": "+minP.toFixed(1)+"‚Äì"+maxP.toFixed(1)+" kg"); } }
  if(next){ const minN=next.weight*0.95, maxN=next.weight*1.05; if(w<minN||w>maxN){ ok=false; msgs.push("—Å–ø—Ä—è–º–æ "+isoToBG_YY(next.date)+": "+minN.toFixed(1)+"‚Äì"+maxN.toFixed(1)+" kg"); } }
  if(!ok){ alert("–ò–∑–≤—ä–Ω –¥–æ–ø—É—Å—Ç–∏–º–∏—Ç–µ –≥—Ä–∞–Ω–∏—Ü–∏:\n"+msgs.join("\n")); return; }

  const idx=data.findIndex(r=>r.date===iso);
  const rec={date: iso, weight: w, bt: !!btFlag.checked};
  if(idx>=0) data[idx]=rec; else data.push(rec);
  saveRecs(data); renderTable(); renderChart();
});

/* –¢–∞–±–ª–∏—Ü–∞ */
const PAGE_SIZES=[7,14,28,84,112,168,336,"all"];
function getPS(){ const v=localStorage.getItem("bt-page-size"); if(v==="all") return "all"; const n=Number(v); return (PAGE_SIZES.indexOf(n)>=0)?n:28; }
function setPS(v){ localStorage.setItem("bt-page-size",v); }
let pageSize=getPS(), currentPage=1;
(function(){ const v=(pageSize==="all")?"all":String(pageSize); const opt=document.querySelector('#pageSize option[value="'+v+'"]'); if(opt) pageSizeSel.value=v; })();
pageSizeSel.addEventListener("change", ()=>{ const v=pageSizeSel.value; pageSize=(v==="all")?"all":Number(v); setPS(v); currentPage=1; renderTable(); renderChart(); });

let __currentSlice=[];
function buildPager(container,total,eff){
  container.innerHTML="";
  const start=(currentPage-1)*eff, from=total?start+1:0, to=Math.min(start+eff,total);
  const info=document.createElement("span"); info.className="info"; info.textContent=from+"-"+to+" –æ—Ç "+total; container.appendChild(info);
  const pagesTotal=Math.max(1,Math.ceil(total/eff)), frag=document.createDocumentFragment();
  function pageBtn(n,active){ const b=document.createElement("button"); b.textContent=String(n); if(active) b.className="active"; b.addEventListener("click",()=>{currentPage=n; renderTable(); renderChart();}); return b; }
  if(pagesTotal>1 && currentPage>1){ const prev=document.createElement("button"); prev.textContent="‚Üê"; prev.addEventListener("click",()=>{currentPage=Math.max(1,currentPage-1); renderTable(); renderChart();}); frag.appendChild(prev); }
  const sp=Math.max(1, Math.min(currentPage-2, Math.max(1,pagesTotal-4))), ep=Math.min(pagesTotal, sp+4);
  for(let p=sp;p<=ep;p++) frag.appendChild(pageBtn(p,p===currentPage));
  if(pagesTotal>1 && currentPage<pagesTotal){ const next=document.createElement("button"); next.textContent="‚Üí"; next.addEventListener("click",()=>{currentPage=Math.min(pagesTotal,currentPage+1); renderTable(); renderChart();}); frag.appendChild(next); }
  container.appendChild(frag);
}
function renderTable(){
  const all=sortDesc(loadRecs()), total=all.length, eff=(pageSize==="all")?(total||1):pageSize;
  const pages=Math.max(1,Math.ceil(total/eff)); if(currentPage>pages) currentPage=pages;
  const start=(currentPage-1)*eff, slice=all.slice(start,start+eff); __currentSlice=slice.slice();

  buildPager(pagerTop,total,eff);
  const tbody=document.querySelector("#tbl tbody"); tbody.innerHTML="";
  slice.forEach(r=>{
    const tr=document.createElement("tr");
    const s=Number(r.weight).toFixed(1).split(".");
    tr.innerHTML =
      '<td class="date">'+isoToBG_YY(r.date)+'</td>'+
      '<td class="w"><span>'+s[0]+'</span><span class="wSmall">.'+s[1]+'</span></td>'+
      '<td class="actions">'+
        '<button class="icon" data-edit="'+r.date+'" title="–†–µ–¥–∞–∫—Ü–∏—è" type="button">‚úé</button> '+
        '<button class="icon" data-del="'+r.date+'" title="–ò–∑—Ç—Ä–∏–π" type="button">üóë</button>'+
      '</td>';
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-edit]').forEach(b=>{
    b.addEventListener("click",()=>{
      const iso=b.getAttribute("data-edit"); const rec=loadRecs().find(x=>x.date===iso);
      if(rec){ currentISO=iso; localStorage.setItem("bt-last-date",iso); dateText.value=isoToBG_YY(iso); prefillFor(iso); window.scrollTo({top:0,behavior:"smooth"}); }
    });
  });
  tbody.querySelectorAll('button[data-del]').forEach(b=>{
    b.addEventListener("click",()=>{
      const iso=b.getAttribute("data-del"); if(!confirm("–î–∞ –∏–∑—Ç—Ä–∏—è –∑–∞–ø–∏—Å–∞ –∑–∞ "+isoToBG_YY(iso)+"?")) return;
      const data=loadRecs().filter(x=>x.date!==iso); saveRecs(data); renderTable(); renderChart();
    });
  });
  buildPager(pagerBottom,total,eff);
}

/* –ì—Ä–∞—Ñ–∏–∫–∞ */
function weekKey(iso){
  const d=new Date(iso); d.setUTCHours(0,0,0,0); d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
  const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const week=Math.ceil((((d-yearStart)/86400000)+1)/7);
  return d.getUTCFullYear()+"-W"+String(week).padStart(2,"0");
}
function monthKey(iso){ const d=new Date(iso); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); }
function labelWeek(k){ const s=k.split("-W"); return "–°"+s[1]+"."+String(s[0]).slice(2); }
function labelMonth(k){ const s=k.split("-"); return s[1]+"."+s[0].slice(2); }

aggSel.addEventListener("change", ()=>renderChart());

function cssPx(name, fallback){ const v=getComputedStyle(document.documentElement).getPropertyValue(name).trim(); const n=parseFloat(v); return Number.isFinite(n)?n:fallback; }
function getChartRawData(){
  const mode=aggSel.value;
  if(mode==="daily"){ const src=(__currentSlice && __currentSlice.length)?__currentSlice.slice():sortDesc(loadRecs()); return sortAsc(src); }
  return sortAsc(loadRecs());
}
function renderChart(){
  const canvas=document.getElementById("chart");
  const ctx=canvas.getContext("2d"), rect=canvas.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
  canvas.width=Math.round(rect.width*dpr); canvas.height=Math.round(360*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
  const w=rect.width, h=360; ctx.clearRect(0,0,w,h);

  const raw=getChartRawData(); if(!raw.length){ ctx.fillStyle="#9fb4ad"; ctx.font="700 "+cssPx('--chart-values', 15)+"px system-ui"; ctx.fillText("–ù—è–º–∞ –¥–∞–Ω–Ω–∏",10,26); return; }

  const mode=aggSel.value; let pts=[];
  if(mode==="daily"){
    pts=raw.map(r=>({x:r.date,y:r.weight,label:isoToBG_YY(r.date),bt:(r.bt!==false)}));
  } else if(mode==="weekly"){
    const wm=new Map(); raw.forEach(r=>{ const k=weekKey(r.date); (wm.get(k)||wm.set(k,[]).get(k)).push(r); });
    wm.forEach((arr,k)=>{ const s=arr.reduce((a,b)=>a+b.weight,0)/arr.length; const btCount=arr.filter(z=>z.bt!==false).length;
      pts.push({x:k,y:s,label:labelWeek(k),bt:(btCount>=arr.length-btCount)}); });
  } else {
    const mm=new Map(); raw.forEach(r=>{ const k=monthKey(r.date); (mm.get(k)||mm.set(k,[]).get(k)).push(r); });
    mm.forEach((arr,k)=>{ const s=arr.reduce((a,b)=>a+b.weight,0)/arr.length; const btCount=arr.filter(z=>z.bt!==false).length;
      pts.push({x:k,y:s,label:labelMonth(k),bt:(btCount>=arr.length-btCount)}); });
  }
  pts.sort((a,b)=>a.x.localeCompare(b.x));
  const vals=pts.map(p=>p.y).filter(Number.isFinite);
  ctx.font="700 "+cssPx('--chart-values', 15)+"px system-ui";
  if(vals.length<2){ ctx.fillStyle="#9fb4ad"; ctx.fillText("–î–æ–±–∞–≤–∏ –ø–æ–Ω–µ 2 —Ç–æ—á–∫–∏",10,26); return; }

  const min=Math.min(...vals), max=Math.max(...vals);
  const padL=48, padR=18, padT=16, padB=96, n=pts.length;
  const X=i=>padL+(w-padL-padR)*(n<=1?0:i/(n-1));
  const Y=v=>h-padB-((v-min)/((max-min)||1))*(h-padT-padB);

  ctx.strokeStyle="#20343a"; ctx.lineWidth=1.1;
  ctx.beginPath(); ctx.moveTo(padL,h-padB); ctx.lineTo(w-padR,h-padB); ctx.moveTo(padL,padT); ctx.lineTo(padL,h-padB); ctx.stroke();

  for(let i=1;i<n;i++){
    const p0=pts[i-1], p1=pts[i];
    const bothBT=(p0.bt&&p1.bt), bothNon=(!p0.bt&&!p1.bt);
    ctx.strokeStyle= bothBT ? getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b'
                 : bothNon ? getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5'
                 : getComputedStyle(document.documentElement).getPropertyValue('--line-neutral').trim()||'#2dd4bf';
    ctx.lineWidth=2.0; ctx.beginPath(); ctx.moveTo(X(i-1),Y(p0.y)); ctx.lineTo(X(i),Y(p1.y)); ctx.stroke();
  }

  ctx.fillStyle="#d9ebe5"; ctx.textBaseline="middle";
  ctx.fillText(String(max.toFixed(1)),10,Y(max)); ctx.fillText(String(min.toFixed(1)),10,Y(min));

  const maxLabels=Math.min(16,n), step=Math.max(1,Math.floor(n/maxLabels));
  const green=getComputedStyle(document.documentElement).getPropertyValue('--line-green').trim()||'#87f3c5';
  const orange=getComputedStyle(document.documentElement).getPropertyValue('--line-orange').trim()||'#f59e0b';
  ctx.font="700 "+cssPx('--chart-label', 15)+"px system-ui";
  for(let j=0;j<n;j++){
    const p=pts[j], x0=X(j), y0=h-padB;
    ctx.beginPath(); ctx.fillStyle=p.bt?orange:green; ctx.arc(x0,Y(p.y),3,0,Math.PI*2); ctx.fill();
    if(j%step===0){ ctx.save(); ctx.translate(x0,y0+64); ctx.rotate(-Math.PI/2); ctx.fillStyle="#e7faf4"; ctx.fillText(p.label,0,0); ctx.restore(); }
  }
}

function migrateDatesAndBT(){
  const arr=loadRecs(); let changed=false;
  for(let i=0;i<arr.length;i++){
    const r=arr[i];
    if(typeof r.date==="string" && !/^\d{4}-\d{2}-\d{2}$/.test(r.date)){
      const iso=bgToISO_any(r.date); if(iso){ r.date=iso; changed=true; }
    }
    if(typeof r.bt==="undefined"){ r.bt=true; changed=true; }
  }
  if(changed) saveRecs(arr);
}
function initialRender(){
  migrateDatesAndBT(); prefillFor(currentISO); renderTable(); renderChart();
  window.addEventListener("resize", ()=>renderChart(), {passive:true});
}
initialRender();
</script>
</body>
</html>
